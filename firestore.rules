rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // FUNCIONES AUXILIARES
    // ============================================================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Verificar si el usuario es el dueño del recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verificar si el usuario existe y tiene rol válido
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // ============================================================================
    // USUARIOS
    // ============================================================================
    
    match /users/{userId} {
      // Cualquiera puede leer datos básicos de usuarios (para mostrar nombres, etc.)
      allow read: if true;
      
      // Solo el mismo usuario o admin puede actualizar
      allow update: if isOwner(userId) || isAdmin();
      
      // Solo se puede crear durante el registro (mismo ID que auth.uid) o admin
      allow create: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
      
      // Solo admin puede eliminar usuarios
      allow delete: if isAdmin();
      
      // ============================================================================
      // DIRECCIONES (Subcolección de users)
      // ============================================================================
      
      match /addresses/{addressId} {
        // Solo el dueño o admin puede leer
        allow read: if isOwner(userId) || isAdmin();
        
        // Solo el dueño o admin puede crear/actualizar/eliminar
        allow create, update, delete: if isOwner(userId) || isAdmin();
      }
      
      // ============================================================================
      // MÉTODOS DE PAGO (Subcolección de users)
      // ============================================================================
      
      match /paymentMethods/{methodId} {
        // Solo el dueño o admin puede leer
        allow read: if isOwner(userId) || isAdmin();
        
        // Solo el dueño o admin puede crear/actualizar/eliminar
        allow create, update, delete: if isOwner(userId) || isAdmin();
      }
    }
    
    // ============================================================================
    // PRODUCTOS
    // ============================================================================
    
    match /products/{productId} {
      // Consultas de lista: cualquier usuario puede listar (se filtrarán activos en el cliente)
      // Usuarios autenticados pueden ver todas (incluyendo inactivas)
      allow list: if true;
      
      // Lectura de documentos individuales: cualquiera puede leer productos activos
      // Solo usuarios autenticados pueden leer productos inactivos (para admin)
      allow get: if resource.data.status == 'active' || 
                     (isAuthenticated() && userExists());
      
      // Solo admin puede crear/actualizar/eliminar productos
      allow create, update, delete: if isAdmin();
      
      // Validar estructura al crear
      allow create: if isAdmin() && 
                       request.resource.data.keys().hasAll(['name', 'brand', 'category', 'type', 'price', 'image', 'lifeStage', 'breedSize', 'stock', 'minStock', 'status', 'createdAt', 'updatedAt']);
    }
    
    // ============================================================================
    // OPCIONES DE PRODUCTOS (Categorías, Tipos, etc.)
    // ============================================================================
    
    match /productOptions/{optionId} {
      // Cualquiera puede leer opciones activas
      allow read: if resource.data.isActive == true || 
                     (isAuthenticated() && userExists());
      
      // Solo admin puede crear/actualizar/eliminar
      allow create, update, delete: if isAdmin();
      
      // Validar estructura al crear
      allow create: if isAdmin() && 
                       request.resource.data.keys().hasAll(['name', 'slug', 'type', 'isActive', 'order', 'createdAt', 'updatedAt']);
    }
    
    // ============================================================================
    // CATEGORÍAS DE PRODUCTOS
    // ============================================================================
    
    match /categories/{categoryId} {
      // Consultas de lista: cualquier usuario puede listar (se filtrarán activas en el cliente)
      // Usuarios autenticados pueden ver todas (incluyendo inactivas)
      allow list: if true;
      
      // Lectura de documentos individuales: usuarios autenticados o categorías activas públicas
      allow get: if (isAuthenticated() && userExists()) ||
                    (resource != null && resource.data.status == 'Activo');
      
      // Solo admin puede crear/actualizar/eliminar categorías
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================================================
    // MARCAS DE PRODUCTOS
    // ============================================================================
    
    match /brands/{brandId} {
      // Consultas de lista: cualquier usuario puede listar (se filtrarán activas en el cliente)
      // Usuarios autenticados pueden ver todas (incluyendo inactivas)
      allow list: if true;
      
      // Lectura de documentos individuales: usuarios autenticados o marcas activas públicas
      allow get: if (isAuthenticated() && userExists()) ||
                    (resource != null && resource.data.status == 'Activo');
      
      // Solo admin puede crear/actualizar/eliminar marcas
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================================================
    // PEDIDOS
    // ============================================================================
    
    match /orders/{orderId} {
      // Solo el dueño del pedido o admin puede leer
      // Para órdenes de invitados, permitir lectura si se conoce el ID y datos de contacto
      allow read: if isOwner(resource.data.userId) || 
                     isAdmin() ||
                     (resource.data.isGuest == true && 
                      resource.data.guestPhone != null);
      
      // Permitir crear pedidos:
      // 1. Usuarios autenticados (solo para sí mismos)
      // 2. Invitados (con isGuest: true y userId que empiece con 'guest_')
      allow create: if (isAuthenticated() && 
                       userExists() && 
                       request.resource.data.userId == request.auth.uid) ||
                     (request.resource.data.isGuest == true && 
                      request.resource.data.userId.matches('guest_.*') &&
                      request.resource.data.guestPhone != null &&
                      request.resource.data.guestName != null);
      
      // Solo admin puede actualizar pedidos (cambiar estado, etc.)
      // El usuario puede actualizar su pedido solo si está en estado 'pending'
      // Permitir actualizar id e invoiceNumber inmediatamente después de crear (solo estos campos)
      allow update: if isAdmin() || 
                       (isOwner(resource.data.userId) && 
                        resource.data.status == 'pending' && 
                        request.resource.data.status == 'cancelled') ||
                       (isOwner(resource.data.userId) && 
                        resource.data.id == '' && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['id', 'invoiceNumber']));
      
      // Solo admin puede eliminar pedidos
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // FAVORITOS
    // ============================================================================
    
    match /favorites/{userId} {
      // Solo el dueño o admin puede leer
      allow read: if isOwner(userId) || isAdmin();
      
      // Solo el dueño puede crear/actualizar (solo para sí mismo)
      allow create, update: if isAuthenticated() && 
                               userExists() && 
                               request.auth.uid == userId;
      
      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // CARRITO DE COMPRAS
    // ============================================================================
    
    match /cart/{userId} {
      // Solo el dueño o admin puede leer
      allow read: if isOwner(userId) || isAdmin();
      
      // Solo el dueño puede crear/actualizar (solo para sí mismo)
      allow create, update: if isAuthenticated() && 
                               userExists() && 
                               request.auth.uid == userId;
      
      // Solo el dueño o admin puede eliminar
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================================================
    // DESCUENTOS (Opcional - para casos complejos)
    // ============================================================================
    
    match /discounts/{discountId} {
      // Cualquiera puede leer descuentos activos
      allow read: if resource.data.isActive == true || 
                     (isAuthenticated() && userExists());
      
      // Solo admin puede crear/actualizar/eliminar
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================================================
    // DEVOLUCIONES
    // ============================================================================
    
    match /returns/{returnId} {
      // Solo el dueño de la devolución o admin puede leer
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Solo usuarios autenticados pueden crear devoluciones (y solo para sí mismos)
      allow create: if isAuthenticated() && 
                       userExists() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Solo admin puede actualizar devoluciones (cambiar estado, etc.)
      // El usuario puede actualizar su devolución solo si está en estado 'pending'
      allow update: if isAdmin() || 
                       (isOwner(resource.data.userId) && 
                        resource.data.status == 'pending' && 
                        request.resource.data.status == 'cancelled');
      
      // Solo admin puede eliminar devoluciones
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // HISTORIAL DE PRODUCTOS VISTOS
    // ============================================================================
    
    match /viewHistory/{userId} {
      // Solo el dueño o admin puede leer
      allow read: if isOwner(userId) || isAdmin();
      
      // Solo el dueño puede crear/actualizar (solo para sí mismo)
      allow create, update: if isAuthenticated() && 
                               userExists() && 
                               request.auth.uid == userId;
      
      // Solo el dueño o admin puede eliminar
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ============================================================================
    // CONFIGURACIONES DE USUARIO
    // ============================================================================
    
    match /settings/{userId} {
      // Solo el dueño o admin puede leer
      allow read: if isOwner(userId) || isAdmin();
      
      // Solo el dueño puede crear/actualizar (solo para sí mismo)
      allow create, update: if isAuthenticated() && 
                               userExists() && 
                               request.auth.uid == userId;
      
      // Solo admin puede eliminar configuraciones
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // CALIFICACIONES (RATINGS/REVIEWS)
    // ============================================================================
    
    match /ratings/{ratingId} {
      // Cualquiera puede leer calificaciones (para mostrar en productos)
      allow read: if true;
      
      // Solo usuarios autenticados pueden crear calificaciones (y solo para sí mismos)
      allow create: if isAuthenticated() && 
                       userExists() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Solo el dueño de la calificación o admin puede actualizar
      allow update: if isOwner(resource.data.userId) || isAdmin();
      
      // Solo admin puede eliminar calificaciones
      allow delete: if isAdmin();
    }
  }
}
