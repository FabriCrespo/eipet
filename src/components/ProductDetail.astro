---
interface Props {
  productId: string;
}

const { productId } = Astro.props;

// Funciones helper
const getCategoryName = (category: string) => {
  return category === 'dog' ? 'Perro' : 'Gato';
};

const getTypeName = (type: string) => {
  const types: Record<string, string> = {
    food: 'Alimento',
    toy: 'Juguete',
    cleaning: 'Limpieza',
    accessory: 'Accesorio'
  };
  return types[type] || type;
};

const getLifeStageName = (stage: string) => {
  const stages: Record<string, string> = {
    cachorro: 'Cachorro',
    gatito: 'Gatito',
    adulto: 'Adulto',
    senior: 'Senior',
    todos: 'Todas las edades'
  };
  return stages[stage] || stage;
};

const getBreedSizeName = (size: string) => {
  const sizes: Record<string, string> = {
    pequeña: 'Raza Pequeña',
    mediana: 'Raza Mediana',
    grande: 'Raza Grande',
    todos: 'Todos los tamaños'
  };
  return sizes[size] || size;
};
---

<div id="product-loading" class="text-center py-16">
  <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#5d3fbb]"></div>
  <p class="mt-4 text-gray-600">Cargando producto...</p>
</div>

<div id="product-not-found" class="text-center py-16 hidden">
  <p class="text-gray-500 text-lg">Producto no encontrado.</p>
  <a href="/products" class="mt-4 inline-block text-[#5d3fbb] hover:underline" data-astro-prefetch>
    Volver a Productos
  </a>
</div>

<div id="product-content" class="hidden">
  <div class="space-y-8">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
  <!-- Product content will be loaded here dynamically -->
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Dynamic imports
  let getProductById: any, getProducts: any, addToCart: any, addToFavorites: any, removeFromFavorites: any, isFavorite: any, getCurrentUser: any, getCartItemCount: any, addToViewHistory: any;
  let currentProduct: any = null;
  let currentUser: any = null;
  
  (async () => {
    const productsModule = await import('../lib/db/products');
    getProductById = productsModule.getProductById;
    getProducts = productsModule.getProducts;
    
    const cartModule = await import('../lib/db/cart');
    addToCart = cartModule.addToCart;
    getCartItemCount = cartModule.getCartItemCount;
    
    const favoritesModule = await import('../lib/db/favorites');
    addToFavorites = favoritesModule.addToFavorites;
    removeFromFavorites = favoritesModule.removeFromFavorites;
    isFavorite = favoritesModule.isFavorite;
    
    const historyModule = await import('../lib/db/history');
    addToViewHistory = historyModule.addToViewHistory;
    
    const authModule = await import('../lib/auth');
    getCurrentUser = authModule.getCurrentUser;
    
    // Get current user
    const firebaseUser = getCurrentUser();
    if (firebaseUser) {
      const userData = localStorage.getItem('user');
      if (userData) {
        try {
          currentUser = JSON.parse(userData);
        } catch (e) {
          console.error('Error parsing user:', e);
        }
      }
    }
    
    // Load product
    await loadProduct();
  })();

  // Helper functions
  function getCategoryName(category: string) {
    return category === 'dog' ? 'Perro' : category === 'cat' ? 'Gato' : category;
  }

  function getTypeName(type: string) {
    const types: Record<string, string> = {
      food: 'Alimento',
      toy: 'Juguete',
      cleaning: 'Limpieza',
      accessory: 'Accesorio'
    };
    return types[type] || type;
  }

  function getLifeStageName(stage: string) {
    const stages: Record<string, string> = {
      cachorro: 'Cachorro',
      gatito: 'Gatito',
      adulto: 'Adulto',
      senior: 'Senior',
      todos: 'Todas las edades'
    };
    return stages[stage] || stage;
  }

  function getBreedSizeName(size: string) {
    const sizes: Record<string, string> = {
      pequeña: 'Raza Pequeña',
      mediana: 'Raza Mediana',
      grande: 'Raza Grande',
      todos: 'Todos los tamaños'
    };
    return sizes[size] || size;
  }

  // Load product from Firestore
  async function loadProduct() {
    const loadingEl = document.getElementById('product-loading');
    const notFoundEl = document.getElementById('product-not-found');
    const contentEl = document.getElementById('product-content');
    
    if (!contentEl) return;
    
    // Get product ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
      if (loadingEl) loadingEl.classList.add('hidden');
      if (notFoundEl) notFoundEl.classList.remove('hidden');
      return;
    }
    
    try {
      const result = await getProductById(productId);
      
      if (result.error || !result.data) {
        console.error('Error loading product:', result.error);
        if (loadingEl) loadingEl.classList.add('hidden');
        if (notFoundEl) notFoundEl.classList.remove('hidden');
        return;
      }
      
      currentProduct = result.data;
      
      // Register product view in history (if user is authenticated)
      if (currentUser && addToViewHistory) {
        try {
          await addToViewHistory(currentUser.id, productId);
        } catch (error) {
          console.error('Error adding to view history:', error);
          // Don't block the page load if history fails
        }
      }
      
      // Check if product is favorite
      const isFav = currentUser ? await isFavorite(currentUser.id, productId) : false;
      
      // Render product
      renderProduct(currentProduct, isFav);
      
      // Load related products
      await loadRelatedProducts(currentProduct);
      
      if (loadingEl) loadingEl.classList.add('hidden');
      if (contentEl) contentEl.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading product:', error);
      if (loadingEl) loadingEl.classList.add('hidden');
      if (notFoundEl) notFoundEl.classList.remove('hidden');
    }
  }

  // Render product
  function renderProduct(product: any, isFav: boolean) {
    const contentEl = document.getElementById('product-content');
    if (!contentEl) return;
    
    const discount = product.discount || 0;
    const price = product.price || 0;
    const originalPrice = product.originalPrice || null;
    
    contentEl.innerHTML = `
      <div class="space-y-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
          <!-- Imagen del Producto -->
          <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="relative aspect-square bg-gray-100">
              ${discount > 0 ? `
                <div class="absolute top-4 left-4 bg-red-500 text-white px-4 py-2 rounded-xl text-lg font-bold z-10 shadow-lg">
                  -${discount}%
                </div>
              ` : ''}
              <img 
                src="${product.image || ''}" 
                alt="${product.name || ''}"
                class="w-full h-full object-cover"
                onerror="this.src='https://via.placeholder.com/600x600?text=Sin+Imagen'"
              />
            </div>
          </div>

          <!-- Información del Producto -->
          <div class="space-y-6">
            <!-- Marca y Categoría -->
            <div class="flex items-center gap-3 flex-wrap">
              <span class="px-3 py-1 bg-[#5d3fbb]/10 text-[#5d3fbb] rounded-lg text-sm font-semibold">
                ${product.brand || ''}
              </span>
              <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold">
                ${getCategoryName(product.category || '')}
              </span>
              <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-semibold">
                ${getTypeName(product.type || '')}
              </span>
            </div>

            <!-- Nombre del Producto -->
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900">
              ${product.name || ''}
            </h1>

            <!-- Precio -->
            <div class="flex items-center gap-4">
              <p class="text-4xl lg:text-5xl font-bold text-[#5d3fbb]">
                Bs. ${price.toLocaleString()}
              </p>
              ${originalPrice ? `
                <p class="text-2xl text-gray-400 line-through">
                  Bs. ${originalPrice.toLocaleString()}
                </p>
              ` : ''}
            </div>

            <!-- Información Adicional -->
            <div class="grid grid-cols-2 gap-4 p-6 bg-white rounded-xl shadow-lg">
              ${product.weight ? `
                <div class="flex items-center gap-3">
                  <div class="bg-[#5d3fbb]/10 rounded-lg p-2">
                    <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Peso/Tamaño</p>
                    <p class="text-lg font-semibold text-gray-800">${product.weight}</p>
                  </div>
                </div>
              ` : ''}
              
              <div class="flex items-center gap-3">
                <div class="bg-purple-100 rounded-lg p-2">
                  <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                </div>
                <div>
                  <p class="text-xs text-gray-500 uppercase tracking-wide">Etapa de Vida</p>
                  <p class="text-lg font-semibold text-gray-800">${getLifeStageName(product.lifeStage || '')}</p>
                </div>
              </div>

              ${product.breedSize && product.breedSize !== 'todos' ? `
                <div class="flex items-center gap-3">
                  <div class="bg-yellow-100 rounded-lg p-2">
                    <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500 uppercase tracking-wide">Tamaño de Raza</p>
                    <p class="text-lg font-semibold text-gray-800">${getBreedSizeName(product.breedSize)}</p>
                  </div>
                </div>
              ` : ''}

              <div class="flex items-center gap-3">
                <div class="bg-green-100 rounded-lg p-2">
                  <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <div>
                  <p class="text-xs text-gray-500 uppercase tracking-wide">Disponibilidad</p>
                  <p class="text-lg font-semibold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}">
                    ${product.stock > 0 ? 'En Stock' : 'Agotado'}
                  </p>
                </div>
              </div>
            </div>

            <!-- Botones de Acción -->
            <div class="flex flex-col sm:flex-row gap-4">
              <button 
                id="add-to-cart-btn"
                class="flex-1 bg-[#5d3fbb] hover:bg-[#6d4fcc] text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 flex items-center justify-center gap-3 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl ${product.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                data-product-id="${product.id}"
                ${product.stock <= 0 ? 'disabled' : ''}
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                ${product.stock <= 0 ? 'Agotado' : 'Agregar al Carrito'}
              </button>
              <button 
                id="add-to-favorites-btn"
                class="px-6 py-4 bg-white border-2 ${isFav ? 'border-red-500 text-red-500' : 'border-gray-300 text-gray-700 hover:border-red-500 hover:text-red-500'} rounded-xl transition-all duration-300 flex items-center justify-center hover:scale-105 active:scale-95"
                aria-label="Agregar a favoritos"
                data-product-id="${product.id}"
              >
                <svg class="w-6 h-6" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
              </button>
            </div>

            <!-- Descripción -->
            <div class="bg-white rounded-xl shadow-lg p-6">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">Descripción del Producto</h2>
              <p class="text-gray-700 leading-relaxed">
                ${getProductDescription(product)}
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Setup event listeners
    setupEventListeners(product.id, isFav);
  }

  // Get product description
  function getProductDescription(product: any): string {
    const type = product.type || '';
    const brand = product.brand || '';
    const category = getCategoryName(product.category || '');
    const lifeStage = getLifeStageName(product.lifeStage || '').toLowerCase();
    const breedSize = getBreedSizeName(product.breedSize || '').toLowerCase();
    
    if (type === 'food') {
      return `Este alimento premium de ${brand} está especialmente formulado para ${lifeStage}s de ${breedSize}. Proporciona una nutrición completa y balanceada para mantener a tu ${category.toLowerCase()} saludable y feliz.`;
    } else if (type === 'toy') {
      return `Este juguete de ${brand} está diseñado para entretener y estimular a tu ${category.toLowerCase()}. Fabricado con materiales seguros y resistentes, es perfecto para ${lifeStage}s de ${breedSize}.`;
    } else if (type === 'cleaning') {
      return `Producto de limpieza de ${brand} especialmente formulado para el cuidado de tu ${category.toLowerCase()}. Ayuda a mantener a tu mascota limpia y saludable con ingredientes naturales y seguros.`;
    } else if (type === 'accessory') {
      return `Accesorio de ${brand} diseñado para mejorar el bienestar de tu ${category.toLowerCase()}. Ideal para ${lifeStage}s de ${breedSize}, este producto combina funcionalidad y estilo.`;
    }
    return `Producto de calidad de ${brand} para tu ${category.toLowerCase()}.`;
  }

  // Setup event listeners
  function setupEventListeners(productId: string, initialIsFav: boolean) {
    // Add to cart button
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', async () => {
        if (!currentUser) {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
          return;
        }
        
        const btnEl = addToCartBtn as HTMLButtonElement;
        const originalText = btnEl.innerHTML;
        btnEl.disabled = true;
        btnEl.innerHTML = '<svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> Agregando...';
        
        try {
          const result = await addToCart(currentUser.id, { productId, quantity: 1 });
          if (result.success) {
            btnEl.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> ¡Agregado!';
            btnEl.classList.add('bg-green-500', 'hover:bg-green-600');
            btnEl.classList.remove('bg-[#5d3fbb]', 'hover:bg-[#6d4fcc]');
            
            setTimeout(() => {
              btnEl.innerHTML = originalText;
              btnEl.classList.remove('bg-green-500', 'hover:bg-green-600');
              btnEl.classList.add('bg-[#5d3fbb]', 'hover:bg-[#6d4fcc]');
              btnEl.disabled = false;
            }, 2000);
            
            // Emitir evento de actualización del carrito
            document.dispatchEvent(new CustomEvent('cartUpdated'));
          } else {
            throw new Error(result.error?.message || 'Error al agregar al carrito');
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
          btnEl.innerHTML = originalText;
          btnEl.disabled = false;
          alert('Error al agregar al carrito. Por favor, intenta de nuevo.');
        }
      });
    }
    
    // Add to favorites button
    const addToFavoritesBtn = document.getElementById('add-to-favorites-btn');
    if (addToFavoritesBtn) {
      let isFav = initialIsFav;
      
      addToFavoritesBtn.addEventListener('click', async () => {
        if (!currentUser) {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
          return;
        }
        
        const btnEl = addToFavoritesBtn as HTMLButtonElement;
        const svg = btnEl.querySelector('svg');
        
        try {
          let result;
          
          if (isFav) {
            result = await removeFromFavorites(currentUser.id, productId);
          } else {
            result = await addToFavorites(currentUser.id, productId);
          }
          
          if (result.success) {
            isFav = !isFav;
            if (isFav) {
              btnEl.classList.remove('border-gray-300', 'text-gray-700');
              btnEl.classList.add('border-red-500', 'text-red-500');
              if (svg) {
                svg.setAttribute('fill', 'currentColor');
              }
            } else {
              btnEl.classList.remove('border-red-500', 'text-red-500');
              btnEl.classList.add('border-gray-300', 'text-gray-700');
              if (svg) {
                svg.setAttribute('fill', 'none');
              }
            }
          }
        } catch (error) {
          console.error('Error toggling favorite:', error);
        }
      });
    }
  }

  // Load related products
  async function loadRelatedProducts(product: any) {
    const relatedContainer = document.querySelector('.mt-16');
    if (!relatedContainer || !product) return;
    
    try {
      const result = await getProducts({
        category: product.category,
        status: 'active',
        limit: 5,
      });
      
      if (result.error || !result.data) return;
      
      const relatedProducts = result.data
        .filter((p: any) => p.id !== product.id)
        .slice(0, 4);
      
      if (relatedProducts.length === 0) {
        relatedContainer.innerHTML = '';
        return;
      }
      
      let relatedHTML = `
        <h2 class="text-3xl font-bold text-[#5d3fbb] mb-8">Productos Relacionados</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      `;
      
      for (const relatedProduct of relatedProducts) {
        const discount = relatedProduct.discount || 0;
        const price = relatedProduct.price || 0;
        const originalPrice = relatedProduct.originalPrice || null;
        
        relatedHTML += `
          <a 
            href="/product?id=${relatedProduct.id}"
            class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group flex flex-col h-full"
            data-astro-prefetch
          >
            <div class="relative h-48 bg-gray-100 overflow-hidden">
              ${discount > 0 ? `
                <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-bold z-10">
                  -${discount}%
                </div>
              ` : ''}
              <img 
                src="${relatedProduct.image || ''}" 
                alt="${relatedProduct.name || ''}"
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                onerror="this.src='https://via.placeholder.com/400x400?text=Sin+Imagen'"
              />
            </div>
            <div class="p-4 flex flex-col grow">
              <p class="text-xs font-semibold text-gray-500 mb-1 uppercase">${relatedProduct.brand || ''}</p>
              <h3 class="font-bold text-sm text-gray-800 mb-2 line-clamp-2">${relatedProduct.name || ''}</h3>
              <div class="mt-auto flex items-center gap-2">
                <p class="text-xl font-bold text-[#5d3fbb]">Bs. ${price.toLocaleString()}</p>
                ${originalPrice ? `
                  <p class="text-sm text-gray-400 line-through">Bs. ${originalPrice.toLocaleString()}</p>
                ` : ''}
              </div>
            </div>
          </a>
        `;
      }
      
      relatedHTML += '</div>';
      relatedContainer.innerHTML = relatedHTML;
    } catch (error) {
      console.error('Error loading related products:', error);
    }
  }
</script>

