---
import productsData from '../data/products.json';

interface Props {
  productId: number;
}

const { productId } = Astro.props;

// Buscar el producto
// Asegurar que el productId sea válido y convertir ambos a número para la comparación
const product = productId && productId > 0 
  ? productsData.products.find(p => Number(p.id) === Number(productId))
  : null;

// Funciones helper
const getCategoryName = (category: string) => {
  return category === 'dog' ? 'Perro' : 'Gato';
};

const getTypeName = (type: string) => {
  const types: Record<string, string> = {
    food: 'Alimento',
    toy: 'Juguete',
    cleaning: 'Limpieza',
    accessory: 'Accesorio'
  };
  return types[type] || type;
};

const getLifeStageName = (stage: string) => {
  const stages: Record<string, string> = {
    cachorro: 'Cachorro',
    gatito: 'Gatito',
    adulto: 'Adulto',
    senior: 'Senior',
    todos: 'Todas las edades'
  };
  return stages[stage] || stage;
};

const getBreedSizeName = (size: string) => {
  const sizes: Record<string, string> = {
    pequeña: 'Raza Pequeña',
    mediana: 'Raza Mediana',
    grande: 'Raza Grande',
    todos: 'Todos los tamaños'
  };
  return sizes[size] || size;
};
---

{!product ? (
  <div class="text-center py-16">
    <p class="text-gray-500 text-lg">Producto no encontrado.</p>
    <a href="/products" class="mt-4 inline-block text-[#5d3fbb] hover:underline" data-astro-prefetch>
      Volver a Productos
    </a>
  </div>
) : (
  <div class="space-y-8">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
    <!-- Imagen del Producto -->
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="relative aspect-square bg-gray-100">
        {product.discount > 0 && (
          <div class="absolute top-4 left-4 bg-red-500 text-white px-4 py-2 rounded-xl text-lg font-bold z-10 shadow-lg">
            -{product.discount}%
          </div>
        )}
        <img 
          src={product.image} 
          alt={product.name}
          class="w-full h-full object-cover"
        />
      </div>
    </div>

    <!-- Información del Producto -->
    <div class="space-y-6">
      <!-- Marca y Categoría -->
      <div class="flex items-center gap-3 flex-wrap">
        <span class="px-3 py-1 bg-[#5d3fbb]/10 text-[#5d3fbb] rounded-lg text-sm font-semibold">
          {product.brand}
        </span>
        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold">
          {getCategoryName(product.category)}
        </span>
        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-semibold">
          {getTypeName(product.type)}
        </span>
      </div>

      <!-- Nombre del Producto -->
      <h1 class="text-3xl lg:text-4xl font-bold text-gray-900">
        {product.name}
      </h1>

      <!-- Precio -->
      <div class="flex items-center gap-4">
        <p class="text-4xl lg:text-5xl font-bold text-[#5d3fbb]">
          Bs. {product.price.toLocaleString()}
        </p>
        {product.originalPrice && (
          <p class="text-2xl text-gray-400 line-through">
            Bs. {product.originalPrice.toLocaleString()}
          </p>
        )}
      </div>

      <!-- Información Adicional -->
      <div class="grid grid-cols-2 gap-4 p-6 bg-white rounded-xl shadow-lg">
        {product.weight && (
          <div class="flex items-center gap-3">
            <div class="bg-[#5d3fbb]/10 rounded-lg p-2">
              <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
              </svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Peso/Tamaño</p>
              <p class="text-lg font-semibold text-gray-800">{product.weight}</p>
            </div>
          </div>
        )}
        
        <div class="flex items-center gap-3">
          <div class="bg-purple-100 rounded-lg p-2">
            <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
          </div>
          <div>
            <p class="text-xs text-gray-500 uppercase tracking-wide">Etapa de Vida</p>
            <p class="text-lg font-semibold text-gray-800">{getLifeStageName(product.lifeStage)}</p>
          </div>
        </div>

        {product.breedSize !== 'todos' && (
          <div class="flex items-center gap-3">
            <div class="bg-yellow-100 rounded-lg p-2">
              <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
              </svg>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Tamaño de Raza</p>
              <p class="text-lg font-semibold text-gray-800">{getBreedSizeName(product.breedSize)}</p>
            </div>
          </div>
        )}

        <div class="flex items-center gap-3">
          <div class="bg-green-100 rounded-lg p-2">
            <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div>
            <p class="text-xs text-gray-500 uppercase tracking-wide">Disponibilidad</p>
            <p class="text-lg font-semibold text-green-600">En Stock</p>
          </div>
        </div>
      </div>

      <!-- Botones de Acción -->
      <div class="flex flex-col sm:flex-row gap-4">
        <button 
          id="add-to-cart-btn"
          class="flex-1 bg-[#5d3fbb] hover:bg-[#6d4fcc] text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 flex items-center justify-center gap-3 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
          data-product-id={product.id}
          data-product-name={product.name}
          data-product-price={product.price}
          data-product-image={product.image}
          data-product-brand={product.brand}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Agregar al Carrito
        </button>
        <button 
          id="add-to-favorites-btn"
          class="px-6 py-4 bg-white border-2 border-gray-300 hover:border-red-500 text-gray-700 hover:text-red-500 rounded-xl transition-all duration-300 flex items-center justify-center hover:scale-105 active:scale-95"
          aria-label="Agregar a favoritos"
          data-product-id={product.id}
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
        </button>
      </div>

      <!-- Descripción -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Descripción del Producto</h2>
        <p class="text-gray-700 leading-relaxed">
          {product.type === 'food' && (
            `Este alimento premium de ${product.brand} está especialmente formulado para ${getLifeStageName(product.lifeStage).toLowerCase()}s de ${getBreedSizeName(product.breedSize).toLowerCase()}. Proporciona una nutrición completa y balanceada para mantener a tu ${getCategoryName(product.category).toLowerCase()} saludable y feliz.`
          )}
          {product.type === 'toy' && (
            `Este juguete de ${product.brand} está diseñado para entretener y estimular a tu ${getCategoryName(product.category).toLowerCase()}. Fabricado con materiales seguros y resistentes, es perfecto para ${getLifeStageName(product.lifeStage).toLowerCase()}s de ${getBreedSizeName(product.breedSize).toLowerCase()}.`
          )}
          {product.type === 'cleaning' && (
            `Producto de limpieza de ${product.brand} especialmente formulado para el cuidado de tu ${getCategoryName(product.category).toLowerCase()}. Ayuda a mantener a tu mascota limpia y saludable con ingredientes naturales y seguros.`
          )}
          {product.type === 'accessory' && (
            `Accesorio de ${product.brand} diseñado para mejorar el bienestar de tu ${getCategoryName(product.category).toLowerCase()}. Ideal para ${getLifeStageName(product.lifeStage).toLowerCase()}s de ${getBreedSizeName(product.breedSize).toLowerCase()}, este producto combina funcionalidad y estilo.`
          )}
        </p>
      </div>
    </div>
  </div>

  <!-- Productos Relacionados -->
  <div class="mt-16">
    <h2 class="text-3xl font-bold text-[#5d3fbb] mb-8">Productos Relacionados</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      {productsData.products
        .filter(p => p.category === product.category && p.id !== product.id)
        .slice(0, 4)
        .map((relatedProduct) => (
          <a 
            href={`/product?id=${relatedProduct.id}`}
            class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group flex flex-col h-full"
            data-astro-prefetch
          >
            <div class="relative h-48 bg-gray-100 overflow-hidden">
              {relatedProduct.discount > 0 && (
                <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-bold z-10">
                  -{relatedProduct.discount}%
                </div>
              )}
              <img 
                src={relatedProduct.image} 
                alt={relatedProduct.name}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
              />
            </div>
            <div class="p-4 flex flex-col grow">
              <p class="text-xs font-semibold text-gray-500 mb-1 uppercase">{relatedProduct.brand}</p>
              <h3 class="font-bold text-sm text-gray-800 mb-2 line-clamp-2">{relatedProduct.name}</h3>
              <div class="mt-auto flex items-center gap-2">
                <p class="text-xl font-bold text-[#5d3fbb]">Bs. {relatedProduct.price.toLocaleString()}</p>
                {relatedProduct.originalPrice && (
                  <p class="text-sm text-gray-400 line-through">Bs. {relatedProduct.originalPrice.toLocaleString()}</p>
                )}
              </div>
            </div>
          </a>
        ))}
    </div>
  </div>
  </div>
)}

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Obtener elementos una sola vez
  const addToCartBtn = document.getElementById('add-to-cart-btn');
  const addToFavoritesBtn = document.getElementById('add-to-favorites-btn');

  // Agregar al carrito
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', () => {
      const product = {
        id: parseInt(addToCartBtn.getAttribute('data-product-id') || '0'),
        name: addToCartBtn.getAttribute('data-product-name') || '',
        price: parseFloat(addToCartBtn.getAttribute('data-product-price') || '0'),
        image: addToCartBtn.getAttribute('data-product-image') || '',
        brand: addToCartBtn.getAttribute('data-product-brand') || ''
      };

      // Obtener carrito actual
      let cart = JSON.parse(localStorage.getItem('cart') || '{"items": []}');
      
      // Verificar si el producto ya está en el carrito
      const existingItem = cart.items.find((item: any) => item.id === product.id);
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.items.push({ ...product, quantity: 1 });
      }

      // Guardar en localStorage
      localStorage.setItem('cart', JSON.stringify(cart));

      // Actualizar contador del carrito en el header
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        const totalItems = cart.items.reduce((sum: number, item: any) => sum + item.quantity, 0);
        cartCount.textContent = totalItems.toString();
        cartCount.classList.remove('hidden');
        cartCount.classList.add('flex');
      }

      // Feedback visual
      const originalText = addToCartBtn.innerHTML;
      addToCartBtn.innerHTML = '<svg class="w-6 h-6 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Agregado!';
      addToCartBtn.classList.add('bg-green-500', 'hover:bg-green-600');
      addToCartBtn.classList.remove('bg-[#5d3fbb]', 'hover:bg-[#6d4fcc]');
      
      setTimeout(() => {
        addToCartBtn.innerHTML = originalText;
        addToCartBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
        addToCartBtn.classList.add('bg-[#5d3fbb]', 'hover:bg-[#6d4fcc]');
      }, 2000);
    });
  }

  // Agregar a favoritos
  if (addToFavoritesBtn && addToCartBtn) {
    const productId = parseInt(addToFavoritesBtn.getAttribute('data-product-id') || '0');
    
    addToFavoritesBtn.addEventListener('click', () => {
      const product = {
        id: productId,
        name: addToCartBtn.getAttribute('data-product-name') || '',
        price: parseFloat(addToCartBtn.getAttribute('data-product-price') || '0'),
        image: addToCartBtn.getAttribute('data-product-image') || '',
        brand: addToCartBtn.getAttribute('data-product-brand') || ''
      };

      let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      
      const existingIndex = favorites.findIndex((item: any) => item.id === product.id);
      
      if (existingIndex >= 0) {
        favorites.splice(existingIndex, 1);
        addToFavoritesBtn.classList.remove('border-red-500', 'text-red-500');
        addToFavoritesBtn.classList.add('border-gray-300', 'text-gray-700');
      } else {
        favorites.push(product);
        addToFavoritesBtn.classList.add('border-red-500', 'text-red-500');
        addToFavoritesBtn.classList.remove('border-gray-300', 'text-gray-700');
      }

      localStorage.setItem('favorites', JSON.stringify(favorites));
    });

    // Verificar si el producto está en favoritos al cargar
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    const isFavorite = favorites.some((item: any) => item.id === productId);
    
    if (isFavorite) {
      addToFavoritesBtn.classList.add('border-red-500', 'text-red-500');
      addToFavoritesBtn.classList.remove('border-gray-300', 'text-gray-700');
    }
  }
</script>

