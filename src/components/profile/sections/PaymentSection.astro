---
import PaymentModal from '../../profile/PaymentModal.astro';
import ConfirmModal from '../../ConfirmModal.astro';

const title = 'Métodos de Pago';
---

<section class="space-y-4">
  <!-- Header compacto y elegante -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 pb-3 border-b border-gray-200">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
        </svg>
        {title}
      </h1>
      <p class="text-xs text-gray-500 mt-1 uppercase tracking-wide">Gestiona tus métodos de pago</p>
    </div>
    <button
      type="button"
      id="add-payment-btn"
      class="flex items-center gap-2 px-4 py-2.5 bg-[#5d3fbb] text-white rounded-lg text-sm font-medium hover:bg-[#4d2fa8] transition-all duration-200"
    >
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Método de Pago
    </button>
  </div>

  <!-- Lista de métodos de pago -->
  <div id="payment-methods-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Se llenará con JavaScript -->
  </div>

  <!-- Mensaje cuando no hay métodos elegante -->
  <div id="no-payment-message" class="hidden text-center py-16">
    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-50 mb-4">
      <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
    </div>
    <p class="text-gray-900 font-semibold mb-1">No se encontraron métodos de pago</p>
    <p class="text-sm text-gray-500">Añade tu primer método de pago para comenzar</p>
  </div>
</section>

<PaymentModal id="payment-modal" />
<ConfirmModal id="delete-payment-modal" />

<script>
  (async function() {
    const modalId = 'payment-modal';
    const confirmModalId = 'delete-payment-modal';
    
    // Variables globales
    let paymentMethods: any[] = [];
    let editingMethodId: string | null = null;
    let currentUserId: string | null = null;

    // Elementos del DOM
    const container = document.getElementById('payment-methods-container');
    const noPaymentMessage = document.getElementById('no-payment-message');
    const addBtn = document.getElementById('add-payment-btn');

    // Obtener userId del usuario autenticado
    async function getCurrentUserId(): Promise<string | null> {
      try {
        // Primero intentar obtener desde localStorage
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            if (user?.id) {
              return user.id;
            }
          } catch (e) {
            console.error('Error parsing user from localStorage:', e);
          }
        }

        // Si no está en localStorage, esperar a que Firebase Auth esté listo
        const { onAuthStateChange, getCurrentUser } = await import('../../../lib/auth.js');
        
        // Verificar si ya hay un usuario autenticado
        const currentUser = getCurrentUser();
        if (currentUser?.uid) {
          return currentUser.uid;
        }
        
        // Si no hay usuario, esperar a que Firebase Auth se inicialice
        return new Promise<string | null>((resolve) => {
          let resolved = false;
          
          const unsubscribe = onAuthStateChange((firebaseUser) => {
            if (resolved) return;
            resolved = true;
            unsubscribe();
            
            if (firebaseUser?.uid) {
              resolve(firebaseUser.uid);
            } else {
              resolve(null);
            }
          });
          
          // Timeout de seguridad
          setTimeout(() => {
            if (!resolved) {
              resolved = true;
              unsubscribe();
              resolve(null);
            }
          }, 2000);
        });
      } catch (error) {
        console.error('Error obteniendo usuario:', error);
        return null;
      }
    }

    // Cargar métodos de pago desde Firebase
    async function loadPaymentMethods() {
      try {
        if (!currentUserId) {
          console.error('No hay usuario autenticado');
          paymentMethods = [];
          renderMethods();
          return;
        }

        const { getPaymentMethods } = await import('../../../lib/db/payment.js');
        const result = await getPaymentMethods(currentUserId);

        if (result.error) {
          console.error('Error cargando métodos de pago:', result.error);
          paymentMethods = [];
        } else {
          // Mapear los datos de Firebase al formato que usa el componente
          paymentMethods = result.data.map((method: any) => {
            const cardNumber = method.cardNumber || '';
            return {
              id: method.id,
              type: method.cardType || (method.type === 'card' ? 'credit' : method.type) || 'credit',
              cardNumber: cardNumber,
              cardHolder: method.cardholderName || method.cardHolder || '',
              expiryDate: method.expiryDate || '',
              brand: method.brand || detectBrand(cardNumber),
              bank: method.bank || '',
              isDefault: method.isDefault || false
            };
          });
        }

        renderMethods();
      } catch (error) {
        console.error('Error en loadPaymentMethods:', error);
        paymentMethods = [];
        renderMethods();
      }
    }

    // Detectar marca de tarjeta
    function detectBrand(cardNumber: string) {
      const num = cardNumber.replace(/\s/g, '');
      if (/^4/.test(num)) return 'Visa';
      if (/^5[1-5]/.test(num) || /^2[2-7]/.test(num)) return 'Mastercard';
      return 'Visa';
    }

    // Función helper para renderizar una tarjeta de método de pago
    // Esta función replica exactamente la estructura del componente PaymentCard.astro
    // para mantener la consistencia entre el componente Astro y el renderizado dinámico
    function renderPaymentCard(method: any): string {
      // Colores profesionales y elegantes según la marca
      const brandConfig = method.brand === 'Visa' 
        ? {
            gradient: 'from-slate-800 via-slate-900 to-slate-950',
            accent: 'from-blue-600 to-blue-700',
            chip: 'bg-gradient-to-br from-amber-400 to-amber-500',
            logoBg: 'bg-blue-600'
          }
        : {
            gradient: 'from-gray-900 via-gray-950 to-black',
            accent: 'from-red-600 to-orange-600',
            chip: 'bg-gradient-to-br from-red-400 to-orange-500',
            logoBg: 'bg-red-600'
          };

      // Función helper para escapar HTML y prevenir XSS
      const escapeHtml = (text: any) => {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      };

      // Esta estructura debe coincidir exactamente con PaymentCard.astro
      return `
        <div class="group relative bg-linear-to-br ${brandConfig.gradient} rounded-2xl overflow-hidden shadow-2xl border border-gray-800/50 hover:shadow-3xl transition-all duration-500 hover:scale-[1.02] hover:border-gray-700/70" data-method-id="${escapeHtml(method.id)}">
          <!-- Patrón de fondo sutil -->
          <div class="absolute inset-0 opacity-10">
            <div class="absolute inset-0" style="background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0); background-size: 40px 40px;"></div>
          </div>
          
          <!-- Efecto de brillo sutil -->
          <div class="absolute top-0 left-0 w-full h-1/2 bg-linear-to-b from-white/5 to-transparent"></div>
          
          <!-- Contenido principal -->
          <div class="relative z-10 p-5">
            <!-- Header con chip, logo y badge -->
            <div class="flex items-start justify-between mb-5">
              <!-- Chip de tarjeta -->
              <div class="relative">
                <div class="${brandConfig.chip} w-11 h-9 rounded-md shadow-lg flex items-center justify-center border border-white/20">
                  <div class="w-7 h-5 bg-linear-to-br from-white/30 to-transparent rounded-sm"></div>
                </div>
              </div>
              
              <!-- Logo de la marca y Badge Predeterminada (lado derecho) -->
              <div class="flex flex-col items-end gap-2">
                <!-- Badge Predeterminada (arriba del logo) -->
                ${method.isDefault ? `
                  <span class="inline-flex items-center gap-1 bg-linear-to-r from-amber-500 to-amber-600 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-md border border-amber-400/40 uppercase tracking-wider">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    Predeterminada
                  </span>
                ` : ''}
                
                <!-- Logo de la marca -->
                <div class="flex flex-col items-end gap-0.5">
                  <div class="${brandConfig.logoBg} px-3 py-1.5 rounded-lg shadow-md">
                    <p class="text-white font-bold text-sm tracking-wide">${escapeHtml(method.brand)}</p>
                  </div>
                  ${method.bank ? `<p class="text-gray-400 text-[10px] font-medium leading-tight">${escapeHtml(method.bank)}</p>` : ''}
                </div>
              </div>
            </div>
            
            <!-- Número de tarjeta -->
            <div class="mb-5">
              <p class="text-gray-400 text-[10px] font-medium mb-1.5 tracking-wider uppercase">Número de Tarjeta</p>
              <p class="text-white text-xl font-mono tracking-[0.15em] font-semibold">${escapeHtml(method.cardNumber)}</p>
            </div>
            
            <!-- Información inferior -->
            <div class="flex items-end justify-between mb-4">
              <div class="flex-1">
                <p class="text-gray-400 text-[10px] font-medium mb-1 tracking-wider uppercase">Titular</p>
                <p class="text-white text-sm font-semibold tracking-wide truncate">${escapeHtml(method.cardHolder)}</p>
              </div>
              <div class="text-right ml-3">
                <p class="text-gray-400 text-[10px] font-medium mb-1 tracking-wider uppercase">Válida Hasta</p>
                <p class="text-white text-sm font-semibold tracking-wide">${escapeHtml(method.expiryDate)}</p>
              </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="flex items-center gap-2 pt-3.5 border-t border-gray-700/50">
              ${!method.isDefault ? `
                <button type="button" class="set-default-btn flex-1 px-3 py-2 bg-linear-to-r ${brandConfig.accent} text-white rounded-lg hover:shadow-lg transition-all duration-300 hover:scale-105 active:scale-95 text-xs font-semibold border border-white/20" data-id="${escapeHtml(method.id)}">
                  Establecer Predeterminada
                </button>
              ` : ''}
              <button type="button" class="edit-btn px-3 py-2 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg transition-all duration-300 hover:scale-105 active:scale-95 border border-gray-700/50 shadow-md" data-id="${escapeHtml(method.id)}" title="Editar">
                <svg class="w-4.5 h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button type="button" class="delete-btn px-3 py-2 bg-red-900/80 hover:bg-red-800 text-white rounded-lg transition-all duration-300 hover:scale-105 active:scale-95 border border-red-800/50 shadow-md" data-id="${escapeHtml(method.id)}" title="Eliminar">
                <svg class="w-4.5 h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
          
          <!-- Borde decorativo inferior -->
          <div class="absolute bottom-0 left-0 right-0 h-1 bg-linear-to-r ${brandConfig.accent}"></div>
        </div>
      `;
    }

    // Renderizar métodos de pago
    function renderMethods() {
      if (!container || !noPaymentMessage) return;

      if (paymentMethods.length === 0) {
        container.classList.add('hidden');
        noPaymentMessage.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      noPaymentMessage.classList.add('hidden');

      container.innerHTML = paymentMethods.map((method: any) => renderPaymentCard(method)).join('');

      attachEventListeners();
    }

    // Asignar event listeners
    function attachEventListeners() {
      document.querySelectorAll('.set-default-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) setDefault(id);
          }
        });
      });

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) openEditModal(id);
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) showDeleteConfirm(id);
          }
        });
      });
    }

    // Establecer como predeterminada
    async function setDefault(id: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update
        paymentMethods = paymentMethods.map((m: any) => ({
          ...m,
          isDefault: m.id === id
        }));
        renderMethods();

        const { setDefaultPaymentMethod } = await import('../../../lib/db/payment.js');
        const result = await setDefaultPaymentMethod(currentUserId, id);

        if (!result.success) {
          // Revertir optimistic update
          await loadPaymentMethods();
          alert('Error al establecer método predeterminado: ' + (result.error?.message || 'Error desconocido'));
        }
      } catch (error: any) {
        console.error('Error estableciendo método predeterminado:', error);
        await loadPaymentMethods();
        alert('Error al establecer método predeterminado: ' + (error.message || 'Error desconocido'));
      }
    }

    // Mostrar confirmación de eliminación
    function showDeleteConfirm(id: string) {
      const method = paymentMethods.find((m: any) => m.id === id);
      if (!method) return;

      (window as any).showConfirmModal(confirmModalId, {
        icon: `
          <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        `,
        iconBg: 'bg-red-100',
        iconColor: 'text-red-600',
        title: 'Eliminar Método de Pago',
        message: `¿Estás seguro de eliminar el método de pago terminado en ${method.cardNumber.slice(-4)}? Esta acción no se puede deshacer.`,
        confirmText: 'Eliminar',
        confirmClass: 'bg-gradient-to-r from-red-500 to-red-600',
        onConfirm: () => {
          deleteMethod(id);
        }
      });
    }

    // Eliminar método
    async function deleteMethod(id: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update: eliminar de la UI inmediatamente
        const methodToDelete = paymentMethods.find((m: any) => m.id === id);
        paymentMethods = paymentMethods.filter((m: any) => m.id !== id);
        renderMethods();

        const { deletePaymentMethod } = await import('../../../lib/db/payment.js');
        const result = await deletePaymentMethod(currentUserId, id);

        if (!result.success) {
          // Revertir optimistic update
          await loadPaymentMethods();
          alert('Error al eliminar método de pago: ' + (result.error?.message || 'Error desconocido'));
        }
      } catch (error: any) {
        console.error('Error eliminando método de pago:', error);
        // Revertir optimistic update
        await loadPaymentMethods();
        alert('Error al eliminar método de pago: ' + (error.message || 'Error desconocido'));
      }
    }

    // Abrir modal para añadir
    function openAddModal() {
      editingMethodId = null;
      
      // Guardar referencia a la función del modal ANTES de cualquier asignación
      const modalOpenFn = (window as any)['openPaymentModal_payment-modal'];
      
      if (modalOpenFn && typeof modalOpenFn === 'function') {
        // Llamar directamente a la función del modal, NO a window.openPaymentModal
        modalOpenFn(null, function(methodData: any) {
          saveMethod(methodData);
        });
      } else {
        // Fallback: intentar acceder directamente al modal
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        } else {
          console.error('No se pudo encontrar la función del modal ni el elemento modal');
        }
      }
    }

    // Abrir modal para editar
    function openEditModal(methodId: string) {
      const method = paymentMethods.find((m: any) => m.id === methodId);
      if (!method) return;

      editingMethodId = methodId;
      
      // Guardar referencia a la función del modal ANTES de cualquier asignación
      const modalOpenFn = (window as any)['openPaymentModal_payment-modal'];
      
      if (modalOpenFn && typeof modalOpenFn === 'function') {
        // Llamar directamente a la función del modal, NO a window.openPaymentModal
        modalOpenFn(method, function(methodData: any) {
          saveMethod(methodData);
        });
      } else {
        console.error('No se pudo encontrar la función del modal');
      }
    }

    // Guardar método
    async function saveMethod(methodData: any) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        const brand = detectBrand(methodData.cardNumber);
        const isDefault = methodData.isDefault || paymentMethods.length === 0;

        // Preparar datos para Firebase
        const paymentData: any = {
          type: 'card', // El tipo en Firebase es 'card' o 'cash'
          cardNumber: methodData.cardNumber,
          cardholderName: methodData.cardHolder,
          expiryDate: methodData.expiryDate,
          isDefault: isDefault,
          // Campos adicionales que no están en el tipo pero los usamos en el componente
          cardType: methodData.type, // 'credit' o 'debit'
          brand: brand,
          bank: methodData.bank
        };

        // Optimistic update
        const finalMethodData: any = {
          id: editingMethodId || 'temp-' + Date.now(),
          ...methodData,
          brand: brand,
          isDefault: isDefault
        };

        if (editingMethodId) {
          const index = paymentMethods.findIndex((m: any) => m.id === editingMethodId);
          if (index !== -1) {
            paymentMethods[index] = finalMethodData;
          }
        } else {
          paymentMethods.push(finalMethodData);
        }

        // Si es predeterminada, desmarcar las demás
        if (finalMethodData.isDefault) {
          paymentMethods = paymentMethods.map((m: any) => ({
            ...m,
            isDefault: m.id === finalMethodData.id
          }));
        }

        renderMethods();

        // Guardar en Firebase
        const { addPaymentMethod, updatePaymentMethod } = await import('../../../lib/db/payment.js');

        if (editingMethodId) {
          const result = await updatePaymentMethod(currentUserId, editingMethodId, paymentData);
          if (!result.success) {
            // Revertir optimistic update
            await loadPaymentMethods();
            alert('Error al actualizar método de pago: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        } else {
          const result = await addPaymentMethod(currentUserId, paymentData);
          if (!result.success) {
            // Revertir optimistic update
            await loadPaymentMethods();
            alert('Error al guardar método de pago: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        }

        // Recargar desde Firebase para sincronizar
        await loadPaymentMethods();
      } catch (error: any) {
        console.error('Error guardando método de pago:', error);
        // Revertir optimistic update
        await loadPaymentMethods();
        alert('Error al guardar método de pago: ' + (error.message || 'Error desconocido'));
      }
    }

    // Event listeners
    if (addBtn) {
      addBtn.addEventListener('click', openAddModal);
    }

    // Función global para el botón del mensaje vacío (usar un nombre completamente diferente)
    // @ts-ignore
    window.openPaymentModalFromSection = function() {
      openAddModal();
    };
    
    // Inicializar: obtener userId y cargar métodos de pago
    async function init() {
      currentUserId = await getCurrentUserId();
      
      if (!currentUserId) {
        console.warn('No se pudo obtener el usuario autenticado');
        paymentMethods = [];
        renderMethods();
        return;
      }

      await loadPaymentMethods();
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
