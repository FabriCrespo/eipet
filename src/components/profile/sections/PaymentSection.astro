---
const title = 'M√©todos de Pago';
---

<section class="space-y-6">
  <!-- T√≠tulo y bot√≥n a√±adir -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-3xl font-bold text-gray-900">{title}</h1>
    <button
      type="button"
      id="add-payment-btn"
      class="flex items-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 transition-all duration-200 hover:shadow-md active:scale-95"
    >
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      A√±adir M√©todo de Pago
    </button>
  </div>

  <!-- Loading State -->
  <div id="payment-loading" class="text-center py-16">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
    <p class="mt-4 text-gray-600">Cargando m√©todos de pago...</p>
  </div>

  <!-- Lista de m√©todos de pago -->
  <div id="payment-methods-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
    <!-- Se llenar√° con JavaScript -->
  </div>

  <!-- Mensaje cuando no hay m√©todos -->
  <div id="no-payment-message" class="hidden text-center py-12">
    <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </svg>
    <p class="text-gray-600 text-lg font-medium mb-2">No tienes m√©todos de pago registrados</p>
    <p class="text-gray-500 text-sm mb-4">A√±ade tu primer m√©todo de pago para comenzar</p>
    <button
      type="button"
      class="inline-flex items-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 transition-all duration-200 hover:shadow-md"
      onclick="openPaymentModal()"
    >
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      A√±adir Primer M√©todo
    </button>
  </div>

  <!-- Modal para a√±adir/editar m√©todo de pago -->
  <div id="payment-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 lg:p-8">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900" id="modal-title">A√±adir M√©todo de Pago</h2>
        <button
          type="button"
          id="close-modal-btn"
          class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          aria-label="Cerrar"
        >
          <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Formulario -->
      <form id="payment-form" class="space-y-4">
        <!-- Tipo de tarjeta -->
        <div class="flex gap-4">
          <button
            type="button"
            class="card-type-btn flex-1 p-4 rounded-xl border-2 border-orange-600 bg-orange-50 transition-all"
            data-type="credit"
          >
            <svg class="mx-auto mb-2 w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            <p class="font-medium text-gray-900">Cr√©dito</p>
          </button>
          <button
            type="button"
            class="card-type-btn flex-1 p-4 rounded-xl border-2 border-gray-300 hover:border-gray-400 transition-all"
            data-type="debit"
          >
            <svg class="mx-auto mb-2 w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            <p class="font-medium text-gray-700">D√©bito</p>
          </button>
        </div>

        <!-- N√∫mero de tarjeta -->
        <div>
          <label for="card-number" class="block text-sm font-medium text-gray-700 mb-2">
            N√∫mero de tarjeta <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="card-number"
            name="cardNumber"
            maxlength="19"
            placeholder="1234 5678 9012 3456"
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-100 transition-all duration-300"
          />
        </div>

        <!-- Titular -->
        <div>
          <label for="card-holder" class="block text-sm font-medium text-gray-700 mb-2">
            Titular de la tarjeta <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="card-holder"
            name="cardHolder"
            placeholder="MAR√çA GARC√çA"
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-100 transition-all duration-300"
          />
        </div>

        <!-- Fecha y CVV -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="expiry-month" class="block text-sm font-medium text-gray-700 mb-2">
              Fecha de vencimiento <span class="text-red-500">*</span>
            </label>
            <div class="flex gap-2">
              <input
                type="text"
                id="expiry-month"
                name="expiryMonth"
                maxlength="2"
                placeholder="MM"
                required
                class="w-20 px-3 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-100 transition-all duration-300 text-center"
              />
              <span class="self-center text-gray-400">/</span>
              <input
                type="text"
                id="expiry-year"
                name="expiryYear"
                maxlength="2"
                placeholder="YY"
                required
                class="w-20 px-3 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-100 transition-all duration-300 text-center"
              />
            </div>
          </div>
          <div>
            <label for="cvv" class="block text-sm font-medium text-gray-700 mb-2">
              CVV <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="cvv"
              name="cvv"
              maxlength="4"
              placeholder="123"
              required
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-100 transition-all duration-300"
            />
          </div>
        </div>

        <!-- Banco -->
        <div>
          <label for="bank" class="block text-sm font-medium text-gray-700 mb-2">
            Banco emisor <span class="text-red-500">*</span>
          </label>
          <select
            id="bank"
            name="bank"
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 focus:border-orange-400 focus:outline-none focus:ring-4 focus:ring-orange-100 transition-all duration-300"
          >
            <option value="">Selecciona tu banco</option>
            <option value="Banco Nacional de Bolivia">Banco Nacional de Bolivia</option>
            <option value="Banco Mercantil Santa Cruz">Banco Mercantil Santa Cruz</option>
            <option value="Banco Uni√≥n">Banco Uni√≥n</option>
            <option value="Banco Bisa">Banco Bisa</option>
            <option value="Banco de Cr√©dito">Banco de Cr√©dito</option>
          </select>
        </div>

        <!-- Checkbox predeterminada -->
        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            id="is-default"
            name="isDefault"
            class="w-5 h-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500 focus:ring-2"
          />
          <label for="is-default" class="text-sm font-medium text-gray-700">
            Establecer como m√©todo de pago predeterminado
          </label>
        </div>

        <!-- Botones -->
        <div class="flex gap-3 pt-4">
          <button
            type="button"
            id="cancel-btn"
            class="flex-1 px-4 py-3 bg-white text-gray-700 border-2 border-gray-200 rounded-xl font-medium hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700 transition-all duration-200 hover:shadow-md active:scale-95"
          >
            Guardar M√©todo
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  // Dynamic imports
  let getPaymentMethods: any, addPaymentMethod: any, updatePaymentMethod: any, deletePaymentMethod: any, setDefaultPaymentMethod: any, getCurrentUser: any;
  let currentUser: any = null;
  
  (async () => {
    const paymentModule = await import('../../../lib/db/payment');
    getPaymentMethods = paymentModule.getPaymentMethods;
    addPaymentMethod = paymentModule.addPaymentMethod;
    updatePaymentMethod = paymentModule.updatePaymentMethod;
    deletePaymentMethod = paymentModule.deletePaymentMethod;
    setDefaultPaymentMethod = paymentModule.setDefaultPaymentMethod;
    
    const authModule = await import('../../../lib/auth');
    getCurrentUser = authModule.getCurrentUser;
    
    // Get current user
    const firebaseUser = getCurrentUser();
    if (firebaseUser) {
      const userData = localStorage.getItem('user');
      if (userData) {
        try {
          currentUser = JSON.parse(userData);
        } catch (e) {
          console.error('Error parsing user:', e);
        }
      }
    }
    
    if (!currentUser) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }
    
    // Load payment methods
    await loadPaymentMethods();
  })();

  (function() {
    let paymentMethods: any[] = [];
    let editingMethodId: string | null = null;
    let currentCardType = 'credit';

    // Elementos del DOM
    const container = document.getElementById('payment-methods-container');
    const noPaymentMessage = document.getElementById('no-payment-message');
    const addBtn = document.getElementById('add-payment-btn');
    const modal = document.getElementById('payment-modal');
    const closeBtn = document.getElementById('close-modal-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const form = document.getElementById('payment-form') as HTMLFormElement;
    const modalTitle = document.getElementById('modal-title');

    // Detectar marca de tarjeta
    function detectBrand(cardNumber: string) {
      const num = cardNumber.replace(/\s/g, '');
      if (/^4/.test(num)) return 'Visa';
      if (/^5[1-5]/.test(num) || /^2[2-7]/.test(num)) return 'Mastercard';
      return 'Visa';
    }

    // Formatear n√∫mero de tarjeta
    function formatCardNumber(value: string) {
      const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      const matches = v.match(/\d{4,16}/g);
      const match = (matches && matches[0]) || '';
      const parts = [];
      for (let i = 0, len = match.length; i < len; i += 4) {
        parts.push(match.substring(i, i + 4));
      }
      return parts.length ? parts.join(' ') : value;
    }

    // Renderizar m√©todos de pago
    function renderMethods() {
      if (!container || !noPaymentMessage) return;

      if (paymentMethods.length === 0) {
        container.classList.add('hidden');
        noPaymentMessage.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      noPaymentMessage.classList.add('hidden');

      container.innerHTML = paymentMethods.map((method: any) => {
        const brandColor = method.brand === 'Visa' 
          ? 'from-blue-500 to-blue-600' 
          : 'from-red-500 to-orange-600';

        return '<div class="bg-gradient-to-br ' + brandColor + ' rounded-2xl p-6 text-white shadow-xl relative" data-method-id="' + method.id + '">' +
          (method.isDefault ? '<span class="absolute top-4 right-4 bg-white/20 backdrop-blur-sm text-white text-xs px-3 py-1 rounded-full font-medium">Predeterminada</span>' : '') +
          '<div class="mb-6">' +
          '<div class="flex items-start justify-between mb-4">' +
          '<div class="text-3xl">üí≥</div>' +
          '<div class="text-right">' +
          '<p class="text-white/80 text-sm">' + (method.bank || '') + '</p>' +
          '<p class="text-white font-bold">' + method.brand + '</p>' +
          '</div>' +
          '</div>' +
          '<div class="space-y-3">' +
          '<div>' +
          '<p class="text-white/70 text-sm">N√∫mero de tarjeta</p>' +
          '<p class="text-xl font-mono tracking-wider">' + method.cardNumber + '</p>' +
          '</div>' +
          '<div class="flex justify-between">' +
          '<div>' +
          '<p class="text-white/70 text-sm">Titular</p>' +
          '<p class="font-medium">' + method.cardHolder + '</p>' +
          '</div>' +
          '<div class="text-right">' +
          '<p class="text-white/70 text-sm">V√°lida hasta</p>' +
          '<p class="font-medium">' + method.expiryDate + '</p>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
          (!method.isDefault ? '<button type="button" class="set-default-btn flex-1 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-lg hover:bg-white/30 transition-colors text-sm" data-id="' + method.id + '">Predeterminar</button>' : '') +
          '<button type="button" class="delete-btn px-4 py-2 bg-white/20 backdrop-blur-sm rounded-lg hover:bg-red-500 transition-colors" data-id="' + method.id + '">' +
          '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
          '</button>' +
          '</div>' +
          '</div>';
      }).join('');

      attachEventListeners();
    }

    // Asignar event listeners
    function attachEventListeners() {
      document.querySelectorAll('.set-default-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) await setDefault(id);
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id && confirm('¬øEst√°s seguro de eliminar este m√©todo de pago?')) {
              await deleteMethod(id);
            }
          }
        });
      });
    }

    // Load payment methods from Firestore
    async function loadPaymentMethods() {
      const loadingEl = document.getElementById('payment-loading');
      const containerEl = document.getElementById('payment-methods-container');
      
      if (!currentUser || !getPaymentMethods) return;
      
      try {
        const result = await getPaymentMethods(currentUser.id);
        
        if (result.error) {
          console.error('Error loading payment methods:', result.error);
          if (loadingEl) loadingEl.classList.add('hidden');
          return;
        }
        
        paymentMethods = result.data || [];
        
        // Convert Firestore data to display format
        paymentMethods = paymentMethods.map((method: any) => ({
          id: method.id,
          type: method.type || 'credit',
          cardNumber: method.cardNumber || '',
          cardHolder: method.cardHolder || '',
          expiryDate: method.expiryDate || '',
          expiryMonth: method.expiryMonth || '',
          expiryYear: method.expiryYear || '',
          brand: method.brand || 'Visa',
          bank: method.bank || '',
          isDefault: method.isDefault || false
        }));
        
        renderMethods();
        
        if (loadingEl) loadingEl.classList.add('hidden');
        if (containerEl) containerEl.classList.remove('hidden');
      } catch (error) {
        console.error('Error loading payment methods:', error);
        if (loadingEl) loadingEl.classList.add('hidden');
      }
    }

    // Establecer como predeterminada
    async function setDefault(id: string) {
      if (!currentUser || !setDefaultPaymentMethod) return;
      
      try {
        const result = await setDefaultPaymentMethod(currentUser.id, id);
        if (!result.success) {
          throw new Error(result.error?.message || 'Error al establecer m√©todo predeterminado');
        }
        
        // Reload payment methods
        await loadPaymentMethods();
      } catch (error) {
        console.error('Error setting default payment method:', error);
        alert('Error al establecer el m√©todo predeterminado. Por favor, intenta de nuevo.');
      }
    }

    // Eliminar m√©todo
    async function deleteMethod(id: string) {
      if (!currentUser || !deletePaymentMethod) return;
      
      try {
        const result = await deletePaymentMethod(currentUser.id, id);
        if (!result.success) {
          throw new Error(result.error?.message || 'Error al eliminar m√©todo de pago');
        }
        
        // Reload payment methods
        await loadPaymentMethods();
      } catch (error) {
        console.error('Error deleting payment method:', error);
        alert('Error al eliminar el m√©todo de pago. Por favor, intenta de nuevo.');
      }
    }

    // Abrir modal
    function openModal(methodId?: string) {
      if (!modal || !modalTitle || !form) return;

      editingMethodId = methodId || null;
      currentCardType = 'credit';

      if (editingMethodId) {
        const method = paymentMethods.find((m: any) => m.id === editingMethodId);
        if (method) {
          (document.getElementById('card-number') as HTMLInputElement).value = method.cardNumber;
          (document.getElementById('card-holder') as HTMLInputElement).value = method.cardHolder;
          const [month, year] = method.expiryDate.split('/');
          (document.getElementById('expiry-month') as HTMLInputElement).value = month;
          (document.getElementById('expiry-year') as HTMLInputElement).value = year;
          (document.getElementById('cvv') as HTMLInputElement).value = '';
          (document.getElementById('bank') as HTMLSelectElement).value = method.bank;
          (document.getElementById('is-default') as HTMLInputElement).checked = method.isDefault;
          currentCardType = method.type;
          modalTitle.textContent = 'Editar M√©todo de Pago';
        }
      } else {
        form.reset();
        modalTitle.textContent = 'A√±adir M√©todo de Pago';
      }

      updateCardTypeButtons();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Cerrar modal
    function closeModal() {
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      editingMethodId = null;
      if (form) form.reset();
    }

    // Actualizar botones de tipo de tarjeta
    function updateCardTypeButtons() {
      document.querySelectorAll('.card-type-btn').forEach(btn => {
        const target = btn as HTMLButtonElement;
        const type = target.getAttribute('data-type');
        if (type === currentCardType) {
          target.classList.add('border-orange-600', 'bg-orange-50');
          target.classList.remove('border-gray-300');
        } else {
          target.classList.add('border-gray-300');
          target.classList.remove('border-orange-600', 'bg-orange-50');
        }
      });
    }

    // Validar n√∫mero de tarjeta usando algoritmo de Luhn
    function validateCardNumber(cardNumber: string): boolean {
      const num = cardNumber.replace(/\s/g, '');
      if (num.length < 13 || num.length > 19) {
        return false;
      }
      
      let sum = 0;
      let isEven = false;
      
      // Recorrer desde el final
      for (let i = num.length - 1; i >= 0; i--) {
        let digit = parseInt(num[i]);
        
        if (isEven) {
          digit *= 2;
          if (digit > 9) {
            digit -= 9;
          }
        }
        
        sum += digit;
        isEven = !isEven;
      }
      
      return sum % 10 === 0;
    }
    
    // Validar fecha de vencimiento (MM/YY)
    function validateExpiryDate(month: string, year: string): boolean {
      const monthNum = parseInt(month);
      const yearNum = parseInt(year);
      
      if (isNaN(monthNum) || isNaN(yearNum)) {
        return false;
      }
      
      if (monthNum < 1 || monthNum > 12) {
        return false;
      }
      
      // Convertir YY a a√±o completo (asumiendo 2000-2099)
      const fullYear = 2000 + yearNum;
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth() + 1;
      
      // Verificar que no est√© vencida
      if (fullYear < currentYear) {
        return false;
      }
      if (fullYear === currentYear && monthNum < currentMonth) {
        return false;
      }
      
      return true;
    }
    
    // Validar CVV
    function validateCVV(cvv: string): boolean {
      const cvvNum = cvv.replace(/\s/g, '');
      return /^\d{3,4}$/.test(cvvNum);
    }
    
    // Validar nombre del titular
    function validateCardHolder(name: string): boolean {
      return name.trim().length >= 2;
    }
    
    // Guardar m√©todo
    async function saveMethod(formData: FormData) {
      if (!currentUser) return;
      
      const cardNumber = (document.getElementById('card-number') as HTMLInputElement).value;
      const cardHolder = (document.getElementById('card-holder') as HTMLInputElement).value;
      const expiryMonth = (document.getElementById('expiry-month') as HTMLInputElement).value;
      const expiryYear = (document.getElementById('expiry-year') as HTMLInputElement).value;
      const cvv = (document.getElementById('cvv') as HTMLInputElement).value;
      
      // Validaciones
      const cardNumberClean = cardNumber.replace(/\s/g, '');
      if (!validateCardNumber(cardNumberClean)) {
        alert('El n√∫mero de tarjeta no es v√°lido. Por favor, verifica los d√≠gitos.');
        return;
      }
      
      if (!validateExpiryDate(expiryMonth, expiryYear)) {
        alert('La fecha de vencimiento no es v√°lida o la tarjeta est√° vencida.');
        return;
      }
      
      if (!validateCVV(cvv)) {
        alert('El CVV debe tener entre 3 y 4 d√≠gitos.');
        return;
      }
      
      if (!validateCardHolder(cardHolder)) {
        alert('El nombre del titular debe tener al menos 2 caracteres.');
        return;
      }
      
      const brand = detectBrand(cardNumber);

      const methodData: any = {
        type: currentCardType,
        cardNumber: cardNumberClean,
        cardHolder: cardHolder.toUpperCase(),
        expiryMonth: parseInt(expiryMonth),
        expiryYear: parseInt(expiryYear),
        expiryDate: expiryMonth + '/' + expiryYear,
        brand: brand,
        bank: (document.getElementById('bank') as HTMLSelectElement).value,
        isDefault: (document.getElementById('is-default') as HTMLInputElement).checked || paymentMethods.length === 0
      };

      try {
        if (editingMethodId) {
          // Editar m√©todo existente
          const result = await updatePaymentMethod(currentUser.id, editingMethodId, methodData);
          if (!result.success) {
            throw new Error(result.error?.message || 'Error al actualizar m√©todo de pago');
          }
        } else {
          // A√±adir nuevo m√©todo
          const result = await addPaymentMethod(currentUser.id, methodData);
          if (!result.success) {
            throw new Error(result.error?.message || 'Error al agregar m√©todo de pago');
          }
        }
        
        // Reload payment methods
        await loadPaymentMethods();
        closeModal();
      } catch (error) {
        console.error('Error saving payment method:', error);
        alert('Error al guardar el m√©todo de pago. Por favor, intenta de nuevo.');
      }
    }

    // Event listeners
    if (addBtn) {
      addBtn.addEventListener('click', () => openModal());
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', closeModal);
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', closeModal);
    }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        await saveMethod(formData);
      });
    }

    // Tipo de tarjeta
    document.querySelectorAll('.card-type-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget;
        if (target && target instanceof HTMLButtonElement) {
          currentCardType = target.getAttribute('data-type') || 'credit';
          updateCardTypeButtons();
        }
      });
    });

    // Formatear n√∫mero de tarjeta
    const cardNumberInput = document.getElementById('card-number');
    if (cardNumberInput) {
      cardNumberInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          target.value = formatCardNumber(target.value);
        }
      });
    }
    
    // Formatear y validar fecha de vencimiento
    const expiryMonthInput = document.getElementById('expiry-month');
    const expiryYearInput = document.getElementById('expiry-year');
    
    if (expiryMonthInput) {
      expiryMonthInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          let value = target.value.replace(/\D/g, '');
          if (value.length > 2) {
            value = value.slice(0, 2);
          }
          // Validar que el mes est√© entre 01 y 12
          if (value.length === 2) {
            const month = parseInt(value);
            if (month < 1 || month > 12) {
              target.setCustomValidity('El mes debe estar entre 01 y 12');
            } else {
              target.setCustomValidity('');
            }
          } else {
            target.setCustomValidity('');
          }
          target.value = value;
          // Auto-avanzar al a√±o si el mes est√° completo
          if (value.length === 2 && expiryYearInput) {
            expiryYearInput.focus();
          }
        }
      });
    }
    
    if (expiryYearInput) {
      expiryYearInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          let value = target.value.replace(/\D/g, '');
          if (value.length > 2) {
            value = value.slice(0, 2);
          }
          target.value = value;
        }
      });
    }
    
    // Validar CVV (solo n√∫meros, 3-4 d√≠gitos)
    const cvvInput = document.getElementById('cvv');
    if (cvvInput) {
      cvvInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          let value = target.value.replace(/\D/g, '');
          if (value.length > 4) {
            value = value.slice(0, 4);
          }
          target.value = value;
          // Validar longitud
          if (value.length > 0 && value.length < 3) {
            target.setCustomValidity('El CVV debe tener entre 3 y 4 d√≠gitos');
          } else {
            target.setCustomValidity('');
          }
        }
      });
    }
    
    // Validar nombre del titular (solo letras y espacios)
    const cardHolderInput = document.getElementById('card-holder');
    if (cardHolderInput) {
      cardHolderInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          // Permitir solo letras, espacios y algunos caracteres especiales comunes
          let value = target.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g, '');
          target.value = value;
        }
      });
    }

    // Cerrar modal al hacer clic fuera
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }

    // Cerrar con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (modal && !modal.classList.contains('hidden')) {
          closeModal();
        }
      }
    });

    // Funci√≥n global
    // @ts-ignore
    window.openPaymentModal = openModal;

    // Note: loadPaymentMethods() is called in the async IIFE above
    // renderMethods() will be called from loadPaymentMethods()
  })();
</script>
