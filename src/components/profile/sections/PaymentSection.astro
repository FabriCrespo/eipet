---
import PaymentModal from '../../profile/PaymentModal.astro';
import ConfirmModal from '../../ConfirmModal.astro';

const title = 'Métodos de Pago';
---

<style>
  .payment-card {
    position: relative;
    background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
    border: 2px solid rgba(251, 191, 36, 0.2);
    border-radius: 24px;
    padding: 0;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.06), 0 1px 3px 0 rgba(0, 0, 0, 0.04);
  }

  .payment-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 24px 32px -8px rgba(251, 191, 36, 0.15), 0 8px 16px -4px rgba(0, 0, 0, 0.08);
    border-color: rgba(251, 191, 36, 0.4);
  }

  .payment-card.is-default {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border-color: rgba(251, 191, 36, 0.5);
  }

  .payment-card.is-default::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #ea580c 100%);
    z-index: 1;
  }

  .payment-card-header {
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(250, 250, 250, 0.9) 100%);
    border-bottom: 1px solid rgba(229, 231, 235, 0.8);
    position: relative;
    z-index: 2;
  }

  .payment-card-body {
    padding: 1.25rem;
    background: white;
    position: relative;
    z-index: 2;
  }

  .payment-card-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid rgba(229, 231, 235, 0.6);
    background: rgba(249, 250, 251, 0.8);
    position: relative;
    z-index: 2;
  }

  .brand-icon-wrapper {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px -2px rgba(251, 191, 36, 0.3);
  }

  .default-badge-payment {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid rgba(251, 191, 36, 0.4);
    border-radius: 50%;
    box-shadow: 0 2px 4px -1px rgba(251, 191, 36, 0.3);
  }

  .payment-gradient-bg {
    position: absolute;
    top: 0;
    right: 0;
    width: 250px;
    height: 250px;
    background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, transparent 70%);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 0;
  }

  .payment-card:hover .payment-gradient-bg {
    opacity: 1;
  }

  .payment-action-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border: 2px solid rgba(229, 231, 235, 0.8);
    background: white;
    cursor: pointer;
  }

  .payment-action-btn:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.12);
  }

  .payment-action-btn.edit:hover {
    background: #fef3c7;
    border-color: #fbbf24;
  }

  .payment-action-btn.delete:hover {
    background: #fee2e2;
    border-color: #ef4444;
  }

  .set-default-payment-btn {
    flex: 1;
    padding: 0.625rem 1rem;
    background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%);
    border: 2px solid rgba(251, 191, 36, 0.4);
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #92400e;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .set-default-payment-btn:hover {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px -2px rgba(251, 191, 36, 0.4);
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .payment-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
    z-index: 3;
  }

  .payment-card:hover::after {
    left: 100%;
  }
</style>

<section class="space-y-4">
  <!-- Header compacto y elegante -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 pb-3 border-b border-gray-200">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
        </svg>
        {title}
      </h1>
      <p class="text-xs text-gray-500 mt-1 uppercase tracking-wide">Gestiona tus métodos de pago</p>
    </div>
    <button
      type="button"
      id="add-payment-btn"
      class="group flex items-center gap-2 px-5 py-3 bg-linear-to-r from-yellow-500 to-orange-600 text-white rounded-xl text-sm font-semibold hover:from-yellow-600 hover:to-orange-700 transition-all duration-300 shadow-md hover:shadow-xl transform hover:-translate-y-0.5"
    >
      <svg class="h-5 w-5 transition-transform duration-300 group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Método de Pago
    </button>
  </div>

  <!-- Lista de métodos de pago -->
  <div id="payment-methods-container" class="grid grid-cols-1 md:grid-cols-2 gap-5 sm:gap-6">
    <!-- Se llenará con JavaScript -->
  </div>

  <!-- Mensaje cuando no hay métodos elegante -->
  <div id="no-payment-message" class="hidden">
    <div class="text-center py-20 px-4">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-linear-to-br from-yellow-50 to-orange-50 mb-6 shadow-lg">
        <svg class="h-10 w-10 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
    </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">No tienes métodos de pago guardados</h3>
      <p class="text-sm text-gray-600 mb-6 max-w-md mx-auto">Añade tu primer método de pago para realizar compras de forma rápida y segura.</p>
      <button
        type="button"
        onclick="window.openPaymentModalFromSection && window.openPaymentModalFromSection()"
        class="inline-flex items-center gap-2 px-6 py-3 bg-linear-to-r from-yellow-500 to-orange-600 text-white rounded-xl text-sm font-semibold hover:from-yellow-600 hover:to-orange-700 transition-all duration-300 shadow-md hover:shadow-xl transform hover:-translate-y-0.5"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Añadir Primer Método de Pago
      </button>
    </div>
  </div>
</section>

<PaymentModal id="payment-modal" />
<ConfirmModal id="delete-payment-modal" />

<script>
  (async function() {
    const modalId = 'payment-modal';
    const confirmModalId = 'delete-payment-modal';
    
    // Variables globales
    let paymentMethods: any[] = [];
    let editingMethodId: string | null = null;
    let currentUserId: string | null = null;

    // Elementos del DOM
    const container = document.getElementById('payment-methods-container');
    const noPaymentMessage = document.getElementById('no-payment-message');
    const addBtn = document.getElementById('add-payment-btn');

    // Obtener userId del usuario autenticado
    async function getCurrentUserId(): Promise<string | null> {
      try {
        // Primero intentar obtener desde localStorage
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            if (user?.id) {
              return user.id;
            }
          } catch (e) {
            console.error('Error parsing user from localStorage:', e);
          }
        }

        // Si no está en localStorage, esperar a que Firebase Auth esté listo
        const { onAuthStateChange, getCurrentUser } = await import('../../../lib/auth.js');
        
        // Verificar si ya hay un usuario autenticado
        const currentUser = getCurrentUser();
        if (currentUser?.uid) {
          return currentUser.uid;
        }
        
        // Si no hay usuario, esperar a que Firebase Auth se inicialice
        return new Promise<string | null>((resolve) => {
          let resolved = false;
          
          const unsubscribe = onAuthStateChange((firebaseUser) => {
            if (resolved) return;
            resolved = true;
            unsubscribe();
            
            if (firebaseUser?.uid) {
              resolve(firebaseUser.uid);
            } else {
              resolve(null);
            }
          });
          
          // Timeout de seguridad
          setTimeout(() => {
            if (!resolved) {
              resolved = true;
              unsubscribe();
              resolve(null);
            }
          }, 2000);
        });
      } catch (error) {
        console.error('Error obteniendo usuario:', error);
        return null;
      }
    }

    // Cargar métodos de pago desde Firebase
    async function loadPaymentMethods() {
      try {
        if (!currentUserId) {
          console.error('No hay usuario autenticado');
          paymentMethods = [];
          renderMethods();
          return;
        }

        const { getPaymentMethods } = await import('../../../lib/db/payment.js');
        const result = await getPaymentMethods(currentUserId);

        if (result.error) {
          console.error('Error cargando métodos de pago:', result.error);
          paymentMethods = [];
        } else {
          // Mapear los datos de Firebase al formato que usa el componente
          paymentMethods = result.data.map((method: any) => {
            const cardNumber = method.cardNumber || '';
            return {
              id: method.id,
              type: method.cardType || (method.type === 'card' ? 'credit' : method.type) || 'credit',
              cardNumber: cardNumber,
              cardHolder: method.cardholderName || method.cardHolder || '',
              expiryDate: method.expiryDate || '',
              brand: method.brand || detectBrand(cardNumber),
              bank: method.bank || '',
              isDefault: method.isDefault || false
            };
          });
        }

        renderMethods();
      } catch (error) {
        console.error('Error en loadPaymentMethods:', error);
        paymentMethods = [];
        renderMethods();
      }
    }

    // Detectar marca de tarjeta
    function detectBrand(cardNumber: string) {
      const num = cardNumber.replace(/\s/g, '');
      if (/^4/.test(num)) return 'Visa';
      if (/^5[1-5]/.test(num) || /^2[2-7]/.test(num)) return 'Mastercard';
      return 'Visa';
    }

    // Función helper para renderizar una tarjeta de método de pago
    function renderPaymentCard(method: any): string {
      // Función helper para escapar HTML y prevenir XSS
      const escapeHtml = (text: any) => {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      };

      const isDefault = method.isDefault || false;
      const cardClass = isDefault ? 'payment-card is-default' : 'payment-card';
      const cardBg = isDefault 
        ? 'background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)' 
        : 'background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%)';
      const cardBorder = isDefault 
        ? 'border-color: rgba(251, 191, 36, 0.5)' 
        : 'border-color: rgba(251, 191, 36, 0.2)';

      // Colores para el logo según la marca
      const brandColors = method.brand === 'Visa' 
        ? { bg: '#1434CB', text: '#ffffff' }
        : { bg: '#EB001B', text: '#ffffff' };

      return '<div class="' + cardClass + '" data-method-id="' + escapeHtml(method.id) + '" style="position: relative; ' + cardBg + '; border: 2px solid; ' + cardBorder + '; border-radius: 24px; padding: 0; overflow: hidden; box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.06), 0 1px 3px 0 rgba(0, 0, 0, 0.04);">' +
        '<div class="payment-gradient-bg" style="position: absolute; top: 0; right: 0; width: 250px; height: 250px; background: radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, transparent 70%); pointer-events: none; opacity: 0; transition: opacity 0.3s ease; z-index: 0;"></div>' +
        
        // Header
        '<div class="payment-card-header" style="padding: 1.25rem; background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(250, 250, 250, 0.9) 100%); border-bottom: 1px solid rgba(229, 231, 235, 0.8); position: relative; z-index: 2;">' +
        '<div class="flex items-center justify-between gap-3">' +
        '<div class="flex items-center gap-3 flex-1 min-w-0">' +
        '<div class="brand-icon-wrapper flex-shrink-0" style="width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px -2px rgba(251, 191, 36, 0.3);">' +
        '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />' +
        '</svg>' +
        '</div>' +
        '<div class="min-w-0 flex-1">' +
        '<div class="flex items-center gap-2 mb-0.5">' +
        '<div style="background: ' + brandColors.bg + '; color: ' + brandColors.text + '; padding: 0.25rem 0.625rem; border-radius: 6px; font-weight: 700; font-size: 0.8125rem;">' + escapeHtml(method.brand) + '</div>' +
        (method.bank ? '<span class="text-xs text-gray-500 font-medium truncate">' + escapeHtml(method.bank) + '</span>' : '') +
        '</div>' +
        '<p class="text-xs text-gray-500 font-medium">' + (method.type === 'credit' ? 'Tarjeta de Crédito' : 'Tarjeta de Débito') + '</p>' +
        '</div>' +
        '</div>' +
        
        // Badge predeterminada (solo icono)
        '<div class="flex items-center gap-2 flex-shrink-0">' +
        (isDefault ? '<span class="default-badge-payment" style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 50%; box-shadow: 0 2px 4px -1px rgba(251, 191, 36, 0.3);" title="Predeterminada"><svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></span>' : '') +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // Body
        '<div class="payment-card-body" style="padding: 1.25rem; background: white; position: relative; z-index: 2;">' +
        '<div class="space-y-3">' +
        
        // Número de tarjeta
        '<div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 border border-gray-200">' +
        '<p class="text-xs text-gray-500 font-medium mb-1.5 uppercase tracking-wide">Número de Tarjeta</p>' +
        '<p class="text-lg font-mono font-bold text-gray-900 tracking-wider">' + escapeHtml(method.cardNumber) + '</p>' +
        '</div>' +
        
        // Información adicional
        '<div class="grid grid-cols-2 gap-3">' +
        '<div>' +
        '<p class="text-xs text-gray-500 font-medium mb-1 uppercase tracking-wide">Titular</p>' +
        '<p class="text-sm font-semibold text-gray-900 truncate">' + escapeHtml(method.cardHolder) + '</p>' +
        '</div>' +
        '<div class="text-right">' +
        '<p class="text-xs text-gray-500 font-medium mb-1 uppercase tracking-wide">Válida Hasta</p>' +
        '<p class="text-sm font-semibold text-gray-900">' + escapeHtml(method.expiryDate) + '</p>' +
        '</div>' +
        '</div>' +
        
        '</div>' +
        '</div>' +
        
        // Footer con acciones
        '<div class="payment-card-footer" style="padding: 1rem 1.25rem; border-top: 1px solid rgba(229, 231, 235, 0.6); background: rgba(249, 250, 251, 0.8); position: relative; z-index: 2;">' +
        '<div class="flex items-center gap-2">' +
        (!isDefault ? '<button type="button" class="set-default-payment-btn" data-id="' + escapeHtml(method.id) + '" style="flex: 1; padding: 0.625rem 1rem; background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 10px; font-size: 0.75rem; font-weight: 600; color: #92400e; transition: all 0.2s ease; cursor: pointer;">Establecer Predeterminada</button>' : '<div class="flex-1"></div>') +
        '<button type="button" class="payment-action-btn edit edit-btn" data-id="' + escapeHtml(method.id) + '" title="Editar" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 2px solid rgba(229, 231, 235, 0.8); background: white; cursor: pointer;">' +
        '<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' +
        '</button>' +
        '<button type="button" class="payment-action-btn delete delete-btn" data-id="' + escapeHtml(method.id) + '" title="Eliminar" style="width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 2px solid rgba(229, 231, 235, 0.8); background: white; cursor: pointer;">' +
        '<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
        '</button>' +
        '</div>' +
        '</div>' +
        
        '</div>';
    }

    // Renderizar métodos de pago
    function renderMethods() {
      if (!container || !noPaymentMessage) return;

      if (paymentMethods.length === 0) {
        container.classList.add('hidden');
        noPaymentMessage.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      noPaymentMessage.classList.add('hidden');

      container.innerHTML = paymentMethods.map((method: any) => renderPaymentCard(method)).join('');

      attachEventListeners();
    }

    // Asignar event listeners
    function attachEventListeners() {
      document.querySelectorAll('.set-default-payment-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) setDefault(id);
          }
        });
      });

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) openEditModal(id);
          }
        });
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const id = target.getAttribute('data-id');
            if (id) showDeleteConfirm(id);
          }
        });
      });
    }

    // Establecer como predeterminada
    async function setDefault(id: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update
        paymentMethods = paymentMethods.map((m: any) => ({
          ...m,
          isDefault: m.id === id
        }));
        renderMethods();

        const { setDefaultPaymentMethod } = await import('../../../lib/db/payment.js');
        const result = await setDefaultPaymentMethod(currentUserId, id);

        if (!result.success) {
          // Revertir optimistic update
          await loadPaymentMethods();
          alert('Error al establecer método predeterminado: ' + (result.error?.message || 'Error desconocido'));
        }
      } catch (error: any) {
        console.error('Error estableciendo método predeterminado:', error);
        await loadPaymentMethods();
        alert('Error al establecer método predeterminado: ' + (error.message || 'Error desconocido'));
      }
    }

    // Mostrar confirmación de eliminación
    function showDeleteConfirm(id: string) {
      const method = paymentMethods.find((m: any) => m.id === id);
      if (!method) return;

      (window as any).showConfirmModal(confirmModalId, {
        icon: `
          <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        `,
        iconBg: 'bg-red-100',
        iconColor: 'text-red-600',
        title: 'Eliminar Método de Pago',
        message: `¿Estás seguro de eliminar el método de pago terminado en ${method.cardNumber.slice(-4)}? Esta acción no se puede deshacer.`,
        confirmText: 'Eliminar',
        confirmClass: 'bg-gradient-to-r from-red-500 to-red-600',
        onConfirm: () => {
          deleteMethod(id);
        }
      });
    }

    // Eliminar método
    async function deleteMethod(id: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update: eliminar de la UI inmediatamente
        const methodToDelete = paymentMethods.find((m: any) => m.id === id);
        paymentMethods = paymentMethods.filter((m: any) => m.id !== id);
        renderMethods();

        const { deletePaymentMethod } = await import('../../../lib/db/payment.js');
        const result = await deletePaymentMethod(currentUserId, id);

        if (!result.success) {
          // Revertir optimistic update
          await loadPaymentMethods();
          alert('Error al eliminar método de pago: ' + (result.error?.message || 'Error desconocido'));
        }
      } catch (error: any) {
        console.error('Error eliminando método de pago:', error);
        // Revertir optimistic update
        await loadPaymentMethods();
        alert('Error al eliminar método de pago: ' + (error.message || 'Error desconocido'));
      }
    }

    // Abrir modal para añadir
    function openAddModal() {
      editingMethodId = null;
      
      // Guardar referencia a la función del modal ANTES de cualquier asignación
      const modalOpenFn = (window as any)['openPaymentModal_payment-modal'];
      
      if (modalOpenFn && typeof modalOpenFn === 'function') {
        // Llamar directamente a la función del modal, NO a window.openPaymentModal
        modalOpenFn(null, function(methodData: any) {
          saveMethod(methodData);
        });
      } else {
        // Fallback: intentar acceder directamente al modal
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        } else {
          console.error('No se pudo encontrar la función del modal ni el elemento modal');
        }
      }
    }

    // Abrir modal para editar
    function openEditModal(methodId: string) {
      const method = paymentMethods.find((m: any) => m.id === methodId);
      if (!method) return;

      editingMethodId = methodId;
      
      // Guardar referencia a la función del modal ANTES de cualquier asignación
      const modalOpenFn = (window as any)['openPaymentModal_payment-modal'];
      
      if (modalOpenFn && typeof modalOpenFn === 'function') {
        // Llamar directamente a la función del modal, NO a window.openPaymentModal
        modalOpenFn(method, function(methodData: any) {
          saveMethod(methodData);
        });
      } else {
        console.error('No se pudo encontrar la función del modal');
      }
    }

    // Guardar método
    async function saveMethod(methodData: any) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        const brand = detectBrand(methodData.cardNumber);
        const isDefault = methodData.isDefault || paymentMethods.length === 0;

        // Preparar datos para Firebase
        const paymentData: any = {
          type: 'card', // El tipo en Firebase es 'card' o 'cash'
          cardNumber: methodData.cardNumber,
          cardholderName: methodData.cardHolder,
          expiryDate: methodData.expiryDate,
          isDefault: isDefault,
          // Campos adicionales que no están en el tipo pero los usamos en el componente
          cardType: methodData.type, // 'credit' o 'debit'
          brand: brand,
          bank: methodData.bank
        };

        // Optimistic update
        const finalMethodData: any = {
          id: editingMethodId || 'temp-' + Date.now(),
          ...methodData,
          brand: brand,
          isDefault: isDefault
        };

        if (editingMethodId) {
          const index = paymentMethods.findIndex((m: any) => m.id === editingMethodId);
          if (index !== -1) {
            paymentMethods[index] = finalMethodData;
          }
        } else {
          paymentMethods.push(finalMethodData);
        }

        // Si es predeterminada, desmarcar las demás
        if (finalMethodData.isDefault) {
          paymentMethods = paymentMethods.map((m: any) => ({
            ...m,
            isDefault: m.id === finalMethodData.id
          }));
        }

        renderMethods();

        // Guardar en Firebase
        const { addPaymentMethod, updatePaymentMethod } = await import('../../../lib/db/payment.js');

        if (editingMethodId) {
          const result = await updatePaymentMethod(currentUserId, editingMethodId, paymentData);
          if (!result.success) {
            // Revertir optimistic update
            await loadPaymentMethods();
            alert('Error al actualizar método de pago: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        } else {
          const result = await addPaymentMethod(currentUserId, paymentData);
          if (!result.success) {
            // Revertir optimistic update
            await loadPaymentMethods();
            alert('Error al guardar método de pago: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        }

        // Recargar desde Firebase para sincronizar
        await loadPaymentMethods();
      } catch (error: any) {
        console.error('Error guardando método de pago:', error);
        // Revertir optimistic update
        await loadPaymentMethods();
        alert('Error al guardar método de pago: ' + (error.message || 'Error desconocido'));
      }
    }

    // Event listeners
    if (addBtn) {
      addBtn.addEventListener('click', openAddModal);
    }

    // Función global para el botón del mensaje vacío (usar un nombre completamente diferente)
    // @ts-ignore
    window.openPaymentModalFromSection = function() {
      openAddModal();
    };
    
    // Inicializar: obtener userId y cargar métodos de pago
    async function init() {
      currentUserId = await getCurrentUserId();
      
      if (!currentUserId) {
        console.warn('No se pudo obtener el usuario autenticado');
        paymentMethods = [];
        renderMethods();
        return;
      }

      await loadPaymentMethods();
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
