---
const title = 'Mis Pedidos';

// Los pedidos se cargar√°n din√°micamente desde Firebase
const orders: any[] = [];
const statusOptions = ['Todos los estados', 'Pendientes', 'Procesando', 'En camino', 'Entregados', 'Cancelados'];
---

<section class="space-y-4">
  <!-- Header compacto y elegante -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 pb-3 border-b border-gray-200">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
        </svg>
        {title}
      </h1>
      <p class="text-xs text-gray-500 mt-1 uppercase tracking-wide">Gestiona y rastrea todos tus pedidos</p>
    </div>
  </div>

  <!-- Datos de pedidos para JavaScript -->
  <script define:vars={{ ordersData: orders }} is:inline>
    window.ordersData = ordersData;
  </script>

  <!-- Barra de b√∫squeda y filtros compactos -->
  <div class="flex flex-col sm:flex-row gap-3">
    <!-- Barra de b√∫squeda elegante -->
    <div class="flex-1 relative">
      <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <input
        type="text"
        id="search-input"
        placeholder="Buscar pedido o producto..."
        class="w-full pl-10 pr-4 py-2.5 text-sm rounded-lg border border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all duration-200"
      />
    </div>

    <!-- Dropdown de filtros elegante -->
    <div class="relative" id="filter-dropdown-container">
      <button
        type="button"
        id="status-filter-btn"
        class="flex items-center gap-2 px-4 py-2.5 min-w-[160px] text-sm rounded-lg border border-gray-200 bg-white text-gray-700 hover:border-[#5d3fbb] hover:bg-[#5d3fbb]/5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 justify-between"
      >
        <span id="status-filter-text" class="font-medium">Todos los estados</span>
        <svg class="h-4 w-4 text-gray-400 transition-transform duration-200" id="status-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      
      <!-- Men√∫ dropdown elegante -->
      <div
        id="status-dropdown-menu"
        class="hidden absolute top-full left-0 mt-1.5 w-full bg-white border border-gray-200 rounded-lg shadow-xl z-50 overflow-hidden"
      >
        {statusOptions.map((status) => (
          <button
            type="button"
            class="filter-option w-full text-left px-4 py-2.5 text-sm hover:bg-[#5d3fbb]/5 transition-colors duration-150 flex items-center justify-between"
            data-status={status === 'Todos los estados' ? 'all' : status.toLowerCase()}
          >
            <span class="font-medium">{status}</span>
            <svg class="h-4 w-4 text-[#5d3fbb] check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={status === 'Todos los estados' ? '' : 'display: none;'}>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Loading State elegante -->
  <div id="orders-loading" class="flex items-center justify-center min-h-[300px]">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-2 border-[#5d3fbb] border-t-transparent mb-3"></div>
      <p class="text-sm text-gray-500 font-medium">Cargando pedidos...</p>
    </div>
  </div>

  <!-- Error State elegante -->
  <div id="orders-error" class="hidden text-center py-16">
    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-50 mb-4">
      <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <p class="text-gray-900 font-semibold mb-1">Error al cargar los pedidos</p>
    <p class="text-sm text-gray-500 mb-4" id="orders-error-message"></p>
    <button
      id="orders-retry-btn"
      class="px-5 py-2 text-sm font-medium bg-[#5d3fbb] text-white rounded-lg hover:bg-[#4d2fa8] transition-colors duration-200"
    >
      Reintentar
    </button>
  </div>

  <!-- Contenedor de pedidos compacto -->
  <div id="orders-container" class="hidden space-y-3 min-h-[300px]">
    <!-- Los pedidos se renderizar√°n aqu√≠ con JavaScript -->
  </div>

  <!-- Mensaje cuando no hay pedidos elegante -->
  <div id="no-orders-message" class="hidden text-center py-16">
    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-50 mb-4">
      <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
      </svg>
    </div>
    <p class="text-gray-900 font-semibold mb-1">No se encontraron pedidos</p>
    <p class="text-sm text-gray-500">Intenta cambiar los filtros de b√∫squeda</p>
  </div>

  <!-- Modal de Calificaci√≥n elegante -->
  <div id="rating-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <!-- T√≠tulo -->
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-xl font-bold text-gray-900">Calificar Pedido</h2>
        <button type="button" onclick="closeRatingModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <!-- Estrellas de calificaci√≥n compactas -->
      <div class="flex items-center justify-center gap-1 mb-5" id="rating-stars">
        <button type="button" class="star-btn text-2xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="1" aria-label="1 estrella">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-2xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="2" aria-label="2 estrellas">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-2xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="3" aria-label="3 estrellas">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-2xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="4" aria-label="4 estrellas">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-2xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="5" aria-label="5 estrellas">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
      </div>
      
      <!-- Textarea de comentarios elegante -->
      <div class="mb-5">
        <textarea
          id="rating-comment"
          placeholder="Comparte tu experiencia..."
          class="w-full h-24 px-4 py-3 text-sm rounded-lg border border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all duration-200 resize-none"
        ></textarea>
      </div>
      
      <!-- Botones de acci√≥n elegantes -->
      <div class="flex gap-2">
        <button
          type="button"
          id="rating-cancel-btn"
          class="flex-1 px-4 py-2.5 text-sm font-semibold bg-white text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95"
        >
          Cancelar
        </button>
        <button
          type="button"
          id="rating-submit-btn"
          class="flex-1 px-4 py-2.5 text-sm font-semibold bg-[#5d3fbb] text-white rounded-lg hover:bg-[#4d2fa8] transition-all duration-200 active:scale-95"
        >
          Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Solicitud de Devoluci√≥n -->
  <div id="return-request-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-5 sm:p-6">
      <!-- T√≠tulo -->
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-xl font-bold text-gray-900">Solicitar Devoluci√≥n</h2>
        <button type="button" id="return-modal-close-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <!-- Informaci√≥n del pedido -->
      <div id="return-order-info" class="mb-5 p-4 bg-gray-50 rounded-lg">
        <!-- Se llenar√° din√°micamente -->
      </div>

      <!-- Selecci√≥n de productos -->
      <div class="mb-5">
        <label class="block text-sm font-semibold text-gray-900 mb-3">Selecciona el producto a devolver:</label>
        <div id="return-products-list" class="space-y-2 max-h-48 overflow-y-auto">
          <!-- Se llenar√° din√°micamente -->
        </div>
      </div>

      <!-- Raz√≥n de devoluci√≥n -->
      <div class="mb-5">
        <label for="return-reason" class="block text-sm font-semibold text-gray-900 mb-2">
          Raz√≥n de la devoluci√≥n <span class="text-red-500">*</span>
        </label>
        <select
          id="return-reason"
          class="w-full px-4 py-2.5 text-sm rounded-lg border border-gray-200 bg-white text-gray-900 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all"
          required
        >
          <option value="">Selecciona una raz√≥n</option>
          <option value="defective">Producto defectuoso</option>
          <option value="wrong_item">Pedido incorrecto</option>
          <option value="damaged">Producto da√±ado</option>
          <option value="not_as_described">No coincide con la descripci√≥n</option>
          <option value="other">Otra raz√≥n</option>
        </select>
      </div>

      <!-- Descripci√≥n -->
      <div class="mb-5">
        <label for="return-description" class="block text-sm font-semibold text-gray-900 mb-2">
          Descripci√≥n detallada <span class="text-red-500">*</span>
        </label>
        <textarea
          id="return-description"
          placeholder="Describe el problema o raz√≥n de la devoluci√≥n..."
          class="w-full h-32 px-4 py-3 text-sm rounded-lg border border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all duration-200 resize-none"
          required
        ></textarea>
      </div>
      
      <!-- Botones de acci√≥n -->
      <div class="flex gap-2">
        <button
          type="button"
          id="return-cancel-btn"
          class="flex-1 px-4 py-2.5 text-sm font-semibold bg-white text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95"
        >
          Cancelar
        </button>
        <button
          type="button"
          id="return-submit-btn"
          class="flex-1 px-4 py-2.5 text-sm font-semibold bg-[#5d3fbb] text-white rounded-lg hover:bg-[#4d2fa8] transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Enviar Solicitud
        </button>
      </div>
    </div>
  </div>

  <!-- Paginaci√≥n -->
  <div id="pagination-container" class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6 pt-6 border-t border-gray-200">
    <div class="text-sm text-gray-600">
      Mostrando <span id="pagination-start">0</span> - <span id="pagination-end">0</span> de <span id="pagination-total">0</span> pedidos
    </div>
    <div class="flex items-center gap-2">
      <button
        id="prev-page-btn"
        type="button"
        class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <div id="pagination-numbers" class="flex items-center gap-1">
        <!-- Los n√∫meros de p√°gina se generar√°n con JavaScript -->
      </div>
      <button
        id="next-page-btn"
        type="button"
        class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <script>
    (function() {
      // Configuraci√≥n
      const ORDERS_PER_PAGE = 3;
      let allOrders: any[] = [];
      let filteredOrders: any[] = [];
      let currentPage = 1;
      let currentFilter = 'all';
      let currentSearch = '';
      let orderEventListenersAttached = false;

      // Elementos del DOM
      const ordersContainer = document.getElementById('orders-container');
      const noOrdersMessage = document.getElementById('no-orders-message');
      const paginationContainer = document.getElementById('pagination-container');
      const searchInput = document.getElementById('search-input');
      const statusFilterBtn = document.getElementById('status-filter-btn');
      const statusFilterText = document.getElementById('status-filter-text');
      const statusFilterArrow = document.getElementById('status-filter-arrow');
      const statusDropdownMenu = document.getElementById('status-dropdown-menu');
      const filterDropdownContainer = document.getElementById('filter-dropdown-container');
      const prevPageBtn = document.getElementById('prev-page-btn');
      const nextPageBtn = document.getElementById('next-page-btn');
      const paginationNumbers = document.getElementById('pagination-numbers');
      const paginationStart = document.getElementById('pagination-start');
      const paginationEnd = document.getElementById('pagination-end');
      const paginationTotal = document.getElementById('pagination-total');
      const ordersLoading = document.getElementById('orders-loading');
      const ordersError = document.getElementById('orders-error');
      const ordersErrorMessage = document.getElementById('orders-error-message');
      const ordersRetryBtn = document.getElementById('orders-retry-btn');

      // Verificar elementos cr√≠ticos
      const criticalElements = {
        ordersContainer,
        noOrdersMessage,
        paginationContainer,
        searchInput,
        statusFilterBtn,
        statusFilterText,
        statusFilterArrow,
        statusDropdownMenu,
        filterDropdownContainer,
        prevPageBtn,
        nextPageBtn,
        paginationNumbers,
        paginationStart,
        paginationEnd,
        paginationTotal,
        ordersLoading,
        ordersError
      };

      // Verificar qu√© elementos faltan
      const missingElements = Object.entries(criticalElements)
        .filter(([name, element]) => !element)
        .map(([name]) => name);

      if (missingElements.length > 0) {
        console.error('Elementos faltantes del DOM:', missingElements);
        console.error('Esperando a que el DOM est√© completamente cargado...');
        
        // Esperar un poco m√°s y reintentar
        setTimeout(() => {
          const retryElements = {
            ordersContainer: document.getElementById('orders-container'),
            noOrdersMessage: document.getElementById('no-orders-message'),
            paginationContainer: document.getElementById('pagination-container'),
            searchInput: document.getElementById('search-input'),
            statusFilterBtn: document.getElementById('status-filter-btn'),
            statusFilterText: document.getElementById('status-filter-text'),
            statusFilterArrow: document.getElementById('status-filter-arrow'),
            statusDropdownMenu: document.getElementById('status-dropdown-menu'),
            filterDropdownContainer: document.getElementById('filter-dropdown-container'),
            prevPageBtn: document.getElementById('prev-page-btn'),
            nextPageBtn: document.getElementById('next-page-btn'),
            paginationNumbers: document.getElementById('pagination-numbers'),
            paginationStart: document.getElementById('pagination-start'),
            paginationEnd: document.getElementById('pagination-end'),
            paginationTotal: document.getElementById('pagination-total'),
            ordersLoading: document.getElementById('orders-loading'),
            ordersError: document.getElementById('orders-error')
          };

          const stillMissing = Object.entries(retryElements)
            .filter(([name, element]) => !element)
            .map(([name]) => name);

          if (stillMissing.length > 0) {
            console.error('A√∫n faltan elementos despu√©s del reintento:', stillMissing);
            if (ordersError) {
              ordersError.classList.remove('hidden');
              if (ordersErrorMessage) {
                ordersErrorMessage.textContent = 'Error al inicializar la p√°gina. Por favor, recarga la p√°gina.';
              }
            }
            return;
          }

          // Si todos los elementos est√°n ahora disponibles, continuar
          console.log('Todos los elementos encontrados despu√©s del reintento');
        }, 500);
        
        return;
      }

      // Funci√≥n para formatear fecha
      function formatDate(timestamp: any): string {
        if (!timestamp) return 'Fecha no disponible';
        
        let date: Date;
        if (timestamp.toDate) {
          date = timestamp.toDate();
        } else if (timestamp instanceof Date) {
          date = timestamp;
        } else {
          return 'Fecha no disponible';
        }

        const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                       'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        
        return `${day} de ${month} de ${year}`;
      }

      // Funci√≥n para mapear estado de Firebase a estado del componente
      function mapOrderStatus(status: string): { 
        status: string; 
        statusColor: string; 
        statusIcon: string;
        progressStep: number;
      } {
        const statusMap: Record<string, any> = {
          'pending': {
            status: 'Pendientes',
            statusColor: 'bg-amber-50 text-amber-700 border border-amber-200',
            statusIcon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
            progressStep: 1
          },
          'processing': {
            status: 'Procesando',
            statusColor: 'bg-blue-50 text-blue-700 border border-blue-200',
            statusIcon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15',
            progressStep: 2
          },
          'shipped': {
            status: 'En camino',
            statusColor: 'bg-[#5d3fbb]/10 text-[#5d3fbb] border border-[#5d3fbb]/20',
            statusIcon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
            progressStep: 3
          },
          'delivered': {
            status: 'Entregados',
            statusColor: 'bg-emerald-50 text-emerald-700 border border-emerald-200',
            statusIcon: 'M5 13l4 4L19 7',
            progressStep: 4
          },
          'cancelled': {
            status: 'Cancelados',
            statusColor: 'bg-red-50 text-red-700 border border-red-200',
            statusIcon: 'M6 18L18 6M6 6l12 12',
            progressStep: 0
          }
        };

        return statusMap[status] || statusMap['pending'];
      }

      // Funci√≥n para determinar acciones disponibles seg√∫n el estado
      function getAvailableActions(status: string): string[] {
        const actions: string[] = ['verDetalles', 'factura'];
        
        if (status === 'delivered') {
          actions.push('calificar', 'devolver');
        }
        
        return actions;
      }

      // Funci√≥n para convertir orden de Firebase al formato del componente
      function convertFirebaseOrderToComponentOrder(firebaseOrder: any): any {
        const statusInfo = mapOrderStatus(firebaseOrder.status || 'pending');
        const productImages = firebaseOrder.items?.map((item: any) => item.productImage || '') || [];
        const products = firebaseOrder.items?.map((item: any) => ({
          name: item.productName || 'Producto sin nombre',
          image: item.productImage || '',
          quantity: item.quantity || 1,
          unitPrice: item.price || 0,
          subtotal: item.subtotal || (item.price * item.quantity) || 0
        })) || [];

        const shippingAddress = firebaseOrder.shippingAddress || {};
        const shipping = {
          address: shippingAddress.address 
            ? `${shippingAddress.address}, ${shippingAddress.district || ''}, ${shippingAddress.city || ''}`
            : 'Direcci√≥n no disponible',
          phone: shippingAddress.phone || 'Tel√©fono no disponible',
          trackingNumber: firebaseOrder.trackingNumber || (firebaseOrder.status === 'pending' ? 'Pendiente de asignaci√≥n' : 'BOL' + firebaseOrder.id.substring(0, 8).toUpperCase()),
          estimatedDelivery: firebaseOrder.status === 'delivered' 
            ? formatDate(firebaseOrder.updatedAt || firebaseOrder.createdAt)
            : 'Pendiente de calcular'
        };

        return {
          id: firebaseOrder.id || '',
          date: formatDate(firebaseOrder.createdAt),
          status: statusInfo.status,
          statusColor: statusInfo.statusColor,
          statusIcon: statusInfo.statusIcon,
          total: firebaseOrder.total || 0,
          productsCount: firebaseOrder.items?.length || 0,
          productImages: productImages,
          showActions: getAvailableActions(firebaseOrder.status || 'pending'),
          progressStep: statusInfo.progressStep,
          products: products,
          shipping: shipping,
          invoiceNumber: firebaseOrder.invoiceNumber
        };
      }

      // Funci√≥n para obtener userId con reintentos
      function getUserId(maxAttempts = 20, delay = 200): Promise<string> {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          
          const tryGetUserId = () => {
            attempts++;
            let userId: string | null = null;
            
            // Intentar obtener desde localStorage
            userId = localStorage.getItem('userId');
            
            // Si no est√° en localStorage, intentar desde window
            if (!userId && typeof window !== 'undefined' && (window as any).currentUserId) {
              userId = (window as any).currentUserId;
            }
            
            // Si a√∫n no est√°, intentar desde el atributo data del contenedor de perfil
            if (!userId) {
              const profilePanel = document.getElementById('profile-content-panel');
              if (profilePanel) {
                userId = profilePanel.getAttribute('data-user-id');
              }
            }
            
            if (userId && userId.trim() !== '') {
              console.log('‚úÖ [ORDERS] UserId obtenido:', userId);
              resolve(userId);
            } else if (attempts < maxAttempts) {
              // Esperar un poco m√°s antes de reintentar
              setTimeout(tryGetUserId, delay);
            } else {
              reject(new Error('Usuario no autenticado. Por favor, inicia sesi√≥n.'));
            }
          };
          
          tryGetUserId();
        });
      }

      // Verificar si la secci√≥n de orders est√° visible
      function isOrdersSectionVisible(): boolean {
        const ordersSection = document.querySelector('[data-profile-section="orders"]');
        if (!ordersSection) return false;
        const isHidden = ordersSection.classList.contains('hidden') || 
                        (ordersSection as HTMLElement).style.display === 'none' ||
                        getComputedStyle(ordersSection).display === 'none';
        return !isHidden;
      }

      // Cargar pedidos desde Firebase
      async function loadOrders() {
        try {
          // Verificar que la secci√≥n est√© visible antes de cargar
          if (!isOrdersSectionVisible()) {
            console.log('‚è≥ [ORDERS] Secci√≥n no visible, esperando...');
            return;
          }

          // Mostrar loader inmediatamente y ocultar otros estados
          if (ordersLoading) {
            ordersLoading.classList.remove('hidden');
            ordersLoading.style.display = 'flex';
          }
          if (ordersError) {
            ordersError.classList.add('hidden');
            ordersError.style.display = 'none';
          }
          if (ordersContainer) {
            ordersContainer.classList.add('hidden');
            ordersContainer.style.display = 'none';
          }
          if (noOrdersMessage) {
            noOrdersMessage.classList.add('hidden');
            noOrdersMessage.style.display = 'none';
          }

          console.log('üîÑ [ORDERS] Iniciando carga de pedidos...');
          
          // Esperar a que el userId est√© disponible (mantener loader visible)
          const userId = await getUserId(30, 200); // Hasta 6 segundos (30 intentos x 200ms)
          
          if (!userId || userId.trim() === '') {
            throw new Error('No se pudo obtener el ID del usuario. Por favor, recarga la p√°gina.');
          }
          
          console.log('‚úÖ [ORDERS] UserId confirmado:', userId);

          // Obtener pedidos del usuario (loader sigue visible)
          const { getUserOrders } = await import('../../../lib/db/orders');
          console.log('üì¶ [ORDERS] Obteniendo pedidos para userId:', userId);
          const ordersResult = await getUserOrders(userId);

          if (ordersResult.error) {
            throw ordersResult.error;
          }

          const rawOrders = ordersResult.data || [];
          console.log('üì¶ [ORDERS] Pedidos obtenidos de Firebase:', rawOrders.length);

          // Verificar CR√çTICAMENTE que todos los pedidos pertenezcan al usuario logueado
          const userOrders = rawOrders.filter((order: any) => {
            const orderUserId = order.userId;
            const matches = orderUserId === userId;
            if (!matches && orderUserId) {
              console.warn('‚ö†Ô∏è [ORDERS] Pedido filtrado (userId no coincide):', {
                orderId: order.id,
                orderUserId: orderUserId,
                currentUserId: userId
              });
            }
            return matches;
          });

          console.log('‚úÖ [ORDERS] Pedidos v√°lidos del usuario despu√©s de filtrado:', userOrders.length);
          console.log('‚ùå [ORDERS] Pedidos filtrados (no pertenecen al usuario):', rawOrders.length - userOrders.length);

          // Si hay pedidos que no pertenecen al usuario, es un error cr√≠tico
          if (rawOrders.length > 0 && userOrders.length !== rawOrders.length) {
            console.error('üö® [ORDERS] ERROR: Se encontraron pedidos de otros usuarios!', {
              total: rawOrders.length,
              validos: userOrders.length,
              invalidos: rawOrders.length - userOrders.length,
              userId: userId
            });
          }

          // Convertir pedidos de Firebase al formato del componente
          allOrders = userOrders.map(convertFirebaseOrderToComponentOrder);
          filteredOrders = [...allOrders];

          console.log('‚úÖ [ORDERS] Pedidos convertidos al formato del componente:', allOrders.length);

          // OCULTAR loader SOLO despu√©s de procesar todos los pedidos
          if (ordersLoading) {
            ordersLoading.classList.add('hidden');
            ordersLoading.style.display = 'none';
          }
          
          // Mostrar resultados
          if (allOrders.length === 0) {
            if (ordersContainer) {
              ordersContainer.classList.add('hidden');
              ordersContainer.style.display = 'none';
            }
            if (noOrdersMessage) {
              noOrdersMessage.classList.remove('hidden');
              noOrdersMessage.style.display = 'block';
            }
            if (paginationContainer) {
              paginationContainer.classList.add('hidden');
            }
          } else {
            if (ordersContainer) {
              ordersContainer.classList.remove('hidden');
              ordersContainer.style.display = 'block';
            }
            if (noOrdersMessage) {
              noOrdersMessage.classList.add('hidden');
              noOrdersMessage.style.display = 'none';
            }
            renderOrders();
            updatePagination();
          }
          
          console.log('‚úÖ [ORDERS] Carga completada exitosamente');
        } catch (error: any) {
          console.error('‚ùå [ORDERS] Error cargando pedidos:', error);
          // Ocultar loader y mostrar error
          if (ordersLoading) {
            ordersLoading.classList.add('hidden');
            ordersLoading.style.display = 'none';
          }
          if (ordersError) {
            ordersError.classList.remove('hidden');
            ordersError.style.display = 'block';
            if (ordersErrorMessage) {
              ordersErrorMessage.textContent = error.message || 'Error desconocido al cargar los pedidos';
            }
          }
          // Asegurar que el contenedor est√© oculto en caso de error
          if (ordersContainer) {
            ordersContainer.classList.add('hidden');
            ordersContainer.style.display = 'none';
          }
        }
      }

      // Bot√≥n de reintentar
      if (ordersRetryBtn) {
        ordersRetryBtn.addEventListener('click', loadOrders);
      }

      // Filtrar pedidos
      function filterOrders() {
        filteredOrders = allOrders.filter((order: any) => {
          // Filtro por estado
          if (currentFilter !== 'all') {
            // Mapear el filtro seleccionado al estado del componente
            const filterMap: Record<string, string> = {
              'pendientes': 'Pendientes',
              'procesando': 'Procesando',
              'en camino': 'En camino',
              'entregados': 'Entregados',
              'cancelados': 'Cancelados'
            };
            const expectedStatus = filterMap[currentFilter] || currentFilter;
            if (order.status !== expectedStatus) {
              return false;
            }
          }

          // Filtro por b√∫squeda
          if (currentSearch.trim() !== '') {
            const searchLower = currentSearch.toLowerCase();
            const orderId = order.id.toString().toLowerCase();
            const invoiceNumber = (order.invoiceNumber || '').toLowerCase();
            const productNames = (order.products || []).map((p: any) => p.name.toLowerCase()).join(' ');
            
            if (!orderId.includes(searchLower) && 
                !invoiceNumber.includes(searchLower) && 
                !productNames.includes(searchLower)) {
              return false;
            }
          }

          return true;
        });

        currentPage = 1;
        renderOrders();
        updatePagination();
      }

      // Renderizar pedidos
      function renderOrders() {
        if (!ordersContainer || !noOrdersMessage || !paginationContainer) return;
        
        const start = (currentPage - 1) * ORDERS_PER_PAGE;
        const end = start + ORDERS_PER_PAGE;
        const ordersToShow = filteredOrders.slice(start, end);

        if (ordersToShow.length === 0) {
          ordersContainer.classList.add('hidden');
          noOrdersMessage.classList.remove('hidden');
          paginationContainer.classList.add('hidden');
          return;
        }

        ordersContainer.classList.remove('hidden');
        noOrdersMessage.classList.add('hidden');
        paginationContainer.classList.remove('hidden');

        ordersContainer.innerHTML = ordersToShow.map((order: any) => {
          const escapeHtml = (text: any) => {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
          };

          const productImagesHtml = order.productImages.slice(0, 4).map((image: any, idx: number) => 
            '<img src="' + escapeHtml(image) + '" alt="Producto ' + (idx + 1) + '" class="w-10 h-10 sm:w-14 sm:h-14 rounded-lg object-cover border border-gray-100 shadow-sm" />'
          ).join('');
          
          const moreProductsCount = order.productImages.length > 4 ? order.productImages.length - 4 : 0;
          const moreProductsHtml = moreProductsCount > 0 
            ? '<div class="w-10 h-10 sm:w-14 sm:h-14 rounded-lg bg-gray-50 border border-gray-100 flex items-center justify-center text-[10px] sm:text-xs font-semibold text-gray-600">+' + moreProductsCount + '</div>'
            : '';

          // Determinar el paso de progreso
          const progressSteps = [
            { label: 'Pedido Realizado', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
            { label: 'Procesando', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
            { label: 'En Camino', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' },
            { label: 'Entregado', icon: 'M5 13l4 4L19 7' }
          ];

          const currentStep = order.progressStep || (order.status === 'Entregados' ? 4 : order.status === 'En camino' ? 3 : order.status === 'Procesando' ? 2 : order.status === 'Pendientes' ? 1 : 1);

          // Productos detallados - si no hay productos detallados, crear desde productImages
          let products = order.products || [];
          if (products.length === 0 && order.productImages && order.productImages.length > 0) {
            const pricePerProduct = order.total / order.productsCount;
            products = order.productImages.map((img: any, idx: number) => ({
              name: 'Producto ' + (idx + 1),
              image: img,
              quantity: 1,
              unitPrice: pricePerProduct,
              subtotal: pricePerProduct
            }));
          }

          // Informaci√≥n de env√≠o - datos por defecto si no existen
          const shipping = order.shipping || {
            address: 'Direcci√≥n no disponible',
            phone: 'Tel√©fono no disponible',
            trackingNumber: order.status === 'Pendientes' ? 'Pendiente de asignaci√≥n' : 'BOL' + order.id + Math.floor(Math.random() * 1000),
            estimatedDelivery: order.status === 'Entregados' ? order.date : 'Pendiente de calcular'
          };

          // Barra de progreso HTML compacta y elegante - optimizada para m√≥vil
          const progressBarSteps = progressSteps.map((step: any, index: number) => {
            const stepNumber = index + 1;
            const isActive = stepNumber <= currentStep;
            return '<div class="flex flex-col items-center flex-1 min-w-0">' +
              '<div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex items-center justify-center border transition-all duration-300 ' + 
              (isActive ? 'bg-[#5d3fbb] border-[#5d3fbb] text-white' : 'bg-white border-gray-200 text-gray-400') + '">' +
              '<svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + step.icon + '" />' +
              '</svg>' +
              '</div>' +
              '<p class="mt-1 sm:mt-1.5 text-[8px] sm:text-[10px] font-medium text-center leading-tight ' + (isActive ? 'text-[#5d3fbb]' : 'text-gray-400') + '">' + step.label + '</p>' +
              '</div>';
          }).join('');

          const progressBarHtml = '<div class="relative mb-4 sm:mb-5">' +
            '<div class="absolute top-3 sm:top-4 left-0 right-0 h-0.5 bg-gray-100 rounded-full"></div>' +
            '<div class="absolute top-3 sm:top-4 left-0 h-0.5 bg-[#5d3fbb] rounded-full transition-all duration-500" style="width: ' + (((currentStep - 1) / 3) * 100) + '%"></div>' +
            '<div class="relative flex justify-between px-1 sm:px-2">' +
            progressBarSteps +
            '</div>' +
            '</div>';

          // Productos HTML compactos y elegantes
          const productsHtml = products.map((product: any) => 
            '<div class="flex items-center gap-3 py-3 border-b border-gray-50 last:border-b-0">' +
            '<img src="' + escapeHtml(product.image) + '" alt="' + escapeHtml(product.name) + '" class="w-12 h-12 rounded-lg object-cover border border-gray-100" />' +
            '<div class="flex-1 min-w-0">' +
            '<h4 class="font-semibold text-sm text-gray-900 truncate">' + escapeHtml(product.name) + '</h4>' +
            '<p class="text-xs text-gray-500 mt-0.5">' + product.quantity + ' x Bs. ' + product.unitPrice.toFixed(2) + '</p>' +
            '</div>' +
            '<p class="font-bold text-sm text-gray-900 whitespace-nowrap ml-2">Bs. ' + product.subtotal.toFixed(2) + '</p>' +
            '</div>'
          ).join('');

          // Informaci√≥n de env√≠o HTML compacta y elegante
          const shippingHtml = '<div class="space-y-2.5">' +
            '<div class="pb-2.5 border-b border-gray-50 last:border-b-0">' +
            '<p class="text-xs text-gray-500 mb-1 font-medium uppercase tracking-wide">Direcci√≥n</p>' +
            '<p class="text-sm font-semibold text-gray-900 leading-tight">' + escapeHtml(shipping.address) + '</p>' +
            '</div>' +
            '<div class="pb-2.5 border-b border-gray-50 last:border-b-0">' +
            '<p class="text-xs text-gray-500 mb-1 font-medium uppercase tracking-wide">Tel√©fono</p>' +
            '<p class="text-sm font-semibold text-gray-900">' + escapeHtml(shipping.phone) + '</p>' +
            '</div>' +
            '<div class="pb-2.5 border-b border-gray-50 last:border-b-0">' +
            '<p class="text-xs text-gray-500 mb-1 font-medium uppercase tracking-wide">Seguimiento</p>' +
            '<p class="text-sm font-semibold text-gray-900 font-mono">' + escapeHtml(shipping.trackingNumber) + '</p>' +
            '</div>' +
            '<div>' +
            '<p class="text-xs text-gray-500 mb-1 font-medium uppercase tracking-wide">Entrega</p>' +
            '<p class="text-sm font-semibold text-gray-900">' + escapeHtml(shipping.estimatedDelivery) + '</p>' +
            '</div>' +
            '</div>';

          // Botones de acci√≥n compactos y elegantes
          const actionsHtml = [
            order.showActions.includes('verDetalles') ? 
              '<button type="button" class="toggle-details-btn flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1.5 sm:py-2 text-[10px] sm:text-xs font-semibold bg-[#5d3fbb] text-white rounded-lg hover:bg-[#4d2fa8] transition-all duration-200 active:scale-95" data-order-id="' + String(order.id).replace(/"/g, '&quot;') + '">' +
              '<svg class="h-3 w-3 sm:h-3.5 sm:w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />' +
              '</svg>' +
              '<span class="details-btn-text hidden sm:inline">Detalles</span>' +
              '</button>' : '',
            order.showActions.includes('factura') ? 
              '<button type="button" class="flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1.5 sm:py-2 text-[10px] sm:text-xs font-semibold bg-white text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95">' +
              '<svg class="h-3 w-3 sm:h-3.5 sm:w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />' +
              '</svg>' +
              '<span class="hidden sm:inline">Factura</span>' +
              '</button>' : '',
            order.showActions.includes('calificar') ? 
              '<button type="button" class="rate-order-btn flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1.5 sm:py-2 text-[10px] sm:text-xs font-semibold bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-all duration-200 active:scale-95" data-order-id="' + String(order.id).replace(/"/g, '&quot;') + '">' +
              '<svg class="h-3 w-3 sm:h-3.5 sm:w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />' +
              '</svg>' +
              '<span class="hidden sm:inline">Calificar</span>' +
              '</button>' : '',
            order.showActions.includes('devolver') ? 
              '<button type="button" class="return-request-btn flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1.5 sm:py-2 text-[10px] sm:text-xs font-semibold bg-white text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95" data-order-id="' + String(order.id).replace(/"/g, '&quot;') + '">' +
              '<svg class="h-3 w-3 sm:h-3.5 sm:w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />' +
              '</svg>' +
              '<span class="hidden sm:inline">Devolver</span>' +
              '</button>' : ''
          ].filter(Boolean).join('');

          return '<div class="bg-white rounded-xl border border-gray-100 hover:border-gray-200 hover:shadow-md transition-all duration-200 p-3 sm:p-4 order-card" data-order-id="' + String(order.id).replace(/"/g, '&quot;') + '">' +
            // Header compacto y elegante - optimizado para m√≥vil
            '<div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-3 pb-3 border-b border-gray-50">' +
            '<div class="flex-1 min-w-0">' +
            '<div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-2.5 mb-1.5">' +
            '<h2 class="text-base sm:text-lg font-bold text-gray-900 tracking-tight">#' + escapeHtml(order.id.substring(0, 8)) + '</h2>' +
            '<span class="px-1.5 sm:px-2 py-0.5 rounded-md text-[9px] sm:text-[10px] font-semibold uppercase tracking-wide flex items-center gap-0.5 sm:gap-1 w-fit ' + order.statusColor + '">' +
            '<svg class="h-2.5 w-2.5 sm:h-3 sm:w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">' +
            '<path stroke-linecap="round" stroke-linejoin="round" d="' + order.statusIcon + '" />' +
            '</svg>' +
            '<span class="hidden sm:inline">' + escapeHtml(order.status) + '</span>' +
            '<span class="sm:hidden">' + escapeHtml(order.status.length > 10 ? order.status.substring(0, 8) + '...' : order.status) + '</span>' +
            '</span>' +
            '</div>' +
            '<p class="text-[10px] sm:text-xs text-gray-500 font-medium">' + escapeHtml(order.date) + '</p>' +
            '</div>' +
            '<div class="text-left sm:text-right flex-shrink-0">' +
            '<p class="text-base sm:text-lg font-bold text-gray-900">Bs. ' + order.total.toFixed(2) + '</p>' +
            '<p class="text-[10px] sm:text-xs text-gray-500 mt-0.5">' + order.productsCount + ' ' + (order.productsCount === 1 ? 'producto' : 'productos') + '</p>' +
            '</div>' +
            '</div>' +
            // Preview de productos (siempre visible, compacto)
            '<div class="flex items-center gap-1.5 sm:gap-2 mb-3 pb-3 border-b border-gray-50 overflow-x-auto">' +
            productImagesHtml + moreProductsHtml +
            '</div>' +
            // Barra de progreso compacta (se muestra cuando se expanden los detalles)
            '<div class="order-progress-section hidden mb-4" data-progress-order-id="' + String(order.id).replace(/"/g, '&quot;') + '">' +
            progressBarHtml +
            '</div>' +
            // Botones de acci√≥n compactos - optimizados para m√≥vil
            '<div class="flex flex-wrap items-center gap-1.5 sm:gap-2">' +
            actionsHtml +
            '</div>' +
            // Secci√≥n de detalles expandible (productos e informaci√≥n de env√≠o)
            '<div class="order-details-section hidden mt-4 pt-4 border-t border-gray-100" data-details-order-id="' + String(order.id).replace(/"/g, '&quot;') + '">' +
            '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">' +
            '<div>' +
            '<h3 class="text-sm font-bold text-gray-900 mb-3 uppercase tracking-wide">Productos</h3>' +
            '<div class="bg-gray-50 rounded-lg p-3">' +
            productsHtml +
            '</div>' +
            '</div>' +
            '<div>' +
            '<h3 class="text-sm font-bold text-gray-900 mb-3 uppercase tracking-wide">Env√≠o</h3>' +
            '<div class="bg-gray-50 rounded-lg p-3">' +
            shippingHtml +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
        }).join('');

        // Asignar event listeners a los botones despu√©s de renderizar
        attachOrderEventListeners();
      }

      // Handler de eventos para los botones (funci√≥n separada para poder removerla si es necesario)
      function handleOrderContainerClick(e: Event) {
        const target = e.target as HTMLElement;
        
        // Manejar botones de toggle detalles
        const toggleBtn = target.closest('.toggle-details-btn') as HTMLButtonElement;
        if (toggleBtn) {
          e.preventDefault();
          e.stopPropagation();
          const orderId = toggleBtn.getAttribute('data-order-id');
          if (orderId) {
            toggleOrderDetails(orderId);
          }
          return;
        }
        
        // Manejar botones de calificar
        const rateBtn = target.closest('.rate-order-btn') as HTMLButtonElement;
        if (rateBtn) {
          e.preventDefault();
          e.stopPropagation();
          const orderId = rateBtn.getAttribute('data-order-id');
          if (orderId && typeof (window as any).openRatingModal === 'function') {
            (window as any).openRatingModal(orderId);
          }
          return;
        }
        
        // Manejar botones de devoluci√≥n
        const returnBtn = target.closest('.return-request-btn') as HTMLButtonElement;
        if (returnBtn) {
          e.preventDefault();
          e.stopPropagation();
          const orderId = returnBtn.getAttribute('data-order-id');
          if (orderId && typeof (window as any).openReturnRequestModal === 'function') {
            (window as any).openReturnRequestModal(orderId);
          }
          return;
        }
      }

      // Funci√≥n para asignar event listeners a los botones de pedidos
      function attachOrderEventListeners() {
        // Usar evento delegado en el contenedor (solo agregar una vez)
        if (ordersContainer && !orderEventListenersAttached) {
          ordersContainer.addEventListener('click', handleOrderContainerClick, true);
          orderEventListenersAttached = true;
        }
      }

      // Actualizar paginaci√≥n
      function updatePagination() {
        const totalPages = Math.ceil(filteredOrders.length / ORDERS_PER_PAGE);
        const start = (currentPage - 1) * ORDERS_PER_PAGE + 1;
        const end = Math.min(currentPage * ORDERS_PER_PAGE, filteredOrders.length);

        if (paginationStart) {
          paginationStart.textContent = String(filteredOrders.length > 0 ? start : 0);
        }
        if (paginationEnd) {
          paginationEnd.textContent = String(end);
        }
        if (paginationTotal) {
          paginationTotal.textContent = String(filteredOrders.length);
        }

        // Botones anterior/siguiente
        if (prevPageBtn instanceof HTMLButtonElement) {
          prevPageBtn.disabled = currentPage === 1;
        }
        if (nextPageBtn instanceof HTMLButtonElement) {
          nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // N√∫meros de p√°gina
        if (paginationNumbers) {
          paginationNumbers.innerHTML = '';
        }
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.type = 'button';
          pageBtn.className = `px-3 py-1.5 text-sm rounded-lg border transition-all duration-200 ${
            i === currentPage
              ? 'border-[#5d3fbb] bg-[#5d3fbb] text-white font-semibold'
              : 'border-gray-200 bg-white text-gray-700 hover:border-[#5d3fbb] hover:bg-[#5d3fbb]/5 font-medium'
          }`;
          pageBtn.textContent = String(i);
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            renderOrders();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          if (paginationNumbers) {
            paginationNumbers.appendChild(pageBtn);
          }
        }
      }

      // Event listeners
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const target = e.target;
          if (target && target instanceof HTMLInputElement) {
            currentSearch = target.value;
            filterOrders();
          }
        });
      }

      if (statusFilterBtn && statusDropdownMenu && statusFilterArrow) {
        statusFilterBtn.addEventListener('click', () => {
          statusDropdownMenu.classList.toggle('hidden');
          statusFilterArrow.classList.toggle('rotate-180');
        });
      }

      document.querySelectorAll('.filter-option').forEach(option => {
        option.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (!target || !(target instanceof HTMLButtonElement)) return;
          
          const status = target.dataset.status || 'all';
          const span = target.querySelector('span');
          const statusText = span ? span.textContent : 'Todos los estados';
          
          currentFilter = status;
          if (statusFilterText) {
            statusFilterText.textContent = statusText || 'Todos los estados';
          }
          if (statusDropdownMenu && statusFilterArrow) {
            statusDropdownMenu.classList.add('hidden');
            statusFilterArrow.classList.remove('rotate-180');
          }
          
          // Actualizar checkmarks
          document.querySelectorAll('.filter-option').forEach(opt => {
            const checkIcon = opt.querySelector('.check-icon');
            if (checkIcon && checkIcon instanceof SVGElement) {
              checkIcon.style.display = 'none';
            }
          });
          const currentCheckIcon = target.querySelector('.check-icon');
          if (currentCheckIcon && currentCheckIcon instanceof SVGElement) {
            currentCheckIcon.style.display = 'block';
          }
          
          filterOrders();
        });
      });

      // Cerrar dropdown al hacer clic fuera
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (target && filterDropdownContainer && statusDropdownMenu && statusFilterArrow && 
            target instanceof Node && !filterDropdownContainer.contains(target)) {
          statusDropdownMenu.classList.add('hidden');
          statusFilterArrow.classList.remove('rotate-180');
        }
      });

      if (prevPageBtn) {
        prevPageBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderOrders();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      }

      if (nextPageBtn) {
        nextPageBtn.addEventListener('click', () => {
          const totalPages = Math.ceil(filteredOrders.length / ORDERS_PER_PAGE);
          if (currentPage < totalPages) {
            currentPage++;
            renderOrders();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        });
      }

      // Funci√≥n para toggle de detalles del pedido
      function toggleOrderDetails(orderId: string) {
        if (!orderId) {
          return;
        }
        
        // Buscar todas las tarjetas de pedidos y encontrar la correcta comparando el atributo
        const allOrderCards = document.querySelectorAll('[data-order-id]');
        let orderCard: Element | null = null;
        
        for (let i = 0; i < allOrderCards.length; i++) {
          const card = allOrderCards[i];
          if (card.getAttribute('data-order-id') === orderId) {
            orderCard = card;
            break;
          }
        }

        if (!orderCard) {
          return;
        }

        // Buscar elementos dentro de la tarjeta espec√≠fica comparando atributos
        const allProgressSections = orderCard.querySelectorAll('[data-progress-order-id]');
        const allDetailsSections = orderCard.querySelectorAll('[data-details-order-id]');
        const allToggleBtns = orderCard.querySelectorAll('.toggle-details-btn');
        
        let progressSection: HTMLElement | null = null;
        let detailsSection: HTMLElement | null = null;
        let toggleBtn: HTMLButtonElement | null = null;
        
        for (let i = 0; i < allProgressSections.length; i++) {
          const section = allProgressSections[i] as HTMLElement;
          if (section.getAttribute('data-progress-order-id') === orderId) {
            progressSection = section;
            break;
          }
        }
        
        for (let i = 0; i < allDetailsSections.length; i++) {
          const section = allDetailsSections[i] as HTMLElement;
          if (section.getAttribute('data-details-order-id') === orderId) {
            detailsSection = section;
            break;
          }
        }
        
        for (let i = 0; i < allToggleBtns.length; i++) {
          const btn = allToggleBtns[i] as HTMLButtonElement;
          if (btn.getAttribute('data-order-id') === orderId) {
            toggleBtn = btn;
            break;
          }
        }
        
        const btnText = toggleBtn?.querySelector('.details-btn-text');

        if (!detailsSection || !toggleBtn) {
          return;
        }

        const isHidden = detailsSection.classList.contains('hidden') || detailsSection.style.display === 'none' || getComputedStyle(detailsSection).display === 'none';
        
        // Si vamos a abrir este pedido, cerrar todos los dem√°s primero
        if (isHidden) {
          // Cerrar todos los dem√°s detalles abiertos
          document.querySelectorAll('.order-details-section').forEach((section: Element) => {
            const sectionElement = section as HTMLElement;
            const sectionOrderId = sectionElement.getAttribute('data-details-order-id');
            if (sectionOrderId && sectionOrderId !== orderId) {
              // Cerrar este detalle
              const sectionCard = sectionElement.closest('[data-order-id]');
              if (sectionCard) {
                const sectionProgress = sectionCard.querySelector(`[data-progress-order-id="${sectionOrderId}"]`) as HTMLElement;
                const sectionToggleBtn = sectionCard.querySelector(`.toggle-details-btn[data-order-id="${sectionOrderId}"]`) as HTMLButtonElement;
                const sectionBtnText = sectionToggleBtn?.querySelector('.details-btn-text');
                
                if (sectionProgress) {
                  sectionProgress.classList.add('hidden');
                  sectionProgress.style.display = 'none';
                }
                
                sectionElement.style.maxHeight = '0';
                sectionElement.style.opacity = '0';
                setTimeout(() => {
                  sectionElement.classList.add('hidden');
                  sectionElement.style.display = 'none';
                  sectionElement.style.maxHeight = '';
                  sectionElement.style.opacity = '';
                  sectionElement.style.transition = '';
                }, 200);
                
                if (sectionBtnText) {
                  sectionBtnText.textContent = 'Detalles';
                }
                if (sectionToggleBtn) {
                  const iconSvg = sectionToggleBtn.querySelector('svg');
                  if (iconSvg) {
                    iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
                  }
                }
              }
            }
          });
        }

        if (isHidden) {
          // Mostrar barra de progreso
          if (progressSection) {
            progressSection.classList.remove('hidden');
            progressSection.style.display = 'block';
          }
          
          // Mostrar detalles con animaci√≥n
          detailsSection.style.display = 'block';
          detailsSection.style.maxHeight = '0';
          detailsSection.style.overflow = 'hidden';
          detailsSection.style.transition = 'max-height 0.4s ease-out, opacity 0.4s ease-out';
          detailsSection.classList.remove('hidden');
          
          // Forzar reflow para que la animaci√≥n funcione
          void detailsSection.offsetHeight;
          
          // Establecer altura m√°xima para la animaci√≥n
          detailsSection.style.maxHeight = detailsSection.scrollHeight + 'px';
          detailsSection.style.opacity = '1';
          
          if (btnText) {
            btnText.textContent = 'Ocultar Detalles';
          }
          // Cambiar icono a ojo cerrado
          const iconSvg = toggleBtn.querySelector('svg');
          if (iconSvg) {
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />';
          }
          
          // Despu√©s de la animaci√≥n, remover estilos inline
          setTimeout(() => {
            detailsSection.style.maxHeight = '';
            detailsSection.style.overflow = '';
            detailsSection.style.opacity = '';
          }, 400);
        } else {
          // Ocultar detalles con animaci√≥n
          detailsSection.style.maxHeight = detailsSection.scrollHeight + 'px';
          detailsSection.style.overflow = 'hidden';
          detailsSection.style.transition = 'max-height 0.4s ease-out, opacity 0.4s ease-out';
          
          // Forzar reflow
          void detailsSection.offsetHeight;
          
          detailsSection.style.maxHeight = '0';
          detailsSection.style.opacity = '0';
          
          // Ocultar barra de progreso
          if (progressSection) {
            progressSection.classList.add('hidden');
            progressSection.style.display = 'none';
          }
          
          if (btnText) {
            btnText.textContent = 'Ver Detalles';
          }
          // Cambiar icono a ojo abierto
          const iconSvg = toggleBtn.querySelector('svg');
          if (iconSvg) {
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
          }
          
          // Despu√©s de la animaci√≥n, ocultar completamente
          setTimeout(() => {
            detailsSection.classList.add('hidden');
            detailsSection.style.display = 'none';
            detailsSection.style.maxHeight = '';
            detailsSection.style.overflow = '';
            detailsSection.style.opacity = '';
            detailsSection.style.transition = '';
          }, 400);
        }
      };

      // Funciones para el modal de calificaci√≥n
      let currentRating = 0;
      let currentOrderId = '';
      let hoveredRating = 0;

      // @ts-ignore
      window.openRatingModal = function(orderId: string) {
        currentOrderId = orderId;
        currentRating = 0;
        hoveredRating = 0;
        
        const modal = document.getElementById('rating-modal');
        const commentTextarea = document.getElementById('rating-comment') as HTMLTextAreaElement;
        
        if (!modal) return;
        
        // Resetear estrellas
        const stars = document.querySelectorAll('.star-btn');
        stars.forEach((star) => {
          const starSvg = star.querySelector('svg');
          if (starSvg) {
            starSvg.setAttribute('fill', 'none');
            starSvg.setAttribute('stroke', 'currentColor');
            starSvg.setAttribute('stroke-width', '2');
          }
          star.classList.remove('text-yellow-400');
          star.classList.add('text-gray-300');
        });
        
        // Limpiar textarea
        if (commentTextarea) {
          commentTextarea.value = '';
        }
        
        // Mostrar modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      };

      // Funci√≥n para cerrar modal
      function closeRatingModal() {
        const modal = document.getElementById('rating-modal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          modal.style.display = 'none';
          document.body.style.overflow = '';
          currentRating = 0;
          hoveredRating = 0;
          currentOrderId = '';
        }
      }

      // Funci√≥n para actualizar estrellas
      function updateStars(rating: number) {
        const stars = document.querySelectorAll('.star-btn');
        stars.forEach((star, index) => {
          const starNumber = index + 1;
          const starSvg = star.querySelector('svg');
          
          if (starNumber <= rating) {
            // Estrella llena
            if (starSvg) {
              starSvg.setAttribute('fill', 'currentColor');
              starSvg.removeAttribute('stroke');
              starSvg.removeAttribute('stroke-width');
            }
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
          } else {
            // Estrella vac√≠a
            if (starSvg) {
              starSvg.setAttribute('fill', 'none');
              starSvg.setAttribute('stroke', 'currentColor');
              starSvg.setAttribute('stroke-width', '2');
            }
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
          }
        });
      }

      // Inicializar event listeners para el modal de calificaci√≥n
      function initRatingModal() {
        const ratingModal = document.getElementById('rating-modal');
        const stars = document.querySelectorAll('.star-btn');
        const cancelBtn = document.getElementById('rating-cancel-btn');
        const submitBtn = document.getElementById('rating-submit-btn');
        const commentTextarea = document.getElementById('rating-comment') as HTMLTextAreaElement;
        const starsContainer = document.getElementById('rating-stars');

        if (!ratingModal || !starsContainer) return;

        // Click en estrellas
        stars.forEach((star) => {
          star.addEventListener('click', (e) => {
            const target = e.currentTarget;
            if (target && target instanceof HTMLButtonElement) {
              const rating = parseInt(target.getAttribute('data-rating') || '0');
              currentRating = rating;
              updateStars(rating);
            }
          });

          // Hover en estrellas
          star.addEventListener('mouseenter', (e) => {
            const target = e.currentTarget;
            if (target && target instanceof HTMLButtonElement) {
              const rating = parseInt(target.getAttribute('data-rating') || '0');
              hoveredRating = rating;
              updateStars(rating);
            }
          });
        });

        // Mouse leave en contenedor de estrellas
        starsContainer.addEventListener('mouseleave', () => {
          hoveredRating = 0;
          updateStars(currentRating);
        });

        // Bot√≥n cancelar
        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeRatingModal);
        }

        // Bot√≥n enviar
        if (submitBtn) {
          submitBtn.addEventListener('click', () => {
            if (currentRating === 0) {
              alert('Por favor, selecciona una calificaci√≥n');
              return;
            }

            const comment = commentTextarea ? commentTextarea.value : '';
            
            // Aqu√≠ puedes enviar la calificaci√≥n a tu API
            console.log('Calificaci√≥n enviada:', {
              orderId: currentOrderId,
              rating: currentRating,
              comment: comment
            });

            // Mostrar mensaje de √©xito (puedes mejorar esto)
            alert('¬°Gracias por tu calificaci√≥n!');
            
            // Cerrar modal
            closeRatingModal();
          });
        }

        // Cerrar modal al hacer clic fuera
        ratingModal.addEventListener('click', (e) => {
          if (e.target === ratingModal) {
            closeRatingModal();
          }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = document.getElementById('rating-modal');
            if (modal && !modal.classList.contains('hidden')) {
              closeRatingModal();
            }
          }
        });
      }

      // Funciones para el modal de devoluci√≥n
      let currentReturnOrderId = '';
      let selectedProductId = '';

      // @ts-ignore
      window.openReturnRequestModal = async function(orderId: string) {
        currentReturnOrderId = orderId;
        selectedProductId = '';
        
        const modal = document.getElementById('return-request-modal');
        const orderInfo = document.getElementById('return-order-info');
        const productsList = document.getElementById('return-products-list');
        const reasonSelect = document.getElementById('return-reason') as HTMLSelectElement;
        const descriptionTextarea = document.getElementById('return-description') as HTMLTextAreaElement;
        
        if (!modal || !orderInfo || !productsList) return;
        
        try {
          // Obtener informaci√≥n del pedido
          const { getOrderById } = await import('../../../lib/db/orders');
          const orderResult = await getOrderById(orderId);
          
          if (!orderResult.data) {
            alert('No se pudo encontrar el pedido');
            return;
          }
          
          const order = orderResult.data;
          
          // Mostrar informaci√≥n del pedido
          orderInfo.innerHTML = `
            <div class="flex items-center gap-3 mb-2">
              <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-900">Pedido #${order.id.substring(0, 8)}</p>
                <p class="text-sm text-gray-600">Total: Bs. ${order.total.toFixed(2)}</p>
              </div>
            </div>
          `;
          
          // Mostrar productos del pedido
          if (!order.items || order.items.length === 0) {
            productsList.innerHTML = '<p class="text-sm text-gray-500">No hay productos en este pedido</p>';
            return;
          }
          
          productsList.innerHTML = order.items.map((item: any, index: number) => `
            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
              <input
                type="radio"
                name="return-product"
                value="${item.productId}"
                data-item-id="${item.id}"
                class="w-4 h-4 text-[#5d3fbb] focus:ring-[#5d3fbb] border-gray-300"
                ${index === 0 ? 'checked' : ''}
              />
              <img src="${item.productImage || ''}" alt="${item.productName}" class="w-12 h-12 rounded-lg object-cover border border-gray-200" />
              <div class="flex-1">
                <p class="font-medium text-sm text-gray-900">${item.productName}</p>
                <p class="text-xs text-gray-600">Cantidad: ${item.quantity} √ó Bs. ${item.price.toFixed(2)}</p>
                <p class="text-xs font-semibold text-gray-900 mt-1">Subtotal: Bs. ${item.subtotal.toFixed(2)}</p>
              </div>
            </label>
          `).join('');
          
          // Establecer primer producto como seleccionado por defecto
          if (order.items.length > 0) {
            selectedProductId = order.items[0].productId;
          }
          
          // Event listener para cambio de producto seleccionado
          productsList.querySelectorAll('input[type="radio"]').forEach((radio: any) => {
            radio.addEventListener('change', () => {
              if (radio.checked) {
                selectedProductId = radio.value;
              }
            });
          });
          
          // Limpiar formulario
          if (reasonSelect) reasonSelect.value = '';
          if (descriptionTextarea) descriptionTextarea.value = '';
          
          // Mostrar modal
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
          
        } catch (error) {
          console.error('Error cargando pedido:', error);
          alert('Error al cargar la informaci√≥n del pedido');
        }
      };

      // Funci√≥n para cerrar modal de devoluci√≥n
      function closeReturnRequestModal() {
        const modal = document.getElementById('return-request-modal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          modal.style.display = 'none';
          document.body.style.overflow = '';
          currentReturnOrderId = '';
          selectedProductId = '';
        }
      }

      // Inicializar event listeners para el modal de devoluci√≥n
      function initReturnRequestModal() {
        const returnModal = document.getElementById('return-request-modal');
        const closeBtn = document.getElementById('return-modal-close-btn');
        const cancelBtn = document.getElementById('return-cancel-btn');
        const submitBtn = document.getElementById('return-submit-btn');
        const reasonSelect = document.getElementById('return-reason') as HTMLSelectElement;
        const descriptionTextarea = document.getElementById('return-description') as HTMLTextAreaElement;

        if (!returnModal) return;

        // Bot√≥n cerrar
        if (closeBtn) {
          closeBtn.addEventListener('click', closeReturnRequestModal);
        }

        // Bot√≥n cancelar
        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeReturnRequestModal);
        }

        // Bot√≥n enviar
        if (submitBtn) {
          submitBtn.addEventListener('click', async () => {
            if (!currentReturnOrderId || !selectedProductId) {
              alert('Por favor, selecciona un producto');
              return;
            }

            const reason = reasonSelect?.value;
            const description = descriptionTextarea?.value;

            if (!reason) {
              alert('Por favor, selecciona una raz√≥n de devoluci√≥n');
              return;
            }

            if (!description || description.trim() === '') {
              alert('Por favor, describe el problema o raz√≥n de la devoluci√≥n');
              return;
            }

            // Deshabilitar bot√≥n
            const btn = submitBtn as HTMLButtonElement;
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
              // Obtener userId
              const userId = await getUserId(30, 200);
              if (!userId) {
                throw new Error('No se pudo obtener el ID del usuario');
              }

              // Obtener informaci√≥n del pedido para la direcci√≥n de env√≠o
              const { getOrderById } = await import('../../../lib/db/orders');
              const orderResult = await getOrderById(currentReturnOrderId);
              
              if (!orderResult.data) {
                throw new Error('Pedido no encontrado');
              }

              const order = orderResult.data;
              const selectedItem = order.items.find((item: any) => item.productId === selectedProductId);
              
              if (!selectedItem) {
                throw new Error('Producto no encontrado en el pedido');
              }

              // Crear devoluci√≥n
              const { createReturn } = await import('../../../lib/db/returns');
              
              const returnData = {
                userId: userId,
                orderId: currentReturnOrderId,
                orderItemId: selectedItem.id,
                productId: selectedProductId,
                reason: reason as any,
                description: description.trim(),
                shippingAddress: order.shippingAddress
              };

              const result = await createReturn(returnData);

              if (!result.success) {
                throw result.error || new Error('Error al crear la devoluci√≥n');
              }

              // Mostrar mensaje de √©xito
              alert('¬°Solicitud de devoluci√≥n enviada exitosamente!');
              
              // Cerrar modal
              closeReturnRequestModal();
              
              // Recargar pedidos para actualizar la UI
              await loadOrders();

            } catch (error: any) {
              console.error('Error creando devoluci√≥n:', error);
              alert(error.message || 'Error al enviar la solicitud de devoluci√≥n');
              
              // Restaurar bot√≥n
              const btn = submitBtn as HTMLButtonElement;
              btn.disabled = false;
              btn.textContent = 'Enviar Solicitud';
            }
          });
        }

        // Cerrar modal al hacer clic fuera
        returnModal.addEventListener('click', (e) => {
          if (e.target === returnModal) {
            closeReturnRequestModal();
          }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = document.getElementById('return-request-modal');
            if (modal && !modal.classList.contains('hidden')) {
              closeReturnRequestModal();
            }
          }
        });
      }

      // Funci√≥n para descargar factura
      // @ts-ignore
      window.downloadInvoice = async function(orderId: string, invoiceNumber: string) {
        try {
          const { getOrderById } = await import('../../../lib/db/orders');
          const orderResult = await getOrderById(orderId);
          
          if (!orderResult.data) {
            alert('No se pudo encontrar la orden');
            return;
          }

          // Aqu√≠ puedes implementar la generaci√≥n de PDF o redirecci√≥n a una p√°gina de factura
          // Por ahora, solo mostramos un mensaje
          alert(`Factura: ${invoiceNumber}\n\nLa funcionalidad de descarga de factura estar√° disponible pronto.`);
        } catch (error) {
          console.error('Error al obtener factura:', error);
          alert('Error al obtener la factura');
        }
      };

      // Inicializar modal de calificaci√≥n cuando el DOM est√© listo
      function initRatingModalWhenReady() {
        const ratingModal = document.getElementById('rating-modal');
        if (!ratingModal) {
          setTimeout(initRatingModalWhenReady, 100);
          return;
        }
        initRatingModal();
      }

      // Observer para detectar cuando la secci√≥n de orders se hace visible
      function setupSectionVisibilityObserver() {
        const ordersSection = document.querySelector('[data-profile-section="orders"]');
        if (!ordersSection) {
          // Si la secci√≥n a√∫n no existe, reintentar despu√©s
          setTimeout(setupSectionVisibilityObserver, 200);
          return;
        }

        // Observer para detectar cambios en la visibilidad
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const target = mutation.target as HTMLElement;
              const isVisible = !target.classList.contains('hidden') && 
                               getComputedStyle(target).display !== 'none';
              
              if (isVisible && allOrders.length === 0) {
                // La secci√≥n se hizo visible y a√∫n no hay pedidos cargados
                console.log('üëÅÔ∏è [ORDERS] Secci√≥n visible, cargando pedidos...');
                loadOrders();
              }
            }
          });
        });

        observer.observe(ordersSection, {
          attributes: true,
          attributeFilter: ['class'],
          subtree: false
        });

        // Verificar estado inicial
        const isVisible = !ordersSection.classList.contains('hidden') && 
                         getComputedStyle(ordersSection).display !== 'none';
        
        if (isVisible) {
          console.log('üëÅÔ∏è [ORDERS] Secci√≥n ya visible inicialmente');
          loadOrders();
        }
      }

      // Inicializar cuando el DOM est√© completamente listo
      function initialize() {
        // Verificar nuevamente que todos los elementos est√©n disponibles
        const allElementsPresent = ordersContainer && noOrdersMessage && paginationContainer && 
          searchInput && statusFilterBtn && statusFilterText && statusFilterArrow && 
          statusDropdownMenu && filterDropdownContainer && prevPageBtn && nextPageBtn && 
          paginationNumbers && paginationStart && paginationEnd && paginationTotal && 
          ordersLoading && ordersError;

        if (!allElementsPresent) {
          console.warn('‚ö†Ô∏è [ORDERS] Algunos elementos a√∫n no est√°n disponibles, esperando...');
          setTimeout(initialize, 200);
          return;
        }

        console.log('‚úÖ [ORDERS] Todos los elementos est√°n disponibles, inicializando...');
        
        // Todos los elementos est√°n disponibles, inicializar funcionalidades
        initRatingModalWhenReady();
        initReturnRequestModal();
        
        // Configurar observer para detectar cuando la secci√≥n se hace visible
        setupSectionVisibilityObserver();
      }

      // Esperar a que el DOM est√© completamente cargado
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initialize, 300);
        });
      } else {
        // DOM ya est√° cargado, pero esperar un poco m√°s para asegurar que todos los elementos est√©n renderizados
        setTimeout(initialize, 300);
      }
    })();
  </script>
</section>

