---
const title = 'Mis Pedidos';
---
  // Pedidos Pendientes
  {
    id: '12389',
    date: '25 de enero de 2025',
    status: 'Pendientes',
    statusColor: 'bg-yellow-50 text-yellow-700 border border-yellow-200',
    statusIcon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
    total: 156.80,
    productsCount: 2,
    productImages: [
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  },
  {
    id: '12388',
    date: '24 de enero de 2025',
    status: 'Pendientes',
    statusColor: 'bg-yellow-50 text-yellow-700 border border-yellow-200',
    statusIcon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
    total: 89.50,
    productsCount: 1,
    productImages: [
      'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  },
  // Pedidos Procesando
  {
    id: '12387',
    date: '24 de enero de 2025',
    status: 'Procesando',
    statusColor: 'bg-blue-50 text-blue-700 border border-blue-200',
    statusIcon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15',
    total: 342.90,
    productsCount: 4,
    productImages: [
      'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  },
  // Pedidos En camino
  {
    id: '12386',
    date: '23 de enero de 2025',
    status: 'En camino',
    statusColor: 'bg-purple-50 text-purple-700 border border-purple-200',
    statusIcon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
    total: 278.30,
    productsCount: 3,
    productImages: [
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  },
  {
    id: '12385',
    date: '22 de enero de 2025',
    status: 'En camino',
    statusColor: 'bg-purple-50 text-purple-700 border border-purple-200',
    statusIcon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
    total: 195.60,
    productsCount: 2,
    productImages: [
      'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  },
  // Pedidos Entregados
  {
    id: '12345',
    date: '23 de enero de 2025',
    status: 'Entregados',
    statusColor: 'bg-green-50 text-green-600 border border-green-200',
    statusIcon: 'M5 13l4 4L19 7',
    total: 234.50,
    productsCount: 3,
    productImages: [
      'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura', 'calificar', 'devolver'],
    progressStep: 4, // 1: Pedido Realizado, 2: Procesando, 3: En Camino, 4: Entregado
    products: [
      {
        name: 'Royal Canin Puppy 15kg',
        image: 'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop',
        quantity: 1,
        unitPrice: 150.00,
        subtotal: 150.00
      },
      {
        name: 'Collar Antipulgas',
        image: 'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop',
        quantity: 2,
        unitPrice: 45.00,
        subtotal: 90.00
      }
    ],
    shipping: {
      address: 'Av. Principal 123, Santa Cruz',
      phone: '+591 71234567',
      trackingNumber: 'BOL123456789',
      estimatedDelivery: '25 de enero de 2025'
    }
  },
  {
    id: '12344',
    date: '20 de enero de 2025',
    status: 'Entregados',
    statusColor: 'bg-green-50 text-green-600 border border-green-200',
    statusIcon: 'M5 13l4 4L19 7',
    total: 412.75,
    productsCount: 5,
    productImages: [
      'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura', 'calificar', 'devolver']
  },
  {
    id: '12343',
    date: '18 de enero de 2025',
    status: 'Entregados',
    statusColor: 'bg-green-50 text-green-600 border border-green-200',
    statusIcon: 'M5 13l4 4L19 7',
    total: 128.90,
    productsCount: 2,
    productImages: [
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura', 'calificar', 'devolver']
  },
  // Pedidos Cancelados
  {
    id: '12382',
    date: '21 de enero de 2025',
    status: 'Cancelados',
    statusColor: 'bg-red-50 text-red-700 border border-red-200',
    statusIcon: 'M6 18L18 6M6 6l12 12',
    total: 167.40,
    productsCount: 2,
    productImages: [
      'https://images.unsplash.com/photo-1589924691995-400dc9ecc119?w=100&h=100&fit=crop',
      'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  },
  {
    id: '12381',
    date: '19 de enero de 2025',
    status: 'Cancelados',
    statusColor: 'bg-red-50 text-red-700 border border-red-200',
    statusIcon: 'M6 18L18 6M6 6l12 12',
    total: 98.20,
    productsCount: 1,
    productImages: [
      'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=100&h=100&fit=crop'
    ],
    showActions: ['verDetalles', 'factura']
  }
];

const statusOptions = ['Todos los estados', 'Pendientes', 'Procesando', 'En camino', 'Entregados', 'Cancelados'];
---

<section class="space-y-6">
  <!-- Título -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">{title}</h1>
  </div>

  <!-- Loading State -->
  <div id="orders-loading" class="text-center py-16">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
    <p class="mt-4 text-gray-600">Cargando pedidos...</p>
  </div>

  <!-- Barra de búsqueda y filtros -->
  <div class="flex flex-col sm:flex-row gap-4 mb-6">
    <!-- Barra de búsqueda -->
    <div class="flex-1 relative">
      <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <input
        type="text"
        id="search-input"
        placeholder="Buscar por número de pedido o producto..."
        class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all duration-300"
      />
    </div>

    <!-- Dropdown de filtros -->
    <div class="relative" id="filter-dropdown-container">
      <button
        type="button"
        id="status-filter-btn"
        class="flex items-center gap-2 px-5 py-3 min-w-[180px] rounded-xl border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-100 justify-between"
      >
        <span id="status-filter-text">Todos los estados</span>
        <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" id="status-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      
      <!-- Menú dropdown -->
      <div
        id="status-dropdown-menu"
        class="hidden absolute top-full left-0 mt-2 w-full bg-white border-2 border-gray-200 rounded-xl shadow-lg z-50 overflow-hidden"
      >
        {statusOptions.map((status) => (
          <button
            type="button"
            class="filter-option w-full text-left px-5 py-3 hover:bg-purple-50 transition-colors duration-200 flex items-center justify-between"
            data-status={status === 'Todos los estados' ? 'all' : status.toLowerCase()}
          >
            <span>{status}</span>
            <svg class="h-4 w-4 text-blue-600 check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={status === 'Todos los estados' ? '' : 'display: none;'}>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Contenedor de pedidos -->
  <div id="orders-container" class="space-y-4 min-h-[400px]">
    <!-- Los pedidos se renderizarán aquí con JavaScript -->
  </div>

  <!-- Mensaje cuando no hay pedidos -->
  <div id="no-orders-message" class="hidden text-center py-12">
    <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
    </svg>
    <p class="text-gray-600 text-lg font-medium mb-2">No se encontraron pedidos</p>
    <p class="text-gray-500 text-sm">Intenta cambiar los filtros de búsqueda</p>
  </div>

  <!-- Modal de Calificación -->
  <div id="rating-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-6 lg:p-8">
      <!-- Título -->
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Calificar Pedido</h2>
      
      <!-- Estrellas de calificación -->
      <div class="flex items-center gap-2 mb-6" id="rating-stars">
        <button type="button" class="star-btn text-3xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="1" aria-label="1 estrella">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="2" aria-label="2 estrellas">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="3" aria-label="3 estrellas">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="4" aria-label="4 estrellas">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
        <button type="button" class="star-btn text-3xl text-gray-300 hover:scale-110 transition-transform duration-200" data-rating="5" aria-label="5 estrellas">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
          </svg>
        </button>
      </div>
      
      <!-- Textarea de comentarios -->
      <div class="mb-6">
        <textarea
          id="rating-comment"
          placeholder="Cuéntanos tu experiencia..."
          class="w-full h-32 px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all duration-300 resize-none"
        ></textarea>
      </div>
      
      <!-- Botones de acción -->
      <div class="flex gap-3">
        <button
          type="button"
          id="rating-cancel-btn"
          class="flex-1 px-4 py-3 bg-white text-gray-700 border-2 border-gray-200 rounded-xl font-medium hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95"
        >
          Cancelar
        </button>
        <button
          type="button"
          id="rating-submit-btn"
          class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-all duration-200 hover:shadow-md active:scale-95"
        >
          Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Solicitud de Devolución -->
  <div id="return-request-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 lg:p-8">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Solicitar Devolución</h2>
        <button
          type="button"
          id="close-return-modal-btn"
          class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          aria-label="Cerrar"
        >
          <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Contenido -->
      <div id="return-request-content" class="space-y-6">
        <!-- Se cargará dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Paginación -->
  <div id="pagination-container" class="flex flex-col sm:flex-row items-center justify-between gap-4 mt-6 pt-6 border-t border-gray-200">
    <div class="text-sm text-gray-600">
      Mostrando <span id="pagination-start">0</span> - <span id="pagination-end">0</span> de <span id="pagination-total">0</span> pedidos
    </div>
    <div class="flex items-center gap-2">
      <button
        id="prev-page-btn"
        type="button"
        class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        disabled
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <div id="pagination-numbers" class="flex items-center gap-1">
        <!-- Los números de página se generarán con JavaScript -->
      </div>
      <button
        id="next-page-btn"
        type="button"
        class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <script>
    // Dynamic imports
    let getUserOrders: any, getCurrentUser: any;
    let currentUser: any = null;
    
    (async () => {
      const ordersModule = await import('../../../lib/db/orders');
      getUserOrders = ordersModule.getUserOrders;
      
      const authModule = await import('../../../lib/auth');
      getCurrentUser = authModule.getCurrentUser;
      
      // Get current user
      const firebaseUser = getCurrentUser();
      if (firebaseUser) {
        const userData = localStorage.getItem('user');
        if (userData) {
          try {
            currentUser = JSON.parse(userData);
          } catch (e) {
            console.error('Error parsing user:', e);
          }
        }
      }
      
      if (!currentUser) {
        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        return;
      }
      
      // Load orders
      await loadOrdersFromFirestore();
    })();

    (function() {
      // Configuración
      const ORDERS_PER_PAGE = 3;
      let allOrders: any[] = [];
      let filteredOrders: any[] = [];
      let currentPage = 1;
      let currentFilter = 'all';
      let currentSearch = '';

      // Elementos del DOM
      const ordersContainer = document.getElementById('orders-container');
      const noOrdersMessage = document.getElementById('no-orders-message');
      const paginationContainer = document.getElementById('pagination-container');
      const searchInput = document.getElementById('search-input');
      const statusFilterBtn = document.getElementById('status-filter-btn');
      const statusFilterText = document.getElementById('status-filter-text');
      const statusFilterArrow = document.getElementById('status-filter-arrow');
      const statusDropdownMenu = document.getElementById('status-dropdown-menu');
      const filterDropdownContainer = document.getElementById('filter-dropdown-container');
      const prevPageBtn = document.getElementById('prev-page-btn');
      const nextPageBtn = document.getElementById('next-page-btn');
      const paginationNumbers = document.getElementById('pagination-numbers');
      const paginationStart = document.getElementById('pagination-start');
      const paginationEnd = document.getElementById('pagination-end');
      const paginationTotal = document.getElementById('pagination-total');

      if (!ordersContainer || !noOrdersMessage || !paginationContainer || !searchInput || 
          !statusFilterBtn || !statusFilterText || !statusFilterArrow || !statusDropdownMenu ||
          !filterDropdownContainer || !prevPageBtn || !nextPageBtn || !paginationNumbers ||
          !paginationStart || !paginationEnd || !paginationTotal) {
        console.error('No se pudieron encontrar todos los elementos necesarios');
        return;
      }

      // Load orders from Firestore
      async function loadOrdersFromFirestore() {
        const loadingEl = document.getElementById('orders-loading');
        
        if (!currentUser || !getUserOrders) return;
        
        try {
          const result = await getUserOrders(currentUser.id);
          
          if (result.error) {
            console.error('Error loading orders:', result.error);
            if (loadingEl) loadingEl.classList.add('hidden');
            return;
          }
          
          const ordersData = result.data || [];
          
          // Convert Firestore orders to display format
          allOrders = ordersData.map((order: any) => {
            const orderDate = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt || Date.now());
            const formattedDate = new Intl.DateTimeFormat('es-ES', {
              day: 'numeric',
              month: 'long',
              year: 'numeric'
            }).format(orderDate);
            
            // Map status
            const statusMap: any = {
              'pending': 'Pendientes',
              'processing': 'Procesando',
              'shipped': 'En camino',
              'delivered': 'Entregados',
              'cancelled': 'Cancelados'
            };
            
            const statusColorMap: any = {
              'pending': 'bg-yellow-50 text-yellow-700 border border-yellow-200',
              'processing': 'bg-blue-50 text-blue-700 border border-blue-200',
              'shipped': 'bg-purple-50 text-purple-700 border border-purple-200',
              'delivered': 'bg-green-50 text-green-600 border border-green-200',
              'cancelled': 'bg-red-50 text-red-700 border border-red-200'
            };
            
            const status = statusMap[order.status] || order.status;
            const statusColor = statusColorMap[order.status] || 'bg-gray-50 text-gray-700 border border-gray-200';
            
            // Get product images from items
            const productImages = order.items?.slice(0, 3).map((item: any) => item.productImage || '') || [];
            
            return {
              id: order.id || order.orderNumber || '',
              date: formattedDate,
              status: status,
              statusColor: statusColor,
              statusIcon: '',
              total: order.total || 0,
              productsCount: order.items?.length || 0,
              productImages: productImages,
              showActions: order.status === 'delivered' 
                ? ['verDetalles', 'factura', 'calificar', 'devolver']
                : ['verDetalles', 'factura'],
              progressStep: order.status === 'delivered' ? 4 : 
                           order.status === 'shipped' ? 3 :
                           order.status === 'processing' ? 2 : 1,
              items: order.items || [],
              orderNumber: order.orderNumber || order.id,
              createdAt: order.createdAt
            };
          });
          
          // Sort by date (newest first)
          allOrders.sort((a: any, b: any) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
            return dateB.getTime() - dateA.getTime();
          });
          
          filteredOrders = [...allOrders];
          renderOrders();
          updatePagination();
          
          if (loadingEl) loadingEl.classList.add('hidden');
        } catch (error) {
          console.error('Error loading orders:', error);
          if (loadingEl) loadingEl.classList.add('hidden');
        }
      }

      // Cargar datos (legacy function, now calls Firestore)
      function loadOrders() {
        if (allOrders && allOrders.length > 0) {
          filteredOrders = [...allOrders];
          renderOrders();
          updatePagination();
        }
      }

      // Filtrar pedidos
      function filterOrders() {
        filteredOrders = allOrders.filter((order: any) => {
          // Filtro por estado
          if (currentFilter !== 'all') {
            const orderStatus = order.status.toLowerCase();
            if (orderStatus !== currentFilter) {
              return false;
            }
          }

          // Filtro por búsqueda
          if (currentSearch.trim() !== '') {
            const searchLower = currentSearch.toLowerCase();
            const orderId = order.id.toString().toLowerCase();
            if (!orderId.includes(searchLower)) {
              return false;
            }
          }

          return true;
        });

        currentPage = 1;
        renderOrders();
        updatePagination();
      }

      // Renderizar pedidos
      function renderOrders() {
        if (!ordersContainer || !noOrdersMessage || !paginationContainer) return;
        
        const start = (currentPage - 1) * ORDERS_PER_PAGE;
        const end = start + ORDERS_PER_PAGE;
        const ordersToShow = filteredOrders.slice(start, end);

        if (ordersToShow.length === 0) {
          ordersContainer.classList.add('hidden');
          noOrdersMessage.classList.remove('hidden');
          paginationContainer.classList.add('hidden');
          return;
        }

        ordersContainer.classList.remove('hidden');
        noOrdersMessage.classList.add('hidden');
        paginationContainer.classList.remove('hidden');

        ordersContainer.innerHTML = ordersToShow.map((order: any) => {
          const escapeHtml = (text: any) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };

          const productImagesHtml = order.productImages.map((image: any, idx: number) => 
            '<img src="' + escapeHtml(image) + '" alt="Producto ' + (idx + 1) + '" class="w-20 h-20 rounded-lg object-cover border border-gray-200 shadow-sm" />'
          ).join('');

          // Determinar el paso de progreso
          const progressSteps = [
            { label: 'Pedido Realizado', icon: 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4' },
            { label: 'Procesando', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
            { label: 'En Camino', icon: 'M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4' },
            { label: 'Entregado', icon: 'M5 13l4 4L19 7' }
          ];

          const currentStep = order.progressStep || (order.status === 'Entregados' ? 4 : order.status === 'En camino' ? 3 : order.status === 'Procesando' ? 2 : order.status === 'Pendientes' ? 1 : 1);

          // Productos detallados - si no hay productos detallados, crear desde productImages
          let products = order.products || [];
          if (products.length === 0 && order.productImages && order.productImages.length > 0) {
            const pricePerProduct = order.total / order.productsCount;
            products = order.productImages.map((img: any, idx: number) => ({
              name: 'Producto ' + (idx + 1),
              image: img,
              quantity: 1,
              unitPrice: pricePerProduct,
              subtotal: pricePerProduct
            }));
          }

          // Información de envío - datos por defecto si no existen
          const shipping = order.shipping || {
            address: order.shippingAddress?.address || 'Dirección no disponible',
            phone: order.shippingAddress?.phone || 'Teléfono no disponible',
            trackingNumber: order.trackingNumber || (order.status === 'Pendientes' || order.status === 'pending' ? 'Pendiente de asignación' : 'No asignado'),
            estimatedDelivery: order.status === 'Entregados' || order.status === 'delivered' ? order.date : 'Pendiente de calcular'
          };

          // Barra de progreso HTML
          const progressBarSteps = progressSteps.map((step: any, index: number) => {
            const stepNumber = index + 1;
            const isActive = stepNumber <= currentStep;
            return '<div class="flex flex-col items-center">' +
              '<div class="w-12 h-12 rounded-full flex items-center justify-center border-2 transition-all duration-300 ' + 
              (isActive ? 'bg-purple-600 border-purple-600 text-white' : 'bg-white border-gray-300 text-gray-400') + '">' +
              '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="' + step.icon + '" />' +
              '</svg>' +
              '</div>' +
              '<p class="mt-2 text-xs font-medium ' + (isActive ? 'text-purple-600' : 'text-gray-400') + '">' + step.label + '</p>' +
              '</div>';
          }).join('');

          const progressBarHtml = '<div class="relative mb-6">' +
            '<div class="absolute top-6 left-0 right-0 h-1 bg-gray-200 rounded-full"></div>' +
            '<div class="absolute top-6 left-0 h-1 bg-purple-600 rounded-full transition-all duration-500" style="width: ' + (((currentStep - 1) / 3) * 100) + '%"></div>' +
            '<div class="relative flex justify-between">' +
            progressBarSteps +
            '</div>' +
            '</div>';

          // Productos HTML
          const productsHtml = products.map((product: any) => 
            '<div class="flex items-center gap-4 py-4 border-b border-gray-100 last:border-b-0">' +
            '<img src="' + escapeHtml(product.image) + '" alt="' + escapeHtml(product.name) + '" class="w-16 h-16 rounded-lg object-cover border border-gray-200" />' +
            '<div class="flex-1">' +
            '<h4 class="font-semibold text-gray-900">' + escapeHtml(product.name) + '</h4>' +
            '<p class="text-sm text-gray-600">' + product.quantity + ' x Bs. ' + product.unitPrice.toFixed(2) + '</p>' +
            '</div>' +
            '<p class="font-bold text-gray-900">Bs. ' + product.subtotal.toFixed(2) + '</p>' +
            '</div>'
          ).join('');

          // Información de envío HTML
          const shippingHtml = '<div class="space-y-3">' +
            '<div>' +
            '<p class="text-sm text-gray-600 mb-1">Dirección</p>' +
            '<p class="font-medium text-gray-900">' + escapeHtml(shipping.address) + '</p>' +
            '</div>' +
            '<div>' +
            '<p class="text-sm text-gray-600 mb-1">Teléfono</p>' +
            '<p class="font-medium text-gray-900">' + escapeHtml(shipping.phone) + '</p>' +
            '</div>' +
            '<div>' +
            '<p class="text-sm text-gray-600 mb-1">Número de seguimiento</p>' +
            '<p class="font-medium text-gray-900">' + escapeHtml(shipping.trackingNumber) + '</p>' +
            '</div>' +
            '<div>' +
            '<p class="text-sm text-gray-600 mb-1">Entrega estimada</p>' +
            '<p class="font-medium text-gray-900">' + escapeHtml(shipping.estimatedDelivery) + '</p>' +
            '</div>' +
            '</div>';

          // Botones de acción
          const actionsHtml = [
            order.showActions.includes('verDetalles') ? 
              '<button type="button" onclick="toggleOrderDetails(\'' + order.id + '\')" class="toggle-details-btn flex items-center gap-2 px-4 py-2.5 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-all duration-200 hover:shadow-md active:scale-95" data-order-id="' + order.id + '">' +
              '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />' +
              '</svg>' +
              '<span class="details-btn-text">Ver Detalles</span>' +
              '</button>' : '',
            order.showActions.includes('factura') ? 
              '<button type="button" class="invoice-btn flex items-center gap-2 px-4 py-2.5 bg-white text-gray-700 border-2 border-gray-200 rounded-xl font-medium hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95" data-order-id="' + order.id + '">' +
              '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />' +
              '</svg>' +
              'Factura' +
              '</button>' : '',
            order.showActions.includes('calificar') ? 
              '<button type="button" onclick="openRatingModal(\'' + order.id + '\')" class="rate-order-btn flex items-center gap-2 px-4 py-2.5 bg-yellow-400 text-gray-900 rounded-xl font-medium hover:bg-yellow-500 transition-all duration-200 hover:shadow-md active:scale-95" data-order-id="' + order.id + '">' +
              '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />' +
              '</svg>' +
              'Calificar' +
              '</button>' : '',
            order.showActions.includes('devolver') ? 
              '<button type="button" class="request-return-btn flex items-center gap-2 px-4 py-2.5 bg-white text-gray-700 border-2 border-gray-200 rounded-xl font-medium hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95" data-order-id="' + order.id + '">' +
              '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />' +
              '</svg>' +
              'Devolver' +
              '</button>' : ''
          ].filter(Boolean).join('');

          return '<div class="bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-lg transition-shadow duration-300 p-6 order-card" data-order-id="' + order.id + '">' +
            // Header del pedido
            '<div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-4">' +
            '<div class="flex-1">' +
            '<div class="flex items-center gap-3 mb-2">' +
            '<h2 class="text-2xl font-bold text-gray-900">#' + escapeHtml(order.id) + '</h2>' +
            '<span class="px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1.5 ' + order.statusColor + '">' +
            '<svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">' +
            '<path stroke-linecap="round" stroke-linejoin="round" d="' + order.statusIcon + '" />' +
            '</svg>' +
            escapeHtml(order.status) +
            '</span>' +
            '</div>' +
            '<p class="text-sm text-gray-600">' + escapeHtml(order.date) + '</p>' +
            '</div>' +
            '<div class="text-right">' +
            '<p class="text-2xl font-bold text-gray-900">Bs. ' + order.total.toFixed(2) + '</p>' +
            '<p class="text-sm text-gray-600">' + order.productsCount + ' productos</p>' +
            '</div>' +
            '</div>' +
            // Barra de progreso (se muestra cuando se expanden los detalles)
            '<div class="order-progress-section hidden mb-6" data-progress-order-id="' + order.id + '">' +
            progressBarHtml +
            '</div>' +
            // Miniaturas de productos (visibles cuando se expanden los detalles)
            '<div class="order-thumbnails-section hidden flex gap-3 mb-6" data-thumbnails-order-id="' + order.id + '">' +
            productImagesHtml +
            '</div>' +
            // Botones de acción
            '<div class="flex flex-wrap gap-3 mb-6">' +
            actionsHtml +
            '</div>' +
            // Sección de detalles expandible (productos e información de envío)
            '<div class="order-details-section hidden mt-6 pt-6 border-t border-gray-200" data-details-order-id="' + order.id + '">' +
            '<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">' +
            '<div>' +
            '<h3 class="text-lg font-bold text-gray-900 mb-4">Productos</h3>' +
            '<div class="space-y-0">' +
            productsHtml +
            '</div>' +
            '</div>' +
            '<div>' +
            '<h3 class="text-lg font-bold text-gray-900 mb-4">Información de Envío</h3>' +
            shippingHtml +
            '</div>' +
            '</div>' +
            ${order.shippingCost !== undefined ? `
            '<div class="mt-6 pt-6 border-t border-gray-200">' +
            '<h3 class="text-lg font-bold text-gray-900 mb-4">Resumen</h3>' +
            '<div class="space-y-2">' +
            '<div class="flex justify-between text-gray-600">' +
            '<span>Subtotal:</span>' +
            '<span class="font-medium">Bs. ${(order.subtotal || 0).toFixed(2)}</span>' +
            '</div>' +
            ${order.discount ? `
            '<div class="flex justify-between text-gray-600">' +
            '<span>Descuento:</span>' +
            '<span class="font-medium text-green-600">-Bs. ${order.discount.toFixed(2)}</span>' +
            '</div>' +
            ` : ''}
            '<div class="flex justify-between text-gray-600">' +
            '<span>Envío:</span>' +
            '<span class="font-medium">Bs. ${order.shippingCost.toFixed(2)}</span>' +
            '</div>' +
            '<div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-gray-200">' +
            '<span>Total:</span>' +
            '<span>Bs. ${(order.total || 0).toFixed(2)}</span>' +
            '</div>' +
            '</div>' +
            '</div>' +
            ` : ''}
            '</div>';
        }).join('');
        
        // Adjuntar event listeners a botones de devolución después de renderizar
        setTimeout(() => {
          attachReturnButtons();
        }, 100);
      }

      // Actualizar paginación
      function updatePagination() {
        const totalPages = Math.ceil(filteredOrders.length / ORDERS_PER_PAGE);
        const start = (currentPage - 1) * ORDERS_PER_PAGE + 1;
        const end = Math.min(currentPage * ORDERS_PER_PAGE, filteredOrders.length);

        if (paginationStart) {
          paginationStart.textContent = String(filteredOrders.length > 0 ? start : 0);
        }
        if (paginationEnd) {
          paginationEnd.textContent = String(end);
        }
        if (paginationTotal) {
          paginationTotal.textContent = String(filteredOrders.length);
        }

        // Botones anterior/siguiente
        if (prevPageBtn instanceof HTMLButtonElement) {
          prevPageBtn.disabled = currentPage === 1;
        }
        if (nextPageBtn instanceof HTMLButtonElement) {
          nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // Números de página
        if (paginationNumbers) {
          paginationNumbers.innerHTML = '';
        }
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.type = 'button';
          pageBtn.className = `px-4 py-2 rounded-lg border-2 transition-all duration-200 ${
            i === currentPage
              ? 'border-purple-600 bg-purple-600 text-white'
              : 'border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50'
          }`;
          pageBtn.textContent = String(i);
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            renderOrders();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          if (paginationNumbers) {
            paginationNumbers.appendChild(pageBtn);
          }
        }
      }

      // Event listeners
      searchInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          currentSearch = target.value;
          filterOrders();
        }
      });

      statusFilterBtn.addEventListener('click', () => {
        statusDropdownMenu.classList.toggle('hidden');
        statusFilterArrow.classList.toggle('rotate-180');
      });

      document.querySelectorAll('.filter-option').forEach(option => {
        option.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (!target || !(target instanceof HTMLButtonElement)) return;
          
          const status = target.dataset.status || 'all';
          const span = target.querySelector('span');
          const statusText = span ? span.textContent : 'Todos los estados';
          
          currentFilter = status;
          if (statusFilterText) {
            statusFilterText.textContent = statusText || 'Todos los estados';
          }
          statusDropdownMenu.classList.add('hidden');
          statusFilterArrow.classList.remove('rotate-180');
          
          // Actualizar checkmarks
          document.querySelectorAll('.filter-option').forEach(opt => {
            const checkIcon = opt.querySelector('.check-icon');
            if (checkIcon && checkIcon instanceof SVGElement) {
              checkIcon.style.display = 'none';
            }
          });
          const currentCheckIcon = target.querySelector('.check-icon');
          if (currentCheckIcon && currentCheckIcon instanceof SVGElement) {
            currentCheckIcon.style.display = 'block';
          }
          
          filterOrders();
        });
      });

      // Cerrar dropdown al hacer clic fuera
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (target && filterDropdownContainer && target instanceof Node && !filterDropdownContainer.contains(target)) {
          statusDropdownMenu.classList.add('hidden');
          statusFilterArrow.classList.remove('rotate-180');
        }
      });

      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderOrders();
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredOrders.length / ORDERS_PER_PAGE);
        if (currentPage < totalPages) {
          currentPage++;
          renderOrders();
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      // Función para toggle de detalles del pedido
      // @ts-ignore
      window.toggleOrderDetails = function(orderId: string) {
        const orderCard = document.querySelector('[data-order-id="' + orderId + '"]');
        if (!orderCard) return;

        const progressSection = orderCard.querySelector('[data-progress-order-id="' + orderId + '"]') as HTMLElement;
        const thumbnailsSection = orderCard.querySelector('[data-thumbnails-order-id="' + orderId + '"]') as HTMLElement;
        const detailsSection = orderCard.querySelector('[data-details-order-id="' + orderId + '"]') as HTMLElement;
        const toggleBtn = orderCard.querySelector('.toggle-details-btn[data-order-id="' + orderId + '"]') as HTMLButtonElement;
        const btnText = toggleBtn?.querySelector('.details-btn-text');

        if (!detailsSection || !toggleBtn) return;

        const isHidden = detailsSection.classList.contains('hidden');

        if (isHidden) {
          // Mostrar barra de progreso
          if (progressSection) {
            progressSection.classList.remove('hidden');
            progressSection.style.display = 'block';
          }
          
          // Mostrar miniaturas
          if (thumbnailsSection) {
            thumbnailsSection.classList.remove('hidden');
            thumbnailsSection.style.display = 'flex';
          }
          
          // Mostrar detalles con animación
          detailsSection.style.display = 'block';
          detailsSection.style.maxHeight = '0';
          detailsSection.style.overflow = 'hidden';
          detailsSection.style.transition = 'max-height 0.4s ease-out, opacity 0.4s ease-out';
          detailsSection.classList.remove('hidden');
          
          // Forzar reflow para que la animación funcione
          void detailsSection.offsetHeight;
          
          // Establecer altura máxima para la animación
          detailsSection.style.maxHeight = detailsSection.scrollHeight + 'px';
          detailsSection.style.opacity = '1';
          
          if (btnText) {
            btnText.textContent = 'Ocultar Detalles';
          }
          // Cambiar icono a ojo cerrado
          const iconSvg = toggleBtn.querySelector('svg');
          if (iconSvg) {
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />';
          }
          
          // Después de la animación, remover estilos inline
          setTimeout(() => {
            detailsSection.style.maxHeight = '';
            detailsSection.style.overflow = '';
            detailsSection.style.opacity = '';
          }, 400);
        } else {
          // Ocultar detalles con animación
          detailsSection.style.maxHeight = detailsSection.scrollHeight + 'px';
          detailsSection.style.overflow = 'hidden';
          detailsSection.style.transition = 'max-height 0.4s ease-out, opacity 0.4s ease-out';
          
          // Forzar reflow
          void detailsSection.offsetHeight;
          
          detailsSection.style.maxHeight = '0';
          detailsSection.style.opacity = '0';
          
          // Ocultar barra de progreso
          if (progressSection) {
            progressSection.classList.add('hidden');
            progressSection.style.display = 'none';
          }
          
          // Ocultar miniaturas
          if (thumbnailsSection) {
            thumbnailsSection.classList.add('hidden');
            thumbnailsSection.style.display = 'none';
          }
          
          if (btnText) {
            btnText.textContent = 'Ver Detalles';
          }
          // Cambiar icono a ojo abierto
          const iconSvg = toggleBtn.querySelector('svg');
          if (iconSvg) {
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
          }
          
          // Después de la animación, ocultar completamente
          setTimeout(() => {
            detailsSection.classList.add('hidden');
            detailsSection.style.display = 'none';
            detailsSection.style.maxHeight = '';
            detailsSection.style.overflow = '';
            detailsSection.style.opacity = '';
            detailsSection.style.transition = '';
          }, 400);
        }
      };

      // Funciones para el modal de calificación
      let currentRating = 0;
      let currentOrderId = '';
      let hoveredRating = 0;

      // @ts-ignore
      window.openRatingModal = function(orderId: string) {
        currentOrderId = orderId;
        currentRating = 0;
        hoveredRating = 0;
        
        const modal = document.getElementById('rating-modal');
        const commentTextarea = document.getElementById('rating-comment') as HTMLTextAreaElement;
        
        if (!modal) return;
        
        // Resetear estrellas
        const stars = document.querySelectorAll('.star-btn');
        stars.forEach((star) => {
          const starSvg = star.querySelector('svg');
          if (starSvg) {
            starSvg.setAttribute('fill', 'none');
            starSvg.setAttribute('stroke', 'currentColor');
            starSvg.setAttribute('stroke-width', '2');
          }
          star.classList.remove('text-yellow-400');
          star.classList.add('text-gray-300');
        });
        
        // Limpiar textarea
        if (commentTextarea) {
          commentTextarea.value = '';
        }
        
        // Mostrar modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      };

      // Función para cerrar modal
      function closeRatingModal() {
        const modal = document.getElementById('rating-modal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          modal.style.display = 'none';
          document.body.style.overflow = '';
          currentRating = 0;
          hoveredRating = 0;
          currentOrderId = '';
        }
      }

      // Función para actualizar estrellas
      function updateStars(rating: number) {
        const stars = document.querySelectorAll('.star-btn');
        stars.forEach((star, index) => {
          const starNumber = index + 1;
          const starSvg = star.querySelector('svg');
          
          if (starNumber <= rating) {
            // Estrella llena
            if (starSvg) {
              starSvg.setAttribute('fill', 'currentColor');
              starSvg.removeAttribute('stroke');
              starSvg.removeAttribute('stroke-width');
            }
            star.classList.remove('text-gray-300');
            star.classList.add('text-yellow-400');
          } else {
            // Estrella vacía
            if (starSvg) {
              starSvg.setAttribute('fill', 'none');
              starSvg.setAttribute('stroke', 'currentColor');
              starSvg.setAttribute('stroke-width', '2');
            }
            star.classList.remove('text-yellow-400');
            star.classList.add('text-gray-300');
          }
        });
      }

      // Inicializar event listeners para el modal de calificación
      function initRatingModal() {
        const ratingModal = document.getElementById('rating-modal');
        const stars = document.querySelectorAll('.star-btn');
        const cancelBtn = document.getElementById('rating-cancel-btn');
        const submitBtn = document.getElementById('rating-submit-btn');
        const commentTextarea = document.getElementById('rating-comment') as HTMLTextAreaElement;
        const starsContainer = document.getElementById('rating-stars');

        if (!ratingModal || !starsContainer) return;

        // Click en estrellas
        stars.forEach((star) => {
          star.addEventListener('click', (e) => {
            const target = e.currentTarget;
            if (target && target instanceof HTMLButtonElement) {
              const rating = parseInt(target.getAttribute('data-rating') || '0');
              currentRating = rating;
              updateStars(rating);
            }
          });

          // Hover en estrellas
          star.addEventListener('mouseenter', (e) => {
            const target = e.currentTarget;
            if (target && target instanceof HTMLButtonElement) {
              const rating = parseInt(target.getAttribute('data-rating') || '0');
              hoveredRating = rating;
              updateStars(rating);
            }
          });
        });

        // Mouse leave en contenedor de estrellas
        starsContainer.addEventListener('mouseleave', () => {
          hoveredRating = 0;
          updateStars(currentRating);
        });

        // Botón cancelar
        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeRatingModal);
        }

        // Botón enviar
        if (submitBtn) {
          submitBtn.addEventListener('click', async () => {
            if (currentRating === 0) {
              alert('Por favor, selecciona una calificación');
              return;
            }

            if (!currentUser || !currentOrderId) {
              alert('Error: No se pudo obtener la información del usuario o pedido');
              return;
            }

            const comment = commentTextarea ? commentTextarea.value : '';
            
            // Obtener información del pedido para obtener productId
            let productId = '';
            try {
              const { getOrderById } = await import('../../../lib/db/orders');
              const orderResult = await getOrderById(currentOrderId);
              if (orderResult.data && orderResult.data.items && orderResult.data.items.length > 0) {
                // Calificar el primer producto del pedido (o se puede modificar para calificar todos)
                productId = orderResult.data.items[0].productId;
              } else {
                alert('Error: No se pudo obtener la información del pedido');
                return;
              }
            } catch (error) {
              console.error('Error getting order:', error);
              alert('Error al obtener información del pedido');
              return;
            }
            
            // Enviar calificación a Firestore
            try {
              const { createRating } = await import('../../../lib/db/ratings');
              const ratingResult = await createRating({
                userId: currentUser.id,
                orderId: currentOrderId,
                productId: productId,
                rating: currentRating,
                comment: comment
              });

              if (ratingResult.success) {
                alert('¡Gracias por tu calificación!');
                // Recargar pedidos para actualizar la UI
                if (typeof loadOrdersFromFirestore === 'function') {
                  await loadOrdersFromFirestore();
                }
              } else {
                alert('Error al guardar la calificación: ' + (ratingResult.error?.message || 'Error desconocido'));
                return;
              }
            } catch (error: any) {
              console.error('Error creating rating:', error);
              alert('Error al guardar la calificación: ' + (error.message || 'Error desconocido'));
              return;
            }
            
            // Cerrar modal
            closeRatingModal();
          });
        }

        // Cerrar modal al hacer clic fuera
        ratingModal.addEventListener('click', (e) => {
          if (e.target === ratingModal) {
            closeRatingModal();
          }
        });

        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = document.getElementById('rating-modal');
            if (modal && !modal.classList.contains('hidden')) {
              closeRatingModal();
            }
          }
        });
      }

      // Inicializar modal de calificación cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRatingModal);
      } else {
        initRatingModal();
      }

      // Funcionalidad de devolución
      let createReturn: any, getOrderById: any, getUserAddresses: any;
      let currentReturnOrderId: string | null = null;
      
      (async () => {
        const returnsModule = await import('../../../lib/db/returns');
        createReturn = returnsModule.createReturn;
        
        const ordersModule = await import('../../../lib/db/orders');
        getOrderById = ordersModule.getOrderById;
        
        const usersModule = await import('../../../lib/db/users');
        getUserAddresses = usersModule.getUserAddresses;
        
        initReturnModal();
      })();
      
      // Función para inicializar modal de devolución
      function initReturnModal() {
        const returnModal = document.getElementById('return-request-modal');
        const closeReturnBtn = document.getElementById('close-return-modal-btn');
        const returnContent = document.getElementById('return-request-content');
        
        // Cerrar modal
        if (closeReturnBtn) {
          closeReturnBtn.addEventListener('click', closeReturnModal);
        }
        
        if (returnModal) {
          returnModal.addEventListener('click', (e) => {
            if (e.target === returnModal) {
              closeReturnModal();
            }
          });
        }
        
        // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (returnModal && !returnModal.classList.contains('hidden')) {
              closeReturnModal();
            }
          }
        });
        
        // Adjuntar event listeners a botones de devolución después de renderizar
        setTimeout(() => {
          attachReturnButtons();
        }, 100);
      }
      
      // Función para adjuntar event listeners a botones de devolución
      function attachReturnButtons() {
        document.querySelectorAll('.request-return-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = (e.currentTarget as HTMLElement).getAttribute('data-order-id');
            if (orderId) {
              await openReturnModal(orderId);
            }
          });
        });
      }
      
      // Función para adjuntar event listeners a botones de factura
      function attachInvoiceButtons() {
        document.querySelectorAll('.invoice-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const orderId = (e.currentTarget as HTMLElement).getAttribute('data-order-id');
            if (!orderId) return;
            
            try {
              const { getOrderById } = await import('../../../lib/db/orders');
              const { getCurrentUserData } = await import('../../../lib/auth');
              const { openInvoice } = await import('../../../lib/utils/invoice');
              
              // Obtener pedido
              const orderResult = await getOrderById(orderId);
              if (!orderResult.data) {
                alert('Error: No se pudo obtener la información del pedido');
                return;
              }
              
              // Obtener datos del usuario
              const userResult = await getCurrentUserData();
              if (!userResult.success || !userResult.user) {
                alert('Error: No se pudo obtener la información del usuario');
                return;
              }
              
              // Abrir factura
              openInvoice(orderResult.data, userResult.user);
            } catch (error: any) {
              console.error('Error opening invoice:', error);
              alert('Error al generar la factura: ' + (error.message || 'Error desconocido'));
            }
          });
        });
      }
      
      // Función para abrir modal de devolución
      async function openReturnModal(orderId: string) {
        if (!getOrderById || !getUserAddresses || !currentUser) return;
        
        try {
          const orderResult = await getOrderById(orderId);
          if (!orderResult.data) {
            alert('Error al cargar el pedido');
            return;
          }
          
          const order = orderResult.data;
          currentReturnOrderId = orderId;
          
          // Obtener direcciones del usuario
          const addressesResult = await getUserAddresses(currentUser.id);
          const addresses = addressesResult.data || [];
          
          const returnModal = document.getElementById('return-request-modal');
          const returnContent = document.getElementById('return-request-content');
          
          if (!returnModal || !returnContent) return;
          
          // Renderizar formulario de devolución
          returnContent.innerHTML = `
            <form id="return-request-form" class="space-y-6">
              <!-- Seleccionar producto a devolver -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Producto a Devolver</label>
                <select id="return-product-select" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all" required>
                  <option value="">Selecciona un producto</option>
                  ${order.items?.map((item: any, index: number) => `
                    <option value="${index}" data-product-id="${item.productId}">
                      ${item.productName} - Cantidad: ${item.quantity} - Bs. ${item.subtotal.toFixed(2)}
                    </option>
                  `).join('') || ''}
                </select>
              </div>
              
              <!-- Motivo de devolución -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Motivo de Devolución</label>
                <select id="return-reason-select" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all" required>
                  <option value="">Selecciona un motivo</option>
                  <option value="defective">Producto defectuoso</option>
                  <option value="wrong_item">Pedido incorrecto</option>
                  <option value="damaged">Producto dañado</option>
                  <option value="not_as_described">No coincide con la descripción</option>
                  <option value="other">Otro</option>
                </select>
              </div>
              
              <!-- Descripción -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Descripción</label>
                <textarea
                  id="return-description"
                  rows="4"
                  placeholder="Describe el problema o motivo de la devolución..."
                  class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all resize-none"
                  required
                ></textarea>
              </div>
              
              <!-- Dirección de recogida -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Dirección de Recogida</label>
                <select id="return-address-select" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all" required>
                  <option value="">Selecciona una dirección</option>
                  ${addresses.map((addr: any) => `
                    <option value="${addr.id}" ${addr.isDefault ? 'selected' : ''}>
                      ${addr.name} - ${addr.address}, ${addr.city}
                    </option>
                  `).join('') || ''}
                </select>
              </div>
              
              <!-- Botones -->
              <div class="flex gap-3 pt-4">
                <button
                  type="button"
                  id="cancel-return-btn"
                  class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  id="submit-return-btn"
                  class="flex-1 px-4 py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 transition-colors"
                >
                  Solicitar Devolución
                </button>
              </div>
            </form>
          `;
          
          // Event listeners del formulario
          const returnForm = document.getElementById('return-request-form') as HTMLFormElement;
          const cancelReturnBtn = document.getElementById('cancel-return-btn');
          
          if (returnForm) {
            returnForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              await submitReturnRequest();
            });
          }
          
          if (cancelReturnBtn) {
            cancelReturnBtn.addEventListener('click', closeReturnModal);
          }
          
          returnModal.classList.remove('hidden');
          returnModal.classList.add('flex');
          returnModal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        } catch (error) {
          console.error('Error opening return modal:', error);
          alert('Error al cargar la información del pedido');
        }
      }
      
      // Función para crear solicitud de devolución
      async function submitReturnRequest() {
        if (!createReturn || !currentUser || !currentReturnOrderId) return;
        
        const productSelect = document.getElementById('return-product-select') as HTMLSelectElement;
        const reasonSelect = document.getElementById('return-reason-select') as HTMLSelectElement;
        const descriptionTextarea = document.getElementById('return-description') as HTMLTextAreaElement;
        const addressSelect = document.getElementById('return-address-select') as HTMLSelectElement;
        const submitBtn = document.getElementById('submit-return-btn') as HTMLButtonElement;
        
        if (!productSelect || !reasonSelect || !descriptionTextarea || !addressSelect) return;
        
        const selectedIndex = parseInt(productSelect.value);
        if (isNaN(selectedIndex)) {
          alert('Por favor, selecciona un producto');
          return;
        }
        
        try {
          const orderResult = await getOrderById(currentReturnOrderId);
          if (!orderResult.data) {
            alert('Error al cargar el pedido');
            return;
          }
          
          const order = orderResult.data;
          const selectedItem = order.items[selectedIndex];
          
          if (!selectedItem) {
            alert('Producto no válido');
            return;
          }
          
          // Obtener orderItemId del item (usar id único si existe, sino productId como fallback)
          const orderItemId = selectedItem.id || selectedItem.productId;
          
          // Obtener dirección seleccionada
          const addressesResult = await getUserAddresses(currentUser.id);
          const addresses = addressesResult.data || [];
          const selectedAddress = addresses.find((a: any) => a.id === addressSelect.value);
          
          if (!selectedAddress) {
            alert('Por favor, selecciona una dirección válida');
            return;
          }
          
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Procesando...';
          }
          
          const returnData = {
            userId: currentUser.id,
            orderId: currentReturnOrderId,
            orderItemId: orderItemId, // Usar id único del item
            productId: selectedItem.productId,
            reason: reasonSelect.value as any,
            description: descriptionTextarea.value,
            shippingAddress: selectedAddress
          };
          
          const result = await createReturn(returnData);
          
          if (result.success) {
            alert('Solicitud de devolución creada exitosamente');
            closeReturnModal();
            // Recargar pedidos para actualizar la UI
            await loadOrdersFromFirestore();
          } else {
            alert('Error al crear la solicitud de devolución: ' + (result.error?.message || 'Error desconocido'));
          }
        } catch (error) {
          console.error('Error creating return:', error);
          alert('Error al crear la solicitud de devolución');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Solicitar Devolución';
          }
        }
      }
      
      // Función para cerrar modal de devolución
      function closeReturnModal() {
        const returnModal = document.getElementById('return-request-modal');
        if (returnModal) {
          returnModal.classList.add('hidden');
          returnModal.classList.remove('flex');
          returnModal.style.display = 'none';
        }
        document.body.style.overflow = '';
        currentReturnOrderId = null;
      }
      
      // Note: loadOrdersFromFirestore() is called in the async IIFE above
      // loadOrders() will be called from there after data is loaded
    })();
  </script>
</section>

