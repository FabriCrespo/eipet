---
const title = 'Favoritos';

// Los productos favoritos se cargar√°n din√°micamente desde Firebase
const favoriteProducts: any[] = [];
const categoryOptions = ['Todas las categor√≠as', 'Alimentos', 'Accesorios', 'Juguetes', 'Camas', 'Higiene'];
---

<section class="space-y-4">
  <!-- Header compacto y elegante -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 pb-3 border-b border-gray-200">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <svg class="w-6 h-6 text-[#5d3fbb]" fill="currentColor" viewBox="0 0 24 24">
          <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
        {title}
      </h1>
      <p class="text-xs text-gray-500 mt-1 uppercase tracking-wide">Tus productos guardados</p>
    </div>
  </div>

  <!-- Loading State - Compacto -->
  <div id="favorites-loading" class="flex items-center justify-center min-h-[200px]">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-2 border-[#5d3fbb] border-t-transparent mb-3"></div>
      <p class="text-sm text-gray-500 font-medium">Cargando favoritos...</p>
    </div>
  </div>

  <!-- Error State - Compacto -->
  <div id="favorites-error" class="hidden text-center py-16">
    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-50 mb-4">
      <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <p class="text-gray-900 font-semibold mb-1">Error al cargar los favoritos</p>
    <p class="text-sm text-gray-500 mb-4" id="favorites-error-message"></p>
    <button
      id="favorites-retry-btn"
      class="px-5 py-2 text-sm font-medium bg-[#5d3fbb] text-white rounded-lg hover:bg-[#4d2fa8] transition-colors duration-200"
    >
      Reintentar
    </button>
  </div>

  <!-- Barra de b√∫squeda y filtros -->
  <div class="flex flex-col sm:flex-row gap-3">
    <!-- Barra de b√∫squeda -->
    <div class="flex-1 relative">
      <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <input
        type="text"
        id="search-input"
        placeholder="Buscar productos favoritos..."
        class="w-full pl-10 pr-4 py-2.5 text-sm rounded-lg border border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all duration-200"
      />
    </div>

    <!-- Dropdown de filtros -->
    <div class="relative" id="filter-dropdown-container">
      <button
        type="button"
        id="category-filter-btn"
        class="flex items-center gap-2 px-4 py-2.5 min-w-[160px] text-sm rounded-lg border border-gray-200 bg-white text-gray-700 hover:border-[#5d3fbb] hover:bg-[#5d3fbb]/5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 justify-between"
      >
        <span id="category-filter-text" class="font-medium">Todas las categor√≠as</span>
        <svg class="h-4 w-4 text-gray-400 transition-transform duration-200" id="category-filter-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      
      <!-- Men√∫ dropdown -->
      <div
        id="category-dropdown-menu"
        class="hidden absolute top-full left-0 mt-1.5 w-full bg-white border border-gray-200 rounded-lg shadow-xl z-50 overflow-hidden"
      >
        {categoryOptions.map((category) => (
          <button
            type="button"
            class="filter-option w-full text-left px-4 py-2.5 text-sm hover:bg-[#5d3fbb]/5 transition-colors duration-150 flex items-center justify-between"
            data-category={category === 'Todas las categor√≠as' ? 'all' : category.toLowerCase()}
          >
            <span class="font-medium">{category}</span>
            <svg class="h-4 w-4 text-[#5d3fbb] check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={category === 'Todas las categor√≠as' ? '' : 'display: none;'}>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Contenedor de productos favoritos - Dise√±o creativo -->
  <div id="products-container" class="hidden min-h-[300px] space-y-3">
    <!-- Los productos se renderizar√°n aqu√≠ con JavaScript -->
  </div>

  <!-- Mensaje cuando no hay favoritos elegante -->
  <div id="no-products-message" class="hidden text-center py-16">
    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-50 mb-4">
      <svg class="h-6 w-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
        <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
      </svg>
    </div>
    <p class="text-gray-900 font-semibold mb-1">No se encontraron productos favoritos</p>
    <p class="text-sm text-gray-500">Intenta cambiar los filtros de b√∫squeda</p>
  </div>

  <!-- Paginaci√≥n compacta -->
  <div id="pagination-container" class="flex flex-col sm:flex-row items-center justify-between gap-3 mt-4 pt-3 border-t border-gray-100">
    <div class="text-xs text-gray-500 order-2 sm:order-1">
      <span id="pagination-start" class="font-semibold text-gray-700">0</span> - <span id="pagination-end" class="font-semibold text-gray-700">0</span> de <span id="pagination-total" class="font-semibold text-gray-700">0</span>
    </div>
    <div class="flex items-center gap-1.5 order-1 sm:order-2">
      <button
        id="prev-page-btn"
        type="button"
        class="px-2.5 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 hover:border-[#5d3fbb] hover:bg-[#5d3fbb]/5 hover:text-[#5d3fbb] transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:border-gray-200 disabled:hover:bg-white disabled:hover:text-gray-600"
        disabled
        aria-label="P√°gina anterior"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <div id="pagination-numbers" class="flex items-center gap-1">
        <!-- Los n√∫meros de p√°gina se generar√°n con JavaScript -->
      </div>
      <button
        id="next-page-btn"
        type="button"
        class="px-2.5 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 hover:border-[#5d3fbb] hover:bg-[#5d3fbb]/5 hover:text-[#5d3fbb] transition-all duration-200 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:border-gray-200 disabled:hover:bg-white disabled:hover:text-gray-600"
        aria-label="P√°gina siguiente"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <script>
    (function() {
      // Configuraci√≥n
      const PRODUCTS_PER_PAGE = 8;
      let allProducts: any[] = [];
      let filteredProducts: any[] = [];
      let currentPage = 1;
      let currentFilter = 'all';
      let currentSearch = '';

      // Elementos del DOM
      const productsContainer = document.getElementById('products-container');
      const noProductsMessage = document.getElementById('no-products-message');
      const paginationContainer = document.getElementById('pagination-container');
      const searchInput = document.getElementById('search-input');
      const categoryFilterBtn = document.getElementById('category-filter-btn');
      const categoryFilterText = document.getElementById('category-filter-text');
      const categoryFilterArrow = document.getElementById('category-filter-arrow');
      const categoryDropdownMenu = document.getElementById('category-dropdown-menu');
      const filterDropdownContainer = document.getElementById('filter-dropdown-container');
      const prevPageBtn = document.getElementById('prev-page-btn');
      const nextPageBtn = document.getElementById('next-page-btn');
      const paginationNumbers = document.getElementById('pagination-numbers');
      const paginationStart = document.getElementById('pagination-start');
      const paginationEnd = document.getElementById('pagination-end');
      const paginationTotal = document.getElementById('pagination-total');
      const favoritesLoading = document.getElementById('favorites-loading');
      const favoritesError = document.getElementById('favorites-error');
      const favoritesErrorMessage = document.getElementById('favorites-error-message');
      const favoritesRetryBtn = document.getElementById('favorites-retry-btn');

      // Validar elementos cr√≠ticos
      if (!productsContainer || !noProductsMessage || !paginationContainer || !searchInput || 
          !categoryFilterBtn || !categoryFilterText || !categoryFilterArrow || !categoryDropdownMenu ||
          !filterDropdownContainer || !prevPageBtn || !nextPageBtn || !paginationNumbers ||
          !paginationStart || !paginationEnd || !paginationTotal) {
        console.error('‚ùå No se pudieron encontrar todos los elementos necesarios');
        console.error('Elementos faltantes:', {
          productsContainer: !productsContainer,
          noProductsMessage: !noProductsMessage,
          paginationContainer: !paginationContainer,
          searchInput: !searchInput
        });
        return;
      }
      
      // Elementos opcionales (loading y error pueden no existir inicialmente)
      if (!favoritesLoading) {
        console.warn('‚ö†Ô∏è favorites-loading no encontrado, creando elemento...');
      }
      if (!favoritesError) {
        console.warn('‚ö†Ô∏è favorites-error no encontrado, creando elemento...');
      }

      // Funci√≥n para obtener userId con reintentos
      function getUserId(maxAttempts = 30, delay = 200): Promise<string> {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          
          const tryGetUserId = () => {
            attempts++;
            let userId: string | null = null;
            
            // Intentar obtener desde localStorage
            userId = localStorage.getItem('userId');
            
            // Si no est√° en localStorage, intentar desde window
            if (!userId && typeof window !== 'undefined' && (window as any).currentUserId) {
              userId = (window as any).currentUserId;
            }
            
            // Si a√∫n no est√°, intentar desde el atributo data del contenedor de perfil
            if (!userId) {
              const profilePanel = document.getElementById('profile-content-panel');
              if (profilePanel) {
                userId = profilePanel.getAttribute('data-user-id');
              }
            }
            
            if (userId && userId.trim() !== '') {
              console.log('‚úÖ [FAVORITES] UserId obtenido:', userId);
              resolve(userId);
            } else if (attempts < maxAttempts) {
              setTimeout(tryGetUserId, delay);
            } else {
              reject(new Error('Usuario no autenticado. Por favor, inicia sesi√≥n.'));
            }
          };
          
          tryGetUserId();
        });
      }

      // Verificar si la secci√≥n de favorites est√° visible
      function isFavoritesSectionVisible(): boolean {
        const favoritesSection = document.querySelector('[data-profile-section="favorites"]');
        if (!favoritesSection) return false;
        const isHidden = favoritesSection.classList.contains('hidden') || 
                        (favoritesSection as HTMLElement).style.display === 'none' ||
                        getComputedStyle(favoritesSection).display === 'none';
        return !isHidden;
      }

      // Cargar productos favoritos desde Firebase
      async function loadProducts() {
        try {
          // Verificar que la secci√≥n est√© visible antes de cargar
          if (!isFavoritesSectionVisible()) {
            console.log('‚è≥ [FAVORITES] Secci√≥n no visible, esperando...');
            return;
          }

          // Mostrar loader inmediatamente y ocultar otros estados
          if (favoritesLoading) {
            favoritesLoading.classList.remove('hidden');
            favoritesLoading.style.display = 'flex';
          }
          if (favoritesError) {
            favoritesError.classList.add('hidden');
            favoritesError.style.display = 'none';
          }
          if (productsContainer) {
            productsContainer.classList.add('hidden');
            productsContainer.style.display = 'none';
          }
          if (noProductsMessage) {
            noProductsMessage.classList.add('hidden');
            noProductsMessage.style.display = 'none';
          }

          console.log('üîÑ [FAVORITES] Iniciando carga de favoritos...');
          
          // Esperar a que el userId est√© disponible (mantener loader visible)
          const userId = await getUserId(30, 200); // Hasta 6 segundos (30 intentos x 200ms)
          
          if (!userId || userId.trim() === '') {
            throw new Error('No se pudo obtener el ID del usuario. Por favor, recarga la p√°gina.');
          }
          
          console.log('‚úÖ [FAVORITES] UserId confirmado:', userId);

          // Obtener favoritos del usuario (loader sigue visible)
          console.log('üì¶ [FAVORITES] Obteniendo favoritos para userId:', userId);
          const { getUserFavorites } = await import('../../../lib/db/favorites');
          const favoritesResult = await getUserFavorites(userId);

          console.log('üì¶ [FAVORITES] Resultado de getUserFavorites:', favoritesResult);

          if (favoritesResult.error || !favoritesResult.data) {
            throw new Error(favoritesResult.error?.message || 'Error al cargar favoritos');
          }

          const favoriteProductIds = favoritesResult.data.productIds || [];
          console.log('üì¶ [FAVORITES] IDs de productos favoritos:', favoriteProductIds.length);

          if (favoriteProductIds.length === 0) {
            // No hay favoritos
            console.log('‚ö†Ô∏è No hay productos favoritos');
            allProducts = [];
            filteredProducts = [];
            if (favoritesLoading) {
              favoritesLoading.classList.add('hidden');
              favoritesLoading.style.display = 'none';
            }
            if (productsContainer) {
              productsContainer.classList.add('hidden');
              productsContainer.style.display = 'none';
            }
            if (noProductsMessage) {
              noProductsMessage.classList.remove('hidden');
              noProductsMessage.style.display = 'block';
            }
            if (paginationContainer) {
              paginationContainer.classList.add('hidden');
              paginationContainer.style.display = 'none';
            }
            return;
          }

          // Obtener detalles de los productos favoritos
          console.log('üì¶ Obteniendo detalles de productos...');
          const { getProductById } = await import('../../../lib/db/products');
          const productPromises = favoriteProductIds.map(async (productId: string) => {
            try {
              const result = await getProductById(productId);
              console.log(`üì¶ Producto ${productId}:`, result);
              if (result.data) {
                console.log(`‚úÖ Producto ${productId} encontrado:`, result.data.name);
                return result.data;
              } else {
                console.warn(`‚ö†Ô∏è Producto ${productId} no encontrado o sin datos`);
                if (result.error) {
                  console.error(`‚ùå Error en producto ${productId}:`, result.error);
                }
                return null;
              }
            } catch (error) {
              console.error(`‚ùå Error obteniendo producto ${productId}:`, error);
              return null;
            }
          });

          const products = await Promise.all(productPromises);
          console.log('üì¶ Productos obtenidos (total):', products.length);
          
          allProducts = products.filter(p => p !== null && p !== undefined) as any[];
          console.log('üì¶ Productos v√°lidos (filtrados):', allProducts.length);
          
          if (allProducts.length === 0 && favoriteProductIds.length > 0) {
            console.error('‚ùå No se pudieron cargar los productos. IDs intentados:', favoriteProductIds);
          }
          
          // Mapear productos al formato esperado
          allProducts = allProducts.map((product: any) => {
            const mapped = {
              id: product.id,
              name: product.name,
              price: product.price,
              originalPrice: product.originalPrice || (product.discount ? product.price / (1 - product.discount / 100) : undefined),
              image: product.image || '',
              category: product.category || 'Sin categor√≠a',
              brand: product.brandName || product.brand || 'Sin marca',
              rating: product.rating || 0,
              reviews: product.reviews || 0,
              inStock: (product.stock || 0) > 0,
              discount: product.discount || 0
            };
            console.log(`üì¶ Producto mapeado: ${mapped.name} (${mapped.id})`);
            return mapped;
          });
          
          filteredProducts = [...allProducts];
          console.log('‚úÖ [FAVORITES] Productos cargados exitosamente:', filteredProducts.length);

          // OCULTAR loader SOLO despu√©s de procesar todos los productos
          if (favoritesLoading) {
            favoritesLoading.classList.add('hidden');
            favoritesLoading.style.display = 'none';
          }
          renderProducts();
          updatePagination();
          
          console.log('‚úÖ [FAVORITES] Carga completada exitosamente');
        } catch (error: any) {
          console.error('‚ùå [FAVORITES] Error cargando favoritos:', error);
          // Ocultar loader y mostrar error
          if (favoritesLoading) {
            favoritesLoading.classList.add('hidden');
            favoritesLoading.style.display = 'none';
          }
          if (favoritesError) {
            favoritesError.classList.remove('hidden');
            favoritesError.style.display = 'block';
            if (favoritesErrorMessage) {
              favoritesErrorMessage.textContent = error.message || 'Error desconocido al cargar los favoritos';
            }
          }
          // Asegurar que el contenedor est√© oculto en caso de error
          if (productsContainer) {
            productsContainer.classList.add('hidden');
            productsContainer.style.display = 'none';
          }
        }
      }

      // Bot√≥n de reintentar
      if (favoritesRetryBtn) {
        favoritesRetryBtn.addEventListener('click', loadProducts);
      }

      // Filtrar productos
      function filterProducts() {
        filteredProducts = allProducts.filter((product: any) => {
          // Filtro por categor√≠a
          if (currentFilter !== 'all') {
            const productCategory = product.category.toLowerCase();
            if (productCategory !== currentFilter) {
              return false;
            }
          }

          // Filtro por b√∫squeda
          if (currentSearch.trim() !== '') {
            const searchLower = currentSearch.toLowerCase();
            const productName = product.name.toLowerCase();
            const productBrand = (product.brand || '').toLowerCase();
            if (!productName.includes(searchLower) && !productBrand.includes(searchLower)) {
              return false;
            }
          }

          return true;
        });

        currentPage = 1;
        renderProducts();
        updatePagination();
      }

      // Renderizar productos
      function renderProducts() {
        if (!productsContainer || !noProductsMessage || !paginationContainer) return;
        
        const start = (currentPage - 1) * PRODUCTS_PER_PAGE;
        const end = start + PRODUCTS_PER_PAGE;
        const productsToShow = filteredProducts.slice(start, end);

        if (productsToShow.length === 0) {
          if (productsContainer) {
            productsContainer.classList.add('hidden');
            productsContainer.style.display = 'none';
          }
          if (noProductsMessage) {
            noProductsMessage.classList.remove('hidden');
            noProductsMessage.style.display = 'block';
          }
          if (paginationContainer) {
            paginationContainer.classList.add('hidden');
            paginationContainer.style.display = 'none';
          }
          return;
        }

        if (productsContainer) {
          productsContainer.classList.remove('hidden');
          productsContainer.style.display = 'block';
        }
        if (noProductsMessage) {
          noProductsMessage.classList.add('hidden');
          noProductsMessage.style.display = 'none';
        }
        if (paginationContainer) {
          paginationContainer.classList.remove('hidden');
          paginationContainer.style.display = 'flex';
        }

        productsContainer.innerHTML = productsToShow.map((product: any) => {
          const escapeHtml = (text: any) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };

          const discountBadge = product.discount && product.discount > 0 ? 
            '<span class="absolute top-1.5 left-1.5 bg-red-500 text-white text-[9px] font-bold px-1 py-0.5 rounded shadow-sm z-10">-' + Math.round(product.discount) + '%</span>' : '';
          
          const originalPriceHtml = product.originalPrice && product.originalPrice > product.price ? 
            '<span class="text-[9px] text-gray-400 line-through">Bs. ' + product.originalPrice.toFixed(2) + '</span>' : '';

          const rating = product.rating || 0;
          const reviews = product.reviews || 0;
          const starsHtml = rating > 0 ? Array.from({ length: 5 }, (_, i) => 
            '<svg class="w-2.5 h-2.5 ' + (i < Math.floor(rating) ? 'text-yellow-400 fill-current' : 'text-gray-300') + '" fill="currentColor" viewBox="0 0 24 24">' +
            '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />' +
            '</svg>'
          ).join('') : '';

          const stockBadge = product.inStock ? 
            '<span class="inline-flex items-center gap-0.5 text-[9px] text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded font-medium">' +
            '<svg class="w-2 h-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>' +
            'Stock</span>' :
            '<span class="text-[9px] text-red-600 bg-red-50 px-1.5 py-0.5 rounded font-medium">Sin stock</span>';

          // Dise√±o creativo tipo feed horizontal elegante
          return `
            <div class="group relative overflow-hidden rounded-xl bg-white border border-gray-200/80 hover:border-[#5d3fbb]/50 transition-all duration-300 hover:shadow-lg" data-product-id="${product.id}">
              <!-- Barra lateral de color sutil -->
              <div class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-[#5d3fbb]/0 via-[#5d3fbb]/20 to-[#5d3fbb]/0 group-hover:from-[#5d3fbb] group-hover:via-[#6d4fcc] group-hover:to-[#5d3fbb] transition-all duration-300"></div>
              
              <div class="relative flex items-stretch gap-0">
                <!-- Imagen del producto -->
                <div class="relative shrink-0 w-28 h-28 sm:w-32 sm:h-32 overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100">
                  <img src="${escapeHtml(product.image)}" alt="${escapeHtml(product.name)}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" loading="lazy" />
                  ${discountBadge}
                  <!-- Overlay sutil al hover -->
                  <div class="absolute inset-0 bg-gradient-to-br from-[#5d3fbb]/0 to-[#5d3fbb]/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </div>
                
                <!-- Contenido principal -->
                <div class="flex-1 flex flex-col justify-between p-3.5 min-w-0">
                  <!-- Header -->
                  <div class="flex items-start justify-between gap-2 mb-2">
                    <div class="flex items-center gap-2 flex-wrap flex-1 min-w-0">
                      <span class="text-[10px] text-[#5d3fbb] bg-[#5d3fbb]/10 px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide">${escapeHtml(product.category)}</span>
                      ${stockBadge}
                    </div>
                    <button type="button" class="remove-favorite-btn shrink-0 p-1.5 rounded-lg hover:bg-red-50 text-gray-400 hover:text-red-500 transition-all duration-200" data-product-id="${product.id}" aria-label="Quitar de favoritos">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Nombre y marca -->
                  <div class="mb-2 min-w-0">
                    <h3 class="text-sm font-bold text-gray-900 mb-0.5 leading-tight line-clamp-2 group-hover:text-[#5d3fbb] transition-colors duration-200">${escapeHtml(product.name)}</h3>
                    <p class="text-xs text-gray-500 truncate">${escapeHtml(product.brand)}</p>
                  </div>
                  
                  <!-- Rating -->
                  ${rating > 0 ? `
                  <div class="flex items-center gap-1.5 mb-2">
                    <div class="flex items-center gap-0.5">
                      ${starsHtml}
                    </div>
                    <span class="text-xs font-semibold text-gray-700">${rating.toFixed(1)}</span>
                    ${reviews > 0 ? `<span class="text-[10px] text-gray-400">(${reviews})</span>` : ''}
                  </div>
                  ` : '<div class="mb-2"></div>'}
                  
                  <!-- Footer con precio y acci√≥n -->
                  <div class="flex items-center justify-between gap-3 pt-2 border-t border-gray-100">
                    <div class="flex items-baseline gap-1.5">
                      ${originalPriceHtml}
                      <p class="text-base font-bold bg-gradient-to-r from-[#5d3fbb] to-[#6d4fcc] bg-clip-text text-transparent">Bs. ${product.price.toFixed(2)}</p>
                    </div>
                    <button type="button" class="add-to-cart-favorite-btn shrink-0 px-3 py-1.5 bg-[#5d3fbb] text-white rounded-lg text-xs font-semibold hover:bg-[#4d2fa8] transition-all duration-200 hover:shadow-md active:scale-95 flex items-center gap-1.5" data-product-id="${product.id}">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                      </svg>
                      <span class="hidden sm:inline">Agregar</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        attachEventListeners();
      }

      // Asignar event listeners
      function attachEventListeners() {
        document.querySelectorAll('.remove-favorite-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const target = e.currentTarget;
            if (target && target instanceof HTMLButtonElement) {
              const productId = target.getAttribute('data-product-id');
              if (productId && confirm('¬øEst√°s seguro de quitar este producto de favoritos?')) {
                removeFromFavorites(productId);
              }
            }
          });
        });

        // Event listeners para botones de agregar al carrito
        document.querySelectorAll('.add-to-cart-favorite-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const target = e.currentTarget;
            if (!target || !(target instanceof HTMLButtonElement)) return;
            
            const productId = target.getAttribute('data-product-id');
            if (!productId) return;

            const product = allProducts.find((p: any) => p.id === productId);
            if (!product) return;

            // Usar la funci√≥n addToCart del Header si est√° disponible
            const addToCartFn = (window as any).addToCart;
            if (addToCartFn && typeof addToCartFn === 'function') {
              const success = addToCartFn({
                id: String(product.id),
                name: product.name,
                price: product.price,
                image: product.image || '',
                brandName: product.brand,
                stock: product.inStock ? 999 : 0
              }, 1);
              
              if (success) {
                // Feedback visual
                const originalText = target.innerHTML;
                target.innerHTML = `
                  <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  Agregado
                `;
                target.disabled = true;
                setTimeout(() => {
                  target.innerHTML = originalText;
                  target.disabled = false;
                }, 2000);
              }
            } else {
              alert('Funci√≥n de carrito no disponible. Por favor, recarga la p√°gina.');
            }
          });
        });
      }

      // Quitar de favoritos
      async function removeFromFavorites(productId: string) {
        try {
          // Obtener userId
          let userId: string | null = localStorage.getItem('userId');
          if (!userId && typeof window !== 'undefined' && (window as any).currentUserId) {
            userId = (window as any).currentUserId;
          }
          if (!userId) {
            const profilePanel = document.getElementById('profile-content-panel');
            if (profilePanel) {
              userId = profilePanel.getAttribute('data-user-id');
            }
          }
          
          if (!userId) {
            alert('Usuario no autenticado');
            return;
          }

          // Quitar de Firebase
          const { removeFromFavorites } = await import('../../../lib/db/favorites');
          const result = await removeFromFavorites(userId, productId);

          if (!result.success) {
            throw new Error(result.error?.message || 'Error al quitar de favoritos');
          }

          // Actualizar lista local
          allProducts = allProducts.filter((p: any) => p.id !== productId);
          filteredProducts = filteredProducts.filter((p: any) => p.id !== productId);
          renderProducts();
          updatePagination();

          // Mostrar notificaci√≥n compacta
          const notification = document.createElement('div');
          notification.className = 'fixed top-3 right-3 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 text-sm';
          notification.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span class="font-medium">Eliminado</span>
          `;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 2000);
        } catch (error: any) {
          console.error('Error al quitar de favoritos:', error);
          alert('Error al quitar de favoritos: ' + (error.message || 'Error desconocido'));
        }
      }

      // Actualizar paginaci√≥n
      function updatePagination() {
        const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);
        const start = (currentPage - 1) * PRODUCTS_PER_PAGE + 1;
        const end = Math.min(currentPage * PRODUCTS_PER_PAGE, filteredProducts.length);

        if (paginationStart) {
          paginationStart.textContent = String(filteredProducts.length > 0 ? start : 0);
        }
        if (paginationEnd) {
          paginationEnd.textContent = String(end);
        }
        if (paginationTotal) {
          paginationTotal.textContent = String(filteredProducts.length);
        }

        // Botones anterior/siguiente
        if (prevPageBtn instanceof HTMLButtonElement) {
          prevPageBtn.disabled = currentPage === 1;
        }
        if (nextPageBtn instanceof HTMLButtonElement) {
          nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // N√∫meros de p√°gina
        if (paginationNumbers) {
          paginationNumbers.innerHTML = '';
        }
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.type = 'button';
          pageBtn.className = `px-3 md:px-4 py-2 rounded-xl border-2 transition-all duration-200 text-sm md:text-base ${
            i === currentPage
              ? 'border-rose-600 bg-rose-600 text-white shadow-md'
              : 'border-gray-200 bg-white text-gray-700 hover:border-rose-400 hover:bg-rose-50'
          }`;
          pageBtn.textContent = String(i);
          pageBtn.setAttribute('aria-label', `Ir a p√°gina ${i}`);
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            renderProducts();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
          if (paginationNumbers) {
            paginationNumbers.appendChild(pageBtn);
          }
        }
      }

      // Event listeners
      searchInput.addEventListener('input', (e) => {
        const target = e.target;
        if (target && target instanceof HTMLInputElement) {
          currentSearch = target.value;
          filterProducts();
        }
      });

      categoryFilterBtn.addEventListener('click', () => {
        categoryDropdownMenu.classList.toggle('hidden');
        categoryFilterArrow.classList.toggle('rotate-180');
      });

      document.querySelectorAll('.filter-option').forEach(option => {
        option.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (!target || !(target instanceof HTMLButtonElement)) return;
          
          const category = target.dataset.category || 'all';
          const span = target.querySelector('span');
          const categoryText = span ? span.textContent : 'Todas las categor√≠as';
          
          currentFilter = category;
          if (categoryFilterText) {
            categoryFilterText.textContent = categoryText || 'Todas las categor√≠as';
          }
          categoryDropdownMenu.classList.add('hidden');
          categoryFilterArrow.classList.remove('rotate-180');
          
          // Actualizar checkmarks
          document.querySelectorAll('.filter-option').forEach(opt => {
            const checkIcon = opt.querySelector('.check-icon');
            if (checkIcon && checkIcon instanceof SVGElement) {
              checkIcon.style.display = 'none';
            }
          });
          const currentCheckIcon = target.querySelector('.check-icon');
          if (currentCheckIcon && currentCheckIcon instanceof SVGElement) {
            currentCheckIcon.style.display = 'block';
          }
          
          filterProducts();
        });
      });

      // Cerrar dropdown al hacer clic fuera
      document.addEventListener('click', (e) => {
        const target = e.target;
        if (target && filterDropdownContainer && target instanceof Node && !filterDropdownContainer.contains(target)) {
          categoryDropdownMenu.classList.add('hidden');
          categoryFilterArrow.classList.remove('rotate-180');
        }
      });

      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderProducts();
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);
        if (currentPage < totalPages) {
          currentPage++;
          renderProducts();
          updatePagination();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      // Observer para detectar cuando la secci√≥n de favorites se hace visible
      function setupSectionVisibilityObserver() {
        const favoritesSection = document.querySelector('[data-profile-section="favorites"]');
        if (!favoritesSection) {
          // Si la secci√≥n a√∫n no existe, reintentar despu√©s
          setTimeout(setupSectionVisibilityObserver, 200);
          return;
        }

        // Observer para detectar cambios en la visibilidad
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const target = mutation.target as HTMLElement;
              const isVisible = !target.classList.contains('hidden') && 
                               getComputedStyle(target).display !== 'none';
              
              if (isVisible && allProducts.length === 0) {
                // La secci√≥n se hizo visible y a√∫n no hay productos cargados
                console.log('üëÅÔ∏è [FAVORITES] Secci√≥n visible, cargando favoritos...');
                loadProducts();
              }
            }
          });
        });

        observer.observe(favoritesSection, {
          attributes: true,
          attributeFilter: ['class'],
          subtree: false
        });

        // Verificar estado inicial
        const isVisible = !favoritesSection.classList.contains('hidden') && 
                         getComputedStyle(favoritesSection).display !== 'none';
        
        if (isVisible) {
          console.log('üëÅÔ∏è [FAVORITES] Secci√≥n ya visible inicialmente');
          loadProducts();
        }
      }

      // Inicializar cuando el DOM est√© completamente listo
      function initialize() {
        console.log('‚úÖ [FAVORITES] Inicializando...');
        
        // Configurar observer para detectar cuando la secci√≥n se hace visible
        setupSectionVisibilityObserver();
      }

      // Esperar a que el DOM est√© completamente cargado
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(initialize, 300);
        });
      } else {
        // DOM ya est√° cargado, pero esperar un poco m√°s para asegurar que todos los elementos est√©n renderizados
        setTimeout(initialize, 300);
      }
    })();
  </script>
</section>
