---
const title = 'Mis Direcciones';

// Datos de ejemplo - en producción vendrían de una API o base de datos
const addresses = [
  {
    id: '1',
    name: 'Casa',
    fullName: 'Juan Pérez',
    phone: '+591 70012345',
    address: 'Av. Principal 123',
    city: 'Santa Cruz',
    district: 'Equipetrol',
    zipCode: '0000',
    isDefault: true,
    instructions: 'Llamar antes de llegar'
  },
  {
    id: '2',
    name: 'Oficina',
    fullName: 'Juan Pérez',
    phone: '+591 70012345',
    address: 'Calle Comercio 456, Edificio Central, Piso 3',
    city: 'La Paz',
    district: 'Centro',
    zipCode: '0000',
    isDefault: false,
    instructions: 'Recepción en el piso 3'
  },
  {
    id: '3',
    name: 'Departamento',
    fullName: 'Juan Pérez',
    phone: '+591 70012345',
    address: 'Av. Libertad 789, Bloque A, Dpto 5B',
    city: 'Cochabamba',
    district: 'Zona Sur',
    zipCode: '0000',
    isDefault: false,
    instructions: 'Tocar timbre 5B'
  }
];
---

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
  #address-map {
    height: 300px;
    width: 100%;
    border-radius: 0.75rem;
    z-index: 0;
  }
  .leaflet-container {
    border-radius: 0.75rem;
  }
</style>

<section class="space-y-6">
  <!-- Título y botón añadir -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-3xl font-bold text-gray-900">{title}</h1>
    <button
      type="button"
      id="add-address-btn"
      class="flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700 transition-all duration-200 hover:shadow-md active:scale-95"
    >
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Nueva Dirección
    </button>
  </div>

  <!-- Lista de direcciones -->
  <div id="addresses-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
    {addresses.map((address) => (
      <div class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm hover:shadow-lg transition-shadow duration-300 p-6 relative" data-address-id={address.id}>
        <!-- Badge de dirección por defecto -->
        {address.isDefault && (
          <span class="absolute top-4 right-4 px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded-full">
            Por defecto
          </span>
        )}

        <!-- Nombre de la dirección -->
        <div class="flex items-start justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-900">{address.name}</h3>
          <div class="flex gap-2">
            <button
              type="button"
              class="edit-address-btn p-2 text-gray-400 hover:text-emerald-600 transition-colors"
              data-address-id={address.id}
              aria-label="Editar dirección"
            >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
            <button
              type="button"
              class="delete-address-btn p-2 text-gray-400 hover:text-red-600 transition-colors"
              data-address-id={address.id}
              aria-label="Eliminar dirección"
            >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Información de la dirección -->
        <div class="space-y-2 text-gray-600">
          <p class="font-medium text-gray-900">{address.fullName}</p>
          <p>{address.address}</p>
          <p>{address.district}, {address.city}</p>
          <p>Código Postal: {address.zipCode}</p>
          <p class="flex items-center gap-2 mt-3">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
            {address.phone}
          </p>
          {address.instructions && (
            <p class="mt-3 pt-3 border-t border-gray-200 text-sm italic">
              <span class="font-medium">Instrucciones:</span> {address.instructions}
            </p>
          )}
        </div>

        <!-- Botón establecer como predeterminada -->
        {!address.isDefault && (
          <button
            type="button"
            class="set-default-btn mt-4 w-full px-4 py-2 text-sm font-medium text-emerald-600 border-2 border-emerald-200 rounded-xl hover:bg-emerald-50 transition-all duration-200"
            data-address-id={address.id}
          >
            Establecer como predeterminada
          </button>
        )}
      </div>
    ))}
  </div>

  <!-- Mensaje cuando no hay direcciones -->
  <div id="no-addresses-message" class="hidden text-center py-12">
    <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
    <p class="text-gray-600 text-lg font-medium mb-2">No tienes direcciones registradas</p>
    <p class="text-gray-500 text-sm mb-4">Añade tu primera dirección para comenzar</p>
    <button
      type="button"
      class="inline-flex items-center gap-2 px-6 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700 transition-all duration-200 hover:shadow-md"
      onclick="openAddressModal()"
    >
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Primera Dirección
    </button>
  </div>

  <!-- Modal para añadir/editar dirección -->
  <div id="address-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6 lg:p-8">
      <!-- Header del modal -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Añadir Nueva Dirección</h2>
        <button
          type="button"
          id="close-modal-btn"
          class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
          aria-label="Cerrar modal"
        >
          <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Formulario -->
      <form id="address-form" class="space-y-4">
        <!-- Nombre de la dirección -->
        <div>
          <label for="address-name" class="block text-sm font-medium text-gray-700 mb-2">
            Nombre de la dirección <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="address-name"
            name="name"
            placeholder="Ej: Casa, Oficina, Departamento"
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
          />
        </div>

        <!-- Nombre completo -->
        <div>
          <label for="address-fullname" class="block text-sm font-medium text-gray-700 mb-2">
            Nombre completo <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="address-fullname"
            name="fullName"
            placeholder="Nombre y apellido"
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
          />
        </div>

        <!-- Teléfono -->
        <div>
          <label for="address-phone" class="block text-sm font-medium text-gray-700 mb-2">
            Teléfono <span class="text-red-500">*</span>
          </label>
          <input
            type="tel"
            id="address-phone"
            name="phone"
            placeholder="+591 70012345"
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
          />
        </div>

        <!-- Dirección -->
        <div>
          <label for="address-street" class="block text-sm font-medium text-gray-700 mb-2">
            Dirección <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="address-street"
            name="address"
            placeholder="Calle, número, edificio, etc."
            required
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
          />
        </div>

        <!-- Mapa interactivo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Selecciona la ubicación en el mapa <span class="text-red-500">*</span>
          </label>
          <div id="address-map" class="border-2 border-gray-200 rounded-xl overflow-hidden"></div>
          <p class="text-xs text-gray-500 mt-2">Haz clic en el mapa para marcar la ubicación exacta</p>
          <input type="hidden" id="address-latitude" name="latitude" />
          <input type="hidden" id="address-longitude" name="longitude" />
        </div>

        <!-- Grid: Distrito y Ciudad -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="address-district" class="block text-sm font-medium text-gray-700 mb-2">
              Distrito/Zona <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="address-district"
              name="district"
              placeholder="Ej: Equipetrol, Centro"
              required
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
            />
          </div>
          <div>
            <label for="address-city" class="block text-sm font-medium text-gray-700 mb-2">
              Ciudad <span class="text-red-500">*</span>
            </label>
            <select
              id="address-city"
              name="city"
              required
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
            >
              <option value="">Selecciona una ciudad</option>
              <option value="Santa Cruz">Santa Cruz</option>
              <option value="La Paz">La Paz</option>
              <option value="Cochabamba">Cochabamba</option>
              <option value="Sucre">Sucre</option>
              <option value="Oruro">Oruro</option>
              <option value="Potosí">Potosí</option>
              <option value="Tarija">Tarija</option>
              <option value="Beni">Beni</option>
              <option value="Pando">Pando</option>
            </select>
          </div>
        </div>

        <!-- Código Postal -->
        <div>
          <label for="address-zip" class="block text-sm font-medium text-gray-700 mb-2">
            Código Postal
          </label>
          <input
            type="text"
            id="address-zip"
            name="zipCode"
            placeholder="0000"
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300"
          />
        </div>

        <!-- Instrucciones de entrega -->
        <div>
          <label for="address-instructions" class="block text-sm font-medium text-gray-700 mb-2">
            Instrucciones de entrega (opcional)
          </label>
          <textarea
            id="address-instructions"
            name="instructions"
            rows="3"
            placeholder="Ej: Llamar antes de llegar, Tocar timbre, etc."
            class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-emerald-400 focus:outline-none focus:ring-4 focus:ring-emerald-100 transition-all duration-300 resize-none"
          ></textarea>
        </div>

        <!-- Checkbox dirección por defecto -->
        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            id="address-default"
            name="isDefault"
            class="w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500 focus:ring-2"
          />
          <label for="address-default" class="text-sm font-medium text-gray-700">
            Establecer como dirección predeterminada
          </label>
        </div>

        <!-- Botones de acción -->
        <div class="flex gap-3 pt-4">
          <button
            type="button"
            id="cancel-form-btn"
            class="flex-1 px-4 py-3 bg-white text-gray-700 border-2 border-gray-200 rounded-xl font-medium hover:border-gray-300 hover:bg-gray-50 transition-all duration-200 active:scale-95"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-xl font-medium hover:bg-emerald-700 transition-all duration-200 hover:shadow-md active:scale-95"
          >
            Guardar Dirección
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  (function() {
    // @ts-ignore
    let addresses = (window.addressesData || []) as any[];
    let editingAddressId: string | null = null;
    let map: any = null;
    let marker: any = null;

    // Coordenadas por defecto (centro de Bolivia - Santa Cruz)
    const defaultLat = -17.8146;
    const defaultLng = -63.1561;
    const defaultZoom = 5;

    // Elementos del DOM
    const addressesContainer = document.getElementById('addresses-container');
    const noAddressesMessage = document.getElementById('no-addresses-message');
    const addAddressBtn = document.getElementById('add-address-btn');
    const addressModal = document.getElementById('address-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const cancelFormBtn = document.getElementById('cancel-form-btn');
    const addressForm = document.getElementById('address-form') as HTMLFormElement;
    const modalTitle = document.getElementById('modal-title');
    const mapContainer = document.getElementById('address-map');
    const latitudeInput = document.getElementById('address-latitude') as HTMLInputElement;
    const longitudeInput = document.getElementById('address-longitude') as HTMLInputElement;

    // Función para renderizar direcciones
    function renderAddresses() {
      if (!addressesContainer || !noAddressesMessage) return;

      if (addresses.length === 0) {
        addressesContainer.classList.add('hidden');
        noAddressesMessage.classList.remove('hidden');
        return;
      }

      addressesContainer.classList.remove('hidden');
      noAddressesMessage.classList.add('hidden');

      addressesContainer.innerHTML = addresses.map((address: any) => {
        const escapeHtml = (text: any) => {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        };

        return '<div class="bg-white rounded-2xl border-2 border-gray-200 shadow-sm hover:shadow-lg transition-shadow duration-300 p-6 relative" data-address-id="' + address.id + '">' +
          (address.isDefault ? '<span class="absolute top-4 right-4 px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded-full">Por defecto</span>' : '') +
          '<div class="flex items-start justify-between mb-4">' +
          '<h3 class="text-xl font-bold text-gray-900">' + escapeHtml(address.name) + '</h3>' +
          '<div class="flex gap-2">' +
          '<button type="button" class="edit-address-btn p-2 text-gray-400 hover:text-emerald-600 transition-colors" data-address-id="' + address.id + '" aria-label="Editar dirección">' +
          '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' +
          '</button>' +
          '<button type="button" class="delete-address-btn p-2 text-gray-400 hover:text-red-600 transition-colors" data-address-id="' + address.id + '" aria-label="Eliminar dirección">' +
          '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
          '</button>' +
          '</div>' +
          '</div>' +
          '<div class="space-y-2 text-gray-600">' +
          '<p class="font-medium text-gray-900">' + escapeHtml(address.fullName) + '</p>' +
          '<p>' + escapeHtml(address.address) + '</p>' +
          '<p>' + escapeHtml(address.district) + ', ' + escapeHtml(address.city) + '</p>' +
          '<p>Código Postal: ' + escapeHtml(address.zipCode) + '</p>' +
          '<p class="flex items-center gap-2 mt-3">' +
          '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>' +
          escapeHtml(address.phone) +
          '</p>' +
          (address.instructions ? '<p class="mt-3 pt-3 border-t border-gray-200 text-sm italic"><span class="font-medium">Instrucciones:</span> ' + escapeHtml(address.instructions) + '</p>' : '') +
          '</div>' +
          (!address.isDefault ? '<button type="button" class="set-default-btn mt-4 w-full px-4 py-2 text-sm font-medium text-emerald-600 border-2 border-emerald-200 rounded-xl hover:bg-emerald-50 transition-all duration-200" data-address-id="' + address.id + '">Establecer como predeterminada</button>' : '') +
          '</div>';
      }).join('');

      // Re-asignar event listeners
      attachEventListeners();
    }

    // Función para inicializar el mapa
    function initMap(lat?: number, lng?: number) {
      if (!mapContainer) return;

      // Destruir mapa existente si existe
      if (map) {
        map.remove();
        map = null;
        marker = null;
      }

      // Coordenadas iniciales
      const initialLat = lat || defaultLat;
      const initialLng = lng || defaultLng;
      const initialZoom = lat && lng ? 15 : defaultZoom;

      // Crear mapa
      // @ts-ignore
      map = L.map('address-map').setView([initialLat, initialLng], initialZoom);

      // Agregar capa de OpenStreetMap
      // @ts-ignore
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      // Si hay coordenadas, agregar marcador
      if (lat && lng) {
        // @ts-ignore
        marker = L.marker([lat, lng], {
          draggable: true
        }).addTo(map);

        // Actualizar coordenadas cuando se arrastra el marcador
        marker.on('dragend', function() {
          const position = marker.getLatLng();
          if (latitudeInput) latitudeInput.value = position.lat.toString();
          if (longitudeInput) longitudeInput.value = position.lng.toString();
        });
      }

      // Agregar marcador al hacer clic en el mapa
      map.on('click', function(e: any) {
        const clickedLat = e.latlng.lat;
        const clickedLng = e.latlng.lng;

        // Actualizar inputs
        if (latitudeInput) latitudeInput.value = clickedLat.toString();
        if (longitudeInput) longitudeInput.value = clickedLng.toString();

        // Eliminar marcador anterior si existe
        if (marker) {
          map.removeLayer(marker);
        }

        // Agregar nuevo marcador
        // @ts-ignore
        marker = L.marker([clickedLat, clickedLng], {
          draggable: true
        }).addTo(map);

        // Actualizar coordenadas cuando se arrastra el marcador
        marker.on('dragend', function() {
          const position = marker.getLatLng();
          if (latitudeInput) latitudeInput.value = position.lat.toString();
          if (longitudeInput) longitudeInput.value = position.lng.toString();
        });
      });

      // Invalidar tamaño del mapa después de un pequeño delay para asegurar que se renderice correctamente
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
        }
      }, 100);
    }

    // Función para abrir modal
    function openAddressModal(addressId?: string) {
      if (!addressModal || !modalTitle) return;

      editingAddressId = addressId || null;

      if (editingAddressId) {
        const address = addresses.find((a: any) => a.id === editingAddressId);
        if (address && addressForm) {
          (document.getElementById('address-name') as HTMLInputElement).value = address.name;
          (document.getElementById('address-fullname') as HTMLInputElement).value = address.fullName;
          (document.getElementById('address-phone') as HTMLInputElement).value = address.phone;
          (document.getElementById('address-street') as HTMLInputElement).value = address.address;
          (document.getElementById('address-district') as HTMLInputElement).value = address.district;
          (document.getElementById('address-city') as HTMLSelectElement).value = address.city;
          (document.getElementById('address-zip') as HTMLInputElement).value = address.zipCode;
          (document.getElementById('address-instructions') as HTMLTextAreaElement).value = address.instructions || '';
          (document.getElementById('address-default') as HTMLInputElement).checked = address.isDefault || false;
          
          // Inicializar mapa con coordenadas de la dirección si existen
          const lat = address.latitude ? parseFloat(address.latitude) : undefined;
          const lng = address.longitude ? parseFloat(address.longitude) : undefined;
          if (latitudeInput) latitudeInput.value = lat ? lat.toString() : '';
          if (longitudeInput) longitudeInput.value = lng ? lng.toString() : '';
          
          modalTitle.textContent = 'Editar Dirección';
        }
      } else {
        if (addressForm) {
          addressForm.reset();
        }
        if (latitudeInput) latitudeInput.value = '';
        if (longitudeInput) longitudeInput.value = '';
        modalTitle.textContent = 'Añadir Nueva Dirección';
      }

      addressModal.classList.remove('hidden');
      addressModal.classList.add('flex');
      addressModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      // Inicializar mapa después de que el modal sea visible
      setTimeout(() => {
        const lat = latitudeInput?.value ? parseFloat(latitudeInput.value) : undefined;
        const lng = longitudeInput?.value ? parseFloat(longitudeInput.value) : undefined;
        initMap(lat, lng);
      }, 300);
    }

    // Función para cerrar modal
    function closeAddressModal() {
      if (!addressModal) return;
      
      // Destruir mapa
      if (map) {
        map.remove();
        map = null;
        marker = null;
      }
      
      addressModal.classList.add('hidden');
      addressModal.classList.remove('flex');
      addressModal.style.display = 'none';
      document.body.style.overflow = '';
      editingAddressId = null;
      if (addressForm) {
        addressForm.reset();
      }
      if (latitudeInput) latitudeInput.value = '';
      if (longitudeInput) longitudeInput.value = '';
    }

    // Función para guardar dirección
    function saveAddress(formData: FormData) {
      const lat = latitudeInput?.value || '';
      const lng = longitudeInput?.value || '';
      
      if (!lat || !lng) {
        alert('Por favor, selecciona una ubicación en el mapa haciendo clic en él');
        return;
      }

      const addressData: any = {
        id: editingAddressId || String(Date.now()),
        name: formData.get('name') as string,
        fullName: formData.get('fullName') as string,
        phone: formData.get('phone') as string,
        address: formData.get('address') as string,
        district: formData.get('district') as string,
        city: formData.get('city') as string,
        zipCode: formData.get('zipCode') as string || '0000',
        instructions: formData.get('instructions') as string || '',
        isDefault: formData.get('isDefault') === 'on',
        latitude: lat,
        longitude: lng
      };

      // Si es dirección por defecto, quitar el flag de las demás
      if (addressData.isDefault) {
        addresses = addresses.map((a: any) => ({ ...a, isDefault: false }));
      }

      if (editingAddressId) {
        // Editar dirección existente
        const index = addresses.findIndex((a: any) => a.id === editingAddressId);
        if (index !== -1) {
          addresses[index] = { ...addresses[index], ...addressData };
        }
      } else {
        // Añadir nueva dirección
        addresses.push(addressData);
      }

      renderAddresses();
      closeAddressModal();
    }

    // Función para eliminar dirección
    function deleteAddress(addressId: string) {
      if (confirm('¿Estás seguro de que deseas eliminar esta dirección?')) {
        addresses = addresses.filter((a: any) => a.id !== addressId);
        renderAddresses();
      }
    }

    // Función para establecer como predeterminada
    function setDefaultAddress(addressId: string) {
      addresses = addresses.map((a: any) => ({
        ...a,
        isDefault: a.id === addressId
      }));
      renderAddresses();
    }

    // Función para asignar event listeners
    function attachEventListeners() {
      // Botones editar
      document.querySelectorAll('.edit-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              openAddressModal(addressId);
            }
          }
        });
      });

      // Botones eliminar
      document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              deleteAddress(addressId);
            }
          }
        });
      });

      // Botones establecer como predeterminada
      document.querySelectorAll('.set-default-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              setDefaultAddress(addressId);
            }
          }
        });
      });
    }

    // Event listeners iniciales
    if (addAddressBtn) {
      addAddressBtn.addEventListener('click', () => openAddressModal());
    }

    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeAddressModal);
    }

    if (cancelFormBtn) {
      cancelFormBtn.addEventListener('click', closeAddressModal);
    }

    if (addressForm) {
      addressForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(addressForm);
        saveAddress(formData);
      });
    }

    // Cerrar modal al hacer clic fuera
    if (addressModal) {
      addressModal.addEventListener('click', (e) => {
        if (e.target === addressModal) {
          closeAddressModal();
        }
      });
    }

    // Cerrar modal con ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (addressModal && !addressModal.classList.contains('hidden')) {
          closeAddressModal();
        }
      }
    });

    // Función global para abrir modal desde el mensaje de "no hay direcciones"
    // @ts-ignore
    window.openAddressModal = openAddressModal;

    // Pasar datos al cliente
    // @ts-ignore
    window.addressesData = addresses;

    // Renderizar inicialmente
    renderAddresses();
  })();
</script>
