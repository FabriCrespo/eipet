---
import ConfirmModal from '../../ConfirmModal.astro';
import AddressModal from '../AddressModal.astro';
import AddressCard from '../AddressCard.astro';

const title = 'Mis Direcciones';
// Las direcciones se cargan dinámicamente desde Firebase
const addresses: any[] = [];

---

<style>
  /* Animación de pulso para el icono de ubicación */
  @keyframes locationPulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }
  
  @keyframes locationRipple {
    0% {
      transform: scale(0.8);
      opacity: 0.8;
    }
    100% {
      transform: scale(2);
      opacity: 0;
    }
  }
  
  .location-icon-animated {
    animation: locationPulse 2s ease-in-out infinite;
  }
  
  .location-ripple {
    position: absolute;
    border: 2px solid rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    animation: locationRipple 2s ease-out infinite;
  }
  
  /* Animación de ondas para el fondo */
  @keyframes wave {
    0%, 100% {
      transform: translateX(0) translateY(0);
    }
    50% {
      transform: translateX(-25px) translateY(-25px);
    }
  }
  
  .wave-bg {
    position: absolute;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 50px 50px;
    animation: wave 20s linear infinite;
    opacity: 0.3;
  }
</style>

<section class="space-y-6">
  <!-- Título y botón añadir -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">{title}</h1>
    <button
      type="button"
      id="add-address-btn"
      class="flex items-center gap-2 px-5 py-2.5 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all duration-200"
    >
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Nueva Dirección
    </button>
  </div>

  <!-- Lista de direcciones -->
  <div id="addresses-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
    {addresses.map((address) => (
      <AddressCard address={address} />
    ))}
  </div>

  <!-- Mensaje cuando no hay direcciones -->
  <div id="no-addresses-message" class="hidden text-center py-12">
    <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
    <p class="text-gray-700 text-base font-medium mb-2">No tienes direcciones registradas</p>
    <p class="text-gray-500 text-sm mb-5">Añade tu primera dirección para comenzar</p>
    <button
      type="button"
      class="inline-flex items-center gap-2 px-5 py-2.5 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-all duration-200"
      onclick="openAddressModal()"
    >
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Primera Dirección
    </button>
  </div>
</section>

<!-- Modal de direcciones -->
<AddressModal />

<!-- Modal de confirmación para eliminar -->

<ConfirmModal id="delete-address-modal" />

<script>
  (async function() {
    // Variables globales
    let addresses: any[] = [];
    let editingAddressId: string | null = null;
    let currentUserId: string | null = null;

    // Elementos del DOM
    const addressesContainer = document.getElementById('addresses-container');
    const noAddressesMessage = document.getElementById('no-addresses-message');
    const addAddressBtn = document.getElementById('add-address-btn');

    // Obtener userId del usuario autenticado - espera a que Firebase Auth esté listo
    async function getCurrentUserId(): Promise<string | null> {
      try {
        // Primero intentar obtener desde localStorage (más rápido, ya está guardado por profile/index.astro)
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            if (user?.id) {
              return user.id;
            }
          } catch (e) {
            console.error('Error parsing user from localStorage:', e);
          }
        }

        // Si no está en localStorage, esperar a que Firebase Auth esté listo
        const { onAuthStateChange, getCurrentUser } = await import('../../../lib/auth.js');
        
        // Verificar si ya hay un usuario autenticado
        const currentUser = getCurrentUser();
        if (currentUser?.uid) {
          return currentUser.uid;
        }
        
        // Si no hay usuario, esperar a que Firebase Auth se inicialice
        return new Promise<string | null>((resolve) => {
          let resolved = false;
          
          const unsubscribe = onAuthStateChange((firebaseUser) => {
            if (resolved) return;
            resolved = true;
            unsubscribe();
            
            if (firebaseUser?.uid) {
              resolve(firebaseUser.uid);
            } else {
              resolve(null);
            }
          });
          
          // Timeout de seguridad (2 segundos debería ser suficiente)
          setTimeout(() => {
            if (!resolved) {
              resolved = true;
              unsubscribe();
              resolve(null);
            }
          }, 2000);
        });
      } catch (error) {
        console.error('Error obteniendo usuario:', error);
        return null;
      }
    }

    // Cargar direcciones desde Firebase
    async function loadAddresses() {
      try {
        if (!currentUserId) {
          console.error('No hay usuario autenticado');
          return;
        }

        const { getUserAddresses } = await import('../../../lib/db/users.js');
        const result = await getUserAddresses(currentUserId);

        if (result.error) {
          console.error('Error cargando direcciones:', result.error);
          addresses = [];
        } else {
          // Convertir timestamps de Firestore a formato compatible
          addresses = result.data.map((addr: any) => ({
            ...addr,
            latitude: addr.latitude ? parseFloat(addr.latitude.toString()) : undefined,
            longitude: addr.longitude ? parseFloat(addr.longitude.toString()) : undefined,
          }));
        }

        renderAddresses();
      } catch (error) {
        console.error('Error en loadAddresses:', error);
        addresses = [];
        renderAddresses();
      }
    }

    // Función para renderizar direcciones
    function renderAddresses() {
      if (!addressesContainer || !noAddressesMessage) return;

      if (addresses.length === 0) {
        addressesContainer.classList.add('hidden');
        noAddressesMessage.classList.remove('hidden');
        return;
      }

      addressesContainer.classList.remove('hidden');
      noAddressesMessage.classList.add('hidden');

      addressesContainer.innerHTML = addresses.map((address: any) => {
        const escapeHtml = (text: any) => {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        };

        return '<div class="relative bg-gradient-to-br from-emerald-600 to-emerald-700 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group" data-address-id="' + address.id + '">' +
          '<div class="wave-bg absolute -top-1/2 -left-1/2 pointer-events-none"></div>' +
          '<div class="relative z-10 h-full flex flex-col p-4">' +
          '<div class="flex items-start justify-between mb-1">' +
          (address.isDefault ? '<span class="px-2 py-1 bg-emerald-600 text-white text-[10px] font-bold rounded-md shadow">⭐ Por defecto</span>' : '<span></span>') +
          '<div class="flex flex-col gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 ml-auto">' +
          '<button type="button" class="edit-address-btn p-1.5 bg-white rounded-md shadow hover:bg-emerald-50 transition-all duration-200 hover:scale-105" data-address-id="' + address.id + '" aria-label="Editar dirección">' +
          '<svg class="h-3.5 w-3.5 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' +
          '</button>' +
          '<button type="button" class="delete-address-btn p-1.5 bg-white rounded-md shadow hover:bg-red-50 transition-all duration-200 hover:scale-105" data-address-id="' + address.id + '" aria-label="Eliminar dirección">' +
          '<svg class="h-3.5 w-3.5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
          '</button>' +
          '</div>' +
          '</div>' +
          '<div class="text-white">' +
          '<div class="relative inline-flex items-center mb-2">' +
          '<div class="location-ripple"></div>' +
          '<svg class="location-icon-animated h-5 w-5 text-white/90" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>' +
          '</div>' +
          '<h3 class="text-xl font-bold mb-1 drop-shadow-lg">' + escapeHtml(address.name) + '</h3>' +
          '<p class="text-xs text-white/90 drop-shadow-md font-medium mb-2">' + escapeHtml(address.district) + ', ' + escapeHtml(address.city) + '</p>' +
          '<div class="space-y-1 mb-2">' +
          '<p class="text-xs text-white/95 font-semibold">' + escapeHtml(address.fullName) + '</p>' +
          '<p class="text-[11px] text-white/85 leading-snug">' + escapeHtml(address.address) + '</p>' +
          '</div>' +
          '<div class="flex items-center gap-1.5 text-[11px] text-white/90 mb-2 pb-2 border-b border-white/20">' +
          '<svg class="h-3.5 w-3.5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>' +
          '<span class="font-medium">' + escapeHtml(address.phone) + '</span>' +
          '</div>' +
          (address.instructions ? '<div class="mb-2"><p class="text-[11px] text-white/70 mb-1 font-medium">Instrucciones:</p><p class="text-[11px] text-white/90 leading-snug">' + escapeHtml(address.instructions) + '</p></div>' : '') +
          (!address.isDefault ? '<button type="button" class="set-default-btn w-full px-3 py-2 text-[11px] font-semibold text-emerald-700 bg-white rounded-md hover:bg-emerald-50 hover:shadow transition-all duration-200" data-address-id="' + address.id + '">Establecer como predeterminada</button>' : '') +
          '</div>' +
          '</div>' +
          '</div>';
      }).join('');

      // Re-asignar event listeners
      attachEventListeners();
    }

    // Función para abrir modal
    function openAddressModal(addressId?: string) {
      editingAddressId = addressId || null;

      // Obtener datos de la dirección si está editando
      const addressData = editingAddressId 
        ? addresses.find((a: any) => a.id === editingAddressId)
        : undefined;

      // Abrir modal usando la API
      if (typeof (window as any).addressModalAPI !== 'undefined') {
        (window as any).addressModalAPI.open(addressData);
      }
    }

    // Función para guardar dirección
    async function saveAddress(formData: FormData) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      // Obtener inputs de coordenadas desde la API del modal
      const latitudeInput = (window as any).addressModalAPI?.getLatitudeInput();
      const longitudeInput = (window as any).addressModalAPI?.getLongitudeInput();
      const saveBtn = (window as any).addressModalAPI?.getSaveButton();
      const saveBtnText = (window as any).addressModalAPI?.getSaveButtonText();
      const saveBtnLoading = (window as any).addressModalAPI?.getSaveButtonLoading();

      const lat = latitudeInput?.value || '';
      const lng = longitudeInput?.value || '';
      
      if (!lat || !lng) {
        alert('Por favor, selecciona una ubicación en el mapa haciendo clic en él');
        return;
      }

      // Mostrar loader
      if (saveBtn) saveBtn.disabled = true;
      if (saveBtnText) saveBtnText.classList.add('hidden');
      if (saveBtnLoading) {
        saveBtnLoading.classList.remove('hidden');
        saveBtnLoading.classList.add('flex');
      }

      try {
        const { addAddress, updateAddress } = await import('../../../lib/db/users.js');

        const addressData: any = {
          name: formData.get('name') as string,
          fullName: formData.get('fullName') as string,
          phone: formData.get('phone') as string,
          address: formData.get('address') as string,
          district: formData.get('district') as string,
          city: formData.get('city') as string,
          instructions: formData.get('instructions') as string || '',
          isDefault: formData.get('isDefault') === 'on',
          latitude: parseFloat(lat),
          longitude: parseFloat(lng)
        };

        // Optimistic update: actualizar UI inmediatamente
        if (editingAddressId) {
          const index = addresses.findIndex((a: any) => a.id === editingAddressId);
          if (index !== -1) {
            addresses[index] = { ...addresses[index], ...addressData };
            renderAddresses();
          }
        }

        // Guardar en Firebase
        if (editingAddressId) {
          const result = await updateAddress(currentUserId, editingAddressId, addressData);
          if (!result.success) {
            // Revertir optimistic update
            await loadAddresses();
            alert('Error al actualizar la dirección: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        } else {
          const result = await addAddress(currentUserId, addressData);
          if (!result.success) {
            alert('Error al guardar la dirección: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        }

        // Recargar direcciones desde Firebase para sincronizar
        await loadAddresses();
        
        // Cerrar modal
        if ((window as any).addressModalAPI) {
          (window as any).addressModalAPI.close();
        }
        editingAddressId = null;
      } catch (error: any) {
        console.error('Error guardando dirección:', error);
        // Revertir optimistic update
        await loadAddresses();
        alert('Error al guardar la dirección: ' + (error.message || 'Error desconocido'));
      } finally {
        // Ocultar loader
        if (saveBtn) saveBtn.disabled = false;
        if (saveBtnText) saveBtnText.classList.remove('hidden');
        if (saveBtnLoading) {
          saveBtnLoading.classList.add('hidden');
          saveBtnLoading.classList.remove('flex');
        }
      }
    }

    // Función para eliminar dirección
    async function deleteAddress(addressId: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      // Obtener información de la dirección para el modal
      const address = addresses.find((a: any) => a.id === addressId);
      const addressName = address?.name || 'esta dirección';

      // Mostrar modal de confirmación
      if (typeof (window as any).showConfirmModal === 'function') {
        (window as any).showConfirmModal('delete-address-modal', {
          icon: `
            <svg class="w-7 h-7 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          `,
          iconBg: 'bg-red-100',
          iconColor: 'text-red-500',
          title: 'Eliminar Dirección',
          message: `¿Estás seguro de que deseas eliminar "${addressName}"? Esta acción no se puede deshacer.`,
          confirmText: 'Eliminar',
          confirmClass: 'bg-red-600 hover:bg-red-700',
          onConfirm: async () => {
            await performDelete(addressId);
          }
        });
      } else {
        // Fallback a confirm si el modal no está disponible
        if (confirm(`¿Estás seguro de que deseas eliminar "${addressName}"?`)) {
          await performDelete(addressId);
        }
      }
    }

    // Función auxiliar para realizar la eliminación
    async function performDelete(addressId: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update: eliminar de la UI inmediatamente
        const addressToDelete = addresses.find((a: any) => a.id === addressId);
        addresses = addresses.filter((a: any) => a.id !== addressId);
        renderAddresses();

        const { deleteAddress: deleteAddressFn } = await import('../../../lib/db/users.js');
        const result = await deleteAddressFn(currentUserId, addressId);
        
        if (!result.success) {
          // Revertir optimistic update
          if (addressToDelete) {
            addresses.push(addressToDelete);
            await loadAddresses();
          }
          alert('Error al eliminar la dirección: ' + (result.error?.message || 'Error desconocido'));
          return;
        }

        // Sincronizar con Firebase (ya está actualizado con optimistic update)
        await loadAddresses();
      } catch (error: any) {
        console.error('Error eliminando dirección:', error);
        // Revertir optimistic update
        await loadAddresses();
        alert('Error al eliminar la dirección: ' + (error.message || 'Error desconocido'));
      }
    }

    // Función para establecer como predeterminada
    async function setDefaultAddress(addressId: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update: actualizar UI inmediatamente
        const previousAddresses = [...addresses];
        addresses = addresses.map((a: any) => ({
          ...a,
          isDefault: a.id === addressId
        }));
        renderAddresses();

        const { setDefaultAddress: setDefaultAddressFn } = await import('../../../lib/db/users.js');
        const result = await setDefaultAddressFn(currentUserId, addressId);
        
        if (!result.success) {
          // Revertir optimistic update
          addresses = previousAddresses;
          renderAddresses();
          alert('Error al establecer la dirección como predeterminada: ' + (result.error?.message || 'Error desconocido'));
          return;
        }

        // Sincronizar con Firebase (ya está actualizado con optimistic update)
        await loadAddresses();
      } catch (error: any) {
        console.error('Error estableciendo dirección predeterminada:', error);
        // Revertir optimistic update
        await loadAddresses();
        alert('Error al establecer la dirección como predeterminada: ' + (error.message || 'Error desconocido'));
      }
    }

    // Función para asignar event listeners
    function attachEventListeners() {
      // Botones editar
      document.querySelectorAll('.edit-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              openAddressModal(addressId);
            }
          }
        });
      });

      // Botones eliminar
      document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              deleteAddress(addressId);
            }
          }
        });
      });

      // Botones establecer como predeterminada
      document.querySelectorAll('.set-default-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              setDefaultAddress(addressId);
            }
          }
        });
      });
    }

    // Event listeners iniciales
    if (addAddressBtn) {
      addAddressBtn.addEventListener('click', () => openAddressModal());
    }

    // Configurar callbacks del modal cuando esté disponible
    function setupModalCallbacks() {
      if (typeof (window as any).addressModalAPI !== 'undefined') {
        // Callback para guardar
        (window as any).addressModalAPI.setOnSave(async (formData: FormData) => {
          await saveAddress(formData);
        });

        // Callback para cerrar
        (window as any).addressModalAPI.setOnClose(() => {
          editingAddressId = null;
        });
      } else {
        // Reintentar después de un breve delay
        setTimeout(setupModalCallbacks, 100);
      }
    }

    // Función global para abrir modal desde el mensaje de "no hay direcciones"
    // @ts-ignore
    window.openAddressModal = openAddressModal;

    // Inicializar cuando el DOM esté listo
    async function init() {
      // Configurar callbacks del modal
      setupModalCallbacks();

      // Obtener userId del usuario autenticado
      currentUserId = await getCurrentUserId();
      
      if (!currentUserId) {
        console.error('No hay usuario autenticado');
        if (addressesContainer) addressesContainer.classList.add('hidden');
        if (noAddressesMessage) {
          noAddressesMessage.classList.remove('hidden');
          noAddressesMessage.innerHTML = `
            <div class="text-center py-12">
              <p class="text-red-500 mb-4">Debes iniciar sesión para ver tus direcciones</p>
              <a href="/login" class="text-emerald-600 hover:underline">Iniciar sesión</a>
            </div>
          `;
        }
        return;
      }

      // Cargar direcciones desde Firebase
      await loadAddresses();
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
