---
import ConfirmModal from '../../ConfirmModal.astro';
import AddressModal from '../AddressModal.astro';
import AddressCard from '../AddressCard.astro';

const title = 'Mis Direcciones';
// Las direcciones se cargan dinámicamente desde Firebase
const addresses: any[] = [];

---

<style>
  /* Asegurar que la sección permita scroll */
  section {
    overflow-y: visible !important;
    overflow-x: visible !important;
    height: auto !important;
    max-height: none !important;
  }

  /* Asegurar que el contenedor de direcciones permita scroll */
  #addresses-container {
    overflow: visible !important;
    height: auto !important;
    max-height: none !important;
  }

  /* Estilos para las nuevas tarjetas */
  .address-card {
    position: relative !important;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
    border: 1px solid rgba(226, 232, 240, 0.8) !important;
    border-radius: 20px !important;
    padding: 0 !important;
    overflow: hidden !important;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.04) !important;
    min-height: 200px;
  }

  .address-card:hover {
    transform: translateY(-4px) !important;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
    border-color: rgba(16, 185, 129, 0.3) !important;
  }

  .address-card.is-default {
    background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%) !important;
    border-color: rgba(16, 185, 129, 0.3) !important;
  }

  .address-card.is-default::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 4px !important;
    background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%) !important;
    z-index: 1;
  }

  .address-header {
    padding: 1.5rem !important;
    border-bottom: 1px solid rgba(226, 232, 240, 0.6) !important;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 250, 252, 0.8) 100%) !important;
    position: relative !important;
    z-index: 2 !important;
  }

  .address-body {
    padding: 1.5rem !important;
    background: white !important;
    position: relative !important;
    z-index: 2 !important;
  }

  .address-footer {
    padding: 1rem 1.5rem !important;
    border-top: 1px solid rgba(226, 232, 240, 0.6) !important;
    background: rgba(248, 250, 252, 0.5) !important;
    position: relative !important;
    z-index: 2 !important;
  }

  .address-icon-wrapper {
    width: 48px !important;
    height: 48px !important;
    border-radius: 12px !important;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3) !important;
    flex-shrink: 0 !important;
  }

  .address-card.is-default .address-icon-wrapper {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
  }

  .default-badge {
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.375rem !important;
    padding: 0.375rem 0.75rem !important;
    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
    border: 1px solid rgba(16, 185, 129, 0.3) !important;
    border-radius: 8px !important;
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    color: #059669 !important;
  }

  .address-actions {
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
  }

  .address-card:hover .address-actions {
    opacity: 1 !important;
  }

  .action-btn {
    width: 36px !important;
    height: 36px !important;
    border-radius: 8px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.2s ease !important;
    border: 1px solid rgba(226, 232, 240, 0.8) !important;
    background: white !important;
    cursor: pointer !important;
  }

  .action-btn:hover {
    transform: scale(1.1) !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
  }

  .action-btn.edit:hover {
    background: #eff6ff !important;
    border-color: #3b82f6 !important;
  }

  .action-btn.delete:hover {
    background: #fef2f2 !important;
    border-color: #ef4444 !important;
  }

  /* Animación sutil para el icono de ubicación */
  @keyframes float {
    0%, 100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-4px);
    }
  }

  .location-icon-float {
    animation: float 3s ease-in-out infinite !important;
  }

  /* Gradiente de fondo sutil */
  .address-gradient-bg {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    width: 200px !important;
    height: 200px !important;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%) !important;
    pointer-events: none !important;
    opacity: 0 !important;
    transition: opacity 0.3s ease !important;
    z-index: 0 !important;
  }

  .address-card:hover .address-gradient-bg {
    opacity: 1 !important;
  }

  /* Botón de establecer como predeterminada */
  .set-default-btn {
    width: 100% !important;
    padding: 0.625rem 1rem !important;
    background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%) !important;
    border: 1.5px solid rgba(16, 185, 129, 0.3) !important;
    border-radius: 10px !important;
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    color: #059669 !important;
    transition: all 0.2s ease !important;
    cursor: pointer !important;
  }

  .set-default-btn:hover {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    color: white !important;
    border-color: transparent !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4) !important;
  }
</style>

<section class="space-y-4">
  <!-- Header compacto y elegante -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 pb-3 border-b border-gray-200">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        {title}
      </h1>
      <p class="text-xs text-gray-500 mt-1 uppercase tracking-wide">Gestiona tus direcciones de envío</p>
    </div>
    <button
      type="button"
      id="add-address-btn"
      class="group flex items-center gap-2 px-5 py-3 bg-linear-to-r from-[#5d3fbb] to-[#7c3aed] text-white rounded-xl text-sm font-semibold hover:from-[#4d2fa8] hover:to-[#6d28d9] transition-all duration-300 shadow-md hover:shadow-xl transform hover:-translate-y-0.5"
    >
      <svg class="h-5 w-5 transition-transform duration-300 group-hover:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Añadir Nueva Dirección
    </button>
  </div>

  <!-- Lista de direcciones -->
  <div id="addresses-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
    {addresses.map((address) => (
      <AddressCard address={address} />
    ))}
  </div>

  <!-- Mensaje cuando no hay direcciones elegante -->
  <div id="no-addresses-message" class="hidden">
    <div class="text-center py-20 px-4">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-linear-to-br from-purple-50 to-pink-50 mb-6 shadow-lg">
        <svg class="h-10 w-10 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">No tienes direcciones guardadas</h3>
      <p class="text-sm text-gray-600 mb-6 max-w-md mx-auto">Añade tu primera dirección de envío para comenzar a recibir tus pedidos de forma rápida y segura.</p>
      <button
        type="button"
        onclick="window.openAddressModal && window.openAddressModal()"
        class="inline-flex items-center gap-2 px-6 py-3 bg-linear-to-r from-[#5d3fbb] to-[#7c3aed] text-white rounded-xl text-sm font-semibold hover:from-[#4d2fa8] hover:to-[#6d28d9] transition-all duration-300 shadow-md hover:shadow-xl transform hover:-translate-y-0.5"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Añadir Primera Dirección
      </button>
    </div>
  </div>
</section>

<!-- Modal de direcciones -->
<AddressModal />

<!-- Modal de confirmación para eliminar -->

<ConfirmModal id="delete-address-modal" />

<script>
  (async function() {
    // Variables globales
    let addresses: any[] = [];
    let editingAddressId: string | null = null;
    let currentUserId: string | null = null;

    // Elementos del DOM
    const addressesContainer = document.getElementById('addresses-container');
    const noAddressesMessage = document.getElementById('no-addresses-message');
    const addAddressBtn = document.getElementById('add-address-btn');

    // Obtener userId del usuario autenticado - espera a que Firebase Auth esté listo
    async function getCurrentUserId(): Promise<string | null> {
      try {
        // Primero intentar obtener desde localStorage (más rápido, ya está guardado por profile/index.astro)
        const userStr = localStorage.getItem('user');
        if (userStr) {
          try {
            const user = JSON.parse(userStr);
            if (user?.id) {
              return user.id;
            }
          } catch (e) {
            console.error('Error parsing user from localStorage:', e);
          }
        }

        // Si no está en localStorage, esperar a que Firebase Auth esté listo
        const { onAuthStateChange, getCurrentUser } = await import('../../../lib/auth.js');
        
        // Verificar si ya hay un usuario autenticado
        const currentUser = getCurrentUser();
        if (currentUser?.uid) {
          return currentUser.uid;
        }
        
        // Si no hay usuario, esperar a que Firebase Auth se inicialice
        return new Promise<string | null>((resolve) => {
          let resolved = false;
          
          const unsubscribe = onAuthStateChange((firebaseUser) => {
            if (resolved) return;
            resolved = true;
            unsubscribe();
            
            if (firebaseUser?.uid) {
              resolve(firebaseUser.uid);
            } else {
              resolve(null);
            }
          });
          
          // Timeout de seguridad (2 segundos debería ser suficiente)
          setTimeout(() => {
            if (!resolved) {
              resolved = true;
              unsubscribe();
              resolve(null);
            }
          }, 2000);
        });
      } catch (error) {
        console.error('Error obteniendo usuario:', error);
        return null;
      }
    }

    // Cargar direcciones desde Firebase
    async function loadAddresses() {
      try {
        if (!currentUserId) {
          console.error('No hay usuario autenticado');
          return;
        }

        const { getUserAddresses } = await import('../../../lib/db/users.js');
        const result = await getUserAddresses(currentUserId);

        if (result.error) {
          console.error('Error cargando direcciones:', result.error);
          addresses = [];
        } else {
          // Convertir timestamps de Firestore a formato compatible
          addresses = result.data.map((addr: any) => ({
            ...addr,
            latitude: addr.latitude ? parseFloat(addr.latitude.toString()) : undefined,
            longitude: addr.longitude ? parseFloat(addr.longitude.toString()) : undefined,
          }));
        }

        renderAddresses();
      } catch (error) {
        console.error('Error en loadAddresses:', error);
        addresses = [];
        renderAddresses();
      }
    }

    // Función para renderizar direcciones
    function renderAddresses() {
      if (!addressesContainer || !noAddressesMessage) return;

      if (addresses.length === 0) {
        addressesContainer.classList.add('hidden');
        noAddressesMessage.classList.remove('hidden');
        return;
      }

      addressesContainer.classList.remove('hidden');
      noAddressesMessage.classList.add('hidden');

      addressesContainer.innerHTML = addresses.map((address: any) => {
        const escapeHtml = (text: any) => {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        };

        const isDefault = address.isDefault || false;
        const cardClass = isDefault ? 'address-card is-default' : 'address-card';
        const cardBg = isDefault 
          ? 'background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%)' 
          : 'background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)';
        const cardBorder = isDefault 
          ? 'border-color: rgba(16, 185, 129, 0.3)' 
          : 'border-color: rgba(226, 232, 240, 0.8)';

        return '<div class="' + cardClass + '" data-address-id="' + address.id + '" style="position: relative; ' + cardBg + '; border: 1px solid; ' + cardBorder + '; border-radius: 20px; padding: 0; overflow: hidden; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.04); min-height: 200px;">' +
          '<div class="address-gradient-bg" style="position: absolute; top: 0; right: 0; width: 200px; height: 200px; background: radial-gradient(circle, rgba(16, 185, 129, 0.08) 0%, transparent 70%); pointer-events: none; opacity: 0; transition: opacity 0.3s ease; z-index: 0;"></div>' +
          
          // Header
          '<div class="address-header" style="padding: 1.5rem; border-bottom: 1px solid rgba(226, 232, 240, 0.6); background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 250, 252, 0.8) 100%); position: relative; z-index: 2;">' +
          '<div class="flex items-start justify-between gap-3">' +
          '<div class="flex items-center gap-3 flex-1 min-w-0">' +
          '<div class="address-icon-wrapper flex-shrink-0" style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); flex-shrink: 0;">' +
          '<svg class="w-6 h-6 text-white location-icon-float" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />' +
          '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />' +
          '</svg>' +
          '</div>' +
          '<div class="min-w-0 flex-1">' +
          '<h3 class="text-lg font-bold text-gray-900 mb-0.5 truncate">' + escapeHtml(address.name) + '</h3>' +
          '<p class="text-sm text-gray-600 truncate">' + escapeHtml(address.district) + ', ' + escapeHtml(address.city) + '</p>' +
          '</div>' +
          '</div>' +
          
          // Badge y acciones
          '<div class="flex items-start gap-2 flex-shrink-0">' +
          (isDefault ? '<span class="default-badge" style="display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.75rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; font-size: 0.75rem; font-weight: 600; color: #059669;"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>Por defecto</span>' : '') +
          '<div class="address-actions flex gap-1.5">' +
          '<button type="button" class="action-btn edit edit-address-btn" data-address-id="' + address.id + '" aria-label="Editar dirección" title="Editar">' +
          '<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>' +
          '</button>' +
          '<button type="button" class="action-btn delete delete-address-btn" data-address-id="' + address.id + '" aria-label="Eliminar dirección" title="Eliminar">' +
          '<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>' +
          '</button>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '</div>' +
          
          // Body
          '<div class="address-body" style="padding: 1.5rem; background: white; position: relative; z-index: 2;">' +
          '<div class="space-y-3">' +
          
          // Nombre completo y dirección
          '<div class="space-y-1.5">' +
          '<div class="flex items-center gap-2 text-gray-900">' +
          '<svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>' +
          '<span class="font-semibold text-sm">' + escapeHtml(address.fullName) + '</span>' +
          '</div>' +
          '<div class="flex items-start gap-2 text-gray-700 ml-6">' +
          '<svg class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>' +
          '<span class="text-sm leading-relaxed">' + escapeHtml(address.address) + '</span>' +
          '</div>' +
          '</div>' +
          
          // Teléfono
          '<div class="flex items-center gap-2 text-gray-700 pt-2 border-t border-gray-100">' +
          '<svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>' +
          '<span class="text-sm font-medium">' + escapeHtml(address.phone) + '</span>' +
          '</div>' +
          
          // Instrucciones (si existen)
          (address.instructions ? 
          '<div class="pt-2 border-t border-gray-100">' +
          '<div class="flex items-start gap-2">' +
          '<svg class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>' +
          '<div class="flex-1">' +
          '<p class="text-xs font-medium text-gray-500 mb-1">Instrucciones de entrega</p>' +
          '<p class="text-sm text-gray-700 leading-relaxed">' + escapeHtml(address.instructions) + '</p>' +
          '</div>' +
          '</div>' +
          '</div>' : '') +
          
          '</div>' +
          '</div>' +
          
          // Footer (solo si no es predeterminada)
          (!isDefault ? 
          '<div class="address-footer" style="padding: 1rem 1.5rem; border-top: 1px solid rgba(226, 232, 240, 0.6); background: rgba(248, 250, 252, 0.5); position: relative; z-index: 2;">' +
          '<button type="button" class="set-default-btn" data-address-id="' + address.id + '" style="width: 100%; padding: 0.625rem 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); border: 1.5px solid rgba(16, 185, 129, 0.3); border-radius: 10px; font-size: 0.75rem; font-weight: 600; color: #059669; transition: all 0.2s ease; cursor: pointer;">' +
          '<span class="flex items-center justify-center gap-2">' +
          '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>' +
          'Establecer como predeterminada' +
          '</span>' +
          '</button>' +
          '</div>' : '') +
          
          '</div>';
      }).join('');

      // Re-asignar event listeners
      attachEventListeners();
    }

    // Función para abrir modal
    function openAddressModal(addressId?: string) {
      editingAddressId = addressId || null;

      // Obtener datos de la dirección si está editando
      const addressData = editingAddressId 
        ? addresses.find((a: any) => a.id === editingAddressId)
        : undefined;

      // Abrir modal usando la API
      if (typeof (window as any).addressModalAPI !== 'undefined') {
        (window as any).addressModalAPI.open(addressData);
      }
    }

    // Función para guardar dirección
    async function saveAddress(formData: FormData) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      // Obtener inputs de coordenadas desde la API del modal
      const latitudeInput = (window as any).addressModalAPI?.getLatitudeInput();
      const longitudeInput = (window as any).addressModalAPI?.getLongitudeInput();
      const saveBtn = (window as any).addressModalAPI?.getSaveButton();
      const saveBtnText = (window as any).addressModalAPI?.getSaveButtonText();
      const saveBtnLoading = (window as any).addressModalAPI?.getSaveButtonLoading();

      const lat = latitudeInput?.value || '';
      const lng = longitudeInput?.value || '';
      
      if (!lat || !lng) {
        alert('Por favor, selecciona una ubicación en el mapa haciendo clic en él');
        return;
      }

      // Mostrar loader
      if (saveBtn) saveBtn.disabled = true;
      if (saveBtnText) saveBtnText.classList.add('hidden');
      if (saveBtnLoading) {
        saveBtnLoading.classList.remove('hidden');
        saveBtnLoading.classList.add('flex');
      }

      try {
        const { addAddress, updateAddress } = await import('../../../lib/db/users.js');

        const addressData: any = {
          name: formData.get('name') as string,
          fullName: formData.get('fullName') as string,
          phone: formData.get('phone') as string,
          address: formData.get('address') as string,
          district: formData.get('district') as string,
          city: formData.get('city') as string,
          instructions: formData.get('instructions') as string || '',
          isDefault: formData.get('isDefault') === 'on',
          latitude: parseFloat(lat),
          longitude: parseFloat(lng)
        };

        // Optimistic update: actualizar UI inmediatamente
        if (editingAddressId) {
          const index = addresses.findIndex((a: any) => a.id === editingAddressId);
          if (index !== -1) {
            addresses[index] = { ...addresses[index], ...addressData };
            renderAddresses();
          }
        }

        // Guardar en Firebase
        if (editingAddressId) {
          const result = await updateAddress(currentUserId, editingAddressId, addressData);
          if (!result.success) {
            // Revertir optimistic update
            await loadAddresses();
            alert('Error al actualizar la dirección: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        } else {
          const result = await addAddress(currentUserId, addressData);
          if (!result.success) {
            alert('Error al guardar la dirección: ' + (result.error?.message || 'Error desconocido'));
            return;
          }
        }

        // Recargar direcciones desde Firebase para sincronizar
        await loadAddresses();
        
        // Cerrar modal
        if ((window as any).addressModalAPI) {
          (window as any).addressModalAPI.close();
        }
        editingAddressId = null;
      } catch (error: any) {
        console.error('Error guardando dirección:', error);
        // Revertir optimistic update
        await loadAddresses();
        alert('Error al guardar la dirección: ' + (error.message || 'Error desconocido'));
      } finally {
        // Ocultar loader
        if (saveBtn) saveBtn.disabled = false;
        if (saveBtnText) saveBtnText.classList.remove('hidden');
        if (saveBtnLoading) {
          saveBtnLoading.classList.add('hidden');
          saveBtnLoading.classList.remove('flex');
        }
      }
    }

    // Función para eliminar dirección
    async function deleteAddress(addressId: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      // Obtener información de la dirección para el modal
      const address = addresses.find((a: any) => a.id === addressId);
      const addressName = address?.name || 'esta dirección';

      // Mostrar modal de confirmación
      if (typeof (window as any).showConfirmModal === 'function') {
        (window as any).showConfirmModal('delete-address-modal', {
          icon: `
            <svg class="w-7 h-7 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          `,
          iconBg: 'bg-red-100',
          iconColor: 'text-red-500',
          title: 'Eliminar Dirección',
          message: `¿Estás seguro de que deseas eliminar "${addressName}"? Esta acción no se puede deshacer.`,
          confirmText: 'Eliminar',
          confirmClass: 'bg-red-600 hover:bg-red-700',
          onConfirm: async () => {
            await performDelete(addressId);
          }
        });
      } else {
        // Fallback a confirm si el modal no está disponible
        if (confirm(`¿Estás seguro de que deseas eliminar "${addressName}"?`)) {
          await performDelete(addressId);
        }
      }
    }

    // Función auxiliar para realizar la eliminación
    async function performDelete(addressId: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update: eliminar de la UI inmediatamente
        const addressToDelete = addresses.find((a: any) => a.id === addressId);
        addresses = addresses.filter((a: any) => a.id !== addressId);
        renderAddresses();

        const { deleteAddress: deleteAddressFn } = await import('../../../lib/db/users.js');
        const result = await deleteAddressFn(currentUserId, addressId);
        
        if (!result.success) {
          // Revertir optimistic update
          if (addressToDelete) {
            addresses.push(addressToDelete);
            await loadAddresses();
          }
          alert('Error al eliminar la dirección: ' + (result.error?.message || 'Error desconocido'));
          return;
        }

        // Sincronizar con Firebase (ya está actualizado con optimistic update)
        await loadAddresses();
      } catch (error: any) {
        console.error('Error eliminando dirección:', error);
        // Revertir optimistic update
        await loadAddresses();
        alert('Error al eliminar la dirección: ' + (error.message || 'Error desconocido'));
      }
    }

    // Función para establecer como predeterminada
    async function setDefaultAddress(addressId: string) {
      if (!currentUserId) {
        alert('No hay usuario autenticado. Por favor, inicia sesión.');
        return;
      }

      try {
        // Optimistic update: actualizar UI inmediatamente
        const previousAddresses = [...addresses];
        addresses = addresses.map((a: any) => ({
          ...a,
          isDefault: a.id === addressId
        }));
        renderAddresses();

        const { setDefaultAddress: setDefaultAddressFn } = await import('../../../lib/db/users.js');
        const result = await setDefaultAddressFn(currentUserId, addressId);
        
        if (!result.success) {
          // Revertir optimistic update
          addresses = previousAddresses;
          renderAddresses();
          alert('Error al establecer la dirección como predeterminada: ' + (result.error?.message || 'Error desconocido'));
          return;
        }

        // Sincronizar con Firebase (ya está actualizado con optimistic update)
        await loadAddresses();
      } catch (error: any) {
        console.error('Error estableciendo dirección predeterminada:', error);
        // Revertir optimistic update
        await loadAddresses();
        alert('Error al establecer la dirección como predeterminada: ' + (error.message || 'Error desconocido'));
      }
    }

    // Función para asignar event listeners
    function attachEventListeners() {
      // Botones editar
      document.querySelectorAll('.edit-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              openAddressModal(addressId);
            }
          }
        });
      });

      // Botones eliminar
      document.querySelectorAll('.delete-address-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              deleteAddress(addressId);
            }
          }
        });
      });

      // Botones establecer como predeterminada
      document.querySelectorAll('.set-default-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.currentTarget;
          if (target && target instanceof HTMLButtonElement) {
            const addressId = target.getAttribute('data-address-id');
            if (addressId) {
              setDefaultAddress(addressId);
            }
          }
        });
      });
    }

    // Event listeners iniciales
    if (addAddressBtn) {
      addAddressBtn.addEventListener('click', () => openAddressModal());
    }

    // Configurar callbacks del modal cuando esté disponible
    function setupModalCallbacks() {
      if (typeof (window as any).addressModalAPI !== 'undefined') {
        // Callback para guardar
        (window as any).addressModalAPI.setOnSave(async (formData: FormData) => {
          await saveAddress(formData);
        });

        // Callback para cerrar
        (window as any).addressModalAPI.setOnClose(() => {
          editingAddressId = null;
        });
      } else {
        // Reintentar después de un breve delay
        setTimeout(setupModalCallbacks, 100);
      }
    }

    // Función global para abrir modal desde el mensaje de "no hay direcciones"
    // @ts-ignore
    window.openAddressModal = openAddressModal;

    // Inicializar cuando el DOM esté listo
    async function init() {
      // Configurar callbacks del modal
      setupModalCallbacks();

      // Obtener userId del usuario autenticado
      currentUserId = await getCurrentUserId();
      
      if (!currentUserId) {
        console.error('No hay usuario autenticado');
        if (addressesContainer) addressesContainer.classList.add('hidden');
        if (noAddressesMessage) {
          noAddressesMessage.classList.remove('hidden');
          noAddressesMessage.innerHTML = `
            <div class="text-center py-12">
              <p class="text-red-500 mb-4">Debes iniciar sesión para ver tus direcciones</p>
              <a href="/login" class="text-emerald-600 hover:underline">Iniciar sesión</a>
            </div>
          `;
        }
        return;
      }

      // Cargar direcciones desde Firebase
      await loadAddresses();
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
