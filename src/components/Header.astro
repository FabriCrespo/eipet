---
import "../styles/global.css";
---

<header
  class="sticky top-0 z-50 bg-linear-to-r from-[#5d3fbb] via-[#6d4fcc] to-[#5d3fbb] shadow-md border-b border-white/10"
>
  <div class="mx-auto max-w-7xl px-3 sm:px-4 relative z-10">
    <!-- Barra principal compacta -->
    <div class="flex items-center justify-between h-12 lg:h-14">
      <!-- Logo compacto -->
      <a
        href="/"
        class="flex items-center space-x-1.5 group shrink-0 logo-link"
        data-astro-prefetch
      >
        <div
          class="bg-[#ffff11] rounded-lg p-1 shadow-md group-hover:scale-105 transition-transform duration-200 logo-icon"
        >
          <svg
            class="w-5 h-5 sm:w-6 sm:h-6 logo-svg"
            viewBox="0 0 32 32"
            fill="none"
          >
            <path
              d="M16 8C16 8 10 2 4 8C-2 14 4 20 4 20L16 28L28 20C28 20 34 14 28 8C22 2 16 8 16 8Z"
              fill="#5d3fbb"></path>
            <circle cx="10" cy="12" r="2" fill="#fff"></circle>
            <circle cx="22" cy="12" r="2" fill="#fff"></circle>
            <path
              d="M16 18C16 18 14 20 10 20C6 20 4 18 4 18"
              stroke="#fff"
              stroke-width="2"
              stroke-linecap="round"></path>
            <path
              d="M16 18C16 18 18 20 22 20C26 20 28 18 28 18"
              stroke="#fff"
              stroke-width="2"
              stroke-linecap="round"></path>
          </svg>
        </div>
        <span
          class="text-base sm:text-lg lg:text-xl font-bold text-white group-hover:text-[#ffff11] transition-colors duration-200 tracking-tight"
          >eipet</span
        >
      </a>

      <!-- Navegación Desktop compacta -->
      <nav class="hidden lg:flex items-center space-x-0.5 xl:space-x-1">
        <div class="relative group">
          <button
            type="button"
            class="flex items-center gap-1 px-2.5 py-1.5 text-white text-sm font-medium rounded-lg hover:bg-white/10 transition-colors duration-200 hover:text-[#ffff11]"
          >
            <span>Productos</span>
            <svg
              class="w-3.5 h-3.5 transition-transform duration-200 group-hover:rotate-180"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div
            class="absolute top-full left-0 mt-1 w-40 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-gray-100 overflow-hidden"
          >
            <a
              href="/products?pet=dog"
              class="block px-3 py-2 text-[#5d3fbb] text-sm font-medium hover:bg-purple-50 transition-colors duration-150"
              data-astro-prefetch
            >
              Perro
            </a>
            <a
              href="/products?pet=cat"
              class="block px-3 py-2 text-[#5d3fbb] text-sm font-medium hover:bg-purple-50 transition-colors duration-150 border-t border-gray-100"
              data-astro-prefetch
            >
              Gato
            </a>
          </div>
        </div>

        <a
          href="/products?filter=discount"
          class="px-2.5 py-1.5 text-white text-sm font-medium rounded-lg hover:bg-white/10 transition-colors duration-200 hover:text-[#ffff11]"
          data-astro-prefetch
        >
          Descuentos
        </a>

        <a
          href="/products?filter=new"
          class="px-2.5 py-1.5 text-white text-sm font-medium rounded-lg hover:bg-white/10 transition-colors duration-200 hover:text-[#ffff11]"
          data-astro-prefetch
        >
          Novedades
        </a>

        <a
          href="/help"
          class="px-2.5 py-1.5 text-white text-sm font-medium rounded-lg hover:bg-white/10 transition-colors duration-200 hover:text-[#ffff11]"
          data-astro-prefetch
        >
          Ayuda
        </a>
      </nav>

      <!-- Barra de Búsqueda compacta (Desktop) -->
      <div class="hidden lg:block flex-1 max-w-xs mx-3">
        <div class="relative">
          <input
            type="text"
            id="header-search-input"
            placeholder="Buscar..."
            class="w-full px-3 py-1.5 pl-9 pr-8 bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg text-white placeholder-white/70 focus:outline-none focus:ring-1 focus:ring-[#ffff11]/50 focus:bg-white/20 transition-all text-xs"
          />
          <svg
            class="absolute left-2.5 top-1/2 transform -translate-y-1/2 w-4 h-4 text-white/70"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <button
            id="header-clear-search-btn"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 p-0.5 text-white/70 hover:text-white hidden transition-colors"
            aria-label="Limpiar búsqueda"
          >
            <svg
              class="w-3.5 h-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>

          <!-- Dropdown de Resultados -->
          <div
            id="search-results-dropdown"
            class="absolute top-full left-0 right-0 mt-1 bg-white rounded-lg shadow-xl border border-gray-200 max-h-80 overflow-y-auto z-50 hidden"
          >
            <div id="search-results-content" class="p-1.5">
              <!-- Los resultados se mostrarán aquí -->
            </div>
            <div id="search-loading" class="p-3 text-center hidden">
              <div
                class="inline-block w-5 h-5 border-2 border-[#5d3fbb] border-t-transparent rounded-full animate-spin"
              >
              </div>
              <p class="text-gray-500 text-xs mt-1.5">Buscando...</p>
            </div>
            <div id="search-empty" class="p-3 text-center hidden">
              <p class="text-gray-500 text-xs">No se encontraron productos</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Acciones Derecha compactas -->
      <div class="flex items-center gap-1.5 sm:gap-2 ml-2">
        <!-- User Menu compacto -->
        <div class="relative group">
          <button
            id="user-btn"
            class="p-1.5 text-white rounded-lg hover:bg-white/10 transition-colors duration-200 active:scale-95"
            aria-label="Cuenta"
          >
            <svg
              class="w-5 h-5 group-hover:text-[#ffff11] transition-colors duration-200"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
          </button>
          <div
            id="user-menu-dropdown"
            class="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 border border-gray-100 overflow-hidden"
          >
            <div class="py-0.5">
              <div id="user-menu-items" class="hidden">
                <a
                  href="/profile"
                  class="hidden items-center gap-2 px-3 py-1.5 text-gray-700 hover:bg-purple-50 transition-colors duration-150 text-xs font-medium"
                  data-astro-prefetch
                >
                  <svg
                    class="w-3.5 h-3.5 text-[#5d3fbb] shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    ></path>
                  </svg>
                  <span>Mi Perfil</span>
                </a>
                <a
                  href="/profile#orders"
                  class="hidden items-center gap-2 px-3 py-1.5 text-gray-700 hover:bg-purple-50 transition-colors duration-150 text-xs font-medium"
                  data-astro-prefetch
                >
                  <svg
                    class="w-3.5 h-3.5 text-[#5d3fbb] shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                    ></path>
                  </svg>
                  <span>Mis Pedidos</span>
                </a>
                <a
                  href="/profile#favorites"
                  class="hidden items-center gap-2 px-3 py-1.5 text-gray-700 hover:bg-purple-50 transition-colors duration-150 text-xs font-medium"
                  data-astro-prefetch
                >
                  <svg
                    class="w-3.5 h-3.5 text-[#5d3fbb] shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                    ></path>
                  </svg>
                  <span>Favoritos</span>
                </a>
              </div>
              <div id="admin-link" class="hidden">
                <a
                  href="/admin/dashboard"
                  class="flex items-center gap-2 px-3 py-1.5 text-gray-700 hover:bg-purple-50 transition-colors duration-150 text-xs font-medium"
                  data-astro-prefetch
                >
                  <svg
                    class="w-3.5 h-3.5 text-[#5d3fbb] shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                    ></path>
                  </svg>
                  <span>Panel Admin</span>
                </a>
              </div>
            </div>
            <hr id="user-menu-divider" class="border-gray-200 hidden" />
            <div class="py-0.5">
              <button
                id="logout-btn"
                class="w-full hidden items-center gap-2 px-3 py-1.5 text-red-600 hover:bg-red-50 transition-colors duration-150 text-xs font-medium text-left"
              >
                <svg
                  class="w-3.5 h-3.5 shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                  ></path>
                </svg>
                <span>Cerrar Sesión</span>
              </button>
              <div id="login-menu-items">
                <a
                  href="/login"
                  class="flex items-center gap-2 px-3 py-1.5 text-gray-700 hover:bg-purple-50 transition-colors duration-150 text-xs font-medium"
                  data-astro-prefetch
                >
                  <svg
                    class="w-3.5 h-3.5 text-[#5d3fbb] shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
                    ></path>
                  </svg>
                  <span>Iniciar Sesión</span>
                </a>
                <a
                  href="/signup"
                  class="flex items-center gap-2 px-3 py-1.5 text-gray-700 hover:bg-purple-50 transition-colors duration-150 text-xs font-medium"
                  data-astro-prefetch
                >
                  <svg
                    class="w-3.5 h-3.5 text-[#5d3fbb] shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
                    ></path>
                  </svg>
                  <span>Crear Cuenta</span>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Botón Búsqueda Móvil -->
        <button
          id="mobile-search-toggle-btn"
          class="lg:hidden p-1.5 text-white rounded-lg hover:bg-white/10 transition-colors duration-200 active:scale-95"
          aria-label="Buscar"
        >
          <svg
            id="search-icon"
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <svg
            id="search-close-icon"
            class="w-5 h-5 hidden text-[#ffff11]"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>

        <!-- Carrito con dropdown -->
        <div class="relative shrink-0">
          <button
            id="cart-btn"
            class="relative p-2 bg-linear-to-br from-[#facc15] via-[#fde047] to-[#facc15] text-[#5d3fbb] rounded-xl active:scale-95 shadow-lg border-2 border-[#fde047]/50 group/cart"
            aria-label="Carrito"
            style="overflow: visible;"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2.5"
                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
              ></path>
            </svg>
            <span
              id="cart-count"
              class="cart-count-badge hidden">0</span
            >
          </button>
        </div>
        <!-- Dropdown del Carrito -->
        <div 
          id="cart-dropdown"
          class="absolute right-0 top-full mt-3 w-80 sm:w-96 max-w-[92vw] bg-white rounded-2xl shadow-2xl border border-gray-200 opacity-0 invisible transition-all duration-200 z-50 max-h-[80vh] flex flex-col"
          style="display: none;"
        >
          <!-- Header del Dropdown -->
          <div
          class="sticky top-0 bg-white border-b border-gray-200 px-5 pt-4 pb-3 rounded-t-2xl z-10"
        >
          <div class="flex items-center justify-between">
            <h3 class="text-base font-bold text-[#5d3fbb]">
              Carrito de Compras
            </h3>
        
            <button
              id="close-cart-btn"
              class="p-1 hover:bg-gray-100 rounded-lg transition-colors"
              aria-label="Cerrar carrito"
            >
              <svg
                class="w-4 h-4 text-gray-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div class="flex justify-center pt-2 sm:hidden">
            <div class="w-10 h-1.5 bg-gray-300 rounded-full"></div>
          </div>
          </div>
          <!-- Contenido del Carrito -->
          <div id="cart-content" class="flex-1 overflow-y-auto px-4 sm:px-5 py-3 min-h-0">
            <div id="cart-skeleton" class="space-y-3 hidden">
              <div class="h-16 sm:h-20 bg-gray-100 rounded-xl animate-pulse"></div>
              <div class="h-16 sm:h-20 bg-gray-100 rounded-xl animate-pulse"></div>
              <div class="h-16 sm:h-20 bg-gray-100 rounded-xl animate-pulse hidden sm:block"></div>
            </div>

            <div id="cart-empty" class="text-center py-8 sm:py-10">
              <svg
                class="w-14 h-14 sm:w-16 sm:h-16 mx-auto text-gray-300 mb-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
              <p class="text-gray-500 text-sm sm:text-base font-medium">
                Tu carrito está vacío
              </p>
              <p class="text-gray-400 text-xs sm:text-sm mt-1">
                Agrega productos para comenzar
              </p>
            </div>

            <div id="cart-items" class="space-y-3 hidden">
              <!-- Los items se renderizarán aquí dinámicamente -->
            </div>
          </div>

          <!-- Footer del Dropdown (Total y Botones) -->
          <div
            id="cart-footer"
            class="sticky bottom-0 bg-white border-t border-gray-200 px-4 sm:px-5 py-4 rounded-b-2xl hidden"
          >
            <!-- Resumen -->
            <div class="mb-3 space-y-1.5">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal:</span>
                <span id="cart-subtotal" class="font-semibold text-gray-900"
                  >Bs. 0</span
                >
              </div>
              <div class="flex justify-between text-base font-bold">
                <span class="text-gray-900">Total:</span>
                <span id="cart-total" class="text-[#5d3fbb]">Bs. 0</span>
              </div>
            </div>

            <!-- Botones -->
            <div class="flex flex-col gap-2">
              <button
                id="view-cart-btn"
                class="w-full px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition-colors text-sm"
              >
                Ver Carrito Completo
              </button>
              <button
                id="checkout-btn"
                class="w-full px-4 py-2.5 bg-[#5d3fbb] hover:bg-[#6d4fcc] text-white font-semibold rounded-lg transition-colors text-sm"
              >
                Proceder al Pago
              </button>
            </div>
          </div>
        </div>

        <!-- Botón Menú Móvil compacto -->
        <button
          id="mobile-menu-btn"
          class="lg:hidden p-1.5 text-white rounded-lg hover:bg-white/10 transition-colors duration-200 active:scale-95"
          aria-label="Menú"
        >
          <svg
            id="menu-icon"
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg
            id="close-icon"
            class="w-5 h-5 hidden text-[#ffff11]"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    
    </div>

    <!-- Barra de Búsqueda Móvil Desplegable -->
    <div
      id="mobile-search-container"
      class="lg:hidden max-h-0 overflow-hidden transition-all duration-300 border-t border-white/20"
    >
      <div
        class="px-3 py-2 bg-linear-to-b from-[#5d3fbb]/95 to-[#6d4fcc]/95 backdrop-blur-sm"
      >
        <div class="relative">
          <input
            type="text"
            id="mobile-search-input"
            placeholder="Buscar..."
            class="w-full px-3 py-2 pl-8 pr-8 bg-white/20 backdrop-blur-md border border-white/30 rounded-lg text-white placeholder-white/70 focus:outline-none focus:ring-1 focus:ring-[#ffff11]/50 focus:bg-white/30 transition-all text-xs"
          />
          <svg
            class="absolute left-2.5 top-1/2 transform -translate-y-1/2 w-4 h-4 text-white/70"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <button
            id="mobile-clear-search-btn"
            class="absolute right-2 top-1/2 transform -translate-y-1/2 p-0.5 text-white/70 hover:text-white hidden transition-colors"
            aria-label="Limpiar búsqueda"
          >
            <svg
              class="w-3.5 h-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <!-- Dropdown de Resultados Móvil -->
        <div
          id="mobile-search-results-dropdown"
          class="mt-2 bg-white rounded-lg shadow-xl border border-gray-100 shadow-[0_12px_30px_rgba(0,0,0,0.12)] max-h-64 overflow-y-auto hidden"
        >
          <div id="mobile-search-results-content" class="p-1.5">
            <!-- Los resultados se mostrarán aquí -->
          </div>
          <div id="mobile-search-loading" class="p-3 text-center hidden">
            <div
              class="inline-block w-5 h-5 border-2 border-[#5d3fbb] border-t-transparent rounded-full animate-spin"
            >
            </div>
            <p class="text-gray-500 text-xs mt-1.5">Buscando...</p>
          </div>
          <div id="mobile-search-empty" class="p-3 text-center hidden">
            <p class="text-gray-500 text-xs">No se encontraron productos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Menú Móvil compacto -->
    <nav
      id="mobile-menu"
      class="lg:hidden max-h-0 overflow-hidden transition-all duration-200 border-t border-white/20"
    >
      <div class="flex flex-col py-2 space-y-0.5">
        <div
          class="px-3 py-1 text-white/80 text-[10px] font-semibold uppercase tracking-wider"
        >
          Productos
        </div>
        <a
          href="/products?pet=dog"
          class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2"
          data-astro-prefetch
        >
          Perro
        </a>
        <a
          href="/products?pet=cat"
          class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2"
          data-astro-prefetch
        >
          Gato
        </a>
        <hr class="my-2 border-white/20 mx-3" />
        <a
          href="/products?filter=discount"
          class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2"
          data-astro-prefetch
        >
          Descuentos
        </a>
        <a
          href="/products?filter=new"
          class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2"
          data-astro-prefetch
        >
          Novedades
        </a>
        <a
          href="/help"
          class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2"
          data-astro-prefetch
        >
          Ayuda
        </a>
        <div id="mobile-user-menu-items" class="hidden">
          <hr class="my-2 border-white/20 mx-3" />
          <div
            class="px-3 py-1 text-white/80 text-[10px] font-semibold uppercase tracking-wider"
          >
            Mi Cuenta
          </div>
          <a
            href="/profile"
            class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2 hidden"
            data-astro-prefetch
          >
            Mi Perfil
          </a>
          <a
            href="/profile#orders"
            class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2 hidden"
            data-astro-prefetch
          >
            Mis Pedidos
          </a>
          <a
            href="/profile#favorites"
            class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2 hidden"
            data-astro-prefetch
          >
            Favoritos
          </a>
        </div>
        <div id="mobile-admin-link" class="hidden">
          <hr class="my-2 border-white/20 mx-3" />
          <a
            href="/admin/dashboard"
            class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2"
            data-astro-prefetch
          >
            Panel Admin
          </a>
        </div>
        <hr
          id="mobile-logout-divider"
          class="my-2 border-white/20 mx-3 hidden"
        />
        <button
          id="mobile-logout-btn"
          class="px-4 py-2 text-red-300 text-sm font-medium hover:bg-red-500/20 transition-colors duration-150 rounded-lg mx-2 text-left hidden"
        >
          Cerrar Sesión
        </button>
        <a
          href="/login"
          id="mobile-login-btn"
          class="px-4 py-2 text-white text-sm font-medium hover:bg-white/10 transition-colors duration-150 rounded-lg mx-2 text-left"
          data-astro-prefetch
        >
          Iniciar Sesión
        </a>
      </div>
    </nav>
  </div>
</header>

<script>
  // Menú móvil
  const mobileMenuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  const menuIcon = document.getElementById("menu-icon");
  const closeIcon = document.getElementById("close-icon");

  mobileMenuBtn?.addEventListener("click", () => {
    const isOpen = mobileMenu?.classList.contains("max-h-0");
    if (isOpen) {
      mobileMenu?.classList.remove("max-h-0");
      mobileMenu?.classList.add("max-h-screen");
      menuIcon?.classList.add("hidden");
      closeIcon?.classList.remove("hidden");
      // Cerrar búsqueda si está abierta
      const mobileSearchContainer = document.getElementById(
        "mobile-search-container",
      );
      if (
        mobileSearchContainer &&
        !mobileSearchContainer.classList.contains("max-h-0")
      ) {
        mobileSearchContainer.classList.add("max-h-0");
        mobileSearchContainer.classList.remove("max-h-64");
        const searchIcon = document.getElementById("search-icon");
        const searchCloseIcon = document.getElementById("search-close-icon");
        if (searchIcon) searchIcon.classList.remove("hidden");
        if (searchCloseIcon) searchCloseIcon.classList.add("hidden");
      }
    } else {
      mobileMenu?.classList.add("max-h-0");
      mobileMenu?.classList.remove("max-h-screen");
      menuIcon?.classList.remove("hidden");
      closeIcon?.classList.add("hidden");
    }
  });

  // Toggle de búsqueda móvil
  const mobileSearchToggleBtn = document.getElementById(
    "mobile-search-toggle-btn",
  );
  const mobileSearchContainer = document.getElementById(
    "mobile-search-container",
  );
  const searchIcon = document.getElementById("search-icon");
  const searchCloseIcon = document.getElementById("search-close-icon");

  mobileSearchToggleBtn?.addEventListener("click", () => {
    const isOpen = mobileSearchContainer?.classList.contains("max-h-0");
    if (isOpen) {
      mobileSearchContainer?.classList.remove("max-h-0");
      mobileSearchContainer?.classList.add("max-h-64");
      if (searchIcon) searchIcon.classList.add("hidden");
      if (searchCloseIcon) searchCloseIcon.classList.remove("hidden");
      // Cerrar menú si está abierto
      if (mobileMenu && !mobileMenu.classList.contains("max-h-0")) {
        mobileMenu.classList.add("max-h-0");
        mobileMenu.classList.remove("max-h-screen");
        menuIcon?.classList.remove("hidden");
        closeIcon?.classList.add("hidden");
      }
      // Focus en el input
      setTimeout(() => {
        const mobileSearchInput = document.getElementById(
          "mobile-search-input",
        ) as HTMLInputElement;
        mobileSearchInput?.focus();
      }, 100);
    } else {
      mobileSearchContainer?.classList.add("max-h-0");
      mobileSearchContainer?.classList.remove("max-h-64");
      if (searchIcon) searchIcon.classList.remove("hidden");
      if (searchCloseIcon) searchCloseIcon.classList.add("hidden");
      // Ocultar dropdown de resultados
      const mobileResultsDropdown = document.getElementById(
        "mobile-search-results-dropdown",
      );
      if (mobileResultsDropdown) mobileResultsDropdown.classList.add("hidden");
    }
  });

  // Usuario y logout
  const userBtn = document.getElementById("user-btn");
  const userMenu = document.getElementById("user-menu-dropdown");
  const logoutBtn = document.getElementById("logout-btn");
  const mobileLogoutBtn = document.getElementById("mobile-logout-btn");

  // Función para actualizar UI del menú basado en estado de autenticación
  function updateAuthUI(user: any | null) {
    const loginMenuItems = document.getElementById("login-menu-items");
    const userMenuItems = document.querySelectorAll(
      'a[href="/profile"], a[href="/profile#orders"], a[href="/profile#favorites"]',
    );
    const userMenuItemsContainer = document.getElementById("user-menu-items");
    const adminLink = document.getElementById("admin-link");
    const mobileAdminLink = document.getElementById("mobile-admin-link");
    const userMenuDivider = document.getElementById("user-menu-divider");
    const mobileLogoutDivider = document.getElementById(
      "mobile-logout-divider",
    );
    const mobileUserMenuItems = document.getElementById(
      "mobile-user-menu-items",
    );
    const mobileProfileLink = document.querySelector('a[href="/profile"]');
    const mobileOrdersLink = document.querySelector(
      'a[href="/profile#orders"]',
    );
    const mobileFavoritesLink = document.querySelector(
      'a[href="/profile#favorites"]',
    );

    if (user) {
      // Usuario autenticado - mostrar opciones de usuario logueado
      logoutBtn?.classList.remove("hidden");
      mobileLogoutBtn?.classList.remove("hidden");
      document.getElementById("mobile-login-btn")?.classList.add("hidden");
      loginMenuItems?.classList.add("hidden");

      // Mostrar items del menú de usuario (perfil, pedidos, favoritos)
      if (userMenuItemsContainer)
        userMenuItemsContainer.classList.remove("hidden");
      userMenuItems.forEach((item) => {
        item.classList.remove("hidden");
        item.classList.add("flex");
      });

      // Mostrar items del menú móvil de usuario
      if (mobileUserMenuItems) mobileUserMenuItems.classList.remove("hidden");
      if (mobileProfileLink) mobileProfileLink.classList.remove("hidden");
      if (mobileOrdersLink) mobileOrdersLink.classList.remove("hidden");
      if (mobileFavoritesLink) mobileFavoritesLink.classList.remove("hidden");

      // Mostrar/ocultar enlace de admin según el rol
      if (user.role === "admin") {
        adminLink?.classList.remove("hidden");
        mobileAdminLink?.classList.remove("hidden");
        // Mostrar separador si hay admin link y logout
        if (userMenuDivider) userMenuDivider.classList.remove("hidden");
        if (mobileLogoutDivider) mobileLogoutDivider.classList.remove("hidden");
      } else {
        adminLink?.classList.add("hidden");
        mobileAdminLink?.classList.add("hidden");
        // Mostrar separador antes del logout para usuarios regulares también
        if (userMenuDivider) userMenuDivider.classList.remove("hidden");
        if (mobileLogoutDivider) mobileLogoutDivider.classList.remove("hidden");
      }
    } else {
      // No hay usuario - mostrar opciones de login
      if (logoutBtn) {
        logoutBtn.classList.add("hidden");
        logoutBtn.classList.remove("flex");
      }
      if (mobileLogoutBtn) {
        mobileLogoutBtn.classList.add("hidden");
        mobileLogoutBtn.classList.remove("flex");
      }
      document.getElementById("mobile-login-btn")?.classList.remove("hidden");
      loginMenuItems?.classList.remove("hidden");

      // Ocultar items del menú de usuario
      if (userMenuItemsContainer)
        userMenuItemsContainer.classList.add("hidden");
      userMenuItems.forEach((item) => {
        item.classList.add("hidden");
        item.classList.remove("flex");
      });

      // Ocultar items del menú móvil de usuario
      if (mobileUserMenuItems) mobileUserMenuItems.classList.add("hidden");
      if (mobileProfileLink) {
        mobileProfileLink.classList.add("hidden");
        mobileProfileLink.classList.remove("flex");
      }
      if (mobileOrdersLink) {
        mobileOrdersLink.classList.add("hidden");
        mobileOrdersLink.classList.remove("flex");
      }
      if (mobileFavoritesLink) {
        mobileFavoritesLink.classList.add("hidden");
        mobileFavoritesLink.classList.remove("flex");
      }

      // Ocultar admin link y separadores
      adminLink?.classList.add("hidden");
      mobileAdminLink?.classList.add("hidden");
      if (userMenuDivider) userMenuDivider.classList.add("hidden");
      if (mobileLogoutDivider) mobileLogoutDivider.classList.add("hidden");
    }

    // Disparar evento personalizado para otros componentes
    window.dispatchEvent(
      new CustomEvent("auth-state-changed", { detail: { user } }),
    );
  }

  // Logout
  async function handleLogout() {
    try {
      const { logout } = await import("../lib/auth");
      await logout();
      localStorage.removeItem("user");
      updateAuthUI(null);
      window.location.href = "/";
    } catch (error) {
      console.error("Error al cerrar sesión:", error);
      // Limpiar localStorage aunque falle
      localStorage.removeItem("user");
      updateAuthUI(null);
      window.location.href = "/";
    }
  }

  logoutBtn?.addEventListener("click", handleLogout);
  mobileLogoutBtn?.addEventListener("click", handleLogout);

  // Inicializar estado de autenticación con Firebase Auth
  async function initAuthState() {
    try {
      const { onAuthStateChange, getCurrentUserData } =
        await import("../lib/auth");

      // Escuchar cambios en el estado de autenticación
      const unsubscribe = onAuthStateChange(async (firebaseUser) => {
        if (firebaseUser) {
          // Usuario autenticado - obtener datos completos desde Firestore
          try {
            const userDataResult = await getCurrentUserData();
            if (userDataResult.success && userDataResult.user) {
              // Guardar en localStorage como caché (no como fuente de verdad)
              localStorage.setItem("user", JSON.stringify(userDataResult.user));
              updateAuthUI(userDataResult.user);
            } else {
              // Error al obtener datos del usuario
              console.error("Error getting user data:", userDataResult.error);
              updateAuthUI(null);
              localStorage.removeItem("user");
            }
          } catch (error) {
            console.error("Error loading user data:", error);
            updateAuthUI(null);
            localStorage.removeItem("user");
          }
        } else {
          // No hay usuario autenticado
          updateAuthUI(null);
          localStorage.removeItem("user");
        }
      });

      // Retornar función para desuscribirse (útil si necesitas limpiar)
      return unsubscribe;
    } catch (error) {
      console.error("Error initializing auth state:", error);
      // Firebase = única fuente de verdad. No confiar en localStorage en error.
      updateAuthUI(null);
    }
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", () => {
    initAuthState();

    // ============================================================================
    // GESTIÓN DEL CARRITO
    // ============================================================================

    // Estado del carrito en memoria (para actualizaciones rápidas)
    let cartState: {
      items: Array<{
        productId: string;
        quantity: number;
        product?: {
          id: string;
          name: string;
          price: number;
          image: string;
          brandName?: string;
          stock?: number;
        };
      }>;
      lastUpdated: number;
    } = {
      items: [],
      lastUpdated: Date.now(),
    };

    // Cargar carrito desde localStorage
    function loadCartFromStorage() {
      try {
        const cartData = localStorage.getItem("cart");
        if (cartData) {
          const parsed = JSON.parse(cartData);
          cartState.items = parsed.items || [];
          cartState.lastUpdated = parsed.lastUpdated || Date.now();
        }
      } catch (e) {
        console.error("Error cargando carrito:", e);
        cartState.items = [];
      }
    }

    // Guardar carrito en localStorage
    function saveCartToStorage() {
      try {
        cartState.lastUpdated = Date.now();
        localStorage.setItem("cart", JSON.stringify(cartState));
      } catch (e) {
        console.error("Error guardando carrito:", e);
      }
    }

    // Calcular total de items
    function getCartItemCount(): number {
      return cartState.items.reduce((sum, item) => sum + item.quantity, 0);
    }

    // Calcular subtotal
    function getCartSubtotal(): number {
      return cartState.items.reduce((sum, item) => {
        const price = item.product?.price || 0;
        return sum + price * item.quantity;
      }, 0);
    }

    // Actualizar contador del carrito
    function updateCartCount() {
      const cartCount = document.getElementById("cart-count");
      if (!cartCount) return;
      const count = getCartItemCount();

      if (cartCount) {
        if (count > 0) {
          cartCount.textContent = count > 99 ? "99+" : count.toString();
          // Agregar padding si el número tiene más de un dígito
          if (count > 9) {
            cartCount.classList.add("px-1");
          } else {
            cartCount.classList.remove("px-1");
          }
          cartCount.classList.remove("hidden");
          cartCount.classList.add("flex");
          // Agregar animación cuando aparece
          cartCount.classList.add("animate-pulse-once");
          setTimeout(() => {
            cartCount.classList.remove("animate-pulse-once");
          }, 500);
        } else {
          cartCount.classList.add("hidden");
          cartCount.classList.remove("flex", "px-1");
        }
      }
    }

    // Renderizar items del carrito
    function renderCartItems() {
      const cartItems = document.getElementById("cart-items");
      const cartEmpty = document.getElementById("cart-empty");
      const cartFooter = document.getElementById("cart-footer");
      const cartSkeleton = document.getElementById("cart-skeleton");

      if (!cartItems || !cartEmpty || !cartFooter) return;

      if (cartSkeleton) cartSkeleton.classList.add("hidden");

      if (cartState.items.length === 0) {
        cartItems.classList.add("hidden");
        cartEmpty.classList.remove("hidden");
        cartFooter.classList.add("hidden");
        return;
      }

      cartItems.classList.remove("hidden");
      cartEmpty.classList.add("hidden");
      cartFooter.classList.remove("hidden");

      // Renderizar items
      cartItems.innerHTML = cartState.items
        .map((item, index) => {
          const product = item.product;
          if (!product) return "";

          const subtotal = (product.price || 0) * item.quantity;

          return `
          <div class="cart-item flex gap-3 p-2.5 bg-gray-50 rounded-lg" data-index="${index}" data-product-id="${item.productId}">
            <!-- Imagen -->
            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-200 rounded-lg overflow-hidden shrink-0">
              <img 
                src="${product.image || ""}" 
                alt="${product.name}"
                class="w-full h-full object-cover"
                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'12\'%3EImagen%3C/text%3E%3C/svg%3E';"
              />
            </div>
            
            <!-- Información -->
            <div class="flex-1 min-w-0">
              <h4 class="text-xs sm:text-sm font-semibold text-gray-900 line-clamp-2 mb-1">${product.name}</h4>
              ${product.brandName ? `<p class="text-[10px] text-gray-500 mb-1">${product.brandName}</p>` : ""}
              
              <!-- Controles de cantidad -->
              <div class="flex items-center justify-between mt-2">
                <div class="flex items-center gap-1.5">
                  <button 
                    type="button"
                    class="cart-decrease-btn w-6 h-6 bg-white border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-center text-xs"
                    data-product-id="${item.productId}"
                    aria-label="Disminuir cantidad"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                  </button>
                  <span class="cart-item-quantity text-xs font-semibold text-gray-900 w-6 text-center">${item.quantity}</span>
                  <button 
                    type="button"
                    class="cart-increase-btn w-6 h-6 bg-white border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-center text-xs"
                    data-product-id="${item.productId}"
                    aria-label="Aumentar cantidad"
                  >
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                  </button>
                </div>
                
                <div class="text-right">
                  <p class="text-xs sm:text-sm font-bold text-[#5d3fbb]">Bs. ${subtotal.toLocaleString()}</p>
                  <p class="text-[10px] text-gray-500">Bs. ${(product.price || 0).toLocaleString()} c/u</p>
                </div>
              </div>
            </div>
            
            <!-- Botón eliminar -->
            <button
              type="button"
              class="cart-remove-btn p-1 text-gray-400 hover:text-red-500 transition-colors shrink-0 self-start"
              data-product-id="${item.productId}"
              aria-label="Eliminar del carrito"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        `;
        })
        .join("");

      // Actualizar totales (listeners por delegación en el contenedor, no por item)
      updateCartTotals();
    }

    // Un solo listener en el contenedor (delegación): evita leaks, duplicados y degradación
    let cartDelegationAttached = false;
    function setupCartItemDelegation() {
      if (cartDelegationAttached) return;
      const cartItemsContainer = document.getElementById("cart-items");
      if (!cartItemsContainer) return;
      cartDelegationAttached = true;
      cartItemsContainer.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        const inc = target.closest(".cart-increase-btn");
        const dec = target.closest(".cart-decrease-btn");
        const del = target.closest(".cart-remove-btn");
        const pidInc = inc?.getAttribute("data-product-id");
        const pidDec = dec?.getAttribute("data-product-id");
        const pidDel = del?.getAttribute("data-product-id");
        if (pidInc) updateCartItemQuantity(pidInc, 1);
        if (pidDec) updateCartItemQuantity(pidDec, -1);
        if (pidDel) removeFromCart(pidDel);
      });
    }

    // Actualizar cantidad de un item
    function updateCartItemQuantity(productId: string, change: number) {
      const item = cartState.items.find((i) => i.productId === productId);
      if (!item) return;

      const newQuantity = item.quantity + change;

      if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
      }

      // Validar stock si está disponible
      if (
        item.product?.stock !== undefined &&
        newQuantity > item.product.stock
      ) {
        alert(`Stock insuficiente. Disponible: ${item.product.stock}`);
        return;
      }

      item.quantity = newQuantity;
      saveCartToStorage();
      renderCartItems();
      updateCartCount();

      // Disparar evento personalizado
      window.dispatchEvent(new CustomEvent("cart-updated"));
    }

    // Eliminar item del carrito
    function removeFromCart(productId: string) {
      cartState.items = cartState.items.filter(
        (item) => item.productId !== productId,
      );
      saveCartToStorage();
      renderCartItems();
      updateCartCount();

      // Disparar evento personalizado
      window.dispatchEvent(new CustomEvent("cart-updated"));
    }

    // Agregar producto al carrito
    function addToCart(
      product: {
        id: string;
        name: string;
        price: number;
        image: string;
        brandName?: string;
        stock?: number;
      },
      quantity: number = 1,
    ) {
      const existingItem = cartState.items.find(
        (item) => item.productId === product.id,
      );

      if (existingItem) {
        // Validar stock
        if (
          product.stock !== undefined &&
          existingItem.quantity + quantity > product.stock
        ) {
          alert(`Stock insuficiente. Disponible: ${product.stock}`);
          return false;
        }
        existingItem.quantity += quantity;
      } else {
        // Validar stock
        if (product.stock !== undefined && quantity > product.stock) {
          alert(`Stock insuficiente. Disponible: ${product.stock}`);
          return false;
        }
        cartState.items.push({
          productId: product.id,
          quantity: quantity,
          product: product,
        });
      }

      saveCartToStorage();
      renderCartItems();
      updateCartCount();

      // Disparar evento personalizado
      window.dispatchEvent(
        new CustomEvent("cart-updated", {
          detail: { productId: product.id, action: "added" },
        }),
      );

      return true;
    }

    // Actualizar totales del carrito
    function updateCartTotals() {
      const subtotalEl = document.getElementById("cart-subtotal");
      const totalEl = document.getElementById("cart-total");

      const subtotal = getCartSubtotal();

      if (subtotalEl) {
        subtotalEl.textContent = `Bs. ${subtotal.toLocaleString()}`;
      }

      if (totalEl) {
        totalEl.textContent = `Bs. ${subtotal.toLocaleString()}`;
      }
    }

    // Cargar datos de productos para items del carrito (si no están cargados)
    async function loadProductDataForCartItems() {
      const itemsNeedingData = cartState.items.filter((item) => !item.product);
      if (itemsNeedingData.length === 0) return;

      const cartSkeleton = document.getElementById("cart-skeleton");
      const cartItems = document.getElementById("cart-items");
      const cartEmpty = document.getElementById("cart-empty");
      if (cartSkeleton) cartSkeleton.classList.remove("hidden");
      if (cartItems) cartItems.classList.add("hidden");
      if (cartEmpty) cartEmpty.classList.add("hidden");

      try {
        const { getProductById } = await import("../lib/db/products");

        for (const item of itemsNeedingData) {
          const productResult = await getProductById(item.productId);
          if (productResult.data) {
            const product = productResult.data;
            const { getBrands } = await import("../lib/db/brands");
            const brandsResult = await getBrands();
            const brand = brandsResult.data?.find(
              (b: any) => b.id === product.brand,
            );

            item.product = {
              id: product.id,
              name: product.name,
              price: product.price,
              image: product.image,
              brandName: brand?.name,
              stock: product.stock,
            };
          }
        }

        saveCartToStorage();
        renderCartItems();
      } catch (error) {
        console.error("Error cargando datos de productos:", error);
      }
    }

    // Inicializar carrito
    async function initCart() {
      setupCartItemDelegation();
      loadCartFromStorage();
      await loadProductDataForCartItems();
      updateCartCount();
      renderCartItems();
    }

    // Toggle del dropdown del carrito
    const cartBtn = document.getElementById("cart-btn");
    const cartDropdown = document.getElementById("cart-dropdown");
    const closeCartBtn = document.getElementById("close-cart-btn");

    function openCartDropdown() {
      if (cartDropdown) {
        document.body.classList.add('cart-open');
        cartDropdown.style.display = "flex";
        // Forzar reflow para animación
        cartDropdown.style.display = "flex";
        requestAnimationFrame(() => {
          cartDropdown.classList.remove("opacity-0", "invisible");
        });
        cartDropdown.classList.remove("opacity-0", "invisible");
        cartDropdown.classList.add("opacity-100", "visible");
      }
    }

    function closeCartDropdown() {
      if (cartDropdown) {
        document.body.classList.remove('cart-open');
        cartDropdown.classList.remove("opacity-100", "visible");
        cartDropdown.classList.add("opacity-0", "invisible");
        setTimeout(() => {
          if (cartDropdown) {
            cartDropdown.style.display = "none";
          }
        }, 200);
      }
    }

    cartBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      if (
        cartDropdown?.classList.contains("opacity-0") ||
        cartDropdown?.style.display === "none"
      ) {
        openCartDropdown();
      } else {
        closeCartDropdown();
      }
    });

    closeCartBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      closeCartDropdown();
    });

    // Un solo listener global: cerrar dropdowns al hacer click fuera (evita múltiples listeners)
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (
        cartDropdown &&
        !cartDropdown.contains(target) &&
        target !== cartBtn &&
        !cartBtn?.contains(target)
      ) {
        closeCartDropdown();
      }
      const resultsDropdown = document.getElementById(
        "search-results-dropdown",
      );
      const mobileResultsDropdown = document.getElementById(
        "mobile-search-results-dropdown",
      );
      const searchInput = document.getElementById("header-search-input");
      const mobileSearchInput = document.getElementById("mobile-search-input");
      const mobileSearchToggleBtn = document.getElementById(
        "mobile-search-toggle-btn",
      );
      const mobileSearchContainer = document.getElementById(
        "mobile-search-container",
      );
      if (
        resultsDropdown &&
        !resultsDropdown.contains(target) &&
        target !== searchInput &&
        target !== mobileSearchInput &&
        !mobileSearchToggleBtn?.contains(target)
      ) {
        resultsDropdown.classList.add("hidden");
      }
      if (
        mobileResultsDropdown &&
        !mobileResultsDropdown.contains(target) &&
        target !== searchInput &&
        target !== mobileSearchInput &&
        !mobileSearchToggleBtn?.contains(target) &&
        !mobileSearchContainer?.contains(target)
      ) {
        mobileResultsDropdown.classList.add("hidden");
      }
    });

    // Cerrar con ESC
    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        cartDropdown &&
        !cartDropdown.classList.contains("opacity-0")
      ) {
        closeCartDropdown();
      }
    });

    // Botones del footer
    const viewCartBtn = document.getElementById("view-cart-btn");
    const checkoutBtn = document.getElementById("checkout-btn");

    viewCartBtn?.addEventListener("click", () => {
      window.location.href = "/cart";
    });

    checkoutBtn?.addEventListener("click", () => {
      window.location.href = "/checkout";
    });

    // Escuchar eventos de actualización del carrito desde otras páginas
    window.addEventListener("storage", (e) => {
      if (e.key === "cart") {
        loadCartFromStorage();
        renderCartItems();
        updateCartCount();
      }
    });

    // Exponer función addToCart globalmente para usar desde products.astro
    (window as any).addToCart = addToCart;
    (window as any).getCartState = () => cartState;

    // Inicializar carrito al cargar
    initCart();

    // Búsqueda en tiempo real
    initHeaderSearch();
  });

  // Función de búsqueda en tiempo real
  function initHeaderSearch() {
    const searchInput = document.getElementById(
      "header-search-input",
    ) as HTMLInputElement;
    const mobileSearchInput = document.getElementById(
      "mobile-search-input",
    ) as HTMLInputElement;
    const clearSearchBtn = document.getElementById("header-clear-search-btn");
    const mobileClearSearchBtn = document.getElementById(
      "mobile-clear-search-btn",
    );
    const resultsDropdown = document.getElementById("search-results-dropdown");
    const resultsContent = document.getElementById("search-results-content");
    const searchLoading = document.getElementById("search-loading");
    const searchEmpty = document.getElementById("search-empty");
    const mobileResultsDropdown = document.getElementById(
      "mobile-search-results-dropdown",
    );
    const mobileResultsContent = document.getElementById(
      "mobile-search-results-content",
    );
    const mobileSearchLoading = document.getElementById(
      "mobile-search-loading",
    );
    const mobileSearchEmpty = document.getElementById("mobile-search-empty");

    let allProducts: any[] = [];
    let searchTimeout: ReturnType<typeof setTimeout> | null = null;

    // Cargar productos
    async function loadProducts() {
      try {
        const response = await fetch("/data/products.json");
        const data = await response.json();
        allProducts = data.products || [];
      } catch (error) {
        console.error("Error cargando productos:", error);
      }
    }

    // Función de búsqueda
    function searchProducts(query: string) {
      if (!query.trim() || allProducts.length === 0) {
        if (resultsDropdown) resultsDropdown.classList.add("hidden");
        if (mobileResultsDropdown)
          mobileResultsDropdown.classList.add("hidden");
        return;
      }

      const searchTerm = query.toLowerCase().trim();
      const results = allProducts
        .filter((product) => {
          const name = (product.name || "").toLowerCase();
          const brand = (product.brand || "").toLowerCase();
          const description = (product.description || "").toLowerCase();
          return (
            name.includes(searchTerm) ||
            brand.includes(searchTerm) ||
            description.includes(searchTerm)
          );
        })
        .slice(0, 5); // Limitar a 5 resultados

      displayResults(results, query);
    }

    // Función para renderizar HTML de resultados
    function renderResultsHTML(results: any[], query: string): string {
      return results
        .map(
          (product) => `
        <a 
          href="/products?search=${encodeURIComponent(query)}" 
          class="flex items-center gap-2 p-2 rounded-lg hover:bg-purple-50 transition-colors group"
          data-astro-prefetch
        >
          <div class="w-10 h-10 bg-gray-100 rounded-lg overflow-hidden shrink-0">
            <img 
              src="${product.image}" 
              alt="${product.name}"
              class="w-full h-full object-cover group-hover:scale-110 transition-transform"
              loading="lazy"
            />
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-xs font-semibold text-gray-900 truncate">${product.name}</p>
            <p class="text-[10px] text-gray-500 truncate">${product.brand}</p>
            <p class="text-xs font-bold text-[#5d3fbb] mt-0.5">Bs. ${product.price.toLocaleString()}</p>
          </div>
        </a>
      `,
        )
        .join("");
    }

    // Mostrar resultados (desktop y móvil)
    function displayResults(results: any[], query: string) {
      // Desktop dropdown
      if (resultsDropdown && resultsContent) {
        if (results.length === 0) {
          resultsDropdown.classList.remove("hidden");
          resultsContent.classList.add("hidden");
          if (searchLoading) searchLoading.classList.add("hidden");
          if (searchEmpty) searchEmpty.classList.remove("hidden");
        } else {
          resultsDropdown.classList.remove("hidden");
          resultsContent.classList.remove("hidden");
          if (searchLoading) searchLoading.classList.add("hidden");
          if (searchEmpty) searchEmpty.classList.add("hidden");
          resultsContent.innerHTML = renderResultsHTML(results, query);
        }
      }

      // Mobile dropdown
      if (mobileResultsDropdown && mobileResultsContent) {
        if (results.length === 0) {
          mobileResultsDropdown.classList.remove("hidden");
          mobileResultsContent.classList.add("hidden");
          if (mobileSearchLoading) mobileSearchLoading.classList.add("hidden");
          if (mobileSearchEmpty) mobileSearchEmpty.classList.remove("hidden");
        } else {
          mobileResultsDropdown.classList.remove("hidden");
          mobileResultsContent.classList.remove("hidden");
          if (mobileSearchLoading) mobileSearchLoading.classList.add("hidden");
          if (mobileSearchEmpty) mobileSearchEmpty.classList.add("hidden");
          mobileResultsContent.innerHTML = renderResultsHTML(results, query);
        }
      }
    }

    // Función de búsqueda con debounce
    function handleSearch(query: string) {
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }

      if (!query.trim()) {
        if (resultsDropdown) resultsDropdown.classList.add("hidden");
        if (mobileResultsDropdown)
          mobileResultsDropdown.classList.add("hidden");
        if (clearSearchBtn) clearSearchBtn.classList.add("hidden");
        if (mobileClearSearchBtn) mobileClearSearchBtn.classList.add("hidden");
        return;
      }

      // Mostrar botón de limpiar
      if (clearSearchBtn) clearSearchBtn.classList.remove("hidden");
      if (mobileClearSearchBtn) mobileClearSearchBtn.classList.remove("hidden");

      // Mostrar loading en desktop
      if (resultsDropdown) resultsDropdown.classList.remove("hidden");
      if (resultsContent) resultsContent.classList.add("hidden");
      if (searchLoading) searchLoading.classList.remove("hidden");
      if (searchEmpty) searchEmpty.classList.add("hidden");

      // Mostrar loading en móvil
      if (mobileResultsDropdown)
        mobileResultsDropdown.classList.remove("hidden");
      if (mobileResultsContent) mobileResultsContent.classList.add("hidden");
      if (mobileSearchLoading) mobileSearchLoading.classList.remove("hidden");
      if (mobileSearchEmpty) mobileSearchEmpty.classList.add("hidden");

      searchTimeout = setTimeout(() => {
        searchProducts(query);
      }, 300);
    }

    // Event listeners para desktop
    searchInput?.addEventListener("input", (e) => {
      const query = (e.target as HTMLInputElement).value;
      // Sincronizar con móvil
      if (mobileSearchInput) mobileSearchInput.value = query;
      handleSearch(query);
    });

    searchInput?.addEventListener("focus", () => {
      const query = searchInput.value;
      if (query.trim()) {
        searchProducts(query);
      }
    });

    clearSearchBtn?.addEventListener("click", () => {
      searchInput.value = "";
      if (mobileSearchInput) mobileSearchInput.value = "";
      if (resultsDropdown) resultsDropdown.classList.add("hidden");
      if (mobileResultsDropdown) mobileResultsDropdown.classList.add("hidden");
      clearSearchBtn.classList.add("hidden");
      if (mobileClearSearchBtn) mobileClearSearchBtn.classList.add("hidden");
      searchInput.focus();
    });

    // Event listeners para móvil
    mobileSearchInput?.addEventListener("input", (e) => {
      const query = (e.target as HTMLInputElement).value;
      // Sincronizar con desktop
      if (searchInput) searchInput.value = query;
      handleSearch(query);
    });

    mobileSearchInput?.addEventListener("focus", () => {
      const query = mobileSearchInput.value;
      if (query.trim()) {
        searchProducts(query);
      }
    });

    mobileClearSearchBtn?.addEventListener("click", () => {
      mobileSearchInput.value = "";
      if (searchInput) searchInput.value = "";
      if (resultsDropdown) resultsDropdown.classList.add("hidden");
      if (mobileResultsDropdown) mobileResultsDropdown.classList.add("hidden");
      mobileClearSearchBtn.classList.add("hidden");
      if (clearSearchBtn) clearSearchBtn.classList.add("hidden");
      mobileSearchInput.focus();
    });

    // Cerrar dropdown con ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (resultsDropdown && !resultsDropdown.classList.contains("hidden")) {
          resultsDropdown.classList.add("hidden");
        }
        if (
          mobileResultsDropdown &&
          !mobileResultsDropdown.classList.contains("hidden")
        ) {
          mobileResultsDropdown.classList.add("hidden");
        }
        searchInput?.blur();
        mobileSearchInput?.blur();
      }
    });

    // Cargar productos al inicializar
    loadProducts();
  }
</script>

<style>
  #cart-footer {
  box-shadow: 0 -4px 12px rgba(0,0,0,0.06);
}
  /* Estilos para el dropdown de búsqueda */
  #search-results-dropdown {
    animation: slideDown 0.15s ease-out;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }

  #search-results-dropdown::-webkit-scrollbar {
    width: 4px;
  }

  #search-results-dropdown::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 8px;
  }

  #search-results-dropdown::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 8px;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-5px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Placeholder personalizado */
  #header-search-input::placeholder,
  #mobile-search-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  /* Estilos para el contenedor de búsqueda móvil */
  #mobile-search-container {
    transition:
      max-height 0.25s ease-out,
      opacity 0.25s ease-out;
  }

  #mobile-search-container.max-h-0 {
    opacity: 0;
  }

  #mobile-search-container:not(.max-h-0) {
    opacity: 1;
  }

  /* Estilos para el dropdown de resultados móvil */
  #mobile-search-results-dropdown {
    animation: slideDown 0.15s ease-out;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
  }

  #mobile-search-results-dropdown::-webkit-scrollbar {
    width: 4px;
  }

  #mobile-search-results-dropdown::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 8px;
  }

  #mobile-search-results-dropdown::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 8px;
  }

  /* Badge del carrito: diseño moderno, simétrico y visible */
  .cart-count-badge {
    --badge-size: 1.25rem;
    position: absolute;
    top: 0;
    right: 0;
    min-width: var(--badge-size);
    height: var(--badge-size);
    padding: 0 0.4em;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    background: linear-gradient(135deg, #5d3fbb 0%, #6d4fcc 100%);
    color: #fff;
    font-size: 0.6875rem;
    font-weight: 700;
    line-height: 1;
    letter-spacing: 0.02em;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
    box-shadow:
      0 2px 8px rgba(93, 63, 187, 0.35),
      0 0 0 2px rgba(255, 255, 255, 0.95);
    z-index: 10;
    user-select: none;
    box-sizing: border-box;
  }
  .cart-count-badge.hidden {
    display: none !important;
  }
  .cart-count-badge:not(.hidden) {
    animation: cart-badge-in 0.45s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes cart-badge-in {
    0% { transform: scale(0); opacity: 0; }
    70% { transform: scale(1.08); }
    100% { transform: scale(1); opacity: 1; }
  }

  /* Estilos para el dropdown del carrito */
#cart-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
}

  #cart-dropdown::-webkit-scrollbar {
    width: 6px;
  }

  #cart-dropdown::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 8px;
  }

  #cart-dropdown::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 8px;
  }

  #cart-dropdown::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  @keyframes slideDownCart {
    from {
      opacity: 0;
      transform: translateY(-8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilos para items del carrito */
  .cart-item {
    transition: background-color 0.15s ease;
  }

  .cart-item:hover {
    background-color: #f9fafb;
  }

/* Mobile */
@media (max-width: 640px) {

  .cart-item {
    padding: 0.75rem;
    border-radius: 0.75rem;
  }
  
  body.cart-open::before {
    content: '';
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.2);
    backdrop-filter: blur(4px);
    z-index: 40;
  }
  #cart-dropdown {
    position: fixed;
    left: 0.75rem;
    right: 0.75rem;
    bottom: 0.75rem;
    top: auto;

    width: auto;
    max-width: none;
    max-height: calc(100vh - 5.5rem);

    border-radius: 1.25rem;
    overflow: hidden;

    animation: slideUpMobile 0.28s cubic-bezier(.16,1,.3,1);
  }

  #cart-footer {
    padding-bottom: calc(1rem + env(safe-area-inset-bottom));
  }

  #cart-content {
    overscroll-behavior: contain;
  }

  @keyframes slideUpMobile {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }


  /* Badge en móvil: contenido dentro del botón, mismo estilo */
  .cart-count-badge:not(.hidden) {
    top: 2px;
    right: 2px;
    --badge-size: 1.125rem;
    font-size: 0.625rem;
    box-shadow:
      0 1px 4px rgba(93, 63, 187, 0.35),
      0 0 0 1.5px rgba(255, 255, 255, 0.95);
  }

  #cart-btn {
    position: relative;
    overflow: visible !important;
  }
</style>
