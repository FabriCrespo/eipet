---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Breadcrumb -->
      <nav class="mb-6 flex items-center gap-2 text-sm text-gray-600">
        <a href="/" class="hover:text-[#5d3fbb] transition-colors" data-astro-prefetch>Inicio</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/cart" class="hover:text-[#5d3fbb] transition-colors" data-astro-prefetch>Carrito</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-800 font-medium">Checkout</span>
      </nav>

      <h1 class="text-3xl lg:text-4xl font-bold text-[#5d3fbb] mb-8">Finalizar Compra</h1>

      <!-- Loading State -->
      <div id="checkout-loading" class="text-center py-16">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#5d3fbb]"></div>
        <p class="mt-4 text-gray-600">Cargando información...</p>
      </div>

      <!-- Checkout Content -->
      <div id="checkout-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Main Content -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Shipping Address -->
            <div class="bg-white rounded-xl shadow-lg p-6">
              <h2 class="text-xl font-bold text-gray-800 mb-4">Dirección de Envío</h2>
              <div id="addresses-list" class="space-y-3">
                <!-- Addresses will be loaded here -->
              </div>
              <a href="/profile?section=addresses" class="mt-4 inline-block text-[#5d3fbb] hover:underline text-sm font-medium">
                + Agregar nueva dirección
              </a>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-xl shadow-lg p-6">
              <h2 class="text-xl font-bold text-gray-800 mb-4">Método de Pago</h2>
              <div id="payment-methods-list" class="space-y-3">
                <!-- Payment methods will be loaded here -->
              </div>
              <a href="/profile?section=payment" class="mt-4 inline-block text-[#5d3fbb] hover:underline text-sm font-medium">
                + Agregar nuevo método de pago
              </a>
            </div>

            <!-- Order Items -->
            <div class="bg-white rounded-xl shadow-lg p-6">
              <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen del Pedido</h2>
              <div id="order-items" class="space-y-4">
                <!-- Order items will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Order Summary -->
          <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-lg p-6 sticky top-4">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">Resumen</h2>
              
              <div class="space-y-3 mb-6">
                <div class="flex justify-between text-gray-600">
                  <span>Subtotal</span>
                  <span id="order-subtotal" class="font-semibold">Bs. 0.00</span>
                </div>
                <div class="flex justify-between text-gray-600">
                  <span>Envío</span>
                  <span id="order-shipping" class="font-semibold">Bs. 0.00</span>
                </div>
                <div class="flex justify-between text-gray-600">
                  <span>Descuento</span>
                  <span id="order-discount" class="font-semibold text-green-600">-Bs. 0.00</span>
                </div>
                <div class="border-t border-gray-200 pt-3 mt-3">
                  <div class="flex justify-between text-xl font-bold text-[#5d3fbb]">
                    <span>Total</span>
                    <span id="order-total" class="text-2xl">Bs. 0.00</span>
                  </div>
                </div>
              </div>

              <button 
                id="place-order-btn"
                class="w-full bg-[#5d3fbb] hover:bg-[#6d4fcc] text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Confirmar Pedido
              </button>
              
              <a 
                href="/cart"
                class="mt-4 w-full block text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-xl transition-all duration-300"
              >
                Volver al Carrito
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  (async () => {
    // Dynamic imports
    const { getCart } = await import('../lib/db/cart');
    const { getProductById, validateAndAdjustStockMultiple } = await import('../lib/db/products');
    const { getUserAddresses } = await import('../lib/db/users');
    const { getPaymentMethods } = await import('../lib/db/payment');
    const { createOrder } = await import('../lib/db/orders');
    const { clearCart } = await import('../lib/db/cart');
    const { getCurrentUser, getCurrentUserData } = await import('../lib/auth');
    
    // Check authentication
    const firebaseUser = getCurrentUser();
    if (!firebaseUser) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }
    
    const userDataResult = await getCurrentUserData();
    if (!userDataResult.success || !userDataResult.user) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }
    
    const currentUser = userDataResult.user;
    let selectedAddress: any = null;
    let selectedPaymentMethod: any = null;
    let cartItems: any[] = [];
    let productsData: Map<string, any> = new Map();
    
    try {
      // Load cart
      const cartResult = await getCart(currentUser.id);
      if (cartResult.error || !cartResult.data || !cartResult.data.items || cartResult.data.items.length === 0) {
        alert('Tu carrito está vacío');
        window.location.href = '/cart';
        return;
      }
      
      cartItems = cartResult.data.items;
      
      // Load products
      for (const item of cartItems) {
        const productResult = await getProductById(item.productId);
        if (productResult.data) {
          productsData.set(item.productId, productResult.data);
        }
      }
      
      // Load addresses
      const addressesResult = await getUserAddresses(currentUser.id);
      const addresses = addressesResult.data || [];
      
      // Load payment methods
      const paymentMethodsResult = await getPaymentMethods(currentUser.id);
      const paymentMethods = paymentMethodsResult.data || [];
      
      // Render addresses
      const addressesList = document.getElementById('addresses-list');
      if (addressesList) {
        if (addresses.length === 0) {
          addressesList.innerHTML = `
            <p class="text-gray-600 mb-4">No tienes direcciones registradas.</p>
            <a href="/profile?section=addresses" class="inline-block bg-[#5d3fbb] text-white px-4 py-2 rounded-lg hover:bg-[#6d4fcc] transition-colors">
              Agregar Dirección
            </a>
          `;
        } else {
          addressesList.innerHTML = addresses.map((addr: any) => {
            const isDefault = addr.isDefault || false;
            const fullName = addr.fullName || `${addr.firstName || ''} ${addr.lastName || ''}`.trim();
            const addressLine = addr.address || addr.street || '';
            return `
              <label class="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all hover:border-[#5d3fbb] address-option ${isDefault ? 'border-[#5d3fbb] bg-purple-50' : 'border-gray-200'}" data-address-id="${addr.id}">
                <input type="radio" name="address" value="${addr.id}" class="mt-1" ${isDefault ? 'checked' : ''} />
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold text-gray-900">${addr.name || 'Dirección'}</span>
                    ${isDefault ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Por defecto</span>' : ''}
                  </div>
                  <p class="text-sm text-gray-700">${fullName}</p>
                  <p class="text-sm text-gray-600">${addressLine}</p>
                  <p class="text-sm text-gray-600">${addr.district || ''}, ${addr.city || ''}</p>
                  <p class="text-sm text-gray-600">${addr.phone || ''}</p>
                </div>
              </label>
            `;
          }).join('');
          
          // Set default address
          const defaultAddress = addresses.find((a: any) => a.isDefault) || addresses[0];
          if (defaultAddress) {
            selectedAddress = defaultAddress;
          }
          
          // Address selection
          document.querySelectorAll('.address-option').forEach(option => {
            option.addEventListener('click', () => {
              document.querySelectorAll('.address-option').forEach(opt => {
                opt.classList.remove('border-[#5d3fbb]', 'bg-purple-50');
                opt.classList.add('border-gray-200');
              });
              option.classList.add('border-[#5d3fbb]', 'bg-purple-50');
              option.classList.remove('border-gray-200');
              
              const radio = option.querySelector('input[type="radio"]') as HTMLInputElement;
              if (radio) radio.checked = true;
              
              const addressId = option.getAttribute('data-address-id');
              selectedAddress = addresses.find((a: any) => a.id === addressId);
              updatePlaceOrderButton();
            });
          });
        }
      }
      
      // Render payment methods
      const paymentMethodsList = document.getElementById('payment-methods-list');
      if (paymentMethodsList) {
        if (paymentMethods.length === 0) {
          paymentMethodsList.innerHTML = `
            <p class="text-gray-600 mb-4">No tienes métodos de pago registrados.</p>
            <a href="/profile?section=payment" class="inline-block bg-[#5d3fbb] text-white px-4 py-2 rounded-lg hover:bg-[#6d4fcc] transition-colors">
              Agregar Método de Pago
            </a>
          `;
        } else {
          paymentMethodsList.innerHTML = paymentMethods.map((method: any) => {
            const isDefault = method.isDefault || false;
            const cardNumber = method.cardNumber ? `**** ${method.cardNumber.slice(-4)}` : '';
            return `
              <label class="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all hover:border-[#5d3fbb] payment-option ${isDefault ? 'border-[#5d3fbb] bg-purple-50' : 'border-gray-200'}" data-payment-id="${method.id}">
                <input type="radio" name="payment" value="${method.id}" class="mt-1" ${isDefault ? 'checked' : ''} />
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold text-gray-900">${method.brand || 'Tarjeta'}</span>
                    ${isDefault ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Por defecto</span>' : ''}
                  </div>
                  ${cardNumber ? `<p class="text-sm text-gray-700">${cardNumber}</p>` : ''}
                  ${method.cardHolder ? `<p class="text-sm text-gray-600">${method.cardHolder}</p>` : ''}
                  ${method.expiryDate ? `<p class="text-sm text-gray-600">Válida hasta ${method.expiryDate}</p>` : ''}
                </div>
              </label>
            `;
          }).join('');
          
          // Set default payment method
          const defaultPayment = paymentMethods.find((m: any) => m.isDefault) || paymentMethods[0];
          if (defaultPayment) {
            selectedPaymentMethod = defaultPayment;
          }
          
          // Payment method selection
          document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', () => {
              document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('border-[#5d3fbb]', 'bg-purple-50');
                opt.classList.add('border-gray-200');
              });
              option.classList.add('border-[#5d3fbb]', 'bg-purple-50');
              option.classList.remove('border-gray-200');
              
              const radio = option.querySelector('input[type="radio"]') as HTMLInputElement;
              if (radio) radio.checked = true;
              
              const paymentId = option.getAttribute('data-payment-id');
              selectedPaymentMethod = paymentMethods.find((m: any) => m.id === paymentId);
              updatePlaceOrderButton();
            });
          });
        }
      }
      
      // Render order items
      const orderItemsContainer = document.getElementById('order-items');
      if (orderItemsContainer) {
        orderItemsContainer.innerHTML = cartItems.map((item: any) => {
          const product = productsData.get(item.productId);
          if (!product) return '';
          
          const currentPrice = product.price || 0;
          const discount = product.discount || 0;
          const originalPrice = product.originalPrice || null;
          const finalPrice = originalPrice ? originalPrice * (1 - discount / 100) : currentPrice;
          const itemTotal = finalPrice * item.quantity;
          
          return `
            <div class="flex items-center gap-4 pb-4 border-b border-gray-200 last:border-0">
              <img src="${product.image || 'https://via.placeholder.com/80'}" alt="${product.name}" class="w-20 h-20 rounded-lg object-cover border border-gray-200" />
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">${product.name}</h3>
                <p class="text-sm text-gray-600">Cantidad: ${item.quantity}</p>
                <div class="flex items-center gap-2 mt-1">
                  <p class="text-sm font-semibold text-gray-900">Bs. ${itemTotal.toFixed(2)}</p>
                  ${originalPrice && discount > 0 ? `
                    <p class="text-xs text-gray-400 line-through">Bs. ${(originalPrice * item.quantity).toFixed(2)}</p>
                    <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">-${discount}%</span>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Calculate totals using current product prices
      let subtotal = 0;
      let totalDiscount = 0;
      
      for (const item of cartItems) {
        const product = productsData.get(item.productId);
        if (!product) continue;
        
        const currentPrice = product.price || 0;
        const discount = product.discount || 0;
        const originalPrice = product.originalPrice || null;
        const finalPrice = originalPrice ? originalPrice * (1 - discount / 100) : currentPrice;
        
        subtotal += finalPrice * item.quantity;
        if (originalPrice && discount > 0) {
          totalDiscount += (originalPrice - finalPrice) * item.quantity;
        }
      }
      
      const discount = totalDiscount;
      
      // Import shipping calculation function
      const { calculateShipping: calcShipping } = await import('../lib/utils/shipping');
      
      const shipping = calcShipping(subtotal, selectedAddress);
      const total = subtotal - discount + shipping;
      
      // Update summary function
      function updateSummary() {
        let currentSubtotal = 0;
        let currentDiscount = 0;
        
        for (const item of cartItems) {
          const product = productsData.get(item.productId);
          if (!product) continue;
          
          const currentPrice = product.price || 0;
          const discount = product.discount || 0;
          const originalPrice = product.originalPrice || null;
          const finalPrice = originalPrice ? originalPrice * (1 - discount / 100) : currentPrice;
          
          currentSubtotal += finalPrice * item.quantity;
          if (originalPrice && discount > 0) {
            currentDiscount += (originalPrice - finalPrice) * item.quantity;
          }
        }
        
        const currentShipping = calcShipping(currentSubtotal, selectedAddress);
        const currentTotal = currentSubtotal - currentDiscount + currentShipping;
        
        const subtotalEl = document.getElementById('order-subtotal');
        const shippingEl = document.getElementById('order-shipping');
        const discountEl = document.getElementById('order-discount');
        const totalEl = document.getElementById('order-total');
        
        if (subtotalEl) subtotalEl.textContent = `Bs. ${currentSubtotal.toFixed(2)}`;
        if (shippingEl) shippingEl.textContent = `Bs. ${currentShipping.toFixed(2)}`;
        if (discountEl) discountEl.textContent = `-Bs. ${currentDiscount.toFixed(2)}`;
        if (totalEl) totalEl.textContent = `Bs. ${currentTotal.toFixed(2)}`;
      }
      
      updateSummary();
      
      // Update place order button
      function updatePlaceOrderButton() {
        const placeOrderBtn = document.getElementById('place-order-btn');
        if (placeOrderBtn) {
          placeOrderBtn.disabled = !selectedAddress || !selectedPaymentMethod;
        }
      }
      
      updatePlaceOrderButton();
      
      // Update summary when address changes
      const originalAddressSelection = document.querySelectorAll('.address-option');
      originalAddressSelection.forEach(option => {
        option.addEventListener('click', () => {
          setTimeout(() => {
            updateSummary();
            updatePlaceOrderButton();
          }, 100);
        });
      });
      
      // Place order
      const placeOrderBtn = document.getElementById('place-order-btn');
      if (placeOrderBtn) {
        placeOrderBtn.addEventListener('click', async () => {
          if (!selectedAddress || !selectedPaymentMethod) {
            alert('Por favor, selecciona una dirección de envío y un método de pago');
            return;
          }
          
          if (placeOrderBtn.disabled) return;
          
          placeOrderBtn.disabled = true;
          placeOrderBtn.textContent = 'Procesando...';
          
          try {
            // Convert cart items to order items (necesitamos los productos para obtener precios actuales)
            const orderItems = cartItems.map((item: any) => {
              const product = productsData.get(item.productId);
              const currentPrice = product?.price || 0;
              const discount = product?.discount || 0;
              const originalPrice = product?.originalPrice || null;
              const finalPrice = originalPrice ? originalPrice * (1 - discount / 100) : currentPrice;
              
              return {
                id: crypto.randomUUID(), // Generar ID único para cada item
                productId: item.productId,
                productName: product?.name || 'Producto',
                productImage: product?.image || '',
                quantity: item.quantity,
                price: finalPrice,
                subtotal: item.quantity * finalPrice
              };
            });
            
            // Validar y actualizar stock de manera atómica usando transacciones
            const stockItems = cartItems.map((item: any) => ({
              productId: item.productId,
              quantity: item.quantity
            }));
            
            const stockResult = await validateAndAdjustStockMultiple(stockItems);
            
            if (!stockResult.success) {
              placeOrderBtn.disabled = false;
              placeOrderBtn.textContent = 'Confirmar Pedido';
              
              const errorMessage = 'Los siguientes productos no tienen stock suficiente:\n\n' + stockResult.errors.join('\n') + '\n\nPor favor, ajusta las cantidades o elimina los productos sin stock.';
              alert(errorMessage);
              return;
            }
            
            // Map address to UserAddress format
            const shippingAddress: any = {
              id: selectedAddress.id,
              name: selectedAddress.name || 'Dirección',
              fullName: selectedAddress.fullName || `${selectedAddress.firstName || ''} ${selectedAddress.lastName || ''}`.trim(),
              phone: selectedAddress.phone || '',
              address: selectedAddress.address || selectedAddress.street || '',
              city: selectedAddress.city || '',
              district: selectedAddress.district || '',
              zipCode: selectedAddress.zipCode || '',
              latitude: selectedAddress.latitude,
              longitude: selectedAddress.longitude,
              instructions: selectedAddress.instructions,
              isDefault: selectedAddress.isDefault || false
            };
            
            // Map payment method to PaymentMethod format
            const paymentMethod: any = {
              id: selectedPaymentMethod.id,
              type: selectedPaymentMethod.type || 'card',
              cardNumber: selectedPaymentMethod.cardNumber,
              expiryDate: selectedPaymentMethod.expiryDate,
              cardholderName: selectedPaymentMethod.cardHolder || selectedPaymentMethod.cardholderName,
              isDefault: selectedPaymentMethod.isDefault || false
            };
            
            // Create order (el stock ya fue actualizado en la transacción anterior)
            const orderResult = await createOrder({
              userId: currentUser.id,
              items: orderItems,
              subtotal: subtotal,
              discount: discount,
              shippingAddress: shippingAddress,
              paymentMethod: paymentMethod,
              shippingCost: shipping
            });
            
            if (orderResult.success) {
              // Clear cart
              await clearCart(currentUser.id);
              
              // Redirect to success page or orders
              alert('¡Pedido creado exitosamente!');
              window.location.href = '/profile?section=orders';
            } else {
              // Si falla la creación del pedido, necesitamos revertir el stock
              // Esto es raro pero podría pasar. En producción, esto debería manejarse con una transacción más compleja
              // o con Cloud Functions que manejen la reversión automáticamente
              console.error('Error creating order after stock update. Stock may need manual adjustment.');
              throw new Error(orderResult.error?.message || 'Error al crear el pedido');
            }
          } catch (error: any) {
            console.error('Error placing order:', error);
            alert('Error al crear el pedido: ' + (error.message || 'Error desconocido'));
            placeOrderBtn.disabled = false;
            placeOrderBtn.textContent = 'Confirmar Pedido';
          }
        });
      }
      
      // Hide loading and show content
      const loadingEl = document.getElementById('checkout-loading');
      const contentEl = document.getElementById('checkout-content');
      if (loadingEl) loadingEl.classList.add('hidden');
      if (contentEl) contentEl.classList.remove('hidden');
      
    } catch (error) {
      console.error('Error loading checkout:', error);
      alert('Error al cargar la información del checkout');
      const loadingEl = document.getElementById('checkout-loading');
      if (loadingEl) loadingEl.classList.add('hidden');
    }
  })();
</script>

