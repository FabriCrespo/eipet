---
import Layout from '../layouts/Layout.astro';
import OrderConfirmationModal from '../components/OrderConfirmationModal.astro';
---

<Layout title="Checkout - Eipet">
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Breadcrumb -->
      <nav class="mb-6 flex items-center gap-2 text-sm text-gray-600">
        <a href="/" class="hover:text-[#5d3fbb] transition-colors" data-astro-prefetch>Inicio</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <a href="/products" class="hover:text-[#5d3fbb] transition-colors" data-astro-prefetch>Productos</a>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-800 font-medium">Checkout</span>
      </nav>

      <!-- T√≠tulo -->
      <div class="mb-8">
        <h1 class="text-3xl lg:text-4xl font-bold bg-linear-to-r from-[#5d3fbb] to-[#6d4fcc] bg-clip-text text-transparent mb-2">
          Finalizar Compra
        </h1>
        <p class="text-gray-600">Completa tu informaci√≥n para procesar tu pedido</p>
      </div>

      <!-- Loading State -->
      <div id="checkout-loading" class="text-center py-20">
        <div class="relative w-16 h-16 mx-auto mb-4">
          <div class="absolute inset-0 border-4 border-[#5d3fbb]/20 rounded-full"></div>
          <div class="absolute inset-0 border-4 border-transparent border-t-[#5d3fbb] rounded-full animate-spin"></div>
        </div>
        <p class="text-[#5d3fbb] font-semibold text-lg">Cargando carrito...</p>
      </div>

      <!-- Error State -->
      <div id="checkout-error" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 mb-6">
        <div class="flex items-center gap-3">
          <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 class="font-bold text-red-800 mb-1">Error</h3>
            <p id="error-message" class="text-red-600 text-sm"></p>
          </div>
        </div>
      </div>

      <!-- Empty Cart State -->
      <div id="empty-cart" class="hidden text-center py-20">
        <div class="max-w-md mx-auto">
          <div class="relative mb-6">
            <div class="absolute inset-0 bg-linear-to-br from-purple-100 to-pink-100 rounded-full blur-2xl opacity-50"></div>
            <svg class="relative w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Tu carrito est√° vac√≠o</h3>
          <p class="text-gray-500 mb-6">Agrega productos a tu carrito antes de continuar.</p>
          <a
            href="/products"
            class="inline-flex items-center gap-2 bg-linear-to-r from-[#5d3fbb] to-[#6d4fcc] hover:from-[#6d4fcc] hover:to-[#7d5fdd] text-white font-semibold px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95"
            data-astro-prefetch
          >
            <span>Ir a Productos</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </a>
        </div>
      </div>

      <!-- Checkout Content -->
      <div id="checkout-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
          <!-- Formulario de Checkout -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Informaci√≥n de Env√≠o -->
            <div class="bg-white rounded-xl shadow-md p-6">
              <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Informaci√≥n de Env√≠o
              </h2>
              
              <!-- Direcciones guardadas (solo si hay usuario logueado) -->
              <div id="saved-addresses-section" class="hidden mb-4">
                <div class="mb-3">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Seleccionar direcci√≥n guardada
                  </label>
                  <div id="addresses-list" class="space-y-2 mb-3">
                    <!-- Se llenar√° din√°micamente -->
                  </div>
                  <button
                    type="button"
                    id="use-new-address-btn"
                    class="text-sm text-[#5d3fbb] hover:underline font-medium"
                  >
                    Usar nueva direcci√≥n
                  </button>
                </div>
              </div>
              
              <form id="shipping-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label for="fullName" class="block text-sm font-semibold text-gray-700 mb-2">
                      Nombre Completo <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="fullName"
                      name="fullName"
                      required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 focus:border-[#5d3fbb] transition-all"
                      placeholder="Juan P√©rez"
                    />
                  </div>
                  <div>
                    <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
                      Tel√©fono <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 focus:border-[#5d3fbb] transition-all"
                      placeholder="+591 70000000"
                    />
                  </div>
                </div>

                <div>
                  <label for="address" class="block text-sm font-semibold text-gray-700 mb-2">
                    Direcci√≥n <span class="text-red-500">*</span>
                  </label>
                  <input
                    type="text"
                    id="address"
                    name="address"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 focus:border-[#5d3fbb] transition-all"
                    placeholder="Calle, n√∫mero, zona"
                  />
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label for="city" class="block text-sm font-semibold text-gray-700 mb-2">
                      Ciudad <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="city"
                      name="city"
                      required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 focus:border-[#5d3fbb] transition-all"
                      placeholder="La Paz"
                    />
                  </div>
                  <div>
                    <label for="district" class="block text-sm font-semibold text-gray-700 mb-2">
                      Zona/Distrito <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="district"
                      name="district"
                      required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 focus:border-[#5d3fbb] transition-all"
                      placeholder="Zona Sur"
                    />
                  </div>
                </div>

                <div>
                  <label for="instructions" class="block text-sm font-semibold text-gray-700 mb-2">
                    Instrucciones de Entrega (Opcional)
                  </label>
                  <textarea
                    id="instructions"
                    name="instructions"
                    rows="3"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 focus:border-[#5d3fbb] transition-all resize-none"
                    placeholder="Ej: Llamar antes de llegar, dejar en recepci√≥n, etc."
                  ></textarea>
                </div>
              </form>
            </div>

            <!-- M√©todo de Pago -->
            <div class="bg-white rounded-xl shadow-md p-6">
              <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                M√©todo de Pago
              </h2>
              
              <!-- M√©todos de pago guardados (solo si hay usuario logueado) -->
              <div id="saved-payment-methods-section" class="hidden mb-4">
                <div class="mb-3">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Seleccionar m√©todo de pago guardado
                  </label>
                  <div id="payment-methods-list" class="space-y-2 mb-3">
                    <!-- Se llenar√° din√°micamente -->
                  </div>
                  <button
                    type="button"
                    id="use-new-payment-btn"
                    class="text-sm text-[#5d3fbb] hover:underline font-medium"
                  >
                    Usar otro m√©todo de pago
                  </button>
                </div>
              </div>
              
              <div id="payment-methods-options" class="space-y-3">
                <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#5d3fbb]/50 transition-all payment-method-option" data-method="cash">
                  <input type="radio" name="paymentMethod" value="cash" class="w-5 h-5 text-[#5d3fbb] focus:ring-[#5d3fbb]" checked />
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900">Pago Contra Entrega</div>
                    <div class="text-sm text-gray-600">Paga cuando recibas tu pedido</div>
                  </div>
                  <svg class="w-6 h-6 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </label>
              </div>
            </div>
          </div>

          <!-- Resumen del Pedido -->
          <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
              <h2 class="text-xl font-bold text-gray-900 mb-4">Resumen del Pedido</h2>
              
              <!-- Items del Carrito -->
              <div id="order-items" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                <!-- Se cargar√°n din√°micamente -->
              </div>

              <!-- Resumen de Precios -->
              <div class="border-t border-gray-200 pt-4 space-y-3">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Subtotal</span>
                  <span id="subtotal" class="font-semibold text-gray-900">Bs. 0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Env√≠o</span>
                  <span id="shipping-cost" class="font-semibold text-gray-900">Bs. 0.00</span>
                </div>
                <div class="flex justify-between text-sm" id="discount-row" style="display: none;">
                  <span class="text-gray-600">Descuento</span>
                  <span id="discount" class="font-semibold text-green-600">-Bs. 0.00</span>
                </div>
                <div class="border-t border-gray-200 pt-3 flex justify-between">
                  <span class="text-lg font-bold text-gray-900">Total</span>
                  <span id="total" class="text-lg font-bold text-[#5d3fbb]">Bs. 0.00</span>
                </div>
              </div>

              <!-- Bot√≥n de Confirmar Pedido -->
              <button
                id="confirm-order-btn"
                class="w-full mt-6 bg-linear-to-r from-[#5d3fbb] to-[#6d4fcc] hover:from-[#6d4fcc] hover:to-[#7d5fdd] text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                disabled
              >
                <span id="confirm-btn-text">Confirmar Pedido</span>
                <span id="confirm-btn-loading" class="hidden items-center justify-center gap-2">
                  <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Procesando...
                </span>
              </button>

              <p class="text-xs text-gray-500 text-center mt-4">
                Al confirmar, aceptas nuestros t√©rminos y condiciones
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal de Confirmaci√≥n de Orden -->
  <OrderConfirmationModal id="order-confirmation-modal" />

  <style>
    .payment-method-option input:checked + div {
      color: #5d3fbb;
    }
    
    .payment-method-option:has(input:checked) {
      border-color: #5d3fbb;
      background-color: #f3f4f6;
    }
  </style>

  <script>
    (async () => {
      // Verificar autenticaci√≥n (solo requerida al confirmar, no para ver el checkout)
      const { getCurrentUser, onAuthStateChange } = await import('../lib/auth');
      
      let currentUser: any = null;
      let currentUserId: string | null = null;
      let cartItems: any[] = [];
      let productsData: Map<string, any> = new Map();
      let shippingCost = 0;
      let userAddresses: any[] = [];
      let userPaymentMethods: any[] = [];
      let selectedAddressId: string | null = null;
      let selectedPaymentMethodId: string | null = null;
      let useManualAddress = true;
      let useManualPayment = true;

      // Funci√≥n para obtener y actualizar el usuario actual
      async function updateCurrentUser() {
        console.log('üîê [CHECKOUT] updateCurrentUser - Verificando autenticaci√≥n...');
        const firebaseUser = getCurrentUser();
        console.log('üîê [CHECKOUT] firebaseUser desde getCurrentUser():', firebaseUser);
        console.log('üîê [CHECKOUT] auth.currentUser:', (await import('../lib/firebase')).auth.currentUser);
        
        if (firebaseUser) {
          currentUserId = firebaseUser.uid;
          console.log('üîê [CHECKOUT] Usuario encontrado, currentUserId:', currentUserId);
        } else {
          currentUserId = null;
          console.log('üîê [CHECKOUT] No se encontr√≥ usuario autenticado');
        }
        return currentUserId;
      }

      // Esperar a que Firebase Auth est√© inicializado usando onAuthStateChange
      let authInitialized = false;
      const unsubscribeAuth = onAuthStateChange((firebaseUser) => {
        console.log('üîê [CHECKOUT] onAuthStateChange - Usuario cambi√≥:', firebaseUser);
        if (!authInitialized) {
          authInitialized = true;
          console.log('üîê [CHECKOUT] Firebase Auth inicializado');
        }
        
        if (firebaseUser) {
          currentUserId = firebaseUser.uid;
          console.log('üîê [CHECKOUT] Usuario autenticado, currentUserId:', currentUserId);
          // Recargar direcciones y m√©todos de pago si el usuario se autentica y el checkout est√° visible
          if (checkoutContent && !checkoutContent.classList.contains('hidden')) {
            console.log('üîê [CHECKOUT] Checkout visible, cargando direcciones y m√©todos de pago...');
            loadUserAddresses();
            loadUserPaymentMethods();
          }
        } else {
          currentUserId = null;
          console.log('üîê [CHECKOUT] Usuario desautenticado');
        }
      });
      
      // Esperar un momento para que Firebase Auth se inicialice
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Verificar usuario despu√©s de esperar
      await updateCurrentUser();

      // Elementos del DOM
      const loadingDiv = document.getElementById('checkout-loading');
      const errorDiv = document.getElementById('checkout-error');
      const errorMessage = document.getElementById('error-message');
      const emptyCartDiv = document.getElementById('empty-cart');
      const checkoutContent = document.getElementById('checkout-content');
      const orderItemsDiv = document.getElementById('order-items');
      const subtotalSpan = document.getElementById('subtotal');
      const shippingCostSpan = document.getElementById('shipping-cost');
      const discountSpan = document.getElementById('discount');
      const discountRow = document.getElementById('discount-row');
      const totalSpan = document.getElementById('total');
      const confirmBtn = document.getElementById('confirm-order-btn');
      const confirmBtnText = document.getElementById('confirm-btn-text');
      const confirmBtnLoading = document.getElementById('confirm-btn-loading');
      const shippingForm = document.getElementById('shipping-form') as HTMLFormElement;
      const savedAddressesSection = document.getElementById('saved-addresses-section');
      const addressesList = document.getElementById('addresses-list');
      const useNewAddressBtn = document.getElementById('use-new-address-btn');
      const savedPaymentMethodsSection = document.getElementById('saved-payment-methods-section');
      const paymentMethodsList = document.getElementById('payment-methods-list');
      const useNewPaymentBtn = document.getElementById('use-new-payment-btn');
      const paymentMethodsOptions = document.getElementById('payment-methods-options');

      // Funci√≥n para mostrar error
      function showError(message: string) {
        if (errorDiv && errorMessage) {
          errorMessage.textContent = message;
          errorDiv.classList.remove('hidden');
        }
      }

      // Funci√≥n para ocultar error
      function hideError() {
        if (errorDiv) {
          errorDiv.classList.add('hidden');
        }
      }

      // Funci√≥n para formatear precio
      function formatPrice(price: number): string {
        return price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Cargar carrito y productos
      async function loadCheckout() {
        try {
          hideError();
          
          // Obtener carrito desde localStorage
          let cartData: any = null;
          try {
            const cartStorage = localStorage.getItem('cart');
            if (cartStorage) {
              cartData = JSON.parse(cartStorage);
            }
          } catch (e) {
            // Error silencioso
          }
          
          if (!cartData || !cartData.items || cartData.items.length === 0) {
            if (loadingDiv) loadingDiv.classList.add('hidden');
            if (emptyCartDiv) emptyCartDiv.classList.remove('hidden');
            return;
          }

          // Convertir items del localStorage al formato esperado
          cartItems = cartData.items.map((item: any) => {
            const productId = item.productId || item.id || item.product?.id;
            const quantity = item.quantity || 1;
            return {
              productId: productId,
              quantity: quantity
            };
          }).filter((item: any) => item.productId);

          // Obtener informaci√≥n de productos
          const { getProductById } = await import('../lib/db/products');
          const { getBrands } = await import('../lib/db/brands');
          
          const brandsResult = await getBrands();
          const brandsMap = new Map();
          if (brandsResult.data) {
            brandsResult.data.forEach((b: any) => brandsMap.set(b.id, b));
          }

          // Obtener detalles de cada producto
          for (const item of cartData.items) {
            const productId = item.productId || item.id;
            
            if (item.product) {
              productsData.set(productId, {
                ...item.product,
                brandName: item.product.brandName || 'Sin marca',
                quantity: item.quantity
              });
            } else {
              const productResult = await getProductById(productId);
              if (productResult.data) {
                const product = productResult.data;
                const brandName = product.brand && brandsMap.has(product.brand) 
                  ? brandsMap.get(product.brand).name 
                  : 'Sin marca';
                
                productsData.set(productId, {
                  ...product,
                  brandName,
                  quantity: item.quantity
                });
              }
            }
          }

          // Renderizar items
          renderOrderItems();
          updateTotals();

          // Ocultar loading y mostrar contenido
          if (loadingDiv) loadingDiv.classList.add('hidden');
          if (checkoutContent) checkoutContent.classList.remove('hidden');
          if (confirmBtn) (confirmBtn as HTMLButtonElement).disabled = false;

          // Esperar un poco m√°s para asegurar que Firebase Auth est√© listo
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // Verificar nuevamente el usuario antes de cargar datos
          await updateCurrentUser();
          
          // Cargar datos del usuario si est√° logueado
          if (currentUserId) {
            console.log('üë§ [CHECKOUT] Usuario logueado, cargando datos del usuario...');
            console.log('üë§ [CHECKOUT] currentUserId:', currentUserId);
            await loadUserData();
            console.log('üë§ [CHECKOUT] loadUserData completado');
            await loadUserAddresses();
            console.log('üë§ [CHECKOUT] loadUserAddresses completado');
            await loadUserPaymentMethods();
            console.log('üë§ [CHECKOUT] loadUserPaymentMethods completado');
          } else {
            console.log('üë§ [CHECKOUT] No hay usuario logueado despu√©s de verificar');
            console.log('üë§ [CHECKOUT] Esperando a que Firebase Auth se inicialice...');
            // Esperar un poco m√°s y verificar de nuevo
            setTimeout(async () => {
              await updateCurrentUser();
              if (currentUserId) {
                console.log('üë§ [CHECKOUT] Usuario encontrado despu√©s de esperar, cargando datos...');
                await loadUserData();
                await loadUserAddresses();
                await loadUserPaymentMethods();
              } else {
                console.log('üë§ [CHECKOUT] A√∫n no hay usuario despu√©s de esperar');
              }
            }, 500);
          }
        } catch (error: any) {
          showError(error.message || 'Error al cargar el carrito');
          if (loadingDiv) loadingDiv.classList.add('hidden');
        }
      }

      // Cargar datos del usuario
      async function loadUserData() {
        try {
          const { getCurrentUserData } = await import('../lib/auth');
          const userDataResult = await getCurrentUserData();
          
          if (userDataResult.success && userDataResult.user) {
            const user = userDataResult.user;
            const fullNameInput = document.getElementById('fullName') as HTMLInputElement;
            const phoneInput = document.getElementById('phone') as HTMLInputElement;
            
            if (fullNameInput && !fullNameInput.value) {
              fullNameInput.value = `${user.firstName || ''} ${user.lastName || ''}`.trim();
            }
            if (phoneInput && !phoneInput.value) {
              phoneInput.value = user.phone || '';
            }
          }
        } catch (error) {
          // Error silencioso
        }
      }

      // Cargar direcciones del usuario
      async function loadUserAddresses() {
        console.log('üìç [CHECKOUT] loadUserAddresses - Iniciando...');
        console.log('üìç [CHECKOUT] currentUserId:', currentUserId);
        
        if (!currentUserId) {
          console.log('üìç [CHECKOUT] No hay currentUserId, saliendo');
          return;
        }
        
        try {
          console.log('üìç [CHECKOUT] Importando getUserAddresses...');
          const { getUserAddresses } = await import('../lib/db/users');
          console.log('üìç [CHECKOUT] Llamando getUserAddresses con userId:', currentUserId);
          
          const result = await getUserAddresses(currentUserId);
          console.log('üìç [CHECKOUT] Resultado de getUserAddresses:', result);
          console.log('üìç [CHECKOUT] result.data:', result.data);
          console.log('üìç [CHECKOUT] result.data?.length:', result.data?.length);
          
          if (result.data && result.data.length > 0) {
            console.log('üìç [CHECKOUT] Direcciones encontradas:', result.data.length);
            userAddresses = result.data;
            console.log('üìç [CHECKOUT] userAddresses asignado:', userAddresses);
            renderAddresses();
            if (savedAddressesSection) {
              savedAddressesSection.classList.remove('hidden');
              console.log('üìç [CHECKOUT] Secci√≥n de direcciones mostrada');
            }
          } else {
            console.log('üìç [CHECKOUT] No se encontraron direcciones o result.data est√° vac√≠o');
          }
        } catch (error) {
          console.error('üìç [CHECKOUT] Error cargando direcciones:', error);
        }
      }

      // Funci√≥n helper para escapar HTML
      function escapeHtml(text: any): string {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      }

      // Renderizar direcciones guardadas
      function renderAddresses() {
        if (!addressesList || userAddresses.length === 0) return;

        addressesList.innerHTML = userAddresses.map((address: any) => {
          const isSelected = selectedAddressId === address.id;
          return `
            <label class="flex items-start gap-3 p-3 border-2 ${isSelected ? 'border-[#5d3fbb] bg-purple-50' : 'border-gray-200'} rounded-lg cursor-pointer hover:border-[#5d3fbb]/50 transition-all address-option" data-address-id="${escapeHtml(address.id)}">
              <input type="radio" name="selectedAddress" value="${escapeHtml(address.id)}" class="mt-1 w-4 h-4 text-[#5d3fbb] focus:ring-[#5d3fbb]" ${isSelected ? 'checked' : ''} />
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-semibold text-gray-900">${escapeHtml(address.name || 'Direcci√≥n')}</span>
                  ${address.isDefault ? '<span class="text-xs bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full font-medium">Predeterminada</span>' : ''}
                </div>
                <p class="text-sm text-gray-700">${escapeHtml(address.fullName)}</p>
                <p class="text-sm text-gray-600">${escapeHtml(address.address)}, ${escapeHtml(address.district)}, ${escapeHtml(address.city)}</p>
                <p class="text-sm text-gray-600">${escapeHtml(address.phone)}</p>
              </div>
            </label>
          `;
        }).join('');

        // Event listeners para selecci√≥n de direcciones
        document.querySelectorAll('.address-option').forEach((option) => {
          option.addEventListener('click', () => {
            const input = option.querySelector('input[type="radio"]') as HTMLInputElement;
            if (input) {
              selectedAddressId = input.value;
              useManualAddress = false;
              fillAddressForm(selectedAddressId);
              renderAddresses();
            }
          });
        });
      }

      // Llenar formulario con direcci√≥n seleccionada
      function fillAddressForm(addressId: string) {
        const address = userAddresses.find((a: any) => a.id === addressId);
        if (!address || !shippingForm) return;

        const fullNameInput = document.getElementById('fullName') as HTMLInputElement;
        const phoneInput = document.getElementById('phone') as HTMLInputElement;
        const addressInput = document.getElementById('address') as HTMLInputElement;
        const cityInput = document.getElementById('city') as HTMLInputElement;
        const districtInput = document.getElementById('district') as HTMLInputElement;
        const instructionsInput = document.getElementById('instructions') as HTMLTextAreaElement;

        if (fullNameInput) fullNameInput.value = address.fullName || '';
        if (phoneInput) phoneInput.value = address.phone || '';
        if (addressInput) addressInput.value = address.address || '';
        if (cityInput) cityInput.value = address.city || '';
        if (districtInput) districtInput.value = address.district || '';
        if (instructionsInput) instructionsInput.value = address.instructions || '';
      }

      // Cargar m√©todos de pago del usuario
      async function loadUserPaymentMethods() {
        console.log('üí≥ [CHECKOUT] loadUserPaymentMethods - Iniciando...');
        console.log('üí≥ [CHECKOUT] currentUserId:', currentUserId);
        
        if (!currentUserId) {
          console.log('üí≥ [CHECKOUT] No hay currentUserId, saliendo');
          return;
        }
        
        try {
          console.log('üí≥ [CHECKOUT] Importando getPaymentMethods...');
          const { getPaymentMethods } = await import('../lib/db/payment');
          console.log('üí≥ [CHECKOUT] Llamando getPaymentMethods con userId:', currentUserId);
          
          const result = await getPaymentMethods(currentUserId);
          console.log('üí≥ [CHECKOUT] Resultado de getPaymentMethods:', result);
          console.log('üí≥ [CHECKOUT] result.data:', result.data);
          console.log('üí≥ [CHECKOUT] result.data?.length:', result.data?.length);
          
          if (result.data && result.data.length > 0) {
            console.log('üí≥ [CHECKOUT] M√©todos de pago encontrados:', result.data.length);
            userPaymentMethods = result.data;
            console.log('üí≥ [CHECKOUT] userPaymentMethods asignado:', userPaymentMethods);
            
            // Seleccionar m√©todo de pago predeterminado si existe
            const defaultPayment = userPaymentMethods.find((m: any) => m.isDefault);
            console.log('üí≥ [CHECKOUT] M√©todo predeterminado encontrado:', defaultPayment);
            
            if (defaultPayment) {
              selectedPaymentMethodId = defaultPayment.id;
              useManualPayment = false;
              console.log('üí≥ [CHECKOUT] M√©todo predeterminado seleccionado:', selectedPaymentMethodId);
              if (paymentMethodsOptions) {
                paymentMethodsOptions.classList.add('hidden');
                console.log('üí≥ [CHECKOUT] Opciones de pago manual ocultadas');
              }
            }
            
            renderPaymentMethods();
            if (savedPaymentMethodsSection) {
              savedPaymentMethodsSection.classList.remove('hidden');
              console.log('üí≥ [CHECKOUT] Secci√≥n de m√©todos de pago mostrada');
            }
          } else {
            console.log('üí≥ [CHECKOUT] No se encontraron m√©todos de pago o result.data est√° vac√≠o');
          }
        } catch (error) {
          console.error('üí≥ [CHECKOUT] Error cargando m√©todos de pago:', error);
        }
      }

      // Renderizar m√©todos de pago guardados
      function renderPaymentMethods() {
        console.log('üé® [CHECKOUT] renderPaymentMethods - Iniciando...');
        console.log('üé® [CHECKOUT] paymentMethodsList:', paymentMethodsList);
        console.log('üé® [CHECKOUT] userPaymentMethods.length:', userPaymentMethods.length);
        console.log('üé® [CHECKOUT] userPaymentMethods:', userPaymentMethods);
        
        if (!paymentMethodsList || userPaymentMethods.length === 0) {
          console.log('üé® [CHECKOUT] No hay m√©todos de pago para renderizar');
          return;
        }

        paymentMethodsList.innerHTML = userPaymentMethods.map((method: any) => {
          const isSelected = selectedPaymentMethodId === method.id;
          const cardNumber = method.cardNumber || '';
          const last4 = cardNumber.length > 4 ? cardNumber.slice(-4) : '';
          const displayNumber = last4 ? `**** **** **** ${last4}` : 'Tarjeta guardada';
          
          return `
            <label class="flex items-center gap-3 p-3 border-2 ${isSelected ? 'border-[#5d3fbb] bg-purple-50' : 'border-gray-200'} rounded-lg cursor-pointer hover:border-[#5d3fbb]/50 transition-all payment-method-saved-option" data-payment-id="${escapeHtml(method.id)}">
              <input type="radio" name="selectedPaymentMethod" value="${escapeHtml(method.id)}" class="w-4 h-4 text-[#5d3fbb] focus:ring-[#5d3fbb]" ${isSelected ? 'checked' : ''} />
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-semibold text-gray-900">${escapeHtml(method.brand || 'Tarjeta')} ${escapeHtml(displayNumber)}</span>
                  ${method.isDefault ? '<span class="text-xs bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full font-medium">Predeterminada</span>' : ''}
                </div>
                <p class="text-sm text-gray-600">${escapeHtml(method.cardholderName || '')}</p>
                <p class="text-sm text-gray-600">V√°lida hasta: ${escapeHtml(method.expiryDate || '')}</p>
              </div>
            </label>
          `;
        }).join('');

        // Event listeners para selecci√≥n de m√©todos de pago
        document.querySelectorAll('.payment-method-saved-option').forEach((option) => {
          option.addEventListener('click', () => {
            const input = option.querySelector('input[type="radio"]') as HTMLInputElement;
            if (input) {
              selectedPaymentMethodId = input.value;
              useManualPayment = false;
              if (paymentMethodsOptions) paymentMethodsOptions.classList.add('hidden');
              renderPaymentMethods();
            }
          });
        });
      }

      // Renderizar items del pedido
      function renderOrderItems() {
        if (!orderItemsDiv) return;

        if (cartItems.length === 0) {
          orderItemsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos</p>';
          return;
        }

        orderItemsDiv.innerHTML = cartItems.map((item) => {
          const product = productsData.get(item.productId);
          if (!product) return '';

          const quantity = item.quantity || 1;
          const price = product.price || 0;
          const subtotal = price * quantity;

          return `
            <div class="flex gap-3">
              <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden shrink-0 flex items-center justify-center">
                <img 
                  src="${escapeHtml(product.image || 'https://images.unsplash.com/photo-1551717743-49959800b1f6?w=400&q=80')}" 
                  alt="${escapeHtml(product.name || 'Producto')}"
                  class="w-full h-full object-contain"
                  onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f3f4f6\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-family=\'Arial\' font-size=\'14\'%3EImagen no disponible%3C/text%3E%3C/svg%3E';"
                />
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-900 text-sm line-clamp-1">${escapeHtml(product.name || 'Producto')}</h4>
                <p class="text-xs text-gray-500">${escapeHtml(product.brandName || 'Sin marca')}</p>
                <div class="flex items-center justify-between mt-1">
                  <span class="text-xs text-gray-600">Cantidad: ${quantity}</span>
                  <span class="font-bold text-[#5d3fbb]">Bs. ${formatPrice(subtotal)}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Actualizar totales
      function updateTotals() {
        let subtotal = 0;

        cartItems.forEach((item) => {
          const product = productsData.get(item.productId);
          if (product) {
            const quantity = item.quantity || 1;
            subtotal += (product.price || 0) * quantity;
          }
        });

        const discount = 0; // Por ahora sin descuentos
        const total = subtotal - discount + shippingCost;

        if (subtotalSpan) subtotalSpan.textContent = `Bs. ${formatPrice(subtotal)}`;
        if (shippingCostSpan) shippingCostSpan.textContent = `Bs. ${formatPrice(shippingCost)}`;
        if (totalSpan) totalSpan.textContent = `Bs. ${formatPrice(total)}`;

        if (discount > 0) {
          if (discountSpan) discountSpan.textContent = `-Bs. ${formatPrice(discount)}`;
          if (discountRow) discountRow.style.display = 'flex';
        } else {
          if (discountRow) discountRow.style.display = 'none';
        }
      }

      // Confirmar pedido
      async function confirmOrder() {
        if (!confirmBtn || !shippingForm) {
          return;
        }

        // Verificar autenticaci√≥n (opcional - permite guest checkout)
        await updateCurrentUser();
        let isGuestOrder = false;
        let guestEmail = '';
        
        if (!currentUserId) {
          const firebaseUser = getCurrentUser();
          console.log('üîê [CHECKOUT] confirmOrder - firebaseUser:', firebaseUser);
          
          if (!firebaseUser) {
            // Usuario no logueado - permitir checkout como invitado
            console.log('üîê [CHECKOUT] Usuario no logueado - procesando como invitado');
            isGuestOrder = true;
            
            // Obtener email del formulario si est√° disponible
            const formData = new FormData(shippingForm);
            const fullName = formData.get('fullName') as string;
            // Intentar obtener email si hay un campo de email (opcional)
            // Por ahora usamos un ID temporal basado en timestamp
            guestEmail = `guest-${Date.now()}@checkout.local`;
            
            // Generar userId temporal para guest
            currentUserId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            console.log('üîê [CHECKOUT] Guest userId generado:', currentUserId);
          } else {
            currentUserId = firebaseUser.uid;
            console.log('üîê [CHECKOUT] Usuario encontrado en confirmOrder, currentUserId:', currentUserId);
          }
        } else {
          // Usuario logueado - verificar que existe en la colecci√≥n de usuarios
          try {
            const { getCurrentUserData } = await import('../lib/auth');
            const userDataResult = await getCurrentUserData();
            
            if (!userDataResult.success || !userDataResult.user) {
              console.warn('‚ö†Ô∏è [CHECKOUT] Usuario autenticado pero no existe en Firestore');
              // Continuar de todas formas, pero marcar como guest
              isGuestOrder = true;
            } else {
              console.log('‚úÖ [CHECKOUT] Usuario verificado en Firestore');
              guestEmail = userDataResult.user.email || '';
            }
          } catch (error: any) {
            console.error('‚ùå [CHECKOUT] Error verificando usuario:', error);
            // Continuar de todas formas
          }
        }

        // Validar formulario o direcci√≥n seleccionada
        if (useManualAddress && !shippingForm.checkValidity()) {
          shippingForm.reportValidity();
          return;
        }

        // Obtener m√©todo de pago seleccionado
        let paymentMethodType = 'cash';
        let selectedPaymentMethod: any = null;

        if (!useManualPayment && selectedPaymentMethodId) {
          selectedPaymentMethod = userPaymentMethods.find((m: any) => m.id === selectedPaymentMethodId);
          if (selectedPaymentMethod) {
            paymentMethodType = selectedPaymentMethod.type || 'card';
          }
        } else {
          const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked') as HTMLInputElement;
          if (!paymentMethodInput) {
            showError('Por favor selecciona un m√©todo de pago');
            return;
          }
          paymentMethodType = paymentMethodInput.value;
        }

        try {
          // Deshabilitar bot√≥n y mostrar loading
          (confirmBtn as HTMLButtonElement).disabled = true;
          if (confirmBtnText) confirmBtnText.classList.add('hidden');
          if (confirmBtnLoading) {
            confirmBtnLoading.classList.remove('hidden');
            confirmBtnLoading.classList.add('flex');
          }

          hideError();

          // Validar stock antes de crear la orden
          // Si es invitado, solo validamos sin actualizar (el stock se actualizar√° despu√©s por admin o Cloud Function)
          // Si es usuario logueado, intentamos validar y actualizar
          const { validateAndAdjustStockMultiple, validateStockMultiple } = await import('../lib/db/products');
          const stockItems = cartItems.map(item => ({
            productId: item.productId,
            quantity: item.quantity || 1
          }));

          console.log('üì¶ [CHECKOUT] Validando stock...');
          console.log('üì¶ [CHECKOUT] isGuest:', isGuestOrder);
          console.log('üì¶ [CHECKOUT] stockItems:', stockItems);

          let stockValidation;
          if (isGuestOrder) {
            // Para invitados, solo validar sin actualizar (no tienen permisos)
            console.log('üì¶ [CHECKOUT] Validando stock para invitado (solo lectura)...');
            stockValidation = await validateStockMultiple(stockItems);
          } else {
            // Para usuarios logueados, intentar validar y actualizar
            console.log('üì¶ [CHECKOUT] Validando y ajustando stock para usuario logueado...');
            stockValidation = await validateAndAdjustStockMultiple(stockItems);
          }
          
          console.log('üì¶ [CHECKOUT] Resultado de validaci√≥n de stock:', stockValidation);
          
          if (!stockValidation.success) {
            showError(stockValidation.errors.join(', ') || 'Error al validar el stock');
            (confirmBtn as HTMLButtonElement).disabled = false;
            if (confirmBtnText) confirmBtnText.classList.remove('hidden');
            if (confirmBtnLoading) {
              confirmBtnLoading.classList.add('hidden');
              confirmBtnLoading.classList.remove('flex');
            }
            return;
          }

          if (isGuestOrder) {
            console.log('‚ö†Ô∏è [CHECKOUT] Orden de invitado - El stock se actualizar√° manualmente o por Cloud Function');
          } else {
            // Verificar si realmente se actualiz√≥ o solo se valid√≥
            if (stockValidation.errors && stockValidation.errors.length === 0) {
              console.log('‚úÖ [CHECKOUT] Stock validado correctamente');
              // Si no es guest pero no se pudo actualizar, avisar
              if (!currentUserId || currentUserId.startsWith('guest_')) {
                console.log('‚ö†Ô∏è [CHECKOUT] Stock no se actualiz√≥ autom√°ticamente (requiere permisos de admin)');
              }
            }
          }

          // Obtener datos de direcci√≥n (de formulario o seleccionada)
          let shippingAddress: any;
          if (!useManualAddress && selectedAddressId) {
            const address = userAddresses.find((a: any) => a.id === selectedAddressId);
            if (address) {
              shippingAddress = {
                id: address.id,
                name: address.name,
                fullName: address.fullName,
                phone: address.phone,
                address: address.address,
                city: address.city,
                district: address.district,
                instructions: address.instructions || '',
                isDefault: address.isDefault,
                latitude: address.latitude,
                longitude: address.longitude
              };
            } else {
              useManualAddress = true;
            }
          }

          if (useManualAddress) {
            const formData = new FormData(shippingForm);
            const { Timestamp } = await import('firebase/firestore');
            const now = Timestamp.now();
            
            shippingAddress = {
              id: `temp-${Date.now()}`,
              name: 'Direcci√≥n de Env√≠o',
              fullName: formData.get('fullName') as string,
              phone: formData.get('phone') as string,
              address: formData.get('address') as string,
              city: formData.get('city') as string,
              district: formData.get('district') as string,
              instructions: (formData.get('instructions') as string) || '',
              isDefault: false,
              createdAt: now,
              updatedAt: now
            };
          }

          // Obtener m√©todo de pago (seleccionado o manual)
          let paymentMethod: any;
          if (!useManualPayment && selectedPaymentMethod) {
            paymentMethod = {
              id: selectedPaymentMethod.id,
              type: selectedPaymentMethod.type,
              cardNumber: selectedPaymentMethod.cardNumber,
              cardholderName: selectedPaymentMethod.cardholderName,
              expiryDate: selectedPaymentMethod.expiryDate,
              brand: selectedPaymentMethod.brand,
              bank: selectedPaymentMethod.bank,
              isDefault: selectedPaymentMethod.isDefault
            };
          } else {
            const { Timestamp } = await import('firebase/firestore');
            const now = Timestamp.now();
            
            paymentMethod = {
              id: `temp-${Date.now()}`,
              type: paymentMethodType as 'card' | 'cash',
              isDefault: false,
              createdAt: now,
              updatedAt: now
            };
          }

          // Calcular totales
          let subtotal = 0;
          const orderItems: any[] = [];

          cartItems.forEach((item) => {
            const product = productsData.get(item.productId);
            if (product) {
              const price = product.price || 0;
              const quantity = item.quantity || 1;
              const itemSubtotal = price * quantity;
              subtotal += itemSubtotal;

              orderItems.push({
                id: `${item.productId}-${Date.now()}-${Math.random()}`,
                productId: item.productId,
                productName: product.name || 'Producto',
                productImage: product.image || '',
                quantity: quantity,
                price: price,
                subtotal: itemSubtotal
              });
            }
          });

          const discount = 0;
          const total = subtotal - discount + shippingCost;

          // Preparar datos de la orden
          // Si es guest, agregar informaci√≥n adicional para identificaci√≥n
          const orderData: any = {
            userId: currentUserId!,
            items: orderItems,
            subtotal: subtotal,
            discount: discount,
            shippingAddress: shippingAddress,
            paymentMethod: paymentMethod,
            shippingCost: shippingCost
          };
          
          // Solo agregar campos de guest si realmente es una orden de invitado
          if (isGuestOrder) {
            orderData.isGuest = true;
            orderData.guestEmail = guestEmail;
            orderData.guestPhone = shippingAddress.phone;
            orderData.guestName = shippingAddress.fullName;
          }
          
          console.log('üì¶ [CHECKOUT] Datos de la orden a crear:', {
            userId: orderData.userId,
            isGuest: orderData.isGuest,
            itemsCount: orderData.items.length,
            subtotal: orderData.subtotal,
            total: total,
            shippingAddress: {
              fullName: orderData.shippingAddress.fullName,
              phone: orderData.shippingAddress.phone,
              city: orderData.shippingAddress.city
            },
            paymentMethod: {
              type: orderData.paymentMethod.type
            }
          });
          
          const { createOrder } = await import('../lib/db/orders');
          const orderResult = await createOrder(orderData);

          if (!orderResult.success) {
            throw new Error(orderResult.error?.message || 'Error al crear la orden');
          }

          // Obtener el invoiceNumber actualizado despu√©s de crear la orden
          let invoiceNumber: string | undefined;
          if (orderResult.id) {
            try {
              // Esperar un momento para que se actualice el invoiceNumber
              await new Promise(resolve => setTimeout(resolve, 500));
              const { getOrderById } = await import('../lib/db/orders');
              const orderDetails = await getOrderById(orderResult.id);
              if (orderDetails.data && orderDetails.data.invoiceNumber) {
                invoiceNumber = orderDetails.data.invoiceNumber;
                console.log('üìÑ [CHECKOUT] InvoiceNumber obtenido:', invoiceNumber);
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è [CHECKOUT] No se pudo obtener invoiceNumber:', e);
              // Continuar sin invoiceNumber
            }
          }

          // Limpiar carrito desde localStorage
          localStorage.setItem('cart', JSON.stringify({ items: [], lastUpdated: Date.now() }));

          // Actualizar contador del carrito en el header si existe
          if ((window as any).updateCartCount) {
            (window as any).updateCartCount();
          }
          
          // Disparar evento de actualizaci√≥n del carrito
          window.dispatchEvent(new CustomEvent('cart-updated'));

          // Preparar datos del modal
          const modalData = {
            id: orderResult.id!,
            invoiceNumber: invoiceNumber,
            items: orderItems.map(item => ({
              productName: item.productName,
              productImage: item.productImage,
              quantity: item.quantity,
              price: item.price,
              subtotal: item.subtotal
            })),
            subtotal: subtotal,
            shippingCost: shippingCost,
            total: total,
            shippingAddress: shippingAddress,
            paymentMethod: paymentMethod
          };

          // Ocultar cualquier loading o mensaje de error
          const loadingDiv = document.getElementById('checkout-loading');
          if (loadingDiv) loadingDiv.classList.add('hidden');

          // Funci√≥n para mostrar el modal con reintentos
          const showModal = (retryCount = 0) => {
            const maxRetries = 5;
            const modal = document.getElementById('order-confirmation-modal');
            
            if (!modal) {
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Modal no encontrado, reintentando... (${retryCount + 1}/${maxRetries})`);
                setTimeout(() => showModal(retryCount + 1), 200);
                return;
              } else {
                console.error('‚ùå Modal order-confirmation-modal no encontrado despu√©s de m√∫ltiples intentos');
                showError('Pedido creado exitosamente. Por favor, revisa tus pedidos en tu perfil.');
                return;
              }
            }

            if (typeof (window as any).showOrderConfirmationModal === 'function') {
              try {
                (window as any).showOrderConfirmationModal('order-confirmation-modal', modalData);
                console.log('‚úÖ Modal de confirmaci√≥n mostrado exitosamente');
              } catch (error) {
                console.error('‚ùå Error al mostrar modal:', error);
                if (retryCount < maxRetries) {
                  setTimeout(() => showModal(retryCount + 1), 200);
                } else {
                  showError('Pedido creado exitosamente. Por favor, revisa tus pedidos en tu perfil.');
                }
              }
            } else {
              if (retryCount < maxRetries) {
                console.log(`‚è≥ Funci√≥n showOrderConfirmationModal no disponible, reintentando... (${retryCount + 1}/${maxRetries})`);
                setTimeout(() => showModal(retryCount + 1), 200);
              } else {
                console.error('‚ùå Funci√≥n showOrderConfirmationModal no disponible despu√©s de m√∫ltiples intentos');
                showError('Pedido creado exitosamente. Por favor, revisa tus pedidos en tu perfil.');
              }
            }
          };

          // Iniciar el proceso de mostrar el modal
          // Usar m√∫ltiples estrategias para asegurar que funcione
          if (document.readyState === 'complete') {
            // P√°gina completamente cargada
            setTimeout(() => showModal(), 100);
          } else if (document.readyState === 'interactive') {
            // DOM listo pero recursos a√∫n cargando
            setTimeout(() => showModal(), 200);
          } else {
            // Esperar a que el DOM est√© listo
            document.addEventListener('DOMContentLoaded', () => {
              setTimeout(() => showModal(), 200);
            });
          }
          
          // Tambi√©n intentar despu√©s de que todos los scripts se hayan ejecutado
          window.addEventListener('load', () => {
            setTimeout(() => {
              const modal = document.getElementById('order-confirmation-modal');
              if (modal && modal.classList.contains('hidden')) {
                // Si el modal a√∫n est√° oculto, intentar mostrarlo
                showModal();
              }
            }, 100);
          });
        } catch (error: any) {
          showError(error.message || 'Error al procesar el pedido. Por favor, intenta nuevamente.');
          (confirmBtn as HTMLButtonElement).disabled = false;
          if (confirmBtnText) confirmBtnText.classList.remove('hidden');
          if (confirmBtnLoading) confirmBtnLoading.classList.add('hidden');
        }
      }

      // Event listeners
      if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmOrder);
      }

      // Bot√≥n para usar nueva direcci√≥n
      if (useNewAddressBtn) {
        useNewAddressBtn.addEventListener('click', () => {
          useManualAddress = true;
          selectedAddressId = null;
          if (savedAddressesSection) savedAddressesSection.classList.add('hidden');
          if (shippingForm) {
            document.querySelectorAll('input[name="selectedAddress"]').forEach((input: any) => {
              input.checked = false;
            });
          }
        });
      }

      // Bot√≥n para usar otro m√©todo de pago
      if (useNewPaymentBtn) {
        useNewPaymentBtn.addEventListener('click', () => {
          useManualPayment = true;
          selectedPaymentMethodId = null;
          if (savedPaymentMethodsSection) savedPaymentMethodsSection.classList.add('hidden');
          if (paymentMethodsOptions) paymentMethodsOptions.classList.remove('hidden');
          document.querySelectorAll('input[name="selectedPaymentMethod"]').forEach((input: any) => {
            input.checked = false;
          });
          // Seleccionar pago contra entrega por defecto
          const cashOption = document.querySelector('input[name="paymentMethod"][value="cash"]') as HTMLInputElement;
          if (cashOption) cashOption.checked = true;
        });
      }

      // Actualizar estilos de m√©todo de pago
      document.querySelectorAll('.payment-method-option').forEach((option) => {
        option.addEventListener('click', () => {
          const input = option.querySelector('input[type="radio"]') as HTMLInputElement;
          if (input && !input.disabled) {
            input.checked = true;
            useManualPayment = true;
            selectedPaymentMethodId = null;
            document.querySelectorAll('.payment-method-option').forEach((opt) => {
              opt.classList.remove('border-[#5d3fbb]', 'bg-purple-50');
            });
            option.classList.add('border-[#5d3fbb]', 'bg-purple-50');
            document.querySelectorAll('input[name="selectedPaymentMethod"]').forEach((input: any) => {
              input.checked = false;
            });
          }
        });
      });

      // Inicializar
      await loadCheckout();
    })();
  </script>
</Layout>

