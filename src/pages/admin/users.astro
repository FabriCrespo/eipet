---
import Layout from '../../layouts/Layout.astro';
import ConfirmModal from '../../components/ConfirmModal.astro';

// Funciones helper
function formatCurrency(value: number): string {
  return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatNumber(value: number): string {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
---

<style>
  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slide-out {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .animate-slide-in {
    animation: slide-in 0.3s ease-out;
  }

  .animate-slide-out {
    animation: slide-out 0.3s ease-in;
  }
</style>

<Layout>
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Header -->
      <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">Gesti칩n de Usuarios</h1>
          <p class="text-gray-600">Administra los usuarios registrados en la plataforma</p>
        </div>
      
      </div>

      <!-- Estad칤sticas -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Usuarios -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Total Usuarios</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-total">0</p>
            </div>
          </div>
        </div>

        <!-- Usuarios Activos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Activos</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-active">0</p>
            </div>
          </div>
        </div>

        <!-- Usuarios Inactivos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Inactivos</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-inactive">0</p>
            </div>
          </div>
        </div>

        <!-- Usuarios Suspendidos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Suspendidos</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-suspended">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Barra de B칰squeda y Filtros -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 mb-8">
        <div class="flex flex-col sm:flex-row gap-4">
          <!-- B칰squeda -->
          <div class="flex-1 relative">
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              id="search-input"
              placeholder="Buscar por nombre, email o tel칠fono..."
              class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
            />
          </div>

          <!-- Filtro por Estado -->
          <select id="status-filter" class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all">
            <option value="all">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
            <option value="suspended">Suspendidos</option>
          </select>

          <!-- Filtro por Orden -->
          <select id="sort-filter" class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all">
            <option value="recent">M치s recientes</option>
            <option value="oldest">M치s antiguos</option>
            <option value="orders">M치s pedidos</option>
            <option value="spent">Mayor gasto</option>
          </select>
        </div>
      </div>

      <!-- Tabla de Usuarios -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Usuario</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Contacto</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Rol</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Pedidos</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Total Gastado</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Estado</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">칔ltimo Pedido</th>
                <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Acciones</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Loading state -->
              <tr id="users-loading">
                <td colspan="8" class="py-16 text-center">
                  <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
                  <p class="mt-4 text-gray-600">Cargando usuarios...</p>
                </td>
              </tr>
              <!-- Empty state -->
              <tr id="users-empty" class="hidden">
                <td colspan="8" class="py-16 text-center">
                  <p class="text-gray-500 text-lg">No se encontraron usuarios.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginaci칩n -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 p-6 border-t border-gray-200">
          <div class="text-sm text-gray-600">
            Mostrando <span class="font-semibold" id="users-start">0</span> - <span class="font-semibold" id="users-end">0</span> de <span class="font-semibold" id="users-total">0</span> usuarios
          </div>
          <div class="flex items-center gap-2" id="pagination-controls">
            <!-- Paginaci칩n se generar치 din치micamente -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal de Confirmaci칩n -->
  <ConfirmModal id="admin-role-modal" />
</Layout>

<script>
  (async function() {
    // Funciones helper
    function formatCurrency(value: number): string {
      return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatNumber(value: number): string {
      return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Funci칩n auxiliar para convertir Timestamp de Firestore a Date
    function toDate(value: any): Date | null {
      if (!value) return null;
      if (value instanceof Date) return value;
      // Verificar si es un Timestamp de Firestore
      if (value && typeof value === 'object' && 'toDate' in value && typeof value.toDate === 'function') {
        return value.toDate();
      }
      // Intentar convertir como string o n칰mero
      if (typeof value === 'string' || typeof value === 'number') {
        return new Date(value);
      }
      return null;
    }

    function formatDate(timestamp: any): string {
      const date = toDate(timestamp);
      if (!date) return 'N/A';
      return new Intl.DateTimeFormat('es-BO', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }).format(date);
    }

    // Estado
    let allUsers: any[] = [];
    let filteredUsers: any[] = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    // Elementos del DOM
    const loadingRow = document.getElementById('users-loading');
    const emptyRow = document.getElementById('users-empty');
    const tableBody = document.getElementById('users-table-body');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
    const sortFilter = document.getElementById('sort-filter') as HTMLSelectElement;
    const statTotal = document.getElementById('stat-total');
    const statActive = document.getElementById('stat-active');
    const statInactive = document.getElementById('stat-inactive');
    const statSuspended = document.getElementById('stat-suspended');
    const usersStart = document.getElementById('users-start');
    const usersEnd = document.getElementById('users-end');
    const usersTotal = document.getElementById('users-total');
    const paginationControls = document.getElementById('pagination-controls');

    // Cargar usuarios
    async function loadUsers() {
      try {
        const { getAllUsers } = await import('../../lib/db/users');
        const { getUserOrders } = await import('../../lib/db/orders');
        
        const usersResult = await getAllUsers();
        if (usersResult.error) {
          throw usersResult.error;
        }

        // Obtener pedidos para cada usuario
        const usersWithStats = await Promise.all(
          usersResult.data.map(async (user) => {
            const ordersResult = await getUserOrders(user.id);
            const orders = ordersResult.data || [];
            
            const totalSpent = orders.reduce((sum, order) => {
              return sum + (order.total || 0);
            }, 0);

            const lastOrder = orders.length > 0 
              ? orders[0].createdAt 
              : null;

            // Determinar estado basado en actividad (칰ltimo pedido hace m치s de 90 d칤as = inactivo)
            let status = 'Activo';
            let statusColor = 'bg-green-50 text-green-700 border border-green-200';
            
            if (lastOrder) {
              const lastOrderDate = toDate(lastOrder);
              if (lastOrderDate) {
                const daysSinceLastOrder = (Date.now() - lastOrderDate.getTime()) / (1000 * 60 * 60 * 24);
                
                if (daysSinceLastOrder > 90) {
                  status = 'Inactivo';
                  statusColor = 'bg-gray-50 text-gray-700 border border-gray-200';
                }
              }
            } else if (user.createdAt) {
              const createdDate = toDate(user.createdAt);
              if (createdDate) {
                const daysSinceCreated = (Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24);
                
                if (daysSinceCreated > 90) {
                  status = 'Inactivo';
                  statusColor = 'bg-gray-50 text-gray-700 border border-gray-200';
                }
              }
            }

            return {
              ...user,
              orders: orders.length,
              totalSpent,
              lastOrder,
              status,
              statusColor,
              fullName: `${user.firstName} ${user.lastName}`,
            };
          })
        );

        allUsers = usersWithStats;
        applyFilters();
        updateStats();
      } catch (error) {
        console.error('Error loading users:', error);
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" class="py-16 text-center">
                <p class="text-red-500">Error al cargar usuarios. Por favor, recarga la p치gina.</p>
              </td>
            </tr>
          `;
        }
      }
    }

    // Actualizar estad칤sticas
    function updateStats() {
      const total = allUsers.length;
      const active = allUsers.filter(u => u.status === 'Activo').length;
      const inactive = allUsers.filter(u => u.status === 'Inactivo').length;
      const suspended = allUsers.filter(u => u.status === 'Suspendido').length;

      if (statTotal) statTotal.textContent = formatNumber(total);
      if (statActive) statActive.textContent = formatNumber(active);
      if (statInactive) statInactive.textContent = formatNumber(inactive);
      if (statSuspended) statSuspended.textContent = formatNumber(suspended);
    }

    // Aplicar filtros y b칰squeda
    function applyFilters() {
      let filtered = [...allUsers];

      // B칰squeda
      const searchTerm = searchInput?.value.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(user => 
          user.fullName.toLowerCase().includes(searchTerm) ||
          user.email.toLowerCase().includes(searchTerm) ||
          user.phone?.toLowerCase().includes(searchTerm)
        );
      }

      // Filtro por estado
      const statusValue = statusFilter?.value || 'all';
      if (statusValue !== 'all') {
        const statusMap: Record<string, string> = {
          'active': 'Activo',
          'inactive': 'Inactivo',
          'suspended': 'Suspendido'
        };
        filtered = filtered.filter(user => user.status === statusMap[statusValue]);
      }

      // Ordenar
      const sortValue = sortFilter?.value || 'recent';
      switch (sortValue) {
        case 'recent':
          filtered.sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
            return dateB - dateA;
          });
          break;
        case 'oldest':
          filtered.sort((a, b) => {
            const dateA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
            const dateB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
            return dateA - dateB;
          });
          break;
        case 'orders':
          filtered.sort((a, b) => b.orders - a.orders);
          break;
        case 'spent':
          filtered.sort((a, b) => b.totalSpent - a.totalSpent);
          break;
      }

      filteredUsers = filtered;
      currentPage = 1;
      renderUsers();
      renderPagination();
    }

    // Renderizar usuarios
    function renderUsers() {
      if (!tableBody) return;

      if (loadingRow) loadingRow.classList.add('hidden');
      if (emptyRow) emptyRow.classList.add('hidden');

      if (filteredUsers.length === 0) {
        if (emptyRow) emptyRow.classList.remove('hidden');
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageUsers = filteredUsers.slice(start, end);

      tableBody.innerHTML = pageUsers.map(user => {
        const isAdmin = user.role === 'admin';
        const roleBadgeColor = isAdmin 
          ? 'bg-purple-50 text-purple-700 border border-purple-200' 
          : 'bg-gray-50 text-gray-700 border border-gray-200';
        
        return `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                  <td class="py-4 px-6">
                    <div>
              <p class="font-semibold text-gray-900">${user.fullName}</p>
              <p class="text-sm text-gray-500">ID: ${user.id}</p>
                    </div>
                  </td>
                  <td class="py-4 px-6">
                    <div>
              <p class="text-sm text-gray-900">${user.email}</p>
              <p class="text-sm text-gray-500">${user.phone || 'N/A'}</p>
            </div>
          </td>
          <td class="py-4 px-6">
            <div class="flex flex-col gap-2">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${roleBadgeColor} w-fit">
                ${isAdmin ? '游녬 Admin' : '游녻 Usuario'}
              </span>
              ${!isAdmin ? `
                <button 
                  class="inline-flex items-center gap-2 px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg transition-colors text-xs font-semibold"
                  title="Hacer administrador"
                  onclick="showAdminConfirmModal('${user.id}', '${user.fullName}', false)"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                  Hacer Admin
                </button>
              ` : `
                <button 
                  class="inline-flex items-center gap-2 px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg transition-colors text-xs font-semibold"
                  title="Quitar privilegios de admin"
                  onclick="showAdminConfirmModal('${user.id}', '${user.fullName}', true)"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                  </svg>
                  Quitar Admin
                </button>
              `}
                    </div>
                  </td>
                  <td class="py-4 px-6">
            <span class="font-semibold text-gray-900">${user.orders}</span>
                  </td>
                  <td class="py-4 px-6">
            <p class="font-semibold text-gray-900">Bs. ${formatCurrency(user.totalSpent)}</p>
                  </td>
                  <td class="py-4 px-6">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${user.statusColor}">
              ${user.status}
                    </span>
                  </td>
                  <td class="py-4 px-6">
            <p class="text-sm text-gray-600">${user.lastOrder ? formatDate(user.lastOrder) : 'Sin pedidos'}</p>
                  </td>
                  <td class="py-4 px-6 text-right">
                    <button 
                      class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors flex items-center gap-2"
                      title="Eliminar usuario"
                      onclick="showDeleteConfirmModal('${user.id}', '${user.fullName}')"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      <span>Eliminar</span>
                    </button>
                  </td>
                </tr>
      `;
      }).join('');

      // Actualizar contadores
      if (usersStart) usersStart.textContent = formatNumber(start + 1);
      if (usersEnd) usersEnd.textContent = formatNumber(Math.min(end, filteredUsers.length));
      if (usersTotal) usersTotal.textContent = formatNumber(filteredUsers.length);
    }

    // Renderizar paginaci칩n
    function renderPagination() {
      if (!paginationControls) return;

      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      if (totalPages <= 1) {
        paginationControls.innerHTML = '';
        return;
      }

      let html = '';
      
      // Bot칩n anterior
      html += `
        <button 
          onclick="goToPage(${currentPage - 1})"
          class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          ${currentPage === 1 ? 'disabled' : ''}
        >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
        </button>
      `;

      // N칰meros de p치gina
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          html += `
            <button 
              onclick="goToPage(${i})"
              class="px-4 py-2 rounded-lg border-2 ${i === currentPage ? 'border-purple-400 bg-purple-50 text-purple-700 font-semibold' : 'border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50'} transition-all"
            >
              ${i}
            </button>
          `;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          html += `<span class="px-2 text-gray-500">...</span>`;
        }
      }

      // Bot칩n siguiente
      html += `
        <button 
          onclick="goToPage(${currentPage + 1})"
          class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          ${currentPage === totalPages ? 'disabled' : ''}
        >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
      `;

      paginationControls.innerHTML = html;
    }

    // Funciones globales para botones
    (window as any).goToPage = function(page: number) {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderUsers();
        renderPagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    };

    // Mostrar modal de confirmaci칩n para eliminar usuario
    (window as any).showDeleteConfirmModal = function(userId: string, userName: string) {
      const modalId = 'admin-role-modal';

      (window as any).showConfirmModal(modalId, {
        icon: `
          <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        `,
        iconBg: 'bg-red-100',
        iconColor: 'text-red-600',
        title: 'Eliminar Usuario',
        message: `쮼st치s seguro de eliminar al usuario "${userName}"? Esta acci칩n no se puede deshacer y se eliminar치n todos los datos asociados al usuario.`,
        confirmText: 'Eliminar Usuario',
        confirmClass: 'bg-gradient-to-r from-red-500 to-red-600',
        onConfirm: async () => {
          await deleteUserById(userId);
        }
      });
    };

    // Funci칩n para eliminar usuario
    async function deleteUserById(userId: string) {
      try {
        const { deleteUser } = await import('../../lib/db/users');
        const result = await deleteUser(userId);
        
        if (result.success) {
          // Remover el usuario del array local
          allUsers = allUsers.filter(u => u.id !== userId);
          applyFilters();
          updateStats();
          
          // Mostrar notificaci칩n de 칠xito
          showSuccessNotification('Usuario eliminado exitosamente');
        } else {
          throw new Error(result.error?.message || 'Error al eliminar el usuario');
        }
      } catch (error: any) {
        console.error('Error deleting user:', error);
        showErrorNotification(`Error: ${error.message || 'Error desconocido'}`);
      }
    }

    // Variables para el modal
    let pendingUserId: string | null = null;
    let pendingIsAdmin: boolean = false;

    // Mostrar modal de confirmaci칩n
    (window as any).showAdminConfirmModal = function(userId: string, userName: string, isCurrentlyAdmin: boolean) {
      pendingUserId = userId;
      pendingIsAdmin = isCurrentlyAdmin;

      const modalId = 'admin-role-modal';

      if (isCurrentlyAdmin) {
        // Quitar admin
        (window as any).showConfirmModal(modalId, {
          icon: `
            <svg class="w-7 h-7 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
          `,
          iconBg: 'bg-orange-100',
          iconColor: 'text-orange-600',
          title: 'Quitar Privilegios de Administrador',
          message: `쮼st치s seguro de quitar los privilegios de administrador a "${userName}"? Este usuario perder치 acceso al panel de administraci칩n y todas las funciones administrativas.`,
          confirmText: 'Quitar Admin',
          confirmClass: 'bg-gradient-to-r from-orange-500 to-red-500',
          onConfirm: async () => {
            await changeUserRole(userId, 'user');
          }
        });
      } else {
        // Hacer admin
        (window as any).showConfirmModal(modalId, {
          icon: `
            <svg class="w-7 h-7 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          `,
          iconBg: 'bg-purple-100',
          iconColor: 'text-purple-600',
          title: 'Convertir en Administrador',
          message: `쮼st치s seguro de convertir a "${userName}" en administrador? Este usuario tendr치 acceso completo al panel de administraci칩n, incluyendo gesti칩n de productos, usuarios, pedidos y configuraciones.`,
          confirmText: 'Hacer Administrador',
          confirmClass: 'bg-gradient-to-r from-purple-500 to-pink-500',
          onConfirm: async () => {
            await changeUserRole(userId, 'admin');
          }
        });
      }
    };

    // Funci칩n para cambiar el rol del usuario
    async function changeUserRole(userId: string, newRole: 'admin' | 'user') {
      try {
        const { updateUser } = await import('../../lib/db/users');
        const result = await updateUser(userId, { role: newRole });
        
        if (result.success) {
          // Actualizar el usuario en el array local
          const userIndex = allUsers.findIndex(u => u.id === userId);
          if (userIndex !== -1) {
            allUsers[userIndex].role = newRole;
            applyFilters();
          }
          
          // Mostrar notificaci칩n de 칠xito
          showSuccessNotification(
            newRole === 'admin'
              ? 'Usuario convertido en administrador exitosamente' 
              : 'Privilegios de administrador removidos exitosamente'
          );
        } else {
          throw new Error(result.error?.message || 'Error al actualizar el rol');
        }
      } catch (error: any) {
        console.error('Error updating user role:', error);
        showErrorNotification(`Error: ${error.message || 'Error desconocido'}`);
      }
    }

    // Funciones de notificaci칩n
    function showSuccessNotification(message: string) {
      // Crear notificaci칩n temporal
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg z-50 flex items-center gap-3 animate-slide-in';
      notification.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="font-semibold">${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('animate-slide-out');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function showErrorNotification(message: string) {
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg z-50 flex items-center gap-3 animate-slide-in';
      notification.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span class="font-semibold">${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('animate-slide-out');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Event listeners
    searchInput?.addEventListener('input', () => {
      applyFilters();
    });

    statusFilter?.addEventListener('change', () => {
      applyFilters();
    });

    sortFilter?.addEventListener('change', () => {
      applyFilters();
    });

    // Cargar usuarios al iniciar
    await loadUsers();
  })();
</script>

