---
import Layout from '../../layouts/Layout.astro';

// Funciones helper para formatear números
function formatCurrency(value: number): string {
  return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatNumber(value: number): string {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Los datos se cargarán dinámicamente desde Firebase
const stats = {
  totalSales: 0,
  totalOrders: 0,
  totalUsers: 0,
  totalProducts: 0,
  pendingOrders: 0,
  lowStock: 0,
  todaySales: 0,
  todayOrders: 0
};

// Los pedidos recientes se cargarán dinámicamente desde Firebase
const recentOrders: any[] = [];

// Los productos más vendidos se cargarán dinámicamente desde Firebase
const topProducts: any[] = [];
---

<Layout>
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Header -->
      <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">Dashboard</h1>
          <p class="text-gray-600">Bienvenido al panel de administración</p>
        </div>
        <div class="flex gap-3">
          <a
            href="/admin/users"
            class="px-6 py-3 bg-linear-to-r from-blue-500 to-cyan-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all duration-300 flex items-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <span>Usuarios</span>
          </a>
          <a
            href="/admin/products"
            class="px-6 py-3 bg-linear-to-r from-orange-500 to-red-500 text-white font-semibold rounded-xl hover:shadow-lg transition-all duration-300 flex items-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span>Productos</span>
          </a>
         
        </div>
      </div>

      <!-- Tarjetas de Métricas -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Ventas Totales -->
        <div class="bg-linear-to-br from-purple-500 to-pink-500 rounded-3xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <span class="text-sm font-medium text-white/80">+12.5%</span>
          </div>
          <p class="text-sm text-white/80 mb-1">Ventas Totales</p>
          <p class="text-3xl font-bold" id="stat-total-sales">Bs. {formatCurrency(stats.totalSales)}</p>
        </div>

        <!-- Pedidos Totales -->
        <div class="bg-linear-to-br from-blue-500 to-cyan-500 rounded-3xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
              </svg>
            </div>
            <span class="text-sm font-medium text-white/80">+8.2%</span>
          </div>
          <p class="text-sm text-white/80 mb-1">Pedidos Totales</p>
          <p class="text-3xl font-bold" id="stat-total-orders">{formatNumber(stats.totalOrders)}</p>
        </div>

        <!-- Usuarios -->
        <div class="bg-linear-to-br from-green-500 to-emerald-500 rounded-3xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
            <span class="text-sm font-medium text-white/80">+15.3%</span>
          </div>
          <p class="text-sm text-white/80 mb-1">Usuarios Registrados</p>
          <p class="text-3xl font-bold" id="stat-total-users">{formatNumber(stats.totalUsers)}</p>
        </div>

        <!-- Productos -->
        <div class="bg-linear-to-br from-orange-500 to-red-500 rounded-3xl p-6 text-white shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <span class="text-sm font-medium text-white/80" id="stat-low-stock">{stats.lowStock} bajo stock</span>
          </div>
          <p class="text-sm text-white/80 mb-1">Productos Activos</p>
          <p class="text-3xl font-bold" id="stat-total-products">{stats.totalProducts}</p>
        </div>
      </div>

      <!-- Segunda Fila de Métricas -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Ventas de Hoy -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center">
              <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Ventas de Hoy</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-today-sales">Bs. {formatCurrency(stats.todaySales)}</p>
            </div>
          </div>
        </div>

        <!-- Pedidos de Hoy -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Pedidos de Hoy</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-today-orders">{stats.todayOrders}</p>
            </div>
          </div>
        </div>

        <!-- Pedidos Pendientes -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center">
              <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Pendientes</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-pending-orders">{stats.pendingOrders}</p>
            </div>
          </div>
        </div>

        <!-- Productos Bajo Stock -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
              <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Bajo Stock</p>
              <p class="text-2xl font-bold text-gray-900" id="stat-low-stock-count">{stats.lowStock}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Gráficos y Tablas -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Gráfico de Ventas -->
        <div class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 lg:p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900">Ventas de los Últimos 7 Días</h2>
            <select class="px-3 py-2 rounded-lg border border-gray-200 text-sm text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100">
              <option>7 días</option>
              <option>30 días</option>
              <option>90 días</option>
            </select>
          </div>
          <div class="h-64 flex items-end justify-between gap-2">
            {[65, 80, 45, 90, 70, 85, 95].map((height, index) => (
              <div class="flex-1 flex flex-col items-center gap-2">
                <div
                  class="w-full bg-linear-to-t from-purple-500 to-pink-500 rounded-t-lg transition-all hover:opacity-80"
                  style={`height: ${height}%`}
                ></div>
                <span class="text-xs text-gray-500">{['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'][index]}</span>
              </div>
            ))}
          </div>
        </div>

        <!-- Productos Más Vendidos -->
        <div class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 lg:p-8">
          <h2 class="text-xl font-bold text-gray-900 mb-6">Productos Más Vendidos</h2>
          
          <!-- Loading state -->
          <div id="top-products-loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
            <p class="mt-4 text-gray-600">Cargando productos más vendidos...</p>
          </div>

          <!-- Empty state -->
          <div id="top-products-empty" class="hidden text-center py-12">
            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <p class="text-gray-900 font-semibold mb-2">No hay productos vendidos</p>
            <p class="text-gray-500 text-sm">Aún no se han realizado ventas</p>
          </div>

          <!-- Products list -->
          <div id="top-products-list" class="hidden space-y-4">
            <!-- Los productos se renderizarán aquí dinámicamente -->
          </div>
        </div>
      </div>

      <!-- Pedidos Recientes -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 lg:p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-900">Pedidos Recientes</h2>
          <a href="/admin/orders" class="text-sm font-medium text-purple-600 hover:text-purple-700 flex items-center gap-1">
            Ver todos
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
        <!-- Loading state -->
        <div id="recent-orders-loading" class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
          <p class="mt-4 text-gray-600">Cargando pedidos recientes...</p>
        </div>

        <!-- Empty state -->
        <div id="recent-orders-empty" class="hidden text-center py-12">
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-gray-900 font-semibold mb-2">No hay pedidos recientes</p>
          <p class="text-gray-500 text-sm">Aún no se han realizado pedidos</p>
        </div>

        <!-- Table -->
        <div id="recent-orders-table" class="hidden overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">ID</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Cliente</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Fecha</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Total</th>
                <th class="text-left py-3 px-4 text-sm font-semibold text-gray-700">Estado</th>
              </tr>
            </thead>
            <tbody id="recent-orders-tbody">
              <!-- Los pedidos se renderizarán aquí dinámicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <script>
    (async function() {
      // Funciones helper para formatear números
      function formatCurrency(value: number): string {
        return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      function formatNumber(value: number): string {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Función auxiliar para convertir Timestamp de Firestore a Date
      function toDate(value: any): Date | null {
        if (!value) return null;
        if (value instanceof Date) return value;
        // Verificar si es un Timestamp de Firestore
        if (value && typeof value === 'object' && 'toDate' in value && typeof value.toDate === 'function') {
          return value.toDate();
        }
        // Intentar convertir como string o número
        if (typeof value === 'string' || typeof value === 'number') {
          return new Date(value);
        }
        return null;
      }

      function formatDate(timestamp: any): string {
        const date = toDate(timestamp);
        if (!date) return 'Fecha no disponible';
        return new Intl.DateTimeFormat('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        }).format(date);
      }

      // Mapear estados a colores
      const statusMap: Record<string, string> = {
        pending: 'bg-yellow-50 text-yellow-700 border border-yellow-200',
        processing: 'bg-blue-50 text-blue-700 border border-blue-200',
        shipped: 'bg-purple-50 text-purple-700 border border-purple-200',
        delivered: 'bg-green-50 text-green-700 border border-green-200',
        cancelled: 'bg-red-50 text-red-700 border border-red-200',
      };

      const statusLabels: Record<string, string> = {
        pending: 'Pendiente',
        processing: 'Procesando',
        shipped: 'En camino',
        delivered: 'Entregado',
        cancelled: 'Cancelado',
      };

      // Elementos del DOM
      const recentOrdersLoading = document.getElementById('recent-orders-loading');
      const recentOrdersEmpty = document.getElementById('recent-orders-empty');
      const recentOrdersTable = document.getElementById('recent-orders-table');
      const recentOrdersTbody = document.getElementById('recent-orders-tbody');

      // Cargar pedidos recientes
      async function loadRecentOrders() {
        try {
          console.log('Cargando pedidos recientes...');
          const { getAllOrders } = await import('../../lib/db/orders');
          const { getAllUsers } = await import('../../lib/db/users');
          
          // Cargar órdenes
          const ordersResult = await getAllOrders();
          if (ordersResult.error) {
            throw ordersResult.error;
          }
          
          let allOrders = ordersResult.data || [];
          console.log('Pedidos cargados:', allOrders.length);
          
          // Cargar usuarios para obtener nombres
          const usersResult = await getAllUsers();
          const users = usersResult.data || [];
          const userMap = new Map(users.map((u: any) => [u.id, u]));
          console.log('Usuarios cargados:', users.length);

          // Procesar órdenes (tomar solo las últimas 5)
          const recentOrders = allOrders.slice(0, 5).map((order: any) => {
            const user = userMap.get(order.userId);
            const customerName = order.isGuest 
              ? (order.guestName || 'Cliente invitado')
              : (user?.name || user?.displayName || user?.firstName && user?.lastName ? `${user.firstName} ${user.lastName}` : 'Usuario no encontrado');
            
            return {
              id: order.id?.substring(0, 8) || 'N/A',
              customer: customerName,
              date: formatDate(order.createdAt),
              total: order.total || 0,
              status: order.status || 'pending',
              statusColor: statusMap[order.status] || statusMap.pending,
              statusLabel: statusLabels[order.status] || 'Pendiente',
            };
          });

          console.log('Pedidos recientes procesados:', recentOrders.length);

          // Ocultar loading
          if (recentOrdersLoading) recentOrdersLoading.classList.add('hidden');

          if (recentOrders.length === 0) {
            console.log('No hay pedidos recientes');
            if (recentOrdersEmpty) recentOrdersEmpty.classList.remove('hidden');
            if (recentOrdersTable) recentOrdersTable.classList.add('hidden');
            return;
          }

          if (recentOrdersEmpty) recentOrdersEmpty.classList.add('hidden');
          if (recentOrdersTable) recentOrdersTable.classList.remove('hidden');

          // Renderizar pedidos
          if (recentOrdersTbody) {
            console.log('Renderizando pedidos en la tabla');
            recentOrdersTbody.innerHTML = recentOrders.map((order: any) => `
              <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                <td class="py-4 px-4">
                  <span class="font-semibold text-gray-900">#${order.id}</span>
                </td>
                <td class="py-4 px-4">
                  <p class="text-gray-900">${order.customer}</p>
                </td>
                <td class="py-4 px-4">
                  <p class="text-sm text-gray-600">${order.date}</p>
                </td>
                <td class="py-4 px-4">
                  <p class="font-semibold text-gray-900">Bs. ${order.total.toFixed(2)}</p>
                </td>
                <td class="py-4 px-4">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${order.statusColor}">
                    ${order.statusLabel}
                  </span>
                </td>
              </tr>
            `).join('');
          } else {
            console.error('No se encontró el elemento recent-orders-tbody');
          }

        } catch (error) {
          console.error('Error cargando pedidos recientes:', error);
          if (recentOrdersLoading) recentOrdersLoading.classList.add('hidden');
          if (recentOrdersEmpty) {
            recentOrdersEmpty.classList.remove('hidden');
            const errorMsg = recentOrdersEmpty.querySelector('p');
            if (errorMsg) errorMsg.textContent = 'Error al cargar los pedidos';
          }
        }
      }

      // Función para cargar estadísticas
      async function loadStats() {
        try {
          const { getAllOrders } = await import('../../lib/db/orders');
          const { getAllUsers } = await import('../../lib/db/users');
          const { getProducts } = await import('../../lib/db/products');
          
          // Cargar órdenes
          const ordersResult = await getAllOrders();
          const orders = ordersResult.data || [];
          
          // Cargar usuarios
          const usersResult = await getAllUsers();
          const users = usersResult.data || [];
          
          // Cargar productos
          const productsResult = await getProducts({ status: 'active' });
          const products = productsResult.data || [];
          
          // Calcular estadísticas
          const totalOrders = orders.length;
          const totalUsers = users.length;
          const totalProducts = products.length;
          
          // Calcular ventas totales (solo pedidos entregados)
          const deliveredOrders = orders.filter((o: any) => o.status === 'delivered');
          const totalSales = deliveredOrders.reduce((sum: number, order: any) => sum + (order.total || 0), 0);
          
          // Pedidos pendientes
          const pendingOrders = orders.filter((o: any) => o.status === 'pending').length;
          
          // Productos bajo stock
          const lowStock = products.filter((p: any) => {
            const stock = p.stock || 0;
            const minStock = p.minStock || 5;
            return stock <= minStock;
          }).length;
          
          // Ventas de hoy
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const todayOrders = orders.filter((o: any) => {
            const orderDate = toDate(o.createdAt);
            if (!orderDate) return false;
            orderDate.setHours(0, 0, 0, 0);
            return orderDate.getTime() === today.getTime();
          });
          const todaySales = todayOrders.reduce((sum: number, order: any) => sum + (order.total || 0), 0);
          const todayOrdersCount = todayOrders.length;
          
          // Actualizar DOM
          const statTotalSales = document.getElementById('stat-total-sales');
          const statTotalOrders = document.getElementById('stat-total-orders');
          const statTotalUsers = document.getElementById('stat-total-users');
          const statTotalProducts = document.getElementById('stat-total-products');
          const statPendingOrders = document.getElementById('stat-pending-orders');
          const statLowStock = document.getElementById('stat-low-stock-badge');
          const statLowStockCount = document.getElementById('stat-low-stock-count');
          const statTodaySales = document.getElementById('stat-today-sales');
          const statTodayOrders = document.getElementById('stat-today-orders');
          
          if (statTotalSales) statTotalSales.textContent = `Bs. ${formatCurrency(totalSales)}`;
          if (statTotalOrders) statTotalOrders.textContent = formatNumber(totalOrders);
          if (statTotalUsers) statTotalUsers.textContent = formatNumber(totalUsers);
          if (statTotalProducts) statTotalProducts.textContent = formatNumber(totalProducts);
          if (statPendingOrders) statPendingOrders.textContent = formatNumber(pendingOrders);
          if (statLowStock) statLowStock.textContent = `${lowStock} bajo stock`;
          if (statLowStockCount) statLowStockCount.textContent = formatNumber(lowStock);
          if (statTodaySales) statTodaySales.textContent = `Bs. ${formatCurrency(todaySales)}`;
          if (statTodayOrders) statTodayOrders.textContent = formatNumber(todayOrdersCount);
          
        } catch (error) {
          console.error('Error cargando estadísticas:', error);
        }
      }

      // Función para cargar productos más vendidos
      async function loadTopProducts() {
        try {
          const topProductsLoading = document.getElementById('top-products-loading');
          const topProductsEmpty = document.getElementById('top-products-empty');
          const topProductsList = document.getElementById('top-products-list');
          
          const { getAllOrders } = await import('../../lib/db/orders');
          const { getProductById } = await import('../../lib/db/products');
          
          // Cargar órdenes entregados
          const ordersResult = await getAllOrders();
          const orders = ordersResult.data || [];
          const deliveredOrders = orders.filter((o: any) => o.status === 'delivered');
          
          // Contar ventas por producto
          const productSales: Map<string, { quantity: number; revenue: number }> = new Map();
          
          for (const order of deliveredOrders) {
            if (order.items && Array.isArray(order.items)) {
              for (const item of order.items) {
                const productId = item.productId;
                if (productId) {
                  const current = productSales.get(productId) || { quantity: 0, revenue: 0 };
                  productSales.set(productId, {
                    quantity: current.quantity + (item.quantity || 0),
                    revenue: current.revenue + (item.subtotal || 0)
                  });
                }
              }
            }
          }
          
          // Convertir a array y ordenar por cantidad vendida
          const sortedProducts = Array.from(productSales.entries())
            .sort((a, b) => b[1].quantity - a[1].quantity)
            .slice(0, 4);
          
          // Obtener información completa de los productos
          const topProductsData: any[] = [];
          for (const [productId, sales] of sortedProducts) {
            const productResult = await getProductById(productId);
            if (productResult.data) {
              topProductsData.push({
                name: productResult.data.name,
                sales: sales.quantity,
                revenue: sales.revenue
              });
            }
          }
          
          // Ocultar loading
          if (topProductsLoading) topProductsLoading.classList.add('hidden');
          
          if (topProductsData.length === 0) {
            if (topProductsEmpty) topProductsEmpty.classList.remove('hidden');
            if (topProductsList) topProductsList.classList.add('hidden');
            return;
          }
          
          if (topProductsEmpty) topProductsEmpty.classList.add('hidden');
          if (topProductsList) {
            topProductsList.classList.remove('hidden');
            topProductsList.innerHTML = topProductsData.map((product: any, index: number) => `
              <div class="flex items-center justify-between p-4 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex items-center gap-3 flex-1">
                  <div class="w-8 h-8 rounded-lg bg-linear-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-sm">
                    ${index + 1}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-gray-900 truncate">${product.name}</p>
                    <p class="text-sm text-gray-600">${product.sales} ventas</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-gray-900">Bs. ${formatCurrency(product.revenue)}</p>
                </div>
              </div>
            `).join('');
          }
          
        } catch (error) {
          console.error('Error cargando productos más vendidos:', error);
          const topProductsLoading = document.getElementById('top-products-loading');
          const topProductsEmpty = document.getElementById('top-products-empty');
          if (topProductsLoading) topProductsLoading.classList.add('hidden');
          if (topProductsEmpty) {
            topProductsEmpty.classList.remove('hidden');
            const errorMsg = topProductsEmpty.querySelector('p');
            if (errorMsg) errorMsg.textContent = 'Error al cargar los productos';
          }
        }
      }

      // Cargar todo al iniciar
      await Promise.all([
        loadStats(),
        loadRecentOrders(),
        loadTopProducts()
      ]);
    })();
  </script>
</Layout>