---
import Layout from "../../layouts/Layout.astro";

// Mapear estados a español
const statusMap: Record<string, { label: string; color: string; icon: string }> = {
  pending: { label: 'Pendiente', color: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
  processing: { label: 'Procesando', color: 'bg-blue-100 text-blue-800 border-blue-200', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },
  shipped: { label: 'En camino', color: 'bg-purple-100 text-purple-800 border-purple-200', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
  delivered: { label: 'Entregado', color: 'bg-green-100 text-green-800 border-green-200', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
  cancelled: { label: 'Cancelado', color: 'bg-red-100 text-red-800 border-red-200', icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z' },
};

// Estados disponibles para actualizar
const availableStatuses = [
  { value: 'pending', label: 'Pendiente' },
  { value: 'processing', label: 'Procesando' },
  { value: 'shipped', label: 'En camino' },
  { value: 'delivered', label: 'Entregado' },
  { value: 'cancelled', label: 'Cancelado' },
];
---

<style>
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
</style>

<Layout title="Administración de Pedidos - Eipet">
  <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3 mb-2">
          <svg class="w-8 h-8 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Administración de Pedidos
        </h1>
        <p class="text-gray-600">Gestiona y actualiza el estado de todos los pedidos</p>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="text-sm text-gray-600 mb-1">Total</div>
          <div class="text-2xl font-bold text-gray-900" id="stat-total">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="text-sm text-gray-600 mb-1">Pendientes</div>
          <div class="text-2xl font-bold text-yellow-600" id="stat-pending">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="text-sm text-gray-600 mb-1">Procesando</div>
          <div class="text-2xl font-bold text-blue-600" id="stat-processing">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="text-sm text-gray-600 mb-1">En camino</div>
          <div class="text-2xl font-bold text-purple-600" id="stat-shipped">0</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
          <div class="text-sm text-gray-600 mb-1">Entregados</div>
          <div class="text-2xl font-bold text-green-600" id="stat-delivered">0</div>
        </div>
      </div>

      <!-- Filtros y búsqueda -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <div class="flex flex-col sm:flex-row gap-4">
          <!-- Búsqueda -->
          <div class="flex-1 relative">
            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              id="search-input"
              placeholder="Buscar por ID, cliente, email..."
              class="w-full pl-10 pr-4 py-2.5 text-sm rounded-lg border border-gray-300 bg-white text-gray-900 placeholder-gray-400 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all"
            />
          </div>

          <!-- Filtro por estado -->
          <div class="relative">
            <select
              id="status-filter"
              class="px-4 py-2.5 text-sm rounded-lg border border-gray-300 bg-white text-gray-900 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all min-w-[180px]"
            >
              <option value="all">Todos los estados</option>
              {availableStatuses.map((status) => (
                <option value={status.value}>{status.label}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      <!-- Loading state -->
      <div id="orders-loading" class="bg-white rounded-lg shadow-sm border border-gray-200 p-16 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#5d3fbb]"></div>
        <p class="mt-4 text-gray-600">Cargando pedidos...</p>
      </div>

      <!-- Empty state -->
      <div id="orders-empty" class="hidden text-center py-16 bg-white rounded-lg shadow-sm border border-gray-200">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-gray-900 font-semibold text-lg mb-2">No hay pedidos</p>
        <p class="text-gray-500">Aún no se han realizado pedidos en el sistema</p>
      </div>

      <!-- Lista de pedidos -->
      <div id="orders-container" class="space-y-4 hidden">
        <!-- Las órdenes se renderizarán aquí dinámicamente -->
      </div>

      <!-- Mensaje cuando no hay resultados de búsqueda -->
      <div id="no-results-message" class="hidden text-center py-16 bg-white rounded-lg shadow-sm border border-gray-200">
        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="text-gray-900 font-semibold text-lg mb-2">No se encontraron pedidos</p>
        <p class="text-gray-500">Intenta cambiar los filtros de búsqueda</p>
      </div>
    </div>
  </div>

  <!-- Modal para rechazar devolución -->
  <div id="reject-return-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-xl font-bold text-gray-900">Rechazar Devolución</h2>
        <button type="button" id="close-reject-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="mb-5">
        <label for="reject-reason" class="block text-sm font-semibold text-gray-900 mb-2">
          Razón del rechazo <span class="text-red-500">*</span>
        </label>
        <textarea
          id="reject-reason"
          placeholder="Explica por qué se rechaza esta devolución..."
          class="w-full h-32 px-4 py-3 text-sm rounded-lg border border-gray-200 bg-white text-gray-900 placeholder-gray-400 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all duration-200 resize-none"
          required
        ></textarea>
      </div>
      
      <div class="flex gap-2">
        <button
          type="button"
          id="reject-cancel-btn"
          class="flex-1 px-4 py-2.5 text-sm font-semibold bg-white text-gray-700 border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-all duration-200"
        >
          Cancelar
        </button>
        <button
          type="button"
          id="reject-submit-btn"
          class="flex-1 px-4 py-2.5 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200"
        >
          Rechazar Devolución
        </button>
      </div>
    </div>
  </div>

  <script>
    (async function() {
      // Mapear estados a español
      const statusMap: Record<string, { label: string; color: string; icon: string }> = {
        pending: { label: 'Pendiente', color: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' },
        processing: { label: 'Procesando', color: 'bg-blue-100 text-blue-800 border-blue-200', icon: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' },
        shipped: { label: 'En camino', color: 'bg-purple-100 text-purple-800 border-purple-200', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
        delivered: { label: 'Entregado', color: 'bg-green-100 text-green-800 border-green-200', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' },
        cancelled: { label: 'Cancelado', color: 'bg-red-100 text-red-800 border-red-200', icon: 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z' },
      };

      // Estados disponibles para actualizar
      const availableStatuses = [
        { value: 'pending', label: 'Pendiente' },
        { value: 'processing', label: 'Procesando' },
        { value: 'shipped', label: 'En camino' },
        { value: 'delivered', label: 'Entregado' },
        { value: 'cancelled', label: 'Cancelado' },
      ];

      // Función auxiliar para convertir Timestamp de Firestore a Date
      function toDate(value: any): Date | null {
        if (!value) return null;
        if (value instanceof Date) return value;
        // Verificar si es un Timestamp de Firestore
        if (value && typeof value === 'object' && 'toDate' in value && typeof value.toDate === 'function') {
          return value.toDate();
        }
        // Intentar convertir como string o número
        if (typeof value === 'string' || typeof value === 'number') {
          return new Date(value);
        }
        return null;
      }

      function formatDate(timestamp: any): string {
        const date = toDate(timestamp);
        if (!date) return 'Fecha no disponible';
        return new Intl.DateTimeFormat('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        }).format(date);
      }

      // Estado
      let allOrders: any[] = [];
      let allUsers: any[] = [];
      let userMap = new Map();
      let allReturns: any[] = [];
      let returnsMap = new Map(); // orderId -> returns[]

      // Elementos del DOM
      const ordersLoading = document.getElementById('orders-loading');
      const ordersEmpty = document.getElementById('orders-empty');
      const ordersContainer = document.getElementById('orders-container');
      const noResultsMessage = document.getElementById('no-results-message');
      const searchInput = document.getElementById('search-input') as HTMLInputElement;
      const statusFilter = document.getElementById('status-filter') as HTMLSelectElement;
      const statTotal = document.getElementById('stat-total');
      const statPending = document.getElementById('stat-pending');
      const statProcessing = document.getElementById('stat-processing');
      const statShipped = document.getElementById('stat-shipped');
      const statDelivered = document.getElementById('stat-delivered');

      // Cargar pedidos y usuarios
      async function loadOrders() {
        try {
          const { getAllOrders } = await import('../../lib/db/orders');
          const { getAllUsers } = await import('../../lib/db/users');
          const { getAllReturns } = await import('../../lib/db/returns');
          
          // Cargar órdenes
          const ordersResult = await getAllOrders();
          if (ordersResult.error) {
            throw ordersResult.error;
          }
          allOrders = ordersResult.data || [];

          // Cargar usuarios
          const usersResult = await getAllUsers();
          if (usersResult.error) {
            console.warn('Error cargando usuarios:', usersResult.error);
          } else {
            allUsers = usersResult.data || [];
            userMap = new Map(allUsers.map((u: any) => [u.id, u]));
          }

          // Cargar devoluciones
          const returnsResult = await getAllReturns();
          if (returnsResult.error) {
            console.warn('Error cargando devoluciones:', returnsResult.error);
          } else {
            allReturns = returnsResult.data || [];
            // Crear mapa de devoluciones por orderId
            returnsMap = new Map();
            allReturns.forEach((ret: any) => {
              if (!returnsMap.has(ret.orderId)) {
                returnsMap.set(ret.orderId, []);
              }
              returnsMap.get(ret.orderId).push(ret);
            });
          }

          // Procesar órdenes
          const processedOrders = allOrders.map((order: any) => {
            const user = userMap.get(order.userId);
            const statusInfo = statusMap[order.status] || statusMap.pending;
            
            // Asegurarse de que el ID esté presente
            if (!order.id) {
              console.warn('Orden sin ID:', order);
            }
            
            return {
              ...order,
              id: order.id, // Asegurar que el ID esté presente
              user,
              statusInfo,
              createdAtFormatted: formatDate(order.createdAt),
              isGuest: order.isGuest || order.userId?.startsWith('guest_'),
              customerName: order.isGuest 
                ? (order.guestName || 'Cliente invitado')
                : (user?.name || user?.displayName || 'Usuario no encontrado'),
              customerEmail: order.isGuest 
                ? (order.guestEmail || 'N/A')
                : (user?.email || 'N/A'),
            };
          });

          // Ordenar por fecha más reciente primero
          processedOrders.sort((a: any, b: any) => {
            const dateA = toDate(a.createdAt)?.getTime() || 0;
            const dateB = toDate(b.createdAt)?.getTime() || 0;
            return dateB - dateA;
          });

          allOrders = processedOrders;

          // Ocultar loading
          if (ordersLoading) ordersLoading.classList.add('hidden');
          
          // Actualizar estadísticas
          updateStats();
          
          // Renderizar órdenes
          renderOrders();

        } catch (error) {
          console.error('Error cargando pedidos:', error);
          if (ordersLoading) ordersLoading.classList.add('hidden');
          if (ordersEmpty) {
            ordersEmpty.classList.remove('hidden');
            ordersEmpty.querySelector('p')!.textContent = 'Error al cargar los pedidos';
          }
        }
      }

      // Actualizar estadísticas
      function updateStats() {
        if (statTotal) statTotal.textContent = allOrders.length.toString();
        if (statPending) statPending.textContent = allOrders.filter((o: any) => o.status === 'pending').length.toString();
        if (statProcessing) statProcessing.textContent = allOrders.filter((o: any) => o.status === 'processing').length.toString();
        if (statShipped) statShipped.textContent = allOrders.filter((o: any) => o.status === 'shipped').length.toString();
        if (statDelivered) statDelivered.textContent = allOrders.filter((o: any) => o.status === 'delivered').length.toString();
      }

      // Renderizar órdenes
      function renderOrders(ordersToRender: any[] = allOrders) {
        if (!ordersContainer) return;

        if (ordersToRender.length === 0) {
          ordersContainer.classList.add('hidden');
          if (noResultsMessage) {
            noResultsMessage.classList.remove('hidden');
          }
          if (ordersEmpty) {
            ordersEmpty.classList.add('hidden');
          }
          return;
        }

        ordersContainer.classList.remove('hidden');
        if (noResultsMessage) noResultsMessage.classList.add('hidden');
        if (ordersEmpty) ordersEmpty.classList.add('hidden');

        ordersContainer.innerHTML = ordersToRender.map((order: any) => {
          const statusInfo = statusMap[order.status] || statusMap.pending;
          const statusOptions = availableStatuses.map((status) => 
            `<option value="${status.value}" ${order.status === status.value ? 'selected' : ''}>${status.label}</option>`
          ).join('');
          
          // Obtener devoluciones de esta orden
          const orderReturns = returnsMap.get(order.id) || [];
          const pendingReturns = orderReturns.filter((r: any) => r.status === 'pending');
          const hasReturns = orderReturns.length > 0;
          
          const reasonMap: Record<string, string> = {
            defective: 'Producto defectuoso',
            wrong_item: 'Pedido incorrecto',
            damaged: 'Producto dañado',
            not_as_described: 'No coincide con la descripción',
            other: 'Otra razón',
          };

          return `
          <div
            class="bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow order-card"
              data-order-id="${order.id}"
              data-status="${order.status}"
              data-customer="${order.customerName.toLowerCase()}"
              data-email="${order.customerEmail.toLowerCase()}"
          >
            <!-- Header del pedido -->
            <div class="p-5 border-b border-gray-100">
              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2 flex-wrap">
                    <h3 class="text-lg font-bold text-gray-900">
                        Pedido #${order.id.substring(0, 8)}
                    </h3>
                      <span class="px-3 py-1 rounded-full text-xs font-semibold border ${statusInfo.color}">
                      <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${statusInfo.icon}" />
                      </svg>
                        ${statusInfo.label}
                    </span>
                    ${hasReturns ? `
                      <span class="px-3 py-1 rounded-full text-xs font-semibold border bg-orange-50 text-orange-700 border-orange-200">
                        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        ${orderReturns.length} Devolución${orderReturns.length > 1 ? 'es' : ''}
                        ${pendingReturns.length > 0 ? ` (${pendingReturns.length} pendiente${pendingReturns.length > 1 ? 's' : ''})` : ''}
                      </span>
                    ` : ''}
                  </div>
                  <div class="text-sm text-gray-600 space-y-1">
                      <p><span class="font-medium">Fecha:</span> ${order.createdAtFormatted}</p>
                      <p><span class="font-medium">Cliente:</span> ${order.customerName}</p>
                      <p><span class="font-medium">Email:</span> ${order.customerEmail}</p>
                      ${order.isGuest ? '<span class="inline-block px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded">Cliente invitado</span>' : ''}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold text-gray-900 mb-1">
                      Bs. ${order.total.toFixed(2)}
                  </div>
                  <div class="text-sm text-gray-500">
                      ${order.items.length} ${order.items.length === 1 ? 'producto' : 'productos'}
                  </div>
                </div>
              </div>
            </div>

            <!-- Detalles del pedido -->
            <div class="p-5">
              <!-- Productos -->
              <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-900 mb-2">Productos:</h4>
                <div class="space-y-2">
                    ${order.items.map((item: any) => `
                    <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                      <img
                          src="${item.productImage || '/placeholder-product.jpg'}"
                          alt="${item.productName}"
                        class="w-12 h-12 object-cover rounded"
                      />
                      <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-gray-900 truncate">${item.productName}</p>
                        <p class="text-xs text-gray-500">
                            Cantidad: ${item.quantity} × Bs. ${item.price.toFixed(2)}
                        </p>
                      </div>
                      <div class="text-sm font-semibold text-gray-900">
                          Bs. ${item.subtotal.toFixed(2)}
                        </div>
                      </div>
                    `).join('')}
                </div>
              </div>

              <!-- Dirección de envío -->
              <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-900 mb-2">Dirección de envío:</h4>
                <div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700">
                    ${order.shippingAddress ? `
                      <p class="font-medium">${order.shippingAddress.fullName}</p>
                      <p>${order.shippingAddress.street}</p>
                      <p>${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.postalCode}</p>
                      ${order.shippingAddress.phone ? `<p class="mt-1 text-gray-600">Tel: ${order.shippingAddress.phone}</p>` : ''}
                    ` : '<p class="text-gray-500">Dirección no disponible</p>'}
                </div>
              </div>

              <!-- Método de pago -->
              <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-900 mb-2">Método de pago:</h4>
                <div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-700">
                    ${order.paymentMethod ? `
                      <p class="font-medium">${order.paymentMethod.type === 'card' ? 'Tarjeta' : 'Efectivo'}</p>
                      ${order.paymentMethod.type === 'card' && order.paymentMethod.last4 ? `<p>Terminada en ${order.paymentMethod.last4}</p>` : ''}
                    ` : '<p class="text-gray-500">Método de pago no disponible</p>'}
                </div>
              </div>

              <!-- Devoluciones -->
              ${hasReturns ? `
              <div class="mb-4 border-t border-gray-100 pt-4">
                <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                  <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Devoluciones (${orderReturns.length})
                </h4>
                <div class="space-y-3">
                  ${orderReturns.map((ret: any) => {
                    const returnStatusMap: Record<string, { label: string; color: string }> = {
                      pending: { label: 'Pendiente', color: 'bg-yellow-50 text-yellow-700 border-yellow-200' },
                      approved: { label: 'Aprobada', color: 'bg-green-50 text-green-700 border-green-200' },
                      rejected: { label: 'Rechazada', color: 'bg-red-50 text-red-700 border-red-200' },
                      processing: { label: 'Procesando', color: 'bg-blue-50 text-blue-700 border-blue-200' },
                      completed: { label: 'Completada', color: 'bg-emerald-50 text-emerald-700 border-emerald-200' },
                      cancelled: { label: 'Cancelada', color: 'bg-gray-50 text-gray-700 border-gray-200' },
                    };
                    const retStatus = returnStatusMap[ret.status] || returnStatusMap.pending;
                    return `
                      <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                        <div class="flex items-start justify-between gap-3 mb-2">
                          <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-900">${ret.productName}</p>
                            <p class="text-xs text-gray-600 mt-1">
                              <span class="font-medium">Razón:</span> ${reasonMap[ret.reason] || ret.reason}
                            </p>
                            <p class="text-xs text-gray-600">
                              <span class="font-medium">Descripción:</span> ${ret.description || 'Sin descripción'}
                            </p>
                            <p class="text-xs text-gray-600 mt-1">
                              <span class="font-medium">Monto:</span> Bs. ${ret.refundAmount.toFixed(2)}
                            </p>
                          </div>
                          <span class="px-2 py-1 rounded-full text-xs font-medium border ${retStatus.color} whitespace-nowrap">
                            ${retStatus.label}
                          </span>
                        </div>
                        ${ret.status === 'pending' ? `
                          <div class="flex gap-2 mt-3 pt-3 border-t border-orange-200">
                            <button
                              type="button"
                              class="flex-1 px-3 py-1.5 text-xs font-semibold bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors approve-return-btn"
                              data-return-id="${ret.id}"
                              data-order-id="${order.id}"
                            >
                              Aprobar
                            </button>
                            <button
                              type="button"
                              class="flex-1 px-3 py-1.5 text-xs font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors reject-return-btn"
                              data-return-id="${ret.id}"
                              data-order-id="${order.id}"
                            >
                              Rechazar
                            </button>
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
              ` : ''}

              <!-- Actualizar estado -->
              <div class="border-t border-gray-100 pt-4">
                <label class="block text-sm font-semibold text-gray-900 mb-2">
                  Actualizar estado del pedido:
                </label>
                <div class="flex flex-col sm:flex-row gap-3">
                  <select
                    class="flex-1 px-4 py-2.5 text-sm rounded-lg border border-gray-300 bg-white text-gray-900 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all order-status-select"
                      data-order-id="${order.id}"
                  >
                      ${statusOptions}
                  </select>
                  <button
                    type="button"
                    class="px-6 py-2.5 bg-[#5d3fbb] text-white rounded-lg hover:bg-[#4d2fa8] transition-colors font-medium text-sm update-status-btn"
                      data-order-id="${order.id}"
                  >
                    Actualizar Estado
                  </button>
                </div>
                <div class="mt-3">
                  <label class="block text-sm font-semibold text-gray-900 mb-2">
                    Número de seguimiento:
                  </label>
                  <input
                    type="text"
                    class="w-full px-4 py-2.5 text-sm rounded-lg border border-gray-300 bg-white text-gray-900 focus:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 tracking-input"
                      data-order-id="${order.id}"
                      value="${order.trackingNumber || ''}"
                    placeholder="Ingrese número de seguimiento (opcional)"
                  />
                </div>
              </div>
            </div>
          </div>
          `;
        }).join('');

        // Los event listeners se manejan mediante event delegation, no necesitan re-attach
      }

    // Filtros y búsqueda
    function filterOrders() {
      if (!ordersContainer) return;

      const searchTerm = searchInput.value.toLowerCase();
      const statusFilterValue = statusFilter.value;

        const filtered = allOrders.filter((order: any) => {
        const matchesSearch = !searchTerm || 
            order.id.toLowerCase().includes(searchTerm) ||
            order.customerName.toLowerCase().includes(searchTerm) ||
            order.customerEmail.toLowerCase().includes(searchTerm);

          const matchesStatus = statusFilterValue === 'all' || order.status === statusFilterValue;

          return matchesSearch && matchesStatus;
        });

        renderOrders(filtered);
    }

    searchInput.addEventListener('input', filterOrders);
    statusFilter.addEventListener('change', filterOrders);

      // Variables para modal de rechazo
      let currentRejectReturnId = '';
      let currentRejectOrderId = '';

      // Función para abrir modal de rechazo
      function openRejectModal(returnId: string, orderId: string) {
        currentRejectReturnId = returnId;
        currentRejectOrderId = orderId;
        const modal = document.getElementById('reject-return-modal');
        const reasonTextarea = document.getElementById('reject-reason') as HTMLTextAreaElement;
        if (modal && reasonTextarea) {
          reasonTextarea.value = '';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
      }

      // Función para cerrar modal de rechazo
      function closeRejectModal() {
        const modal = document.getElementById('reject-return-modal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          modal.style.display = 'none';
          document.body.style.overflow = '';
          currentRejectReturnId = '';
          currentRejectOrderId = '';
        }
      }

      // Inicializar modal de rechazo
      function initRejectModal() {
        const modal = document.getElementById('reject-return-modal');
        const closeBtn = document.getElementById('close-reject-modal-btn');
        const cancelBtn = document.getElementById('reject-cancel-btn');
        const submitBtn = document.getElementById('reject-submit-btn');
        const reasonTextarea = document.getElementById('reject-reason') as HTMLTextAreaElement;

        if (closeBtn) {
          closeBtn.addEventListener('click', closeRejectModal);
        }

        if (cancelBtn) {
          cancelBtn.addEventListener('click', closeRejectModal);
        }

        if (submitBtn) {
          submitBtn.addEventListener('click', async () => {
            const reason = reasonTextarea?.value.trim();
            if (!reason) {
              alert('Por favor, ingresa una razón para el rechazo');
              return;
            }

            if (!currentRejectReturnId) {
              alert('Error: No se encontró el ID de la devolución');
              return;
            }

            const btn = submitBtn as HTMLButtonElement;
            btn.disabled = true;
            btn.textContent = 'Rechazando...';

            try {
              const { updateReturnStatus, updateReturn } = await import('../../lib/db/returns');
              
              // Actualizar estado a rejected
              const result = await updateReturnStatus(currentRejectReturnId, 'rejected');
              
              if (!result.success) {
                throw result.error || new Error('Error al rechazar la devolución');
              }

              // Agregar razón al timeline (opcional, podrías agregar un campo adminReason)
              // Por ahora solo actualizamos el estado

              // Mostrar mensaje de éxito
              const successMsg = document.createElement('div');
              successMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-3';
              successMsg.style.animation = 'slideInRight 0.3s ease-out';
              successMsg.innerHTML = `
                <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <div>
                  <p class="font-semibold">Devolución rechazada</p>
                  <p class="text-sm text-red-100">La devolución ha sido rechazada exitosamente</p>
                </div>
              `;
              document.body.appendChild(successMsg);

              setTimeout(async () => {
                successMsg.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                  successMsg.remove();
                }, 300);
                await loadOrders();
              }, 2500);

              closeRejectModal();

            } catch (error: any) {
              console.error('Error rechazando devolución:', error);
              alert(error.message || 'Error al rechazar la devolución');
              
              btn.disabled = false;
              btn.textContent = 'Rechazar Devolución';
            }
          });
        }

        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeRejectModal();
            }
          });
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modal = document.getElementById('reject-return-modal');
            if (modal && !modal.classList.contains('hidden')) {
              closeRejectModal();
            }
          }
        });
      }

      // Event delegation para botones de actualización de estado y devoluciones
      if (ordersContainer) {
        ordersContainer.addEventListener('click', async (e) => {
          const target = e.target as HTMLElement;
          
          // Botón aprobar devolución
          const approveBtn = target.closest('.approve-return-btn') as HTMLButtonElement;
          if (approveBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const returnId = approveBtn.getAttribute('data-return-id');
            if (!returnId) {
              alert('Error: No se encontró el ID de la devolución');
              return;
            }

            if (!confirm('¿Estás seguro de que deseas aprobar esta devolución?')) {
              return;
            }

            approveBtn.disabled = true;
            approveBtn.textContent = 'Aprobando...';

            try {
              const { updateReturnStatus } = await import('../../lib/db/returns');
              const result = await updateReturnStatus(returnId, 'approved');
              
              if (!result.success) {
                throw result.error || new Error('Error al aprobar la devolución');
              }

              const successMsg = document.createElement('div');
              successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-3';
              successMsg.style.animation = 'slideInRight 0.3s ease-out';
              successMsg.innerHTML = `
                <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <div>
                  <p class="font-semibold">Devolución aprobada</p>
                  <p class="text-sm text-green-100">La devolución ha sido aprobada exitosamente</p>
                </div>
              `;
              document.body.appendChild(successMsg);

              setTimeout(async () => {
                successMsg.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                  successMsg.remove();
                }, 300);
                await loadOrders();
              }, 2500);

            } catch (error: any) {
              console.error('Error aprobando devolución:', error);
              alert(error.message || 'Error al aprobar la devolución');
              
              approveBtn.disabled = false;
              approveBtn.textContent = 'Aprobar';
            }
            return;
          }

          // Botón rechazar devolución
          const rejectBtn = target.closest('.reject-return-btn') as HTMLButtonElement;
          if (rejectBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const returnId = rejectBtn.getAttribute('data-return-id');
            const orderId = rejectBtn.getAttribute('data-order-id');
            if (returnId && orderId) {
              openRejectModal(returnId, orderId);
            }
            return;
          }

          const updateBtn = target.closest('.update-status-btn') as HTMLButtonElement;
          
          if (!updateBtn) return;
          
          e.preventDefault();
          e.stopPropagation();
          
          // Obtener el orderId del contenedor padre (order-card) que siempre tiene el ID
          const orderCard = updateBtn.closest('.order-card') as HTMLElement;
          let orderId: string | null = null;
          
          if (orderCard) {
            orderId = orderCard.getAttribute('data-order-id');
          }
          
          // Si no funciona, intentar desde el botón directamente
          if (!orderId) {
            orderId = updateBtn.getAttribute('data-order-id') || updateBtn.dataset.orderId || null;
          }
          
          if (!orderId) {
            console.error('No se encontró orderId. Botón:', updateBtn);
            console.error('OrderCard:', orderCard);
            console.error('HTML del botón:', updateBtn.outerHTML);
            return;
          }

          const select = ordersContainer.querySelector(
          `.order-status-select[data-order-id="${orderId}"]`
        ) as HTMLSelectElement;
          const trackingInput = ordersContainer.querySelector(
          `.tracking-input[data-order-id="${orderId}"]`
        ) as HTMLInputElement;

          if (!select) {
            console.error('No se encontró el select para el pedido:', orderId);
            return;
          }

        const newStatus = select.value as any;
        const trackingNumber = trackingInput?.value?.trim() || '';

        // Deshabilitar botón mientras se actualiza
          updateBtn.disabled = true;
          updateBtn.textContent = 'Actualizando...';

        try {
            console.log('Actualizando pedido:', orderId, 'con estado:', newStatus);
            const { updateOrder } = await import('../../lib/db/orders');
            
          // Actualizar estado y número de seguimiento en una sola operación
          const updateData: any = { status: newStatus };
          if (trackingNumber) {
            updateData.trackingNumber = trackingNumber;
          } else {
            // Si está vacío, eliminar el campo (usar null para borrarlo)
            updateData.trackingNumber = null;
          }

          const updateResult = await updateOrder(orderId, updateData);
          
          if (!updateResult.success) {
            throw new Error('Error al actualizar el pedido');
          }

            console.log('Pedido actualizado exitosamente');

            // Obtener el nuevo estado en español
            const statusLabels: Record<string, string> = {
              pending: 'Pendiente',
              processing: 'Procesando',
              shipped: 'En camino',
              delivered: 'Entregado',
              cancelled: 'Cancelado'
            };
            const newStatusLabel = statusLabels[newStatus] || newStatus;

            // Mostrar notificador de éxito
          const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-3';
            successMsg.style.animation = 'slideInRight 0.3s ease-out';
          successMsg.innerHTML = `
              <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
              <div>
                <p class="font-semibold">Estado del pedido actualizado</p>
                <p class="text-sm text-green-100">Estado: ${newStatusLabel}</p>
              </div>
          `;
          document.body.appendChild(successMsg);

            setTimeout(async () => {
              successMsg.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => {
            successMsg.remove();
              }, 300);
              // Recargar las órdenes
              await loadOrders();
            }, 2500);

        } catch (error) {
          console.error('Error actualizando estado:', error);
          
            // Mostrar notificador de error
          const errorMsg = document.createElement('div');
            errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-3';
            errorMsg.style.animation = 'slideInRight 0.3s ease-out';
          errorMsg.innerHTML = `
              <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
              <div>
                <p class="font-semibold">Error al actualizar el estado</p>
                <p class="text-sm text-red-100">Por favor, intenta nuevamente</p>
              </div>
          `;
          document.body.appendChild(errorMsg);

            setTimeout(() => {
              errorMsg.style.animation = 'slideOutRight 0.3s ease-in';
          setTimeout(() => {
            errorMsg.remove();
              }, 300);
          }, 3000);

          // Restaurar botón
            updateBtn.disabled = false;
            updateBtn.textContent = 'Actualizar Estado';
        }
      });
      }

      // Inicializar modal de rechazo
      initRejectModal();

      // Cargar órdenes al iniciar
      await loadOrders();
    })();
  </script>
</Layout>
