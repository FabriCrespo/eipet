---
import Layout from "../../layouts/Layout.astro";
import { getProducts, getProductSalesStats } from "../../lib/db/products";
import { getCategories } from "../../lib/db/categories";
import { getBrands } from "../../lib/db/brands";
import ProductModal from "../../components/admin/ProductModal.astro";
import ViewProductModal from "../../components/admin/ViewProductModal.astro";

// Funciones helper
function formatCurrency(value: number): string {
  return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function formatNumber(value: number): string {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Carga de datos real desde Firebase
// Obtener todos los productos (sin filtro de status para el admin)
const productsResult = await getProducts();
const categoriesResult = await getCategories();
const brandsResult = await getBrands();

// Usamos any explícitamente porque las interfaces de BD pueden no estar sincronizadas con todos los campos reales
const rawProducts: any[] = productsResult.data || [];
const rawCategories: any[] = categoriesResult.data || [];
const rawBrands: any[] = brandsResult.data || [];

// Mapas para búsqueda rápida
const categoryMap = new Map(rawCategories.map((c) => [c.id, c]));
const brandMap = new Map(rawBrands.map((b) => [b.id, b]));

// Procesar Productos
const products = await Promise.all(
  rawProducts.map(async (p) => {
    const categoryData = categoryMap.get(p.category);
    const brandData = brandMap.get(p.brand);
    
    const category = categoryData || { name: "Sin categoría" };
    const brand = brandData || {
      name: "Sin marca",
      categoryId: "",
    };

    // Obtener estadísticas de ventas (esto podría optimizarse luego)
    // const salesStats = await getProductSalesStats(p.id);
    // TODO: Optimizar estadísticas de ventas para evitar N+1 queries. Por ahora mockeamos 0 para rendimiento.
    const salesStats = { sales: 0, revenue: 0 };

    const minStock = p.minStock || 5;
    let stockStatus = "normal";
    let stockColor = "bg-blue-100 text-blue-800";

    if (p.stock === 0) {
      stockStatus = "out";
      stockColor = "bg-red-100 text-red-800";
    } else if (p.stock <= minStock) {
      stockStatus = "low";
      stockColor = "bg-yellow-100 text-yellow-800";
    }

    // Normalizar status
    const isActive = p.status === "active" || p.status === "Activo";

    return {
      ...p,
      // Asegurar compatibilidad con la vista
      category: category.name, // Nombre de categoría para mostrar
      categoryId: p.category, // ID real
      brand: brand.name, // Nombre de marca para mostrar
      brandId: p.brand, // ID real

      sku: p.sku || "N/A",
      price: p.price || 0,
      minStock,

      stockStatus,
      stockColor,

      status: isActive ? "Activo" : "Inactivo",
      statusColor: isActive
        ? "bg-green-100 text-green-800"
        : "bg-gray-100 text-gray-800",

      sales: salesStats.sales,
      revenue: salesStats.revenue,
    };
  }),
);

// Procesar Categorías (Solo lo necesario para selects)
const categories = rawCategories;

// Procesar Marcas (Solo lo necesario para selects)
const brands = rawBrands.map((b) => ({
  ...b,
  categoryId: b.categoryId, // Necesario para data-category en select
}));

// Calcular Estadísticas Globales
const stats = {
  totalProducts: products.length,
  activeProducts: products.filter((p) => p.status === "Activo").length,
  lowStock: products.filter((p) => p.stockStatus === "low").length,
  outOfStock: products.filter((p) => p.stockStatus === "out").length,
  totalValue: products.reduce((sum, p) => sum + p.price * p.stock, 0),
  totalStock: products.reduce((sum, p) => sum + p.stock, 0),
};

---

<Layout>
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Header -->
      <div
        class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
      >
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
            Gestión de Productos
          </h1>
          <p class="text-gray-600">Gestiona el inventario de productos</p>
        </div>
        <div class="flex gap-2">
          <!-- Navegación -->
          <a
            href="/admin/categories"
            class="px-5 py-3 bg-white border border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all duration-300 flex items-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
              ></path>
            </svg>
            <span>Categorías</span>
          </a>
          <a
            href="/admin/marcas"
            class="px-5 py-3 bg-white border border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all duration-300 flex items-center gap-2"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <span>Marcas</span>
          </a>

          <!-- Botón Nuevo Producto -->
          <button
            type="button"
            id="new-product-btn"
            class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 hover:shadow-lg transition-all duration-300 flex items-center gap-2 product-action-btn"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"></path>
            </svg>
            <span>Nuevo Producto</span>
          </button>
        </div>
      </div>

      <!-- Content -->
      <div id="products-content">
        <!-- Tab Content: Productos -->
        <div id="products-tab" class="tab-content">
          <!-- Estadísticas -->
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
          >
            <!-- Total Productos -->
            <div
              class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                    ></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Total Productos</p>
                  <p id="stat-total-products" class="text-2xl font-bold text-gray-900">
                    {formatNumber(stats.totalProducts)}
                  </p>
                </div>
              </div>
            </div>

            <!-- Productos Activos -->
            <div
              class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Activos</p>
                  <p id="stat-active-products" class="text-2xl font-bold text-gray-900">
                    {formatNumber(stats.activeProducts)}
                  </p>
                </div>
              </div>
            </div>

            <!-- Bajo Stock -->
            <div
              class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-yellow-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                    ></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Bajo Stock</p>
                  <p id="stat-low-stock" class="text-2xl font-bold text-gray-900">
                    {formatNumber(stats.lowStock)}
                  </p>
                </div>
              </div>
            </div>

            <!-- Agotados -->
            <div
              class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center"
                >
                  <svg
                    class="w-6 h-6 text-red-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
                    ></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Agotados</p>
                  <p id="stat-out-of-stock" class="text-2xl font-bold text-gray-900">
                    {formatNumber(stats.outOfStock)}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Estadísticas de Stock -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Valor Total del Inventario -->
            <div
              class="bg-white rounded-3xl p-6 border border-gray-200 shadow-md"
            >
              <div class="flex items-center gap-4">
                <div
                  class="w-16 h-16 rounded-xl bg-purple-100 flex items-center justify-center"
                >
                  <svg
                    class="w-8 h-8 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-600 mb-1">
                    Valor Total del Inventario
                  </p>
                  <p id="stat-total-value" class="text-3xl font-bold text-gray-900">
                    Bs. {formatCurrency(stats.totalValue)}
                  </p>
                </div>
              </div>
            </div>

            <!-- Total de Unidades -->
            <div
              class="bg-white rounded-3xl p-6 border border-gray-200 shadow-md"
            >
              <div class="flex items-center gap-4">
                <div
                  class="w-16 h-16 rounded-xl bg-blue-100 flex items-center justify-center"
                >
                  <svg
                    class="w-8 h-8 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                    ></path>
                  </svg>
                </div>
                <div>
                  <p class="text-sm text-gray-600 mb-1">
                    Total de Unidades en Stock
                  </p>
                  <p id="stat-total-stock" class="text-3xl font-bold text-gray-900">
                    {formatNumber(stats.totalStock)}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Barra de Búsqueda y Filtros -->
          <div
            class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 mb-8"
          >
            <div class="flex flex-col sm:flex-row gap-4">
              <!-- Búsqueda -->
              <div class="flex-1 relative">
                <div
                  class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
                >
                  <svg
                    class="h-5 w-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </div>
                <input
                  type="text"
                  placeholder="Buscar por nombre, SKU o categoría..."
                  class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
                />
              </div>

              <!-- Filtro por Categoría -->
              <select
                class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
              >
                <option value="all">Todas las categorías</option>
                <option value="alimentos">Alimentos</option>
                <option value="accesorios">Accesorios</option>
                <option value="juguetes">Juguetes</option>
                <option value="higiene">Higiene</option>
                <option value="camas">Camas</option>
              </select>

              <!-- Filtro por Stock -->
              <select
                class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
              >
                <option value="all">Todo el stock</option>
                <option value="normal">Stock normal</option>
                <option value="low">Bajo stock</option>
                <option value="out">Agotado</option>
              </select>
            </div>
          </div>

          <!-- Tabla de Productos -->
          <div
            class="bg-white rounded-3xl border border-gray-200 shadow-md overflow-hidden"
          >
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >Producto</th
                    >
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >Categoría</th
                    >
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >SKU</th
                    >
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >Precio</th
                    >
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >Stock</th
                    >
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >Estado</th
                    >
                    <th
                      class="text-left py-4 px-6 text-sm font-semibold text-gray-700"
                      >Ventas</th
                    >
                    <th
                      class="text-right py-4 px-6 text-sm font-semibold text-gray-700"
                      >Acciones</th
                    >
                  </tr>
                </thead>
                <tbody id="products-table-body">
                  {
                    products.length > 0 ? products.map((product) => (
                      <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="py-4 px-6">
                          <div class="flex items-center gap-3">
                            <img
                              src={product.image}
                              alt={product.name}
                              class="w-12 h-12 rounded-lg object-cover border border-gray-200"
                            />
                            <div>
                              <p class="font-semibold text-gray-900">
                                {product.name}
                              </p>
                              <p class="text-xs text-gray-500">
                                ID: {product.id}
                              </p>
                            </div>
                          </div>
                        </td>
                        <td class="py-4 px-6">
                          <span class="text-sm text-gray-700">
                            {product.category}
                          </span>
                        </td>
                        <td class="py-4 px-6">
                          <span class="text-sm font-mono text-gray-600">
                            {product.sku}
                          </span>
                        </td>
                        <td class="py-4 px-6">
                          <p class="font-semibold text-gray-900">
                            Bs. {formatCurrency(product.price)}
                          </p>
                        </td>
                        <td class="py-4 px-6">
                          <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2">
                              <span
                                class={`px-2 py-1 rounded text-xs font-medium ${product.stockColor}`}
                              >
                                {product.stock} unidades
                              </span>
                              {product.stockStatus === "low" && (
                                <span class="text-xs text-yellow-600">
                                  ⚠ Mín: {product.minStock}
                                </span>
                              )}
                              {product.stockStatus === "out" && (
                                <span class="text-xs text-red-600">
                                  ⚠ Agotado
                                </span>
                              )}
                            </div>
                            {product.stockStatus === "normal" && (
                              <span class="text-xs text-gray-500">
                                Mín: {product.minStock}
                              </span>
                            )}
                          </div>
                        </td>
                        <td class="py-4 px-6">
                          <span
                            class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${product.statusColor}`}
                          >
                            {product.status}
                          </span>
                        </td>
                        <td class="py-4 px-6">
                          <div>
                            <p class="text-sm font-semibold text-gray-900">
                              {product.sales} ventas
                            </p>
                            <p class="text-xs text-gray-500">
                              Bs. {formatCurrency(product.revenue)}
                            </p>
                          </div>
                        </td>
                        <td class="py-4 px-6 text-right">
                          <div class="flex items-center justify-end gap-2">
                            <button
                              type="button"
                              data-product-id={product.id}
                              data-action="view"
                              class="view-product-btn p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                              title="Ver detalles"
                            >
                              <svg
                                class="w-5 h-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                />
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                />
                              </svg>
                            </button>
                            <button
                              type="button"
                              data-product-id={product.id}
                              data-action="edit"
                              class="edit-product-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                              title="Editar"
                            >
                              <svg
                                class="w-5 h-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                />
                              </svg>
                            </button>
                            <button
                              type="button"
                              data-product-id={product.id}
                              data-action="stock"
                              class="adjust-stock-btn p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                              title="Ajustar stock"
                            >
                              <svg
                                class="w-5 h-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                />
                              </svg>
                            </button>
                            <button
                              type="button"
                              data-product-id={product.id}
                              data-action="delete"
                              class="delete-product-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              title="Eliminar"
                            >
                              <svg
                                class="w-5 h-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                />
                              </svg>
                            </button>
                          </div>
                        </td>
                      </tr>
                    )) : (
                      <tr>
                        <td colspan="8" class="py-8 px-6 text-center text-gray-500">
                          <p>Cargando productos...</p>
                        </td>
                      </tr>
                    )
                  }
                </tbody>
              </table>
            </div>

            <!-- Paginación -->
            <div
              class="flex flex-col sm:flex-row items-center justify-between gap-4 p-6 border-t border-gray-200"
            >
              <div class="text-sm text-gray-600">
                Mostrando <span class="font-semibold">1</span> - <span
                  class="font-semibold">{products.length}</span
                > de <span class="font-semibold">{products.length}</span> productos
              </div>
              <div class="flex items-center gap-2">
                <button
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled
                >
                  <svg
                    class="h-5 w-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <button
                  class="px-4 py-2 rounded-lg border-2 border-purple-400 bg-purple-50 text-purple-700 font-semibold"
                  >1</button
                >
                <button
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all"
                  >2</button
                >
                <button
                  class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all"
                >
                  <svg
                    class="h-5 w-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Cierre de products-tab -->
      </div>
    </div>
  </section>
  <!-- MODALES DE PRODUCTOS -->

  <!-- Modal: Nuevo Producto -->
  <ProductModal 
    categories={categories} 
    brands={brands} 
    mode="create"
    modalId="new-product-modal"
    formId="new-product-form"
    closeButtonId="close-new-modal-btn"
    cancelButtonId="cancel-new-btn"
  />

  <!-- Modal: Editar Producto -->
  <ProductModal 
    categories={categories} 
    brands={brands} 
    mode="edit"
    modalId="edit-product-modal"
    formId="edit-product-form"
    closeButtonId="close-edit-modal-btn"
    cancelButtonId="cancel-edit-btn"
  />

  <!-- Modal: Ver Producto -->
  <ViewProductModal />

  <!-- Modal: Ajustar Stock -->
  <div
    id="adjust-stock-modal"
    class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    style="display: none;"
  >
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-start mb-6">
        <h3 class="text-xl font-bold text-gray-900">Ajustar Stock</h3>
        <button
          type="button"
          id="close-stock-modal-btn"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="adjust-stock-form" class="space-y-6">
        <div id="adjust-stock-content" class="space-y-4">
          <!-- Contenido dinámico -->
        </div>
        <div class="flex gap-4 pt-4 border-t border-gray-100">
          <button
            type="button"
            id="cancel-stock-btn"
            class="flex-1 px-6 py-3 bg-white border-2 border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all"
            >Cancelar</button
          >
          <button
            type="submit"
            class="flex-1 px-6 py-3 bg-orange-600 text-white font-semibold rounded-xl hover:bg-orange-700 transition-all"
            >Confirmar Ajuste</button
          >
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Eliminar Producto -->
  <div
    id="delete-product-modal"
    class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4"
    style="display: none;"
  >
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 text-center">
      <div
        class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <svg
          class="w-8 h-8 text-red-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
          ></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-gray-900 mb-2">¿Eliminar Producto?</h3>
      <p id="delete-product-message" class="text-gray-600 mb-6">
        ¿Estás seguro de que deseas eliminar este producto? Esta acción no se
        puede deshacer.
      </p>
      <div class="flex gap-4">
        <button
          type="button"
          id="cancel-delete-btn"
          class="flex-1 px-6 py-3 bg-white border-2 border-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all"
          >Cancelar</button
        >
        <button
          type="button"
          id="confirm-delete-btn"
          class="flex-1 px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-all"
          >Eliminar</button
        >
      </div>
    </div>
  </div>

  <!-- Data para JavaScript -->
  <script
    type="application/json"
    id="products-data-json"
    set:html={JSON.stringify(products)}
  />
  <script
    type="application/json"
    id="categories-data-json"
    set:html={JSON.stringify(categories)}
  />
  <script
    type="application/json"
    id="brands-data-json"
    set:html={JSON.stringify(brands)}
  />

  <script>
    (function () {
      // Obtener datos
      let productsData: any[] = [];
      const dataScript = document.getElementById("products-data-json");
      if (dataScript && dataScript.textContent) {
        try {
          productsData = JSON.parse(dataScript.textContent);
        } catch (e) {
          console.error("Error parsing products data:", e);
        }
      }

      // Modales
      const viewModal = document.getElementById("view-product-modal");
      const editModal = document.getElementById("edit-product-modal");
      const stockModal = document.getElementById("adjust-stock-modal");
      const deleteModal = document.getElementById("delete-product-modal");
      const newModal = document.getElementById("new-product-modal");

      // Funciones para abrir/cerrar modales
      function openModal(modal: HTMLElement | null) {
        if (!modal) return;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeModal(modal: HTMLElement | null) {
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modal.style.display = "none";
        document.body.style.overflow = "";
      }

      // Abrir modal de ver detalles
      document.querySelectorAll(".view-product-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const productId = btn.getAttribute("data-product-id");
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !viewModal) return;

          const content = document.getElementById("view-product-content");
          if (content) {
            content.innerHTML = `
                <div class="flex gap-4 pb-4 border-b border-gray-200">
                  <img src="${product.image}" alt="${product.name}" class="w-20 h-20 rounded-lg object-cover border border-gray-200" />
                  <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">${product.name}</h3>
                    <p class="text-xs text-gray-600 mb-0.5">ID: ${product.id}</p>
                    <p class="text-xs text-gray-600 mb-1">SKU: ${product.sku}</p>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${product.statusColor}">
                      ${product.status}
                    </span>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Categoría</p>
                    <p class="text-sm text-gray-900">${product.category}</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Precio</p>
                    <p class="text-sm text-gray-900 font-bold">Bs. ${product.price.toFixed(2)}</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Actual</p>
                    <p class="text-sm text-gray-900">${product.stock} unidades</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Mínimo</p>
                    <p class="text-sm text-gray-900">${product.minStock} unidades</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Ventas</p>
                    <p class="text-sm text-gray-900">${product.sales} ventas</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Ingresos</p>
                    <p class="text-sm text-gray-900 font-bold">Bs. ${product.revenue.toFixed(2)}</p>
                  </div>
                </div>
              `;
          }
          openModal(viewModal);
        });
      });



      // Abrir modal de nuevo producto
      const newProductBtn = document.getElementById("new-product-btn");
      if (newProductBtn) {
        newProductBtn.addEventListener("click", () => {
          openModal(newModal);
        });
      }

      // Cerrar modales
      const closeButtons = [
        { id: "close-view-modal-btn", modal: viewModal },
        { id: "close-edit-modal-btn", modal: editModal },
        { id: "close-stock-modal-btn", modal: stockModal },
        { id: "close-new-modal-btn", modal: newModal },
        { id: "cancel-edit-btn", modal: editModal },
        { id: "cancel-stock-btn", modal: stockModal },
        { id: "cancel-delete-btn", modal: deleteModal },
        { id: "cancel-new-btn", modal: newModal },
      ];

      closeButtons.forEach(({ id, modal }) => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener("click", () => closeModal(modal));
        }
      });


      const stockForm = document.getElementById("adjust-stock-form");
      if (stockForm) {
        stockForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const productId = (
            document.getElementById("adjust-product-id") as HTMLInputElement
          )?.value;
          const adjustment = (
            document.getElementById("stock-adjustment") as HTMLInputElement
          )?.value;
          console.log("Ajustar stock:", productId, adjustment);
          alert("Stock ajustado exitosamente");
          closeModal(stockModal);
        });
      }

      const newForm = document.getElementById("new-product-form");
      if (newForm) {
        newForm.addEventListener("submit", (e) => {
          e.preventDefault();
          console.log("Nuevo producto creado");
          alert("Producto creado exitosamente");
          closeModal(newModal);
          (newForm as HTMLFormElement).reset();
        });
      }

      // Cerrar modales al hacer clic fuera
      [viewModal, editModal, stockModal, deleteModal, newModal].forEach(
        (modal) => {
          if (modal) {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                closeModal(modal);
              }
            });
          }
        },
      );

      // Cerrar modales con ESC
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          [viewModal, editModal, stockModal, deleteModal, newModal].forEach(
            (modal) => {
              if (modal && !modal.classList.contains("hidden")) {
                closeModal(modal);
              }
            },
          );
        }
      });
  })();
</script>
</Layout>

<!-- Data para JavaScript -->
<script
  type="application/json"
  id="products-data-json"
  set:html={JSON.stringify(products)}
/>
<script
  type="application/json"
  id="categories-data-json"
  set:html={JSON.stringify(categories)}
/>
<script
  type="application/json"
  id="brands-data-json"
  set:html={JSON.stringify(brands)}
/>

<script>
  (function () {
    // Helper para leer datos JSON
    const getJsonData = (id: string) => {
      const element = document.getElementById(id);
      if (element && element.textContent) {
        try {
          return JSON.parse(element.textContent);
        } catch (e) {
          console.error(`Error parsing ${id}:`, e);
          return [];
        }
      }
      return [];
    };

    let productsData: any[] = getJsonData("products-data-json");
    let allBrandsCache: any[] = []; // Cache para marcas cargadas dinámicamente

    // Función para renderizar productos en la tabla
    function renderProductsTable(products: any[]) {
      const tbody = document.getElementById("products-table-body");
      if (!tbody) return;

      if (products.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="py-8 px-6 text-center text-gray-500">
              <p>No hay productos disponibles</p>
            </td>
          </tr>
        `;
        return;
      }

      function formatCurrency(value: number): string {
        return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      tbody.innerHTML = products.map((product: any) => {
        const stockStatus = product.stock === 0 ? "out" : (product.stock <= (product.minStock || 5) ? "low" : "normal");
        const stockColor = stockStatus === "out" ? "bg-red-100 text-red-800" : (stockStatus === "low" ? "bg-yellow-100 text-yellow-800" : "bg-blue-100 text-blue-800");
        const isActive = product.status === "active" || product.status === "Activo";
        const statusColor = isActive ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-800";
        const statusText = isActive ? "Activo" : "Inactivo";
        
        // Obtener la URL de la imagen
        const imageUrl = product.image || '';
        const productName = product.name || product.nombre || 'Sin nombre';

        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
            <td class="py-4 px-6">
              <div class="flex items-center gap-3">
                <img
                  src="${imageUrl}"
                  alt="${productName}"
                  class="w-12 h-12 rounded-lg object-cover border border-gray-200"
                  onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect fill=%22%23ddd%22 width=%2248%22 height=%2248%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2212%22%3ESin imagen%3C/text%3E%3C/svg%3E'"
                />
                <div>
                  <p class="font-semibold text-gray-900">${productName}</p>
                  <p class="text-xs text-gray-500">ID: ${product.id}</p>
                </div>
              </div>
            </td>
            <td class="py-4 px-6">
              <span class="text-sm text-gray-700">${product.categoria || product.category || 'Sin categoría'}</span>
            </td>
            <td class="py-4 px-6">
              <span class="text-sm font-mono text-gray-600">${product.sku || 'N/A'}</span>
            </td>
            <td class="py-4 px-6">
              <p class="font-semibold text-gray-900">Bs. ${formatCurrency(product.precio || product.price || 0)}</p>
            </td>
            <td class="py-4 px-6">
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                  <span class="px-2 py-1 rounded text-xs font-medium ${stockColor}">
                    ${product.stock || 0} unidades
                  </span>
                  ${stockStatus === "low" ? `<span class="text-xs text-yellow-600">⚠ Mín: ${product.minStock || 5}</span>` : ''}
                  ${stockStatus === "out" ? `<span class="text-xs text-red-600">⚠ Agotado</span>` : ''}
                </div>
                ${stockStatus === "normal" ? `<span class="text-xs text-gray-500">Mín: ${product.minStock || 5}</span>` : ''}
              </div>
            </td>
            <td class="py-4 px-6">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusColor}">
                ${statusText}
              </span>
            </td>
            <td class="py-4 px-6">
              <div>
                <p class="text-sm font-semibold text-gray-900">${product.sales || 0} ventas</p>
                <p class="text-xs text-gray-500">Bs. ${formatCurrency(product.revenue || 0)}</p>
              </div>
            </td>
            <td class="py-4 px-6 text-right">
              <div class="flex items-center justify-end gap-2">
                <button type="button" data-product-id="${product.id}" data-action="view" class="view-product-btn p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Ver detalles">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
                <button type="button" data-product-id="${product.id}" data-action="edit" class="edit-product-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Editar">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button type="button" data-product-id="${product.id}" data-action="stock" class="adjust-stock-btn p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors" title="Ajustar stock">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
                <button type="button" data-product-id="${product.id}" data-action="delete" class="delete-product-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Actualizar productsData para que los event listeners funcionen
      productsData = products;
      
      // Re-attach event listeners
      attachProductEventListeners();
    }

    function attachProductEventListeners() {
      // Los listeners se manejan mediante event delegation, no es necesario re-agregarlos
    }

    // Función para calcular y actualizar estadísticas
    function updateStats(products: any[]) {
      function formatNumber(value: number): string {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      function formatCurrency(value: number): string {
        return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      // Calcular estadísticas
      const totalProducts = products.length;
      const activeProducts = products.filter((p: any) => {
        const status = p.status;
        return status === "active" || status === "Activo";
      }).length;
      
      const lowStock = products.filter((p: any) => {
        const stock = p.stock || 0;
        const minStock = p.minStock || 5;
        return stock > 0 && stock <= minStock;
      }).length;
      
      const outOfStock = products.filter((p: any) => (p.stock || 0) === 0).length;
      
      const totalValue = products.reduce((sum: number, p: any) => {
        const price = p.price || p.precio || 0;
        const stock = p.stock || 0;
        return sum + (price * stock);
      }, 0);
      
      const totalStock = products.reduce((sum: number, p: any) => sum + (p.stock || 0), 0);

      // Actualizar elementos del DOM
      const totalProductsEl = document.getElementById('stat-total-products');
      const activeProductsEl = document.getElementById('stat-active-products');
      const lowStockEl = document.getElementById('stat-low-stock');
      const outOfStockEl = document.getElementById('stat-out-of-stock');
      const totalValueEl = document.getElementById('stat-total-value');
      const totalStockEl = document.getElementById('stat-total-stock');

      if (totalProductsEl) totalProductsEl.textContent = formatNumber(totalProducts);
      if (activeProductsEl) activeProductsEl.textContent = formatNumber(activeProducts);
      if (lowStockEl) lowStockEl.textContent = formatNumber(lowStock);
      if (outOfStockEl) outOfStockEl.textContent = formatNumber(outOfStock);
      if (totalValueEl) totalValueEl.textContent = `Bs. ${formatCurrency(totalValue)}`;
      if (totalStockEl) totalStockEl.textContent = formatNumber(totalStock);
    }

    // Modales
    const viewModal = document.getElementById("view-product-modal");
    const editModal = document.getElementById("edit-product-modal");
    const stockModal = document.getElementById("adjust-stock-modal");
    const deleteModal = document.getElementById("delete-product-modal");
    const newModal = document.getElementById("new-product-modal");

    // Funciones de carga dinámica reutilizables
    async function loadCategories(selectId: string, selectedId: string = "") {
      const categorySelect = document.getElementById(
        selectId,
      ) as HTMLSelectElement | null;
      if (!categorySelect) return;

      try {
        // @ts-ignore
        const { getCategories } = await import("../../lib/db/categories");
        const result = await getCategories();

        if (result.error) {
          console.error("Error cargando categorías:", result.error);
          return;
        }

        // Limpiar y poblar
        categorySelect.innerHTML =
          '<option value="">Seleccionar categoría</option>';

        result.data.forEach((category: any) => {
          const option = document.createElement("option");
          option.value = category.id;
          option.textContent = category.name;
          categorySelect.appendChild(option);
        });

        if (selectedId) categorySelect.value = selectedId;
      } catch (error) {
        console.error("Error cargando categorías dinámicas:", error);
      }
    }

    async function loadBrands(
      categoryId: string,
      brandSelectId: string,
      selectedBrandId: string = "",
    ) {
      const brandSelect = document.getElementById(
        brandSelectId,
      ) as HTMLSelectElement | null;
      if (!brandSelect) return;

      try {
        // Cargar marcas si no están en cache
        if (allBrandsCache.length === 0) {
          // @ts-ignore
          const { getBrands } = await import("../../lib/db/brands");
          const result = await getBrands();

          if (result.error) {
            console.error("Error cargando marcas:", result.error);
            return;
          }

          allBrandsCache = result.data.map((b: any) => ({
            ...b,
            categoryId: b.categoryId,
          }));
        }

        // Limpiar y poblar con TODAS las marcas
        brandSelect.innerHTML = '<option value="">Seleccionar marca</option>';
        brandSelect.disabled = false; // Siempre habilitado

        allBrandsCache.forEach((brand) => {
          const option = document.createElement("option");
          option.value = brand.id;
          option.textContent = brand.name;
          brandSelect.appendChild(option);
        });

        if (selectedBrandId) {
          brandSelect.value = selectedBrandId;
        }
      } catch (error) {
        console.error("Error cargando marcas dinámicas:", error);
      }
    }

    // Función helper simplificada (ya no necesita filtrar)
    function setupCategoryChangeListener(
      catSelectId: string,
      brandSelectId: string,
    ) {
      // Ya no es necesario recargar marcas al cambiar categoría porque mostramos todas
      return;
    }

    // Funciones para abrir/cerrar modales
    function openModal(modal: HTMLElement | null) {
      if (!modal) return;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      modal.style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function closeModal(modal: HTMLElement | null) {
      if (!modal) return;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      modal.style.display = "none";
      document.body.style.overflow = "";
    }

    // LISTENER PARA NUEVO PRODUCTO
    const newProductBtn = document.getElementById("new-product-btn");
    if (newProductBtn) {
      newProductBtn.addEventListener("click", async () => {
        // Cargar datos frescos al abrir el modal
        await loadCategories("new-product-form-category");
        // Inicializar marcas (mostrando todas)
        await loadBrands("", "new-product-form-brand"); // Cargar marcas inmediatamente

        // Resetear form
        const metaForm = document.getElementById(
          "new-product-form",
        ) as HTMLFormElement;
        if (metaForm) metaForm.reset();

        // Limpiar preview de imagen
        const previewContainer = document.getElementById("new-product-form-image-preview-container");
        const preview = document.getElementById("new-product-form-image-preview") as HTMLImageElement;
        const imageInput = document.getElementById("new-product-form-image-file") as HTMLInputElement;
        if (previewContainer) previewContainer.classList.add("hidden");
        if (preview) preview.src = "";
        if (imageInput) imageInput.value = "";

        openModal(newModal);
      });
    }

    // Configurar listener para nuevo producto (permanente)
    setupCategoryChangeListener("new-product-form-category", "new-product-form-brand");

      // Event delegation para botones de productos (funciona con elementos renderizados dinámicamente)
      const productsTableBody = document.getElementById("products-table-body");
      
      if (productsTableBody) {
        // Abrir modal de ver detalles
        productsTableBody.addEventListener("click", (e) => {
          const target = e.target as HTMLElement;
          const btn = target.closest(".view-product-btn");
          if (!btn) return;
          
          const productId = btn.getAttribute("data-product-id");
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !viewModal) return;

          const content = document.getElementById("view-product-content");
          if (content) {
            content.innerHTML = `
              <div class="flex gap-4 pb-4 border-b border-gray-200">
                <img src="${product.image}" alt="${product.name}" class="w-20 h-20 rounded-lg object-cover border border-gray-200" />
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900 mb-1">${product.name}</h3>
                  <p class="text-xs text-gray-600 mb-0.5">ID: ${product.id}</p>
                  <p class="text-xs text-gray-600 mb-1">SKU: ${product.sku}</p>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${product.statusColor || 'bg-gray-100 text-gray-800'}">
                    ${product.status}
                  </span>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Categoría</p>
                  <p class="text-sm text-gray-900">${product.category}</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Precio</p>
                  <p class="text-sm text-gray-900 font-bold">Bs. ${(product.price || product.precio || 0).toFixed(2)}</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Actual</p>
                  <p class="text-sm text-gray-900">${product.stock || 0} unidades</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Mínimo</p>
                  <p class="text-sm text-gray-900">${product.minStock || 5} unidades</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Ventas</p>
                  <p class="text-sm text-gray-900">${product.sales || 0} ventas</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Ingresos</p>
                  <p class="text-sm text-gray-900 font-bold">Bs. ${(product.revenue || 0).toFixed(2)}</p>
                </div>
              </div>
            `;
          }
          openModal(viewModal);
        });

        // Abrir modal de editar
        productsTableBody.addEventListener("click", async (e) => {
          const target = e.target as HTMLElement;
          const btn = target.closest(".edit-product-btn");
          if (!btn) return;
          
          const productId = btn.getAttribute("data-product-id");
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !editModal) return;

          // Cargar categorías y marcas
          await loadCategories("edit-product-form-category", product.categoryId || product.categoriaId);
          await loadBrands(product.categoryId || product.categoriaId, "edit-product-form-brand", product.brandId || product.marcaId);

          // Llenar los campos del formulario
          const nameInput = document.getElementById("edit-product-form-name") as HTMLInputElement;
          const skuInput = document.getElementById("edit-product-form-sku") as HTMLInputElement;
          const priceInput = document.getElementById("edit-product-form-price") as HTMLInputElement;
          const stockInput = document.getElementById("edit-product-form-stock") as HTMLInputElement;
          const minStockInput = document.getElementById("edit-product-form-min-stock") as HTMLInputElement;
          const statusRadioActive = document.querySelector('input[name="edit-product-form-status"][value="Activo"]') as HTMLInputElement;
          const statusRadioInactive = document.querySelector('input[name="edit-product-form-status"][value="Inactivo"]') as HTMLInputElement;
          const productIdInput = document.getElementById("edit-product-form-product-id") as HTMLInputElement;
          const currentImageUrlInput = document.getElementById("edit-product-form-current-image-url") as HTMLInputElement;
          const previewContainer = document.getElementById("edit-product-form-image-preview-container");
          const preview = document.getElementById("edit-product-form-image-preview") as HTMLImageElement;
          const imageInput = document.getElementById("edit-product-form-image-file") as HTMLInputElement;

          if (nameInput) nameInput.value = product.name || "";
          if (skuInput) skuInput.value = product.sku || "";
          if (priceInput) priceInput.value = (product.price || product.precio || 0).toString();
          if (stockInput) stockInput.value = (product.stock || 0).toString();
          if (minStockInput) minStockInput.value = (product.minStock || 5).toString();
          if (productIdInput) productIdInput.value = product.id;
          if (currentImageUrlInput) currentImageUrlInput.value = product.image || "";

          // Configurar status
          const isActive = product.status === "active" || product.status === "Activo";
          if (statusRadioActive) statusRadioActive.checked = isActive;
          if (statusRadioInactive) statusRadioInactive.checked = !isActive;

          // Configurar preview de imagen
          if (preview && product.image) {
            preview.src = product.image;
            if (previewContainer) previewContainer.classList.remove("hidden");
          } else {
            if (previewContainer) previewContainer.classList.add("hidden");
            if (preview) preview.src = "";
          }
          if (imageInput) imageInput.value = "";

          // Configurar preview de imagen cuando cambie
          if (imageInput && preview && previewContainer) {
            // Remover listeners anteriores si existen
            const newImageInput = imageInput.cloneNode(true);
            imageInput.parentNode?.replaceChild(newImageInput, imageInput);
            
            newImageInput.addEventListener("change", (e) => {
              const target = e.target as HTMLInputElement;
              const file = target.files ? target.files[0] : null;
              if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                  if (event.target && event.target.result && preview) {
                    preview.src = event.target.result as string;
                    previewContainer.classList.remove("hidden");
                  }
                };
                reader.readAsDataURL(file);
              }
            });
          }

          // Configurar botón de eliminar imagen
          const removeImageBtn = document.getElementById("remove-edit-product-form-image");
          if (removeImageBtn) {
            const newRemoveBtn = removeImageBtn.cloneNode(true);
            removeImageBtn.parentNode?.replaceChild(newRemoveBtn, removeImageBtn);
            
            newRemoveBtn.addEventListener("click", () => {
              if (imageInput) imageInput.value = "";
              if (preview) preview.src = "";
              if (previewContainer) previewContainer.classList.add("hidden");
              if (currentImageUrlInput) currentImageUrlInput.value = "";
            });
          }

          openModal(editModal);
        });

        // Abrir modal de ajustar stock
        productsTableBody.addEventListener("click", (e) => {
          const target = e.target as HTMLElement;
          const btn = target.closest(".adjust-stock-btn");
          if (!btn) return;
          
          const productId = btn.getAttribute("data-product-id");
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !stockModal) return;

          const content = document.getElementById("adjust-stock-content");
          if (content) {
            content.innerHTML = `
              <div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                <p class="text-xs text-gray-600 mb-0.5">Producto</p>
                <p class="text-sm font-semibold text-gray-900">${product.name || product.nombre || 'Sin nombre'}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Stock Actual</label>
                <p class="text-base font-bold text-gray-900 mb-3">${product.stock || 0} unidades</p>
              </div>
              <div>
                <label for="stock-adjustment" class="block text-sm font-semibold text-gray-700 mb-1.5">
                  Ajuste de Stock <span class="text-gray-500 font-normal text-xs">(positivo para agregar, negativo para quitar)</span>
                </label>
                <input
                  type="number"
                  id="stock-adjustment"
                  required
                  step="1"
                  class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-100"
                  placeholder="Ej: 10 para agregar o -5 para quitar"
                />
              </div>
              <input type="hidden" id="adjust-product-id" value="${product.id}" />
            `;
          }
          openModal(stockModal);
        });

        // Abrir modal de eliminar
        productsTableBody.addEventListener("click", (e) => {
          const target = e.target as HTMLElement;
          const btn = target.closest(".delete-product-btn");
          if (!btn) return;
          
          const productId = btn.getAttribute("data-product-id");
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !deleteModal) return;

          const message = document.getElementById("delete-product-message");
          if (message) {
            message.textContent = `¿Estás seguro de que deseas eliminar "${product.name}"? Esta acción no se puede deshacer.`;
          }

          const confirmBtn = document.getElementById("confirm-delete-btn");
          if (confirmBtn && productId) {
            confirmBtn.setAttribute("data-product-id", productId);
          }

          openModal(deleteModal);
        });
      }

    // Cerrar modales
    const closeButtons = [
      { id: "close-view-modal-btn", modal: viewModal },
      { id: "close-edit-modal-btn", modal: editModal },
      { id: "close-stock-modal-btn", modal: stockModal },
      { id: "close-new-modal-btn", modal: newModal },
      { id: "cancel-edit-btn", modal: editModal },
      { id: "cancel-stock-btn", modal: stockModal },
      { id: "cancel-delete-btn", modal: deleteModal },
      { id: "cancel-new-btn", modal: newModal },
    ];

    closeButtons.forEach(({ id, modal }) => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.addEventListener("click", () => closeModal(modal));
      }
    });

    // Funciones de notificación tipo toast
    function showSuccessToast(message: string) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-xl shadow-lg z-[60] flex items-center gap-3 animate-slide-in';
      toast.innerHTML = `
        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="font-semibold">${message}</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showErrorToast(message: string) {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-xl shadow-lg z-[60] flex items-center gap-3 animate-slide-in';
      toast.innerHTML = `
        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        <span class="font-semibold">${message}</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Agregar estilos de animación para los toasts
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slide-in {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .animate-slide-in {
        animation: slide-in 0.3s ease-out;
      }
    `;
    document.head.appendChild(style);

    // Confirmar eliminación
    const confirmDeleteBtn = document.getElementById("confirm-delete-btn") as HTMLButtonElement | null;
    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener("click", async () => {
        const productId = confirmDeleteBtn.getAttribute("data-product-id");
        if (!productId) return;

        // Deshabilitar botón mientras se procesa
        const originalText = confirmDeleteBtn.textContent;
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.textContent = 'Eliminando...';

        try {
          // @ts-ignore
          const { deleteProduct } = await import("../../lib/db/products");
          const result = await deleteProduct(productId);

          if (result.success) {
            showSuccessToast('Producto eliminado exitosamente');
            closeModal(deleteModal);
            
            // Recargar la página para actualizar la lista
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            throw new Error(result.error?.message || 'Error al eliminar el producto');
          }
        } catch (error: any) {
          showErrorToast(error.message || 'Error al eliminar el producto');
          confirmDeleteBtn.disabled = false;
          confirmDeleteBtn.textContent = originalText || 'Eliminar';
        }
      });
    }

    // Submit formularios
    // Submit formularios
    const editForm = document.getElementById(
      "edit-product-form",
    ) as HTMLFormElement;
    if (editForm) {
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitBtn = editForm.querySelector(
          'button[type="submit"]',
        ) as HTMLButtonElement;
        const originalText = submitBtn
          ? submitBtn.textContent
          : "Guardar Cambios";
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Guardando...";
        }

        try {
          const productId = (
            document.getElementById("edit-product-form-product-id") as HTMLInputElement
          )?.value;
          const currentImageUrl = (
            document.getElementById("edit-product-form-current-image-url") as HTMLInputElement
          )?.value;
          const editImageInput = document.getElementById(
            "edit-product-form-image-file",
          ) as HTMLInputElement;

          // Obtener valores del formulario
          const name = (
            document.getElementById("edit-product-form-name") as HTMLInputElement
          )?.value.trim();
          const categoryId = (
            document.getElementById("edit-product-form-category") as HTMLSelectElement
          )?.value;
          const brandId = (
            document.getElementById("edit-product-form-brand") as HTMLSelectElement
          )?.value;
          const sku = (
            document.getElementById("edit-product-form-sku") as HTMLInputElement
          )?.value.trim();
          const price = parseFloat(
            (document.getElementById("edit-product-form-price") as HTMLInputElement)
              ?.value || "0",
          );
          const stock = parseInt(
            (document.getElementById("edit-product-form-stock") as HTMLInputElement)
              ?.value || "0",
          );
          const minStock = parseInt(
            (document.getElementById("edit-product-form-min-stock") as HTMLInputElement)
              ?.value || "0",
          );
          const statusRadio = document.querySelector(
            'input[name="edit-product-form-status"]:checked',
          ) as HTMLInputElement;
          const status: "active" | "inactive" = statusRadio?.value === "Activo" ? "active" : "inactive";

          // Validaciones
          if (!name) {
            throw new Error("El nombre del producto es requerido");
          }
          if (!categoryId) {
            throw new Error("Debe seleccionar una categoría");
          }
          if (!brandId) {
            throw new Error("Debe seleccionar una marca");
          }
          if (!sku) {
            throw new Error("El código (SKU) es requerido");
          }
          if (price <= 0) {
            throw new Error("El precio debe ser mayor a 0");
          }
          if (stock < 0) {
            throw new Error("El stock no puede ser negativo");
          }
          if (minStock < 0) {
            throw new Error("El stock mínimo no puede ser negativo");
          }

          let finalImageUrl = currentImageUrl;
          const newImageFile = editImageInput?.files
            ? editImageInput.files[0]
            : null;

          // Si hay nueva imagen, subirla y reemplazar
          if (newImageFile) {
            // Validar tamaño de archivo (5MB máximo)
            if (newImageFile.size > 5 * 1024 * 1024) {
              throw new Error("La imagen no puede ser mayor a 5MB");
            }

            // @ts-ignore
            const {
              uploadProductImage,
              deleteProductImage,
              isFirebaseStorageUrl,
            } = await import("../../lib/utils/storage");
            const uploadResult = await uploadProductImage(
              newImageFile,
              productId,
            );

            if (uploadResult.error || !uploadResult.url) {
              throw new Error(
                uploadResult.error?.message || "Error al subir nueva imagen",
              );
            }
            finalImageUrl = uploadResult.url;

            // Eliminar imagen anterior si era de Firebase y es diferente
            if (
              currentImageUrl &&
              isFirebaseStorageUrl(currentImageUrl) &&
              currentImageUrl !== finalImageUrl
            ) {
              try {
                await deleteProductImage(currentImageUrl);
              } catch (err) {
                console.error("Error eliminando imagen anterior:", err);
              }
            }
          }

          // Actualizar producto en Firebase
          // @ts-ignore
          const { updateProduct } = await import("../../lib/db/products");
          const updateData: any = {
            name,
            category: categoryId as any,
            brand: brandId,
            price,
            stock,
            minStock,
            status,
            image: finalImageUrl,
          };
          // Agregar sku si existe en el tipo (puede no estar en UpdateProductData)
          if (sku) updateData.sku = sku;
          const updateResult = await updateProduct(productId, updateData);

          if (!updateResult.success || updateResult.error) {
            throw new Error(
              updateResult.error?.message || "Error al actualizar el producto",
            );
          }

          showSuccessToast('Producto actualizado exitosamente');
          closeModal(editModal);
          
          // Recargar la página para ver los cambios
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } catch (error) {
          console.error("Error actualizando producto:", error);
          const errorMessage =
            error instanceof Error
              ? error.message
              : "Error desconocido al actualizar el producto";
          showErrorToast(errorMessage);
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      });
    }

    const stockForm = document.getElementById(
      "adjust-stock-form",
    ) as HTMLFormElement;
    if (stockForm) {
      stockForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitBtn = stockForm.querySelector(
          'button[type="submit"]',
        ) as HTMLButtonElement;
        const originalText = submitBtn
          ? submitBtn.textContent
          : "Confirmar Ajuste";
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Procesando...";
        }

        try {
          const productId = (
            document.getElementById("adjust-product-id") as HTMLInputElement
          )?.value;
          const adjustmentInput = document.getElementById(
            "stock-adjustment",
          ) as HTMLInputElement;
          const adjustment = parseInt(adjustmentInput?.value || "0", 10);

          // Validaciones
          if (!productId) {
            throw new Error("ID de producto no encontrado");
          }
          if (!adjustmentInput || !adjustmentInput.value) {
            throw new Error("Debe ingresar un valor de ajuste");
          }
          if (isNaN(adjustment)) {
            throw new Error("El ajuste debe ser un número válido");
          }
          if (adjustment === 0) {
            throw new Error("El ajuste no puede ser cero");
          }

          // Ajustar stock usando Firebase
          // @ts-ignore
          const { adjustStock } = await import("../../lib/db/products");
          const result = await adjustStock(productId, adjustment);

          if (!result.success || result.error) {
            throw new Error(
              result.error?.message || "Error al ajustar el stock",
            );
          }

          showSuccessToast('Stock ajustado exitosamente');
          closeModal(stockModal);

          // Recargar la página para ver los cambios
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } catch (error) {
          console.error("Error ajustando stock:", error);
          const errorMessage =
            error instanceof Error
              ? error.message
              : "Error desconocido al ajustar el stock";
          showErrorToast(errorMessage);
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      });
    }

    // Lógica para imagen de nuevo producto
    const newProductImageInput = document.getElementById(
      "new-product-form-image-file",
    ) as HTMLInputElement;
    const newProductImagePreviewContainer = document.getElementById(
      "new-product-form-image-preview-container",
    );
    const newProductImagePreview = document.getElementById(
      "new-product-form-image-preview",
    ) as HTMLImageElement;
    const removeNewProductImageBtn = document.getElementById(
      "remove-new-product-form-image",
    );

    if (
      newProductImageInput &&
      newProductImagePreview &&
      newProductImagePreviewContainer
    ) {
      newProductImageInput.addEventListener("change", (e) => {
        const target = e.target as HTMLInputElement;
        const file = target.files ? target.files[0] : null;

        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            if (event.target && event.target.result) {
              newProductImagePreview.src = event.target.result as string;
              newProductImagePreviewContainer.classList.remove("hidden");
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    if (removeNewProductImageBtn) {
      removeNewProductImageBtn.addEventListener("click", () => {
        if (newProductImageInput) newProductImageInput.value = "";
        if (newProductImagePreview) newProductImagePreview.src = "";
        if (newProductImagePreviewContainer)
          newProductImagePreviewContainer.classList.add("hidden");
      });
    }

    const newForm = document.getElementById(
      "new-product-form",
    ) as HTMLFormElement;

    if (newForm) {
      newForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitBtn = newForm.querySelector(
          'button[type="submit"]',
        ) as HTMLButtonElement;
        const originalText = submitBtn
          ? submitBtn.textContent
          : "Crear Producto";

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Guardando...";
        }

        try {
          // Obtener valores del formulario
          const name = (
            document.getElementById("new-product-form-name") as HTMLInputElement
          )?.value.trim();
          const categoryId = (
            document.getElementById("new-product-form-category") as HTMLSelectElement
          )?.value;
          const brandId = (
            document.getElementById("new-product-form-brand") as HTMLSelectElement
          )?.value;
          const sku = (
            document.getElementById("new-product-form-sku") as HTMLInputElement
          )?.value.trim();
          const price = parseFloat(
            (document.getElementById("new-product-form-price") as HTMLInputElement)
              ?.value || "0",
          );
          const stock = parseInt(
            (document.getElementById("new-product-form-stock") as HTMLInputElement)
              ?.value || "0",
          );
          const minStock = parseInt(
            (
              document.getElementById(
                "new-product-form-min-stock",
              ) as HTMLInputElement
            )?.value || "0",
          );
          const statusRadio = document.querySelector(
            'input[name="new-product-form-status"]:checked',
          ) as HTMLInputElement;
          const status: "active" | "inactive" = statusRadio?.value === "Activo" ? "active" : "inactive";

          // Validaciones
          if (!name) {
            throw new Error("El nombre del producto es requerido");
          }
          if (!categoryId) {
            throw new Error("Debe seleccionar una categoría");
          }
          if (!brandId) {
            throw new Error("Debe seleccionar una marca");
          }
          if (!sku) {
            throw new Error("El código (SKU) es requerido");
          }
          if (price <= 0) {
            throw new Error("El precio debe ser mayor a 0");
          }
          if (stock < 0) {
            throw new Error("El stock no puede ser negativo");
          }
          if (minStock < 0) {
            throw new Error("El stock mínimo no puede ser negativo");
          }

          // Manejar subida de imagen
          let imageUrl = "";
          const imageFile = newProductImageInput?.files
            ? newProductImageInput.files[0]
            : null;

          if (imageFile) {
            // Validar tamaño de archivo (5MB máximo)
            if (imageFile.size > 5 * 1024 * 1024) {
              throw new Error("La imagen no puede ser mayor a 5MB");
            }

            // @ts-ignore
            const { uploadProductImage } =
              await import("../../lib/utils/storage");
            const uploadResult = await uploadProductImage(imageFile);

            if (uploadResult.error || !uploadResult.url) {
              throw new Error(
                uploadResult.error?.message || "Error al subir imagen",
              );
            }
            imageUrl = uploadResult.url;
          } else {
            throw new Error("Debe subir una imagen para el producto");
          }

          // Crear el producto usando los IDs directamente
          // @ts-ignore
          const { createProduct } = await import("../../lib/db/products");

          // Usar IDs directamente ya que en la práctica se guardan así en Firestore
          const productData = {
            name,
            brand: brandId, // ID de la marca
            category: categoryId, // ID de la categoría
            type: "food", // Valor por defecto
            price,
            image: imageUrl,
            lifeStage: "todos", // Valor por defecto
            breedSize: "todos", // Valor por defecto
            stock,
            minStock,
            status,
            sku, // Campo adicional SKU
            tags: [], // Tags vacíos por defecto
          };

          const result = await createProduct(productData);

          if (!result.success || result.error) {
            throw new Error(
              result.error?.message || "Error al crear el producto",
            );
          }

          alert("✓ Producto creado exitosamente");

          // Cerrar modal y resetear formulario
          closeModal(newModal);
          newForm.reset();

          // Limpiar preview
          const newProductImagePreviewContainerClean = document.getElementById("new-product-form-image-preview-container");
          const newProductImagePreviewClean = document.getElementById("new-product-form-image-preview") as HTMLImageElement;
          const newProductImageInputClean = document.getElementById("new-product-form-image-file") as HTMLInputElement;
          if (newProductImagePreviewContainerClean)
            newProductImagePreviewContainerClean.classList.add("hidden");
          if (newProductImagePreviewClean) newProductImagePreviewClean.src = "";
          if (newProductImageInputClean) newProductImageInputClean.value = "";

          // Recargar la página para ver el nuevo producto
          window.location.reload();
        } catch (error) {
          console.error("Error al crear producto:", error);
          const errorMessage =
            error instanceof Error
              ? error.message
              : "Error desconocido al crear el producto";
          alert("✗ " + errorMessage);
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }
      });
    }

    // Cerrar modales al hacer clic fuera
    [viewModal, editModal, stockModal, deleteModal, newModal].forEach(
      (modal) => {
        if (modal) {
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              closeModal(modal);
            }
          });
        }
      },
    );

    // Cerrar modales con ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        [viewModal, editModal, stockModal, deleteModal, newModal].forEach(
          (modal) => {
            if (modal && !modal.classList.contains("hidden")) {
              closeModal(modal);
            }
          },
        );
      }
    });

    // DEBUG: Obtener productos, categorías y marcas, mapear IDs a nombres y mostrar en consola
    (async function() {
      try {
        // @ts-ignore
        const { getProducts } = await import("../../lib/db/products");
        // @ts-ignore
        const { getCategories } = await import("../../lib/db/categories");
        // @ts-ignore
        const { getBrands } = await import("../../lib/db/brands");
        
        // Obtener todos los datos
        const [productsResult, categoriesResult, brandsResult] = await Promise.all([
          getProducts(),
          getCategories(),
          getBrands()
        ]);
        
        // Crear mapas de IDs a nombres
        const categoryMap = new Map((categoriesResult.data || []).map((c: any) => [c.id, c.name]));
        const brandMap = new Map((brandsResult.data || []).map((b: any) => [b.id, b.name]));
        
        if (productsResult.data && productsResult.data.length > 0) {
          // Mapear productos con nombres en lugar de IDs
          const productsWithNames = productsResult.data.map((p: any) => ({
              id: p.id,
              name: p.name,
              nombre: p.name,
              sku: p.sku,
              precio: p.price,
              price: p.price,
              stock: p.stock,
              status: p.status,
              image: p.image || '', // Asegurar que siempre haya un valor
              categoria: categoryMap.get(p.category) || `[ID: ${p.category}]`,
              category: categoryMap.get(p.category) || `[ID: ${p.category}]`,
              marca: brandMap.get(p.brand) || `[ID: ${p.brand}]`,
              brand: brandMap.get(p.brand) || `[ID: ${p.brand}]`,
              categoriaId: p.category,
              marcaId: p.brand,
              minStock: p.minStock || 5,
              sales: p.sales || 0,
              revenue: p.revenue || 0
            }));
          
          // Verificar productos del servidor
          const serverProducts = getJsonData("products-data-json");
          if (serverProducts.length === 0) {
            // Si el servidor no tiene productos, renderizar desde el cliente
            renderProductsTable(productsWithNames);
            // Actualizar estadísticas con los productos obtenidos
            updateStats(productsWithNames);
          } else {
            // Si hay productos del servidor, también actualizar estadísticas por si acaso
            updateStats(serverProducts);
          }
        }
      } catch (error) {
        console.error("Error al obtener datos:", error);
      }
    })();
  })();
</script>
