---
import Layout from '../../layouts/Layout.astro';

// Funciones helper
function formatCurrency(value: number): string {
  return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatNumber(value: number): string {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Datos iniciales - se cargarán desde Firestore
const products: any[] = [];

const stats = {
  totalProducts: 0,
  activeProducts: 0,
  outOfStock: 0,
  lowStock: 0,
  totalStock: 0,
  totalValue: 0
};
---

<Layout>
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Header -->
      <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">Productos y Control de Stock</h1>
          <p class="text-gray-600">Gestiona tu inventario y productos</p>
        </div>
        <button
          type="button"
          id="new-product-btn"
          class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 hover:shadow-lg transition-all duration-300 flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <span>Nuevo Producto</span>
        </button>
      </div>

      <!-- Estadísticas -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Productos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Total Productos</p>
              <p class="text-2xl font-bold text-gray-900" id="total-products">{formatNumber(stats.totalProducts)}</p>
            </div>
          </div>
        </div>

        <!-- Productos Activos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Activos</p>
              <p class="text-2xl font-bold text-gray-900">{formatNumber(stats.activeProducts)}</p>
            </div>
          </div>
        </div>

        <!-- Bajo Stock -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Bajo Stock</p>
              <p class="text-2xl font-bold text-gray-900" id="low-stock">{formatNumber(stats.lowStock)}</p>
            </div>
          </div>
        </div>

        <!-- Agotados -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Agotados</p>
              <p class="text-2xl font-bold text-gray-900" id="out-of-stock">{formatNumber(stats.outOfStock)}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Estadísticas de Stock -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Valor Total del Inventario -->
        <div class="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-xl bg-purple-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600 mb-1">Valor Total del Inventario</p>
              <p class="text-3xl font-bold text-gray-900" id="total-value">Bs. {formatCurrency(stats.totalValue)}</p>
            </div>
          </div>
        </div>

        <!-- Total de Unidades -->
        <div class="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-xl bg-blue-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600 mb-1">Total de Unidades en Stock</p>
              <p class="text-3xl font-bold text-gray-900" id="total-stock">{formatNumber(stats.totalStock)}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Barra de Búsqueda y Filtros -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 mb-8">
        <div class="flex flex-col sm:flex-row gap-4">
          <!-- Búsqueda -->
          <div class="flex-1 relative">
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              id="products-search-input"
              placeholder="Buscar por nombre, SKU o categoría..."
              class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
            />
          </div>

          <!-- Filtro por Categoría -->
          <select id="products-category-filter" class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all">
            <option value="all">Todas las categorías</option>
            <option value="alimentos">Alimentos</option>
            <option value="accesorios">Accesorios</option>
            <option value="juguetes">Juguetes</option>
            <option value="higiene">Higiene</option>
            <option value="camas">Camas</option>
          </select>

          <!-- Filtro por Stock -->
          <select id="products-stock-filter" class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all">
            <option value="all">Todo el stock</option>
            <option value="normal">Stock normal</option>
            <option value="low">Bajo stock</option>
            <option value="out">Agotado</option>
          </select>
          
          <!-- Filtro por Estado -->
          <select id="products-status-filter" class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all">
            <option value="all">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
          </select>
        </div>
      </div>

      <!-- Tabla de Productos -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md overflow-hidden hidden" id="products-table-container">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Producto</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Categoría</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">SKU</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Precio</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Stock</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Estado</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Ventas</th>
                <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <!-- Products will be loaded here dynamically -->
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 p-6 border-t border-gray-200">
          <div class="text-sm text-gray-600">
            Mostrando <span class="font-semibold">1</span> - <span class="font-semibold">{products.length}</span> de <span class="font-semibold">{products.length}</span> productos
          </div>
          <div class="flex items-center gap-2">
            <button class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <button class="px-4 py-2 rounded-lg border-2 border-purple-400 bg-purple-50 text-purple-700 font-semibold">1</button>
            <button class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all">2</button>
            <button class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal: Ver Detalles del Producto -->
  <div id="view-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Detalles del Producto</h2>
        <button type="button" id="close-view-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="view-product-content" class="space-y-4">
        <!-- Se cargará dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Modal: Editar Producto -->
  <div id="edit-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Editar Producto</h2>
        <button type="button" id="close-edit-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="edit-product-form" class="space-y-4">
        <div id="edit-product-content" class="space-y-3">
          <!-- Se cargará dinámicamente -->
        </div>
        <div class="flex gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="cancel-edit-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
            Cancelar
          </button>
          <button type="submit" class="flex-1 px-4 py-2.5 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all text-sm">
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ajustar Stock -->
  <div id="adjust-stock-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Ajustar Stock</h2>
        <button type="button" id="close-stock-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="adjust-stock-form" class="space-y-4">
        <div id="adjust-stock-content" class="space-y-3">
          <!-- Se cargará dinámicamente -->
        </div>
        <div class="flex gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="cancel-stock-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
            Cancelar
          </button>
          <button type="submit" class="flex-1 px-4 py-2.5 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700 transition-all text-sm">
            Ajustar Stock
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Eliminar Producto -->
  <div id="delete-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-5">
      <div class="text-center mb-4">
        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-3">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </div>
        <h2 class="text-lg font-bold text-gray-900 mb-1">¿Eliminar Producto?</h2>
        <p class="text-sm text-gray-600 mb-4" id="delete-product-message">Esta acción no se puede deshacer.</p>
      </div>
      <div class="flex gap-2">
        <button type="button" id="cancel-delete-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
          Cancelar
        </button>
        <button type="button" id="confirm-delete-btn" class="flex-1 px-4 py-2.5 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-all text-sm">
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Nuevo Producto -->
  <div id="new-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Nuevo Producto</h2>
        <button type="button" id="close-new-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="new-product-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Nombre -->
          <div class="md:col-span-2">
            <label for="new-product-name" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Nombre del Producto <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="new-product-name"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="Ej: Royal Canin Puppy 15kg"
            />
          </div>

          <!-- Categoría -->
          <div>
            <label for="new-product-category" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Categoría <span class="text-red-500">*</span>
            </label>
            <select
              id="new-product-category"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
            >
              <option value="">Seleccionar categoría</option>
              <option value="Alimentos">Alimentos</option>
              <option value="Accesorios">Accesorios</option>
              <option value="Juguetes">Juguetes</option>
              <option value="Higiene">Higiene</option>
              <option value="Camas">Camas</option>
            </select>
          </div>

          <!-- SKU -->
          <div>
            <label for="new-product-sku" class="block text-sm font-semibold text-gray-700 mb-1.5">
              SKU <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="new-product-sku"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="Ej: RC-PUPPY-15KG"
            />
          </div>

          <!-- Precio -->
          <div>
            <label for="new-product-price" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Precio (Bs.) <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="new-product-price"
              step="0.01"
              min="0"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="0.00"
            />
          </div>

          <!-- Stock Inicial -->
          <div>
            <label for="new-product-stock" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Stock Inicial <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="new-product-stock"
              min="0"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="0"
            />
          </div>

          <!-- Stock Mínimo -->
          <div>
            <label for="new-product-min-stock" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Stock Mínimo <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="new-product-min-stock"
              min="0"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="0"
            />
          </div>

          <!-- Imagen del Producto -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1.5">
              Imagen del Producto
            </label>
            
            <!-- Opción: Subir archivo o usar URL -->
            <div class="mb-3 flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="new-image-type" value="file" checked class="w-4 h-4 text-purple-600" />
                <span class="text-sm text-gray-700">Subir archivo</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="new-image-type" value="url" class="w-4 h-4 text-purple-600" />
                <span class="text-sm text-gray-700">Usar URL externa</span>
              </label>
            </div>

            <!-- Input de archivo -->
            <div id="new-image-file-container" class="space-y-2">
              <input
                type="file"
                id="new-product-image-file"
                accept="image/jpeg,image/jpg,image/png,image/webp"
                class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
              />
              <p class="text-xs text-gray-500">Formatos permitidos: JPG, PNG, WEBP. Tamaño máximo: 5MB</p>
              
              <!-- Preview de imagen -->
              <div id="new-image-preview-container" class="hidden mt-3">
                <div class="relative inline-block">
                  <img id="new-image-preview" src="" alt="Preview" class="max-w-full h-48 rounded-lg border-2 border-gray-200 object-cover" />
                  <button
                    type="button"
                    id="new-image-remove-btn"
                    class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition-colors"
                    aria-label="Eliminar imagen"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
              
              <!-- Barra de progreso -->
              <div id="new-image-upload-progress" class="hidden mt-2">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div id="new-image-progress-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">Subiendo imagen...</p>
              </div>
            </div>

            <!-- Input de URL -->
            <div id="new-image-url-container" class="hidden">
              <input
                type="url"
                id="new-product-image-url"
                class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
                placeholder="https://ejemplo.com/imagen.jpg"
              />
            </div>
          </div>

          <!-- Estado -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Estado</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2">
                <input type="radio" name="new-product-status" value="Activo" checked class="w-4 h-4 text-purple-600" />
                <span class="text-sm text-gray-700">Activo</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="new-product-status" value="Inactivo" class="w-4 h-4 text-purple-600" />
                <span class="text-sm text-gray-700">Inactivo</span>
              </label>
            </div>
          </div>
        </div>

        <div class="flex gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="cancel-new-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
            Cancelar
          </button>
          <button type="submit" class="flex-1 px-4 py-2.5 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all text-sm">
            Crear Producto
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading State -->
  <div id="products-loading" class="text-center py-16">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
    <p class="mt-4 text-gray-600">Cargando productos...</p>
  </div>

  <script>
    // Dynamic imports
    let getProducts: any, createProduct: any, updateProduct: any, deleteProduct: any, adjustStock: any, getCurrentUser: any, getCurrentUserData: any;
    let currentUser: any = null;
    let productsData: any[] = [];
    
    (async () => {
      const productsModule = await import('../../lib/db/products');
      getProducts = productsModule.getProducts;
      createProduct = productsModule.createProduct;
      updateProduct = productsModule.updateProduct;
      deleteProduct = productsModule.deleteProduct;
      adjustStock = productsModule.adjustStock;
      
      const authModule = await import('../../lib/auth');
      getCurrentUser = authModule.getCurrentUser;
      getCurrentUserData = authModule.getCurrentUserData;
      
      // Check if user is admin
      const firebaseUser = getCurrentUser();
      if (!firebaseUser) {
        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        return;
      }
      
      const userDataResult = await getCurrentUserData();
      if (!userDataResult.success || !userDataResult.user || userDataResult.user.role !== 'admin') {
        alert('No tienes permisos para acceder a esta página');
        window.location.href = '/';
        return;
      }
      
      currentUser = userDataResult.user;
    })();

    (function() {

      // Modales
      const viewModal = document.getElementById('view-product-modal');
      const editModal = document.getElementById('edit-product-modal');
      const stockModal = document.getElementById('adjust-stock-modal');
      const deleteModal = document.getElementById('delete-product-modal');
      const newModal = document.getElementById('new-product-modal');

      // Funciones para abrir/cerrar modales
      function openModal(modal: HTMLElement | null) {
        if (!modal) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      function closeModal(modal: HTMLElement | null) {
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }

      // Abrir modal de ver detalles
      document.querySelectorAll('.view-product-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const productId = btn.getAttribute('data-product-id');
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !viewModal) return;

          const content = document.getElementById('view-product-content');
          if (content) {
            content.innerHTML = `
              <div class="flex gap-4 pb-4 border-b border-gray-200">
                <img src="${product.image}" alt="${product.name}" class="w-20 h-20 rounded-lg object-cover border border-gray-200" />
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-gray-900 mb-1">${product.name}</h3>
                  <p class="text-xs text-gray-600 mb-0.5">ID: ${product.id}</p>
                  <p class="text-xs text-gray-600 mb-1">SKU: ${product.sku}</p>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${product.statusColor}">
                    ${product.status}
                  </span>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Categoría</p>
                  <p class="text-sm text-gray-900">${product.category}</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Precio</p>
                  <p class="text-sm text-gray-900 font-bold">Bs. ${product.price.toFixed(2)}</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Actual</p>
                  <p class="text-sm text-gray-900">${product.stock} unidades</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Mínimo</p>
                  <p class="text-sm text-gray-900">${product.minStock} unidades</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Ventas</p>
                  <p class="text-sm text-gray-900">${product.sales} ventas</p>
                </div>
                <div>
                  <p class="text-xs font-semibold text-gray-700 mb-0.5">Ingresos</p>
                  <p class="text-sm text-gray-900 font-bold">Bs. ${product.revenue.toFixed(2)}</p>
                </div>
              </div>
            `;
          }
          openModal(viewModal);
        });
      });

      // Abrir modal de editar
      document.querySelectorAll('.edit-product-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const productId = btn.getAttribute('data-product-id');
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !editModal) return;

          const content = document.getElementById('edit-product-content');
          if (content) {
            content.innerHTML = `
              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Nombre del Producto</label>
                <input type="text" id="edit-name" value="${product.name}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Categoría</label>
                <select id="edit-category" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100">
                  <option value="Alimentos" ${product.category === 'Alimentos' ? 'selected' : ''}>Alimentos</option>
                  <option value="Accesorios" ${product.category === 'Accesorios' ? 'selected' : ''}>Accesorios</option>
                  <option value="Juguetes" ${product.category === 'Juguetes' ? 'selected' : ''}>Juguetes</option>
                  <option value="Higiene" ${product.category === 'Higiene' ? 'selected' : ''}>Higiene</option>
                  <option value="Camas" ${product.category === 'Camas' ? 'selected' : ''}>Camas</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">SKU</label>
                <input type="text" id="edit-sku" value="${product.sku}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Precio (Bs.)</label>
                <input type="number" id="edit-price" step="0.01" value="${product.price}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Stock Mínimo</label>
                <input type="number" id="edit-min-stock" value="${product.minStock}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Imagen del Producto</label>
                
                <!-- Imagen actual -->
                <div class="mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                  <p class="text-xs text-gray-600 mb-2">Imagen actual:</p>
                  <img src="${product.image}" alt="${product.name}" id="edit-current-image-preview" class="max-w-full h-32 rounded-lg border-2 border-gray-200 object-cover" onerror="this.src='https://via.placeholder.com/200x200?text=Sin+Imagen'" />
                </div>

                <!-- Opción: Mantener, subir nueva o usar URL -->
                <div class="mb-3 flex flex-wrap gap-4">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="edit-image-type" value="keep" checked class="w-4 h-4 text-purple-600" />
                    <span class="text-sm text-gray-700">Mantener imagen actual</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="edit-image-type" value="file" class="w-4 h-4 text-purple-600" />
                    <span class="text-sm text-gray-700">Subir nueva imagen</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="edit-image-type" value="url" class="w-4 h-4 text-purple-600" />
                    <span class="text-sm text-gray-700">Usar URL externa</span>
                  </label>
                </div>

                <!-- Input de archivo -->
                <div id="edit-image-file-container" class="hidden space-y-2">
                  <input
                    type="file"
                    id="edit-product-image-file"
                    accept="image/jpeg,image/jpg,image/png,image/webp"
                    class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                  />
                  <p class="text-xs text-gray-500">Formatos permitidos: JPG, PNG, WEBP. Tamaño máximo: 5MB</p>
                  
                  <!-- Preview de nueva imagen -->
                  <div id="edit-image-preview-container" class="hidden mt-3">
                    <div class="relative inline-block">
                      <img id="edit-image-preview" src="" alt="Preview" class="max-w-full h-48 rounded-lg border-2 border-gray-200 object-cover" />
                      <button
                        type="button"
                        id="edit-image-remove-btn"
                        class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 transition-colors"
                        aria-label="Eliminar imagen"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  <!-- Barra de progreso -->
                  <div id="edit-image-upload-progress" class="hidden mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                      <div id="edit-image-progress-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Subiendo imagen...</p>
                  </div>
                </div>

                <!-- Input de URL -->
                <div id="edit-image-url-container" class="hidden">
                  <input
                    type="url"
                    id="edit-product-image-url"
                    value="${product.image}"
                    class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
                    placeholder="https://ejemplo.com/imagen.jpg"
                  />
                </div>
              </div>
              <input type="hidden" id="edit-product-id" value="${product.id}" />
              <input type="hidden" id="edit-current-image-url" value="${product.image}" />
            `;
            
            // Setup event listeners para el formulario de editar
            setupEditImageHandlers();
          }
          openModal(editModal);
        });
      });

      // Función para configurar handlers de imagen en formulario de editar
      function setupEditImageHandlers() {
        // Manejar cambio entre mantener, subir archivo y usar URL
        const editImageTypeRadios = document.querySelectorAll('input[name="edit-image-type"]');
        const editImageFileContainer = document.getElementById('edit-image-file-container');
        const editImageUrlContainer = document.getElementById('edit-image-url-container');
        const editImageFileInput = document.getElementById('edit-product-image-file') as HTMLInputElement;
        const editImagePreviewContainer = document.getElementById('edit-image-preview-container');
        const editImagePreview = document.getElementById('edit-image-preview') as HTMLImageElement;
        const editImageRemoveBtn = document.getElementById('edit-image-remove-btn');
        const editImageUploadProgress = document.getElementById('edit-image-upload-progress');
        const editImageProgressBar = document.getElementById('edit-image-progress-bar');

        editImageTypeRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            const value = (e.target as HTMLInputElement).value;
            if (value === 'keep') {
              if (editImageFileContainer) editImageFileContainer.classList.add('hidden');
              if (editImageUrlContainer) editImageUrlContainer.classList.add('hidden');
            } else if (value === 'file') {
              if (editImageFileContainer) editImageFileContainer.classList.remove('hidden');
              if (editImageUrlContainer) editImageUrlContainer.classList.add('hidden');
            } else {
              if (editImageFileContainer) editImageFileContainer.classList.add('hidden');
              if (editImageUrlContainer) editImageUrlContainer.classList.remove('hidden');
            }
          });
        });

        // Preview de imagen cuando se selecciona un archivo
        if (editImageFileInput) {
          editImageFileInput.addEventListener('change', async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) return;

            // Validar archivo
            const { validateImageFile } = await import('../../lib/utils/storage');
            const validation = validateImageFile(file);
            if (!validation.valid) {
              alert(validation.error || 'Archivo inválido');
              editImageFileInput.value = '';
              return;
            }

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
              if (editImagePreview && e.target?.result) {
                editImagePreview.src = e.target.result as string;
                if (editImagePreviewContainer) editImagePreviewContainer.classList.remove('hidden');
              }
            };
            reader.readAsDataURL(file);
          });
        }

        // Eliminar imagen seleccionada
        if (editImageRemoveBtn) {
          editImageRemoveBtn.addEventListener('click', () => {
            if (editImageFileInput) editImageFileInput.value = '';
            if (editImagePreviewContainer) editImagePreviewContainer.classList.add('hidden');
            if (editImagePreview) editImagePreview.src = '';
          });
        }
      }

      // Abrir modal de ajustar stock
      document.querySelectorAll('.adjust-stock-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const productId = btn.getAttribute('data-product-id');
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !stockModal) return;

          const content = document.getElementById('adjust-stock-content');
          if (content) {
            content.innerHTML = `
              <div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                <p class="text-xs text-gray-600 mb-0.5">Producto</p>
                <p class="text-sm font-semibold text-gray-900">${product.name}</p>
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Stock Actual</label>
                <p class="text-base font-bold text-gray-900 mb-3">${product.stock} unidades</p>
              </div>
              <div>
                <label for="stock-adjustment" class="block text-sm font-semibold text-gray-700 mb-1.5">
                  Ajuste de Stock <span class="text-gray-500 font-normal text-xs">(positivo para agregar, negativo para quitar)</span>
                </label>
                <input
                  type="number"
                  id="stock-adjustment"
                  class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-100"
                  placeholder="Ej: +10 o -5"
                />
              </div>
              <div>
                <label for="stock-reason" class="block text-sm font-semibold text-gray-700 mb-1.5">Motivo del Ajuste</label>
                <textarea
                  id="stock-reason"
                  rows="2"
                  class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-100 resize-none"
                  placeholder="Ej: Recepción de mercancía, pérdida de inventario, etc."
                ></textarea>
              </div>
              <input type="hidden" id="adjust-product-id" value="${product.id}" />
            `;
          }
          openModal(stockModal);
        });
      });

      // Abrir modal de eliminar
      document.querySelectorAll('.delete-product-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const productId = btn.getAttribute('data-product-id');
          const product = productsData.find((p: any) => p.id === productId);
          if (!product || !deleteModal) return;

          const message = document.getElementById('delete-product-message');
          if (message) {
            message.textContent = `¿Estás seguro de que deseas eliminar "${product.name}"? Esta acción no se puede deshacer.`;
          }
          
          const confirmBtn = document.getElementById('confirm-delete-btn');
          if (confirmBtn && productId) {
            confirmBtn.setAttribute('data-product-id', productId);
          }
          
          openModal(deleteModal);
        });
      });

      // Abrir modal de nuevo producto
      const newProductBtn = document.getElementById('new-product-btn');
      if (newProductBtn) {
        newProductBtn.addEventListener('click', () => {
          openModal(newModal);
        });
      }

      // Cerrar modales
      const closeButtons = [
        { id: 'close-view-modal-btn', modal: viewModal },
        { id: 'close-edit-modal-btn', modal: editModal },
        { id: 'close-stock-modal-btn', modal: stockModal },
        { id: 'close-new-modal-btn', modal: newModal },
        { id: 'cancel-edit-btn', modal: editModal },
        { id: 'cancel-stock-btn', modal: stockModal },
        { id: 'cancel-delete-btn', modal: deleteModal },
        { id: 'cancel-new-btn', modal: newModal }
      ];

      closeButtons.forEach(({ id, modal }) => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('click', () => closeModal(modal));
        }
      });

      // Load products from Firestore
      async function loadProducts() {
        const loadingEl = document.getElementById('products-loading');
        const tableBody = document.querySelector('tbody');
        
        if (!getProducts) return;
        
        try {
          const result = await getProducts();
          
          if (result.error) {
            console.error('Error loading products:', result.error);
            if (loadingEl) loadingEl.classList.add('hidden');
            return;
          }
          
          productsData = result.data || [];
          
          // Convert to display format
          productsData = productsData.map((product: any) => {
            const stockStatus = product.stock === 0 ? 'out' : 
                              (product.stock < (product.minStock || 10)) ? 'low' : 'normal';
            const status = product.active !== false ? 'Activo' : 'Inactivo';
            const statusColor = status === 'Activo' 
              ? 'bg-green-50 text-green-700 border border-green-200'
              : 'bg-gray-50 text-gray-700 border border-gray-200';
            const stockColor = stockStatus === 'out' 
              ? 'bg-gray-50 text-gray-700'
              : stockStatus === 'low'
              ? 'bg-red-50 text-red-700'
              : 'bg-green-50 text-green-700';
            
            return {
              id: product.id,
              name: product.name || '',
              category: product.category || '',
              sku: product.sku || '',
              price: product.price || 0,
              stock: product.stock || 0,
              minStock: product.minStock || 10,
              status: status,
              statusColor: statusColor,
              stockStatus: stockStatus,
              stockColor: stockColor,
              image: product.image || '',
              sales: 0, // Would need to calculate from orders
              revenue: 0 // Would need to calculate from orders
            };
          });
          
          // Calcular ventas y revenue para cada producto
          const { getProductSalesStats } = await import('../../lib/db/products');
          for (let i = 0; i < productsData.length; i++) {
            const stats = await getProductSalesStats(productsData[i].id);
            productsData[i].sales = stats.sales;
            productsData[i].revenue = stats.revenue;
          }
          
          // Inicializar filteredProductsData con productsData
          filteredProductsData = [...productsData];
          
          renderProductsTable();
          updateStats();
          
          if (loadingEl) loadingEl.classList.add('hidden');
          const tableContainer = document.getElementById('products-table-container');
          if (tableContainer) tableContainer.classList.remove('hidden');
        } catch (error) {
          console.error('Error loading products:', error);
          if (loadingEl) loadingEl.classList.add('hidden');
        }
      }

      // Variables para filtros
      let filteredProductsData: any[] = [];
      let currentSearch = '';
      let currentCategoryFilter = 'all';
      let currentStockFilter = 'all';
      let currentStatusFilter = 'all';
      
      // Función para aplicar filtros
      function applyFilters() {
        const searchInput = document.getElementById('products-search-input') as HTMLInputElement;
        const categoryFilter = document.getElementById('products-category-filter') as HTMLSelectElement;
        const stockFilter = document.getElementById('products-stock-filter') as HTMLSelectElement;
        const statusFilter = document.getElementById('products-status-filter') as HTMLSelectElement;
        
        currentSearch = searchInput?.value.toLowerCase().trim() || '';
        currentCategoryFilter = categoryFilter?.value || 'all';
        currentStockFilter = stockFilter?.value || 'all';
        currentStatusFilter = statusFilter?.value || 'all';
        
        filteredProductsData = productsData.filter((product: any) => {
          // Filtro por búsqueda
          if (currentSearch) {
            const searchLower = currentSearch.toLowerCase();
            const nameMatch = (product.name || '').toLowerCase().includes(searchLower);
            const skuMatch = (product.sku || '').toLowerCase().includes(searchLower);
            const categoryMatch = (product.category || '').toLowerCase().includes(searchLower);
            
            if (!nameMatch && !skuMatch && !categoryMatch) {
              return false;
            }
          }
          
          // Filtro por categoría
          if (currentCategoryFilter !== 'all') {
            const productCategory = (product.category || '').toLowerCase();
            if (productCategory !== currentCategoryFilter.toLowerCase()) {
              return false;
            }
          }
          
          // Filtro por stock
          if (currentStockFilter !== 'all') {
            if (product.stockStatus !== currentStockFilter) {
              return false;
            }
          }
          
          // Filtro por estado
          if (currentStatusFilter !== 'all') {
            const isActive = product.status === 'Activo';
            if (currentStatusFilter === 'active' && !isActive) {
              return false;
            }
            if (currentStatusFilter === 'inactive' && isActive) {
              return false;
            }
          }
          
          return true;
        });
        
        renderProductsTable();
        updateStats();
      }
      
      function renderProductsTable() {
        const tbody = document.querySelector('tbody');
        if (!tbody) return;
        
        const productsToRender = filteredProductsData.length > 0 ? filteredProductsData : productsData;
        
        if (productsToRender.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="py-12 text-center">
                <p class="text-gray-500">No se encontraron productos con los filtros seleccionados</p>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = productsToRender.map((product: any) => `
          <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
            <td class="py-4 px-6">
              <div class="flex items-center gap-3">
                <img
                  src="${product.image || 'https://via.placeholder.com/50'}"
                  alt="${product.name}"
                  class="w-12 h-12 rounded-lg object-cover border border-gray-200"
                />
                <div>
                  <p class="font-semibold text-gray-900">${product.name}</p>
                  <p class="text-xs text-gray-500">ID: ${product.id}</p>
                </div>
              </div>
            </td>
            <td class="py-4 px-6">
              <span class="text-sm text-gray-700">${product.category}</span>
            </td>
            <td class="py-4 px-6">
              <span class="text-sm text-gray-700 font-mono">${product.sku}</span>
            </td>
            <td class="py-4 px-6">
              <span class="text-sm font-semibold text-gray-900">Bs. ${product.price.toFixed(2)}</span>
            </td>
            <td class="py-4 px-6">
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-700">${product.stock}</span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${product.stockColor}">
                  ${product.stockStatus === 'out' ? 'Agotado' : product.stockStatus === 'low' ? 'Bajo' : 'Normal'}
                </span>
              </div>
            </td>
            <td class="py-4 px-6">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${product.statusColor}">
                ${product.status}
              </span>
            </td>
            <td class="py-4 px-6">
              <span class="text-sm text-gray-700">${product.sales}</span>
            </td>
            <td class="py-4 px-6 text-right">
              <div class="flex items-center justify-end gap-2">
                <button
                  type="button"
                  class="view-product-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                  data-product-id="${product.id}"
                  aria-label="Ver detalles"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                </button>
                <button
                  type="button"
                  class="edit-product-btn p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                  data-product-id="${product.id}"
                  aria-label="Editar"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button
                  type="button"
                  class="adjust-stock-btn p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                  data-product-id="${product.id}"
                  aria-label="Ajustar stock"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                </button>
                <button
                  type="button"
                  class="delete-product-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                  data-product-id="${product.id}"
                  aria-label="Eliminar"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
        
        // Re-attach event listeners
        attachEventListeners();
      }

      function updateStats() {
        const totalProducts = productsData.length;
        const lowStock = productsData.filter((p: any) => p.stockStatus === 'low').length;
        const outOfStock = productsData.filter((p: any) => p.stockStatus === 'out').length;
        const totalStock = productsData.reduce((sum: number, p: any) => sum + p.stock, 0);
        const totalValue = productsData.reduce((sum: number, p: any) => sum + (p.price * p.stock), 0);
        
        // Update stats in DOM
        const statsEls: any = {
          'total-products': totalProducts,
          'low-stock': lowStock,
          'out-of-stock': outOfStock,
          'total-stock': totalStock,
          'total-value': totalValue.toFixed(2)
        };
        
        Object.keys(statsEls).forEach(key => {
          const el = document.getElementById(key);
          if (el) {
            if (key === 'total-value') {
              el.textContent = `Bs. ${statsEls[key]}`;
            } else {
              el.textContent = statsEls[key].toString();
            }
          }
        });
      }

      function attachEventListeners() {
        // Re-attach all event listeners for buttons
        // This is called after rendering the table
      }

      // Confirmar eliminación
      const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async () => {
          const productId = confirmDeleteBtn.getAttribute('data-product-id');
          if (productId && deleteProduct) {
            try {
              const result = await deleteProduct(productId);
              if (result.success) {
                alert('Producto eliminado exitosamente');
                closeModal(deleteModal);
                await loadProducts();
              } else {
                alert('Error al eliminar producto: ' + (result.error?.message || 'Error desconocido'));
              }
            } catch (error) {
              console.error('Error deleting product:', error);
              alert('Error al eliminar producto');
            }
          }
        });
      }

      // Submit formularios
      const editForm = document.getElementById('edit-product-form') as HTMLFormElement;
      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const productId = (document.getElementById('edit-product-id') as HTMLInputElement)?.value;
          if (!productId || !updateProduct) return;
          
          try {
            // Determinar tipo de imagen (mantener, archivo o URL)
            const imageType = (document.querySelector('input[name="edit-image-type"]:checked') as HTMLInputElement)?.value;
            let imageUrl = '';
            let oldImageUrl = '';

            if (imageType === 'keep') {
              // Mantener imagen actual
              const currentImageInput = document.getElementById('edit-current-image-url') as HTMLInputElement;
              imageUrl = currentImageInput?.value || '';
            } else if (imageType === 'file') {
              // Subir nueva imagen
              const fileInput = document.getElementById('edit-product-image-file') as HTMLInputElement;
              const file = fileInput?.files?.[0];
              
              if (!file) {
                alert('Por favor, selecciona una imagen');
                return;
              }

              // Guardar URL de imagen anterior para eliminarla después
              const currentImageInput = document.getElementById('edit-current-image-url') as HTMLInputElement;
              oldImageUrl = currentImageInput?.value || '';

              // Mostrar progreso
              const editImageUploadProgress = document.getElementById('edit-image-upload-progress');
              const editImageProgressBar = document.getElementById('edit-image-progress-bar');
              if (editImageUploadProgress) editImageUploadProgress.classList.remove('hidden');
              if (editImageProgressBar) editImageProgressBar.style.width = '50%';

              // Subir imagen
              const { uploadProductImage, deleteProductImage, isFirebaseStorageUrl } = await import('../../lib/utils/storage');
              const uploadResult = await uploadProductImage(file, productId);
              
              if (editImageProgressBar) editImageProgressBar.style.width = '100%';

              if (!uploadResult.success || !uploadResult.url) {
                if (editImageUploadProgress) editImageUploadProgress.classList.add('hidden');
                alert('Error al subir la imagen: ' + (uploadResult.error?.message || 'Error desconocido'));
                return;
              }

              imageUrl = uploadResult.url;

              // Eliminar imagen anterior del Storage si es de Firebase Storage
              if (oldImageUrl && isFirebaseStorageUrl(oldImageUrl)) {
                try {
                  await deleteProductImage(oldImageUrl);
                } catch (error) {
                  console.error('Error deleting old image:', error);
                  // No fallar la actualización si no se puede eliminar la imagen anterior
                }
              }

              if (editImageUploadProgress) editImageUploadProgress.classList.add('hidden');
            } else {
              // Usar URL externa
              const urlInput = document.getElementById('edit-product-image-url') as HTMLInputElement;
              imageUrl = urlInput?.value || '';
              
              if (!imageUrl) {
                alert('Por favor, ingresa una URL de imagen');
                return;
              }

              // Si la URL anterior era de Firebase Storage y ahora es externa, eliminar la anterior
              const currentImageInput = document.getElementById('edit-current-image-url') as HTMLInputElement;
              oldImageUrl = currentImageInput?.value || '';
              
              if (oldImageUrl && oldImageUrl !== imageUrl) {
                const { deleteProductImage, isFirebaseStorageUrl } = await import('../../lib/utils/storage');
                if (isFirebaseStorageUrl(oldImageUrl)) {
                  try {
                    await deleteProductImage(oldImageUrl);
                  } catch (error) {
                    console.error('Error deleting old image:', error);
                  }
                }
              }
            }

            const updateData: any = {
              name: (document.getElementById('edit-name') as HTMLInputElement)?.value,
              category: (document.getElementById('edit-category') as HTMLSelectElement)?.value,
              sku: (document.getElementById('edit-sku') as HTMLInputElement)?.value,
              price: parseFloat((document.getElementById('edit-price') as HTMLInputElement)?.value || '0'),
              minStock: parseInt((document.getElementById('edit-min-stock') as HTMLInputElement)?.value || '10'),
              image: imageUrl
            };
            
            const result = await updateProduct(productId, updateData);
            if (result.success) {
              alert('Producto actualizado exitosamente');
              closeModal(editModal);
              await loadProducts();
            } else {
              alert('Error al actualizar producto: ' + (result.error?.message || 'Error desconocido'));
            }
          } catch (error) {
            console.error('Error updating product:', error);
            alert('Error al actualizar producto: ' + ((error as Error).message || 'Error desconocido'));
            const editImageUploadProgress = document.getElementById('edit-image-upload-progress');
            if (editImageUploadProgress) editImageUploadProgress.classList.add('hidden');
          }
        });
      }

      const stockForm = document.getElementById('adjust-stock-form') as HTMLFormElement;
      if (stockForm) {
        stockForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const productId = (document.getElementById('adjust-product-id') as HTMLInputElement)?.value;
          const adjustment = parseInt((document.getElementById('stock-adjustment') as HTMLInputElement)?.value || '0');
          if (!productId || !adjustStock) return;
          
          try {
            const result = await adjustStock(productId, adjustment);
            if (result.success) {
              alert('Stock ajustado exitosamente');
              closeModal(stockModal);
              await loadProducts();
            } else {
              alert('Error al ajustar stock: ' + (result.error?.message || 'Error desconocido'));
            }
          } catch (error) {
            console.error('Error adjusting stock:', error);
            alert('Error al ajustar stock');
          }
        });
      }

      // Manejar cambio entre subir archivo y usar URL (formulario nuevo producto)
      const newImageTypeRadios = document.querySelectorAll('input[name="new-image-type"]');
      const newImageFileContainer = document.getElementById('new-image-file-container');
      const newImageUrlContainer = document.getElementById('new-image-url-container');
      const newImageFileInput = document.getElementById('new-product-image-file') as HTMLInputElement;
      const newImagePreviewContainer = document.getElementById('new-image-preview-container');
      const newImagePreview = document.getElementById('new-image-preview') as HTMLImageElement;
      const newImageRemoveBtn = document.getElementById('new-image-remove-btn');
      const newImageUploadProgress = document.getElementById('new-image-upload-progress');
      const newImageProgressBar = document.getElementById('new-image-progress-bar');

      newImageTypeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          const value = (e.target as HTMLInputElement).value;
          if (value === 'file') {
            if (newImageFileContainer) newImageFileContainer.classList.remove('hidden');
            if (newImageUrlContainer) newImageUrlContainer.classList.add('hidden');
          } else {
            if (newImageFileContainer) newImageFileContainer.classList.add('hidden');
            if (newImageUrlContainer) newImageUrlContainer.classList.remove('hidden');
          }
        });
      });

      // Preview de imagen cuando se selecciona un archivo
      if (newImageFileInput) {
        newImageFileInput.addEventListener('change', async (e) => {
          const file = (e.target as HTMLInputElement).files?.[0];
          if (!file) return;

          // Validar archivo
          const { validateImageFile } = await import('../../lib/utils/storage');
          const validation = validateImageFile(file);
          if (!validation.valid) {
            alert(validation.error || 'Archivo inválido');
            newImageFileInput.value = '';
            return;
          }

          // Mostrar preview
          const reader = new FileReader();
          reader.onload = (e) => {
            if (newImagePreview && e.target?.result) {
              newImagePreview.src = e.target.result as string;
              if (newImagePreviewContainer) newImagePreviewContainer.classList.remove('hidden');
            }
          };
          reader.readAsDataURL(file);
        });
      }

      // Eliminar imagen seleccionada
      if (newImageRemoveBtn) {
        newImageRemoveBtn.addEventListener('click', () => {
          if (newImageFileInput) newImageFileInput.value = '';
          if (newImagePreviewContainer) newImagePreviewContainer.classList.add('hidden');
          if (newImagePreview) newImagePreview.src = '';
        });
      }

      const newForm = document.getElementById('new-product-form') as HTMLFormElement;
      if (newForm) {
        newForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!createProduct) return;
          
          try {
            // Determinar tipo de imagen (archivo o URL)
            const imageType = (document.querySelector('input[name="new-image-type"]:checked') as HTMLInputElement)?.value;
            let imageUrl = '';

            const formData = new FormData(newForm);
            const productData: any = {
              name: formData.get('name') as string,
              category: formData.get('category') as string,
              sku: formData.get('sku') as string,
              price: parseFloat(formData.get('price') as string || '0'),
              stock: parseInt(formData.get('stock') as string || '0'),
              minStock: parseInt(formData.get('minStock') as string || '10'),
              description: formData.get('description') as string || '',
              active: true
            };

            if (imageType === 'file') {
              // Subir archivo: primero crear producto, luego subir imagen con ID real
              const fileInput = document.getElementById('new-product-image-file') as HTMLInputElement;
              const file = fileInput?.files?.[0];
              
              if (!file) {
                alert('Por favor, selecciona una imagen o usa una URL externa');
                return;
              }

              // Mostrar progreso
              if (newImageUploadProgress) newImageUploadProgress.classList.remove('hidden');
              if (newImageProgressBar) newImageProgressBar.style.width = '25%';

              // Crear producto primero sin imagen
              const { uploadProductImage } = await import('../../lib/utils/storage');
              const { updateProduct: updateProductFn } = await import('../../lib/db/products');
              
              productData.image = ''; // Placeholder temporal
              const result = await createProduct(productData);
              
              if (!result.success || !result.id) {
                if (newImageUploadProgress) newImageUploadProgress.classList.add('hidden');
                alert('Error al crear producto: ' + (result.error?.message || 'Error desconocido'));
                return;
              }
              
              // Subir imagen con el ID real del producto
              if (newImageProgressBar) newImageProgressBar.style.width = '50%';
              const uploadResult = await uploadProductImage(file, result.id);
              
              if (!uploadResult.success || !uploadResult.url) {
                if (newImageUploadProgress) newImageUploadProgress.classList.add('hidden');
                alert('Error al subir la imagen: ' + (uploadResult.error?.message || 'Error desconocido'));
                return;
              }
              
              // Actualizar producto con la URL de la imagen
              if (newImageProgressBar) newImageProgressBar.style.width = '75%';
              const updateResult = await updateProductFn(result.id, { image: uploadResult.url });
              
              if (!updateResult.success) {
                if (newImageUploadProgress) newImageUploadProgress.classList.add('hidden');
                alert('Producto creado pero error al actualizar la imagen: ' + (updateResult.error?.message || 'Error desconocido'));
                return;
              }
              
              if (newImageProgressBar) newImageProgressBar.style.width = '100%';
              if (newImageUploadProgress) newImageUploadProgress.classList.add('hidden');
              
              alert('Producto creado exitosamente');
              closeModal(newModal);
              newForm.reset();
              if (newImagePreviewContainer) newImagePreviewContainer.classList.add('hidden');
              await loadProducts();
            } else {
              // Usar URL externa
              const urlInput = document.getElementById('new-product-image-url') as HTMLInputElement;
              const imageUrl = urlInput?.value || '';
              
              if (!imageUrl) {
                alert('Por favor, ingresa una URL de imagen o sube un archivo');
                return;
              }
              
              productData.image = imageUrl;
              const result = await createProduct(productData);
              
              if (result.success) {
                alert('Producto creado exitosamente');
                closeModal(newModal);
                newForm.reset();
                if (newImagePreviewContainer) newImagePreviewContainer.classList.add('hidden');
                await loadProducts();
              } else {
                alert('Error al crear producto: ' + (result.error?.message || 'Error desconocido'));
              }
            }
          } catch (error) {
            console.error('Error creating product:', error);
            alert('Error al crear producto: ' + ((error as Error).message || 'Error desconocido'));
            if (newImageUploadProgress) newImageUploadProgress.classList.add('hidden');
          }
        });
      }

      // Cerrar modales al hacer clic fuera
      [viewModal, editModal, stockModal, deleteModal, newModal].forEach((modal) => {
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeModal(modal);
            }
          });
        }
      });

      // Cerrar modales con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          [viewModal, editModal, stockModal, deleteModal, newModal].forEach((modal) => {
            if (modal && !modal.classList.contains('hidden')) {
              closeModal(modal);
            }
          });
        }
      });
      
      // Función para adjuntar event listeners de filtros
      function attachFilterListeners() {
        const searchInput = document.getElementById('products-search-input');
        const categoryFilter = document.getElementById('products-category-filter');
        const stockFilter = document.getElementById('products-stock-filter');
        const statusFilter = document.getElementById('products-status-filter');
        
        // Búsqueda en tiempo real
        if (searchInput) {
          searchInput.addEventListener('input', () => {
            applyFilters();
          });
        }
        
        // Filtros
        if (categoryFilter) {
          categoryFilter.addEventListener('change', () => {
            applyFilters();
          });
        }
        
        if (stockFilter) {
          stockFilter.addEventListener('change', () => {
            applyFilters();
          });
        }
        
        if (statusFilter) {
          statusFilter.addEventListener('change', () => {
            applyFilters();
          });
        }
      }
      
      // Load products after everything is initialized
      loadProducts();
    })();
  </script>
</Layout>

