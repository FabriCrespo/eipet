---
import Layout from '../../layouts/Layout.astro';

// Funciones helper
function formatCurrency(value: number): string {
  return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function formatNumber(value: number): string {
  return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

---

<Layout>
  <section class="py-8 lg:py-12 bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Header -->
      <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
          <div>
            <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">Gestión de Productos</h1>
            <p class="text-gray-600">Gestiona tus productos de manera eficiente</p>
          </div>
          <div class="flex gap-2">
            <button
              type="button"
              id="new-product-btn"
              class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 hover:shadow-lg transition-all duration-300 flex items-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              <span>Nuevo Producto</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Sección: Productos -->
      <!-- Estadísticas -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Productos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Total Productos</p>
              <p class="text-2xl font-bold text-gray-900" id="stats-total-products">0</p>
            </div>
          </div>
        </div>

        <!-- Productos Activos -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Activos</p>
              <p class="text-2xl font-bold text-gray-900" id="stats-active-products">0</p>
            </div>
          </div>
        </div>

        <!-- Bajo Stock -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-yellow-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Bajo Stock</p>
              <p class="text-2xl font-bold text-gray-900" id="stats-low-stock">0</p>
            </div>
          </div>
        </div>

        <!-- Agotados -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600">Agotados</p>
              <p class="text-2xl font-bold text-gray-900" id="stats-out-of-stock">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Estadísticas de Stock -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Valor Total del Inventario -->
        <div class="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-xl bg-purple-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600 mb-1">Valor Total del Inventario</p>
              <p class="text-3xl font-bold text-gray-900" id="stats-total-value">Bs. 0.00</p>
            </div>
          </div>
        </div>

        <!-- Total de Unidades -->
        <div class="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
          <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-xl bg-blue-100 flex items-center justify-center">
              <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-600 mb-1">Total de Unidades en Stock</p>
              <p class="text-3xl font-bold text-gray-900" id="stats-total-stock">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Barra de Búsqueda y Filtros -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md p-6 mb-8">
        <div class="flex flex-col sm:flex-row gap-4">
          <!-- Búsqueda -->
          <div class="flex-1 relative">
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input
              type="text"
              placeholder="Buscar por nombre o SKU..."
              class="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
            />
          </div>

          <!-- Filtro por Stock -->
          <select class="px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-700 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all">
            <option value="all">Todo el stock</option>
            <option value="normal">Stock normal</option>
            <option value="low">Bajo stock</option>
            <option value="out">Agotado</option>
          </select>
        </div>
      </div>

      <!-- Tabla de Productos -->
      <div class="bg-white rounded-3xl border border-gray-200 shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Producto</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">SKU</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Precio</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Stock</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Estado</th>
                <th class="text-left py-4 px-6 text-sm font-semibold text-gray-700">Ventas</th>
                <th class="text-right py-4 px-6 text-sm font-semibold text-gray-700">Acciones</th>
              </tr>
            </thead>
            <tbody id="products-tbody">
              <tr>
                <td colspan="7" class="py-8 px-6 text-center text-gray-500">
                  <p class="mb-2">No hay productos registrados</p>
                  <p class="text-sm">Crea tu primer producto usando el botón "Nuevo Producto"</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 p-6 border-t border-gray-200">
          <div class="text-sm text-gray-600">
            Mostrando <span class="font-semibold" id="products-showing-start">0</span> - <span class="font-semibold" id="products-showing-end">0</span> de <span class="font-semibold" id="products-total">0</span> productos
          </div>
          <div class="flex items-center gap-2">
            <button class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <button class="px-4 py-2 rounded-lg border-2 border-purple-400 bg-purple-50 text-purple-700 font-semibold">1</button>
            <button class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all">2</button>
            <button class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50 transition-all">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal: Ver Detalles del Producto -->
  <div id="view-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Detalles del Producto</h2>
        <button type="button" id="close-view-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="view-product-content" class="space-y-4">
        <!-- Se cargará dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Modal: Editar Producto -->
  <div id="edit-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Editar Producto</h2>
        <button type="button" id="close-edit-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="edit-product-form" class="space-y-4">
        <div id="edit-product-content" class="space-y-3">
          <!-- Se cargará dinámicamente -->
        </div>
        <div class="flex gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="cancel-edit-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
            Cancelar
          </button>
          <button type="submit" class="flex-1 px-4 py-2.5 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all text-sm">
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ajustar Stock -->
  <div id="adjust-stock-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Ajustar Stock</h2>
        <button type="button" id="close-stock-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="adjust-stock-form" class="space-y-4">
        <div id="adjust-stock-content" class="space-y-3">
          <!-- Se cargará dinámicamente -->
        </div>
        <div class="flex gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="cancel-stock-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
            Cancelar
          </button>
          <button type="submit" class="flex-1 px-4 py-2.5 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700 transition-all text-sm">
            Ajustar Stock
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Eliminar Producto -->
  <div id="delete-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-5">
      <div class="text-center mb-4">
        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-3">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </div>
        <h2 class="text-lg font-bold text-gray-900 mb-1">¿Eliminar Producto?</h2>
        <p class="text-sm text-gray-600 mb-4" id="delete-product-message">Esta acción no se puede deshacer.</p>
      </div>
      <div class="flex gap-2">
        <button type="button" id="cancel-delete-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
          Cancelar
        </button>
        <button type="button" id="confirm-delete-btn" class="flex-1 px-4 py-2.5 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-all text-sm">
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Nuevo Producto -->
  <div id="new-product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-gray-900">Nuevo Producto</h2>
        <button type="button" id="close-new-modal-btn" class="p-1.5 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="new-product-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Nombre -->
          <div class="md:col-span-2">
            <label for="new-product-name" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Nombre del Producto <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="new-product-name"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="Ej: Royal Canin Puppy 15kg"
            />
          </div>

          <!-- SKU -->
          <div>
            <label for="new-product-sku" class="block text-sm font-semibold text-gray-700 mb-1.5">
              SKU <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="new-product-sku"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="Ej: RC-PUPPY-15KG"
            />
          </div>

          <!-- Precio -->
          <div>
            <label for="new-product-price" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Precio (Bs.) <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="new-product-price"
              step="0.01"
              min="0"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="0.00"
            />
          </div>

          <!-- Stock Inicial -->
          <div>
            <label for="new-product-stock" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Stock Inicial <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="new-product-stock"
              min="0"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="0"
            />
          </div>

          <!-- Stock Mínimo -->
          <div>
            <label for="new-product-min-stock" class="block text-sm font-semibold text-gray-700 mb-1.5">
              Stock Mínimo <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              id="new-product-min-stock"
              min="0"
              required
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="0"
            />
          </div>

          <!-- URL de Imagen -->
          <div class="md:col-span-2">
            <label for="new-product-image" class="block text-sm font-semibold text-gray-700 mb-1.5">
              URL de Imagen
            </label>
            <input
              type="url"
              id="new-product-image"
              class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white text-gray-800 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100 transition-all"
              placeholder="https://ejemplo.com/imagen.jpg"
            />
          </div>

          <!-- Estado -->
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Estado</label>
            <div class="flex gap-4">
              <label class="flex items-center gap-2">
                <input type="radio" name="new-product-status" value="Activo" checked class="w-4 h-4 text-purple-600" />
                <span class="text-sm text-gray-700">Activo</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="new-product-status" value="Inactivo" class="w-4 h-4 text-purple-600" />
                <span class="text-sm text-gray-700">Inactivo</span>
              </label>
            </div>
          </div>
        </div>

        <div class="flex gap-2 pt-3 border-t border-gray-200">
          <button type="button" id="cancel-new-btn" class="flex-1 px-4 py-2.5 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-gray-300 transition-all text-sm">
            Cancelar
          </button>
          <button type="submit" class="flex-1 px-4 py-2.5 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all text-sm">
            Crear Producto
          </button>
        </div>
      </form>
    </div>
  </div>


  <script type="module">
    (async function() {
      // Obtener datos - inicialmente vacío, se cargará desde Firestore
      let productsData = [];

      // Funciones helper para formatear
      function formatCurrency(value) {
        return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      function formatNumber(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Función para actualizar estadísticas
      function updateStats() {
        const stats = {
          totalProducts: productsData.length,
          activeProducts: productsData.filter((p) => p.status === 'Activo').length,
          outOfStock: productsData.filter((p) => {
            const stock = p.stock || 0;
            const minStock = p.minStock || 0;
            return stock === 0;
          }).length,
          lowStock: productsData.filter((p) => {
            const stock = p.stock || 0;
            const minStock = p.minStock || 0;
            return stock > 0 && stock < minStock;
          }).length,
          totalStock: productsData.reduce((sum, p) => sum + (p.stock || 0), 0),
          totalValue: productsData.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0)
        };

        const totalProductsEl = document.getElementById('stats-total-products');
        const activeProductsEl = document.getElementById('stats-active-products');
        const lowStockEl = document.getElementById('stats-low-stock');
        const outOfStockEl = document.getElementById('stats-out-of-stock');
        const totalStockEl = document.getElementById('stats-total-stock');
        const totalValueEl = document.getElementById('stats-total-value');

        if (totalProductsEl) totalProductsEl.textContent = formatNumber(stats.totalProducts);
        if (activeProductsEl) activeProductsEl.textContent = formatNumber(stats.activeProducts);
        if (lowStockEl) lowStockEl.textContent = formatNumber(stats.lowStock);
        if (outOfStockEl) outOfStockEl.textContent = formatNumber(stats.outOfStock);
        if (totalStockEl) totalStockEl.textContent = formatNumber(stats.totalStock);
        if (totalValueEl) totalValueEl.textContent = `Bs. ${formatCurrency(stats.totalValue)}`;
      }

      // Función para renderizar la tabla de productos
      function renderProductsTable() {
        const tbody = document.getElementById('products-tbody');
        if (!tbody) return;

        if (productsData.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="py-8 px-6 text-center text-gray-500">
                <p class="mb-2">No hay productos registrados</p>
                <p class="text-sm">Crea tu primer producto usando el botón "Nuevo Producto"</p>
              </td>
            </tr>
          `;
          updateStats();
          updatePagination();
          return;
        }

        tbody.innerHTML = productsData.map((product) => {
          const stockStatus = product.stock === 0 ? 'out' : (product.stock < (product.minStock || 0) ? 'low' : 'normal');
          const stockColor = stockStatus === 'out' 
            ? 'bg-gray-50 text-gray-700' 
            : stockStatus === 'low' 
            ? 'bg-red-50 text-red-700' 
            : 'bg-green-50 text-green-700';
          const statusColor = product.status === 'Activo' 
            ? 'bg-green-50 text-green-700 border border-green-200' 
            : 'bg-gray-50 text-gray-700 border border-gray-200';

          return `
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
              <td class="py-4 px-6">
                <div class="flex items-center gap-3">
                  ${product.image ? `<img
                    src="${product.image}"
                    alt="${product.name}"
                    class="w-12 h-12 rounded-lg object-cover border border-gray-200"
                  />` : `<div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center border border-gray-200">
                    <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </div>`}
                  <div>
                    <p class="font-semibold text-gray-900">${product.name || 'Sin nombre'}</p>
                    <p class="text-xs text-gray-500">ID: ${product.id}</p>
                  </div>
                </div>
              </td>
              <td class="py-4 px-6">
                <span class="text-sm font-mono text-gray-600">${product.sku || 'N/A'}</span>
              </td>
              <td class="py-4 px-6">
                <p class="font-semibold text-gray-900">Bs. ${formatCurrency(product.price || 0)}</p>
              </td>
              <td class="py-4 px-6">
                <div class="flex flex-col gap-1">
                  <div class="flex items-center gap-2">
                    <span class="px-2 py-1 rounded text-xs font-medium ${stockColor}">
                      ${product.stock || 0} unidades
                    </span>
                    ${stockStatus === 'low' ? `<span class="text-xs text-yellow-600">⚠ Mín: ${product.minStock || 0}</span>` : ''}
                    ${stockStatus === 'out' ? `<span class="text-xs text-red-600">⚠ Agotado</span>` : ''}
                  </div>
                  ${stockStatus === 'normal' ? `<span class="text-xs text-gray-500">Mín: ${product.minStock || 0}</span>` : ''}
                </div>
              </td>
              <td class="py-4 px-6">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusColor}">
                  ${product.status || 'Activo'}
                </span>
              </td>
              <td class="py-4 px-6">
                <div>
                  <p class="text-sm font-semibold text-gray-900">${product.sales || 0} ventas</p>
                  <p class="text-xs text-gray-500">Bs. ${formatCurrency(product.revenue || 0)}</p>
                </div>
              </td>
              <td class="py-4 px-6 text-right">
                <div class="flex items-center justify-end gap-2">
                  <button
                    type="button"
                    data-product-id="${product.id}"
                    data-action="view"
                    class="view-product-btn p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                    title="Ver detalles"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    data-product-id="${product.id}"
                    data-action="edit"
                    class="edit-product-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                    title="Editar"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    data-product-id="${product.id}"
                    data-action="stock"
                    class="adjust-stock-btn p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"
                    title="Ajustar stock"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    data-product-id="${product.id}"
                    data-action="delete"
                    class="delete-product-btn p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                    title="Eliminar"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');

        // Re-asignar event listeners
        attachProductEventListeners();
        updateStats();
        updatePagination();
      }

      // Función para actualizar paginación
      function updatePagination() {
        const total = productsData.length;
        const showingStart = total > 0 ? 1 : 0;
        const showingEnd = total;

        const startEl = document.getElementById('products-showing-start');
        const endEl = document.getElementById('products-showing-end');
        const totalEl = document.getElementById('products-total');

        if (startEl) startEl.textContent = formatNumber(showingStart);
        if (endEl) endEl.textContent = formatNumber(showingEnd);
        if (totalEl) totalEl.textContent = formatNumber(total);
      }

      // Función para asignar event listeners a los botones de productos
      function attachProductEventListeners() {
        // Abrir modal de ver detalles
        document.querySelectorAll('.view-product-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const productId = btn.getAttribute('data-product-id');
            const product = productsData.find((p) => p.id === productId);
            if (!product || !viewModal) return;

            const statusColor = product.status === 'Activo' 
              ? 'bg-green-50 text-green-700 border border-green-200' 
              : 'bg-gray-50 text-gray-700 border border-gray-200';

            const content = document.getElementById('view-product-content');
            if (content) {
              content.innerHTML = `
                <div class="flex gap-4 pb-4 border-b border-gray-200">
                  ${product.image ? `<img src="${product.image}" alt="${product.name || 'Producto'}" class="w-20 h-20 rounded-lg object-cover border border-gray-200" />` : `<div class="w-20 h-20 rounded-lg bg-gray-100 flex items-center justify-center border border-gray-200">
                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </div>`}
                  <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">${product.name || 'Sin nombre'}</h3>
                    <p class="text-xs text-gray-600 mb-0.5">ID: ${product.id}</p>
                    <p class="text-xs text-gray-600 mb-1">SKU: ${product.sku || 'N/A'}</p>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                      ${product.status || 'Activo'}
                    </span>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Precio</p>
                    <p class="text-sm text-gray-900 font-bold">Bs. ${formatCurrency(product.price || 0)}</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Actual</p>
                    <p class="text-sm text-gray-900">${product.stock || 0} unidades</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Stock Mínimo</p>
                    <p class="text-sm text-gray-900">${product.minStock || 0} unidades</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Ventas</p>
                    <p class="text-sm text-gray-900">${product.sales || 0} ventas</p>
                  </div>
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-0.5">Ingresos</p>
                    <p class="text-sm text-gray-900 font-bold">Bs. ${formatCurrency(product.revenue || 0)}</p>
                  </div>
                </div>
              `;
            }
            openModal(viewModal);
          });
        });

        // Abrir modal de editar
        document.querySelectorAll('.edit-product-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const productId = btn.getAttribute('data-product-id');
            const product = productsData.find((p) => p.id === productId);
            if (!product || !editModal) return;

            const content = document.getElementById('edit-product-content');
            if (content) {
              content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Nombre del Producto</label>
                    <input type="text" id="edit-name" value="${product.name || ''}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">SKU</label>
                    <input type="text" id="edit-sku" value="${product.sku || ''}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Precio (Bs.)</label>
                    <input type="number" id="edit-price" step="0.01" value="${product.price || 0}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
                  </div>
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Stock Mínimo</label>
                    <input type="number" id="edit-min-stock" value="${product.minStock || 0}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
                  </div>
                  <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">URL de Imagen</label>
                    <input type="url" id="edit-image" value="${product.image || ''}" class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-100" />
                  </div>
                </div>
                <input type="hidden" id="edit-product-id" value="${product.id}" />
              `;
            }
            openModal(editModal);
          });
        });

        // Abrir modal de ajustar stock
        document.querySelectorAll('.adjust-stock-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const productId = btn.getAttribute('data-product-id');
            const product = productsData.find((p) => p.id === productId);
            if (!product || !stockModal) return;

            const content = document.getElementById('adjust-stock-content');
            if (content) {
              content.innerHTML = `
                <div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                  <p class="text-xs text-gray-600 mb-0.5">Producto</p>
                  <p class="text-sm font-semibold text-gray-900">${product.name || 'Sin nombre'}</p>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-1">Stock Actual</label>
                  <p class="text-base font-bold text-gray-900 mb-3">${product.stock || 0} unidades</p>
                </div>
                <div>
                  <label for="stock-adjustment" class="block text-sm font-semibold text-gray-700 mb-1.5">
                    Ajuste de Stock <span class="text-gray-500 font-normal text-xs">(positivo para agregar, negativo para quitar)</span>
                  </label>
                  <input
                    type="number"
                    id="stock-adjustment"
                    class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-100"
                    placeholder="Ej: +10 o -5"
                  />
                </div>
                <div>
                  <label for="stock-reason" class="block text-sm font-semibold text-gray-700 mb-1.5">Motivo del Ajuste</label>
                  <textarea
                    id="stock-reason"
                    rows="2"
                    class="w-full px-3 py-2 rounded-lg border-2 border-gray-200 text-sm focus:border-orange-400 focus:outline-none focus:ring-2 focus:ring-orange-100 resize-none"
                    placeholder="Ej: Recepción de mercancía, pérdida de inventario, etc."
                  ></textarea>
                </div>
                <input type="hidden" id="adjust-product-id" value="${product.id}" />
              `;
            }
            openModal(stockModal);
          });
        });

        // Abrir modal de eliminar
        document.querySelectorAll('.delete-product-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const productId = btn.getAttribute('data-product-id');
            const product = productsData.find((p) => p.id === productId);
            if (!product || !deleteModal) return;

            const message = document.getElementById('delete-product-message');
            if (message) {
              message.textContent = `¿Estás seguro de que deseas eliminar "${product.name || 'este producto'}"? Esta acción no se puede deshacer.`;
            }
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            if (confirmBtn && productId) {
              confirmBtn.setAttribute('data-product-id', productId);
            }
            
            openModal(deleteModal);
          });
        });
      }

      // Modales
      const viewModal = document.getElementById('view-product-modal');
      const editModal = document.getElementById('edit-product-modal');
      const stockModal = document.getElementById('adjust-stock-modal');
      const deleteModal = document.getElementById('delete-product-modal');
      const newModal = document.getElementById('new-product-modal');

      // Funciones para abrir/cerrar modales
      function openModal(modal) {
        if (!modal) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      function closeModal(modal) {
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }

      // Renderizar tabla inicialmente
      renderProductsTable();

      // Abrir modal de nuevo producto
      const newProductBtn = document.getElementById('new-product-btn');
      if (newProductBtn) {
        newProductBtn.addEventListener('click', () => {
          const newForm = document.getElementById('new-product-form');
          if (newForm) {
            newForm.reset();
          }
          openModal(newModal);
        });
      }

      // Función para resetear el formulario de nuevo producto
      function resetNewProductForm() {
        const newForm = document.getElementById('new-product-form');
        if (newForm) {
          newForm.reset();
        }
      }

      // Cerrar modales
      const closeButtons = [
        { id: 'close-view-modal-btn', modal: viewModal },
        { id: 'close-edit-modal-btn', modal: editModal },
        { id: 'close-stock-modal-btn', modal: stockModal },
        { id: 'close-new-modal-btn', modal: newModal, resetFn: resetNewProductForm },
        { id: 'cancel-edit-btn', modal: editModal },
        { id: 'cancel-stock-btn', modal: stockModal },
        { id: 'cancel-delete-btn', modal: deleteModal },
        { id: 'cancel-new-btn', modal: newModal, resetFn: resetNewProductForm }
      ];

      closeButtons.forEach(({ id, modal, resetFn }) => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.addEventListener('click', () => {
            if (resetFn) resetFn();
            closeModal(modal);
          });
        }
      });

      // Confirmar eliminación
      const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', () => {
          const productId = confirmDeleteBtn.getAttribute('data-product-id');
          if (productId) {
            console.log('Eliminar producto:', productId);
            alert('Producto eliminado exitosamente');
            closeModal(deleteModal);
            // Aquí iría la lógica para eliminar el producto
          }
        });
      }

      // Submit formularios
      const editForm = document.getElementById('edit-product-form');
      if (editForm) {
        editForm.addEventListener('submit', (e) => {
          e.preventDefault();
          
          // Validar que se haya ingresado el nombre
          const productId = document.getElementById('edit-product-id')?.value;
          const productName = document.getElementById('edit-name')?.value;
          
          if (!productName || productName.trim() === '') {
            alert('Por favor, ingrese el nombre del producto');
            return;
          }
          
          // Obtener todos los datos del formulario
          const formData = {
            id: productId,
            name: productName,
            sku: document.getElementById('edit-sku')?.value,
            price: parseFloat(document.getElementById('edit-price')?.value || '0'),
            minStock: parseInt(document.getElementById('edit-min-stock')?.value || '0'),
            image: document.getElementById('edit-image')?.value || ''
          };
          
          console.log('Editar producto:', formData);
          alert('Producto actualizado exitosamente');
          closeModal(editModal);
        });
      }

      const stockForm = document.getElementById('adjust-stock-form');
      if (stockForm) {
        stockForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const productId = document.getElementById('adjust-product-id')?.value;
          const adjustment = document.getElementById('stock-adjustment')?.value;
          console.log('Ajustar stock:', productId, adjustment);
          alert('Stock ajustado exitosamente');
          closeModal(stockModal);
        });
      }

      const newForm = document.getElementById('new-product-form');
      if (newForm) {
        newForm.addEventListener('submit', (e) => {
          e.preventDefault();
          
          // Validar que se haya ingresado el nombre
          const productName = document.getElementById('new-product-name')?.value;
          
          if (!productName || productName.trim() === '') {
            alert('Por favor, ingrese el nombre del producto');
            return;
          }
          
          // Obtener todos los datos del formulario
          const formData = {
            name: productName,
            sku: document.getElementById('new-product-sku')?.value,
            price: parseFloat(document.getElementById('new-product-price')?.value || '0'),
            stock: parseInt(document.getElementById('new-product-stock')?.value || '0'),
            minStock: parseInt(document.getElementById('new-product-min-stock')?.value || '0'),
            image: document.getElementById('new-product-image')?.value || '',
            status: document.querySelector('input[name="new-product-status"]:checked')?.value || 'Activo'
          };
          
          console.log('Nuevo producto creado:', formData);
          alert('Producto creado exitosamente');
          closeModal(newModal);
          newForm.reset();
        });
      }

      // Cerrar modales al hacer clic fuera
      [viewModal, editModal, stockModal, deleteModal].forEach((modal) => {
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeModal(modal);
            }
          });
        }
      });
      
      // Cerrar modal de nuevo producto al hacer clic fuera (con reset)
      if (newModal) {
        newModal.addEventListener('click', (e) => {
          if (e.target === newModal) {
            resetNewProductForm();
            closeModal(newModal);
          }
        });
      }

      // Cerrar modales con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          [viewModal, editModal, stockModal, deleteModal].forEach((modal) => {
            if (modal && !modal.classList.contains('hidden')) {
              closeModal(modal);
            }
          });
          
          // Cerrar modal de nuevo producto con ESC (con reset)
          if (newModal && !newModal.classList.contains('hidden')) {
            resetNewProductForm();
            closeModal(newModal);
          }
        }
      });

    })();
  </script>


</Layout>

