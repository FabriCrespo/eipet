---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <section class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-linear-to-br from-purple-50 via-white to-pink-50">
    <div class="max-w-md w-full">
      <!-- Logo y Título -->
      <div class="text-center mb-8">
        <a href="/" class="inline-flex items-center gap-3 mb-4">
          <div class="bg-[#ffff11] rounded-xl p-2.5 shadow-lg">
            <svg width="36" height="36" viewBox="0 0 32 32" fill="none">
              <path d="M16 8C16 8 10 2 4 8C-2 14 4 20 4 20L16 28L28 20C28 20 34 14 28 8C22 2 16 8 16 8Z" fill="#5d3fbb"/>
              <circle cx="10" cy="12" r="2" fill="#fff"/>
              <circle cx="22" cy="12" r="2" fill="#fff"/>
              <path d="M16 18C16 18 14 20 10 20C6 20 4 18 4 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              <path d="M16 18C16 18 18 20 22 20C26 20 28 18 28 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <span class="text-3xl font-bold text-[#5d3fbb]">eipet</span>
        </a>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Recuperar Contraseña</h1>
        <p class="text-gray-600">Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña</p>
      </div>

      <!-- Formulario -->
      <div class="bg-white rounded-3xl shadow-2xl p-8 border border-gray-100">
        <form id="forgot-password-form" class="space-y-6">
          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
              Correo Electrónico
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 bg-white text-gray-800 placeholder-gray-400 focus:border-purple-400 focus:outline-none focus:ring-4 focus:ring-purple-100 transition-all"
              placeholder="tu@email.com"
            />
            <p id="error-message" class="mt-2 text-sm text-red-600 hidden"></p>
            <p id="success-message" class="mt-2 text-sm text-green-600 hidden"></p>
          </div>

          <!-- Botón Enviar -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-[#5d3fbb] hover:bg-[#6d4fcc] text-white font-bold py-3.5 px-6 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Enviar Enlace de Recuperación
          </button>

          <!-- Link de vuelta a login -->
          <div class="text-center">
            <a href="/login" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
              ← Volver al inicio de sesión
            </a>
          </div>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script>
  (async () => {
    const { resetPassword } = await import('../lib/auth');
    
    const form = document.getElementById('forgot-password-form') as HTMLFormElement;
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const errorMessage = document.getElementById('error-message') as HTMLParagraphElement;
    const successMessage = document.getElementById('success-message') as HTMLParagraphElement;
    
    if (!form || !emailInput || !submitBtn) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Reset messages
      if (errorMessage) {
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
      }
      if (successMessage) {
        successMessage.classList.add('hidden');
        successMessage.textContent = '';
      }
      
      const email = emailInput.value.trim();
      
      if (!email) {
        if (errorMessage) {
          errorMessage.textContent = 'Por favor, ingresa tu correo electrónico';
          errorMessage.classList.remove('hidden');
        }
        return;
      }
      
      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';
      
      try {
        const result = await resetPassword(email);
        
        if (result.success) {
          // Show success message
          if (successMessage) {
            successMessage.textContent = 'Se ha enviado un enlace de recuperación a tu correo electrónico. Por favor, revisa tu bandeja de entrada.';
            successMessage.classList.remove('hidden');
          }
          
          // Clear form
          emailInput.value = '';
          
          // Disable form
          submitBtn.disabled = true;
          submitBtn.textContent = 'Enlace Enviado';
        } else {
          // Show error message
          if (errorMessage) {
            errorMessage.textContent = result.error || 'Error al enviar el email de recuperación';
            errorMessage.classList.remove('hidden');
          }
          
          // Re-enable button
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar Enlace de Recuperación';
        }
      } catch (error: any) {
        console.error('Error sending password reset email:', error);
        if (errorMessage) {
          errorMessage.textContent = 'Error al enviar el email. Por favor, intenta de nuevo.';
          errorMessage.classList.remove('hidden');
        }
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar Enlace de Recuperación';
      }
    });
  })();
</script>

