---
import Layout from '../layouts/Layout.astro';

// Obtener parámetros de la URL
const url = Astro.url;
const petFilter = url.searchParams.get('pet') || 'all';
const filterType = url.searchParams.get('filter') || 'all';

const getTitle = () => {
  if (petFilter === 'dog') return 'Productos para Perros';
  if (petFilter === 'cat') return 'Productos para Gatos';
  return 'Productos';
};

const getSubtitle = () => {
  if (petFilter === 'dog') return 'Explora nuestra selección especializada para perros.';
  if (petFilter === 'cat') return 'Explora nuestra selección especializada para gatos.';
  return 'Encuentra todo lo que necesitas para tu mascota.';
};
---

<Layout>
  <section class="py-8 lg:py-12 bg-white min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
      <!-- Header -->
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
        <div class="mb-4 lg:mb-0">
          <div class="flex items-center gap-3 mb-2">
            <div class="bg-[#ffff11] rounded-lg p-1.5">
              <svg width="24" height="24" viewBox="0 0 32 32" fill="none">
                <path d="M16 8C16 8 10 2 4 8C-2 14 4 20 4 20L16 28L28 20C28 20 34 14 28 8C22 2 16 8 16 8Z" fill="#5d3fbb"/>
                <circle cx="10" cy="12" r="2" fill="#fff"/>
                <circle cx="22" cy="12" r="2" fill="#fff"/>
                <path d="M16 18C16 18 14 20 10 20C6 20 4 18 4 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                <path d="M16 18C16 18 18 20 22 20C26 20 28 18 28 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <h1 class="text-2xl lg:text-3xl font-bold text-[#5d3fbb]">
              {getTitle()}
            </h1>
          </div>
          <p class="text-gray-600 text-sm lg:text-base ml-10">
            {getSubtitle()}
          </p>
        </div>
        
        <!-- Controles de ordenamiento y vista -->
        <div class="flex items-center gap-3">
          <select 
            id="sort-select"
            class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:border-[#5d3fbb] focus:outline-none focus:ring-2 focus:ring-[#5d3fbb]/20 transition-all"
          >
            <option value="relevant">Más relevantes</option>
            <option value="price-low">Precio: menor a mayor</option>
            <option value="price-high">Precio: mayor a menor</option>
            <option value="discount">Mayor descuento</option>
          </select>
          <div class="flex gap-1 border border-gray-300 rounded-lg p-1">
            <button 
              id="grid-view"
              class="p-2 rounded hover:bg-purple-50 text-gray-600 hover:text-[#5d3fbb] transition-colors active"
              aria-label="Vista de cuadrícula"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
              </svg>
            </button>
            <button 
              id="list-view"
              class="p-2 rounded hover:bg-purple-50 text-gray-600 hover:text-[#5d3fbb] transition-colors"
              aria-label="Vista de lista"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">
        <!-- Sidebar de Filtros -->
        <aside class="lg:w-64 shrink-0">
          <div class="bg-white rounded-xl shadow-lg p-6 sticky top-24">
            <div class="mb-6">
              <h2 class="text-xl font-bold text-[#5d3fbb] mb-1">Filtros</h2>
              <p class="text-sm text-gray-600">Filtros pensados para tu mascota</p>
            </div>

            <!-- Filtro: Precio -->
            <div class="mb-6">
              <button 
                id="price-filter-btn"
                class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-purple-50 transition-colors"
              >
                <div class="flex items-center gap-3">
                  <svg class="w-5 h-5 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span class="font-semibold text-gray-800">Precio</span>
                </div>
                <svg class="w-4 h-4 text-gray-400 transition-transform" id="price-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="price-filter-content" class="hidden mt-2 pl-8 space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="0-100">
                  <span class="text-sm text-gray-700">Bs. 0 - 100</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="100-200">
                  <span class="text-sm text-gray-700">Bs. 100 - 200</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="200-300">
                  <span class="text-sm text-gray-700">Bs. 200 - 300</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="300+">
                  <span class="text-sm text-gray-700">Bs. 300+</span>
                </label>
              </div>
            </div>

            <!-- Filtro: Etapa de Vida -->
            <div class="mb-6">
              <button 
                id="life-stage-filter-btn"
                class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-purple-50 transition-colors"
              >
                <div class="flex items-center gap-3">
                  <svg class="w-5 h-5 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                  <span class="font-semibold text-gray-800">Etapa de Vida</span>
                </div>
                <svg class="w-4 h-4 text-gray-400 transition-transform" id="life-stage-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="life-stage-filter-content" class="hidden mt-2 pl-8 space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="cachorro">
                  <span class="text-sm text-gray-700">Cachorro</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="adulto">
                  <span class="text-sm text-gray-700">Adulto</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="senior">
                  <span class="text-sm text-gray-700">Senior</span>
                </label>
              </div>
            </div>

            <!-- Filtro: Tamaño de Raza -->
            <div class="mb-6">
              <button 
                id="breed-size-filter-btn"
                class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-purple-50 transition-colors"
              >
                <div class="flex items-center gap-3">
                  <svg class="w-5 h-5 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                  <span class="font-semibold text-gray-800">Tamaño de Raza</span>
                </div>
                <svg class="w-4 h-4 text-gray-400 transition-transform" id="breed-size-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="breed-size-filter-content" class="hidden mt-2 pl-8 space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="pequeña">
                  <span class="text-sm text-gray-700">Pequeña</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="mediana">
                  <span class="text-sm text-gray-700">Mediana</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="grande">
                  <span class="text-sm text-gray-700">Grande</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="todos">
                  <span class="text-sm text-gray-700">Todos los tamaños</span>
                </label>
              </div>
            </div>

            <!-- Filtro: Tipo -->
            <div>
              <button 
                id="type-filter-btn"
                class="w-full flex items-center justify-between p-3 rounded-lg hover:bg-purple-50 transition-colors"
              >
                <div class="flex items-center gap-3">
                  <svg class="w-5 h-5 text-[#5d3fbb]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                  </svg>
                  <span class="font-semibold text-gray-800">Tipo</span>
                </div>
                <svg class="w-4 h-4 text-gray-400 transition-transform" id="type-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="type-filter-content" class="hidden mt-2 pl-8 space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="food">
                  <span class="text-sm text-gray-700">Alimento</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="toy">
                  <span class="text-sm text-gray-700">Juguetes</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="cleaning">
                  <span class="text-sm text-gray-700">Limpieza</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="w-4 h-4 text-[#5d3fbb] rounded" value="accessory">
                  <span class="text-sm text-gray-700">Accesorios</span>
                </label>
              </div>
            </div>
          </div>
        </aside>

        <!-- Grid de Productos -->
        <div class="flex-1">
          <div id="products-loading" class="text-center py-16">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#5d3fbb]"></div>
            <p class="mt-4 text-gray-600">Cargando productos...</p>
          </div>
          <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- Products will be loaded here dynamically -->
          </div>
          <div id="products-empty" class="text-center py-16 hidden">
            <p class="text-gray-500 text-lg">No se encontraron productos con los filtros seleccionados.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    #products-grid.list-view {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #products-grid.list-view .product-card {
      flex-direction: row;
      height: auto;
      max-height: 300px;
    }

    #products-grid.list-view .product-card > div:first-child {
      width: 300px;
      height: 100%;
      flex-shrink: 0;
    }

    #products-grid.list-view .product-card > div:last-child {
      flex: 1;
    }
  </style>

  <script>
    // Dynamic imports
    let getProducts: any, addToCart: any, addToFavorites: any, removeFromFavorites: any, isFavorite: any, getCurrentUser: any;
    let allProducts: any[] = [];
    let currentUser: any = null;
    
    (async () => {
      const productsModule = await import('../lib/db/products');
      getProducts = productsModule.getProducts;
      
      const cartModule = await import('../lib/db/cart');
      addToCart = cartModule.addToCart;
      
      const favoritesModule = await import('../lib/db/favorites');
      addToFavorites = favoritesModule.addToFavorites;
      removeFromFavorites = favoritesModule.removeFromFavorites;
      isFavorite = favoritesModule.isFavorite;
      
      const authModule = await import('../lib/auth');
      getCurrentUser = authModule.getCurrentUser;
      
      // Get current user
      const firebaseUser = getCurrentUser();
      if (firebaseUser) {
        const userData = localStorage.getItem('user');
        if (userData) {
          try {
            currentUser = JSON.parse(userData);
          } catch (e) {
            console.error('Error parsing user:', e);
          }
        }
      }
      
      // Load products
      await loadProducts();
    })();

    // Obtener los filtros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const petFilter = urlParams.get('pet') || 'all';
    const filterType = urlParams.get('filter') || 'all';

    // Load products from Firestore
    async function loadProducts() {
      const loadingEl = document.getElementById('products-loading');
      const gridEl = document.getElementById('products-grid');
      const emptyEl = document.getElementById('products-empty');
      
      if (!gridEl) return;
      
      try {
        // Build filters
        const filters: any = {
          status: 'active',
        };
        
        if (petFilter === 'dog') {
          filters.category = 'dog';
        } else if (petFilter === 'cat') {
          filters.category = 'cat';
        }
        
        if (filterType === 'discount') {
          filters.discount = true;
        }
        
        // Get products from Firestore
        const result = await getProducts(filters);
        
        if (result.error) {
          console.error('Error loading products:', result.error);
          if (loadingEl) loadingEl.classList.add('hidden');
          if (emptyEl) emptyEl.classList.remove('hidden');
          return;
        }
        
        allProducts = result.data || [];
        
        // Filter new products if needed
        if (filterType === 'new') {
          // Sort by createdAt and take last 5
          allProducts.sort((a: any, b: any) => {
            const aDate = a.createdAt?.toDate?.() || new Date(0);
            const bDate = b.createdAt?.toDate?.() || new Date(0);
            return bDate.getTime() - aDate.getTime();
          });
          allProducts = allProducts.slice(0, 5);
        }
        
        // Render products
        renderProducts(allProducts);
        
        if (loadingEl) loadingEl.classList.add('hidden');
        if (allProducts.length === 0) {
          if (emptyEl) emptyEl.classList.remove('hidden');
        } else {
          if (emptyEl) emptyEl.classList.add('hidden');
          if (gridEl) gridEl.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading products:', error);
        if (loadingEl) loadingEl.classList.add('hidden');
        if (emptyEl) emptyEl.classList.remove('hidden');
      }
    }

    // Render products
    async function renderProducts(products: any[]) {
      const gridEl = document.getElementById('products-grid');
      if (!gridEl) return;
      
      gridEl.innerHTML = '';
      
      for (const product of products) {
        const isFav = currentUser ? await isFavorite(currentUser.id, product.id) : false;
        const discount = product.discount || 0;
        const price = product.price || 0;
        const originalPrice = product.originalPrice || null;
        
        const productCard = document.createElement('div');
        productCard.className = 'product-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden group flex flex-col h-[520px]';
        productCard.setAttribute('data-category', product.category || '');
        productCard.setAttribute('data-type', product.type || '');
        productCard.setAttribute('data-life-stage', product.lifeStage || '');
        productCard.setAttribute('data-breed-size', product.breedSize || '');
        productCard.setAttribute('data-price', price.toString());
        productCard.setAttribute('data-discount', discount.toString());
        productCard.setAttribute('data-product-id', product.id);
        
        productCard.innerHTML = `
          <div class="relative h-64 bg-gray-100 overflow-hidden shrink-0">
            ${discount > 0 ? `
              <div class="absolute top-3 left-3 bg-red-500 text-white px-3 py-1 rounded-lg text-sm font-bold z-10 shadow-lg">
                -${discount}%
              </div>
            ` : ''}
            <button 
              class="favorite-btn absolute top-3 right-3 bg-white/90 hover:bg-white rounded-full p-2 z-10 transition-all hover:scale-110 shadow-lg ${isFav ? 'text-red-500' : 'text-gray-400'}"
              aria-label="Agregar a favoritos"
              data-product-id="${product.id}"
            >
              <svg class="w-5 h-5 ${isFav ? 'fill-current' : ''}" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              </svg>
            </button>
            ${product.weight ? `
              <div class="absolute bottom-3 left-3 bg-[#5d3fbb] text-white px-3 py-1 rounded-lg text-xs font-bold z-10 shadow-lg">
                ${product.weight}
              </div>
            ` : ''}
            <img 
              src="${product.image || ''}" 
              alt="${product.name || ''}"
              class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
              onerror="this.src='https://via.placeholder.com/400x400?text=Sin+Imagen'"
            />
          </div>
          <div class="p-5 bg-linear-to-b from-white to-purple-50/30 flex flex-col grow min-h-0">
            <p class="text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wide">${product.brand || ''}</p>
            <h3 class="font-bold text-base text-gray-800 mb-2 line-clamp-2 min-h-10">${product.name || ''}</h3>
            <div class="mb-4 min-h-8 flex items-center gap-2">
              <p class="text-2xl font-bold text-[#5d3fbb]">Bs. ${price.toLocaleString()}</p>
              ${originalPrice ? `
                <p class="text-lg text-gray-400 line-through">Bs. ${originalPrice.toLocaleString()}</p>
              ` : ''}
            </div>
            <div class="flex gap-2 mt-auto">
              <button 
                class="add-to-cart-btn flex-1 bg-[#5d3fbb] hover:bg-[#6d4fcc] text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shrink-0 hover:scale-105 active:scale-95"
                data-product-id="${product.id}"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Agregar
              </button>
              <a 
                href="/product?id=${product.id}"
                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shrink-0 hover:scale-105 active:scale-95"
              >
                Ver Detalles
              </a>
            </div>
          </div>
        `;
        
        gridEl.appendChild(productCard);
      }
      
      // Add event listeners
      setupProductEventListeners();
    }

    // Setup event listeners for products
    function setupProductEventListeners() {
      // Add to cart buttons
      document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const productId = (e.currentTarget as HTMLElement).getAttribute('data-product-id');
          if (!productId) return;
          
          if (!currentUser) {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            return;
          }
          
          const btnEl = e.currentTarget as HTMLButtonElement;
          const originalText = btnEl.innerHTML;
          btnEl.disabled = true;
          btnEl.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>';
          
          try {
            const result = await addToCart(currentUser.id, { productId, quantity: 1 });
            if (result.success) {
              btnEl.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> ¡Agregado!';
              btnEl.classList.add('bg-green-500', 'hover:bg-green-600');
              setTimeout(() => {
                btnEl.innerHTML = originalText;
                btnEl.classList.remove('bg-green-500', 'hover:bg-green-600');
                btnEl.disabled = false;
              }, 2000);
              
              // Emitir evento de actualización del carrito
              document.dispatchEvent(new CustomEvent('cartUpdated'));
            } else {
              throw new Error(result.error?.message || 'Error al agregar al carrito');
            }
          } catch (error) {
            console.error('Error adding to cart:', error);
            btnEl.innerHTML = originalText;
            btnEl.disabled = false;
            alert('Error al agregar al carrito. Por favor, intenta de nuevo.');
          }
        });
      });
      
      // Favorite buttons
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const productId = (e.currentTarget as HTMLElement).getAttribute('data-product-id');
          if (!productId) return;
          
          if (!currentUser) {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
            return;
          }
          
          const btnEl = e.currentTarget as HTMLButtonElement;
          const svg = btnEl.querySelector('svg');
          
          try {
            const isFav = await isFavorite(currentUser.id, productId);
            let result;
            
            if (isFav) {
              result = await removeFromFavorites(currentUser.id, productId);
            } else {
              result = await addToFavorites(currentUser.id, productId);
            }
            
            if (result.success) {
              if (isFav) {
                btnEl.classList.remove('text-red-500');
                btnEl.classList.add('text-gray-400');
                if (svg) {
                  svg.setAttribute('fill', 'none');
                }
              } else {
                btnEl.classList.remove('text-gray-400');
                btnEl.classList.add('text-red-500');
                if (svg) {
                  svg.setAttribute('fill', 'currentColor');
                }
              }
            }
          } catch (error) {
            console.error('Error toggling favorite:', error);
          }
        });
      });
    }

    // Función para aplicar filtros
    function applyFilters() {
      const cards = document.querySelectorAll('.product-card');
      
      cards.forEach(card => {
        let show = true;
        
        // Filtro por pet (categoría) - siempre aplicar si está en la URL
        if (petFilter !== 'all') {
          const cardCategory = card.getAttribute('data-category');
          if (cardCategory !== petFilter) {
            show = false;
          }
        }
        
        // Filtro por tipo (discount/new) - siempre aplicar si está en la URL
        if (show && filterType !== 'all') {
          if (filterType === 'discount') {
            const discount = parseInt(card.getAttribute('data-discount') || '0');
            if (discount <= 0) {
              show = false;
            }
          }
        }
        
        // Solo aplicar otros filtros si el producto pasa los filtros de URL
        if (show) {
          // Filtro por tipo
          const typeCheckboxes = document.querySelectorAll('#type-filter-content input:checked');
          if (typeCheckboxes.length > 0) {
            const types = Array.from(typeCheckboxes).map(cb => (cb as HTMLInputElement).value);
            show = show && types.includes(card.getAttribute('data-type') || '');
          }

          // Filtro por etapa de vida
          const lifeStageCheckboxes = document.querySelectorAll('#life-stage-filter-content input:checked');
          if (lifeStageCheckboxes.length > 0) {
            const stages = Array.from(lifeStageCheckboxes).map(cb => (cb as HTMLInputElement).value);
            show = show && stages.includes(card.getAttribute('data-life-stage') || '');
          }

          // Filtro por tamaño de raza
          const breedSizeCheckboxes = document.querySelectorAll('#breed-size-filter-content input:checked');
          if (breedSizeCheckboxes.length > 0) {
            const sizes = Array.from(breedSizeCheckboxes).map(cb => (cb as HTMLInputElement).value);
            show = show && sizes.includes(card.getAttribute('data-breed-size') || '');
          }

          // Filtro por precio
          const priceCheckboxes = document.querySelectorAll('#price-filter-content input:checked');
          if (priceCheckboxes.length > 0) {
            const price = parseFloat(card.getAttribute('data-price') || '0');
            const priceRanges = Array.from(priceCheckboxes).map(cb => (cb as HTMLInputElement).value);
            const matchesPrice = priceRanges.some(range => {
              if (range === '300+') return price >= 300;
              const [min, max] = range.split('-').map(Number);
              return price >= min && price < max;
            });
            show = show && matchesPrice;
          }
        }

        if (show) {
          (card as HTMLElement).style.display = '';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
      
      // Update empty message
      const visibleCards = Array.from(document.querySelectorAll('.product-card')).filter(card => 
        (card as HTMLElement).style.display !== 'none'
      );
      const emptyEl = document.getElementById('products-empty');
      const gridEl = document.getElementById('products-grid');
      if (visibleCards.length === 0) {
        if (emptyEl) emptyEl.classList.remove('hidden');
        if (gridEl) gridEl.classList.add('hidden');
      } else {
        if (emptyEl) emptyEl.classList.add('hidden');
        if (gridEl) gridEl.classList.remove('hidden');
      }
    }

    // Aplicar filtros cuando cambien los checkboxes

    // Toggle filtros
    const filterButtons = [
      { btn: 'price-filter-btn', content: 'price-filter-content', arrow: 'price-arrow' },
      { btn: 'life-stage-filter-btn', content: 'life-stage-filter-content', arrow: 'life-stage-arrow' },
      { btn: 'breed-size-filter-btn', content: 'breed-size-filter-content', arrow: 'breed-size-arrow' },
      { btn: 'type-filter-btn', content: 'type-filter-content', arrow: 'type-arrow' }
    ];

    filterButtons.forEach(({ btn, content, arrow }) => {
      const button = document.getElementById(btn);
      const filterContent = document.getElementById(content);
      const arrowIcon = document.getElementById(arrow);

      button?.addEventListener('click', () => {
        const isHidden = filterContent?.classList.contains('hidden');
        if (isHidden) {
          filterContent?.classList.remove('hidden');
          arrowIcon?.classList.add('rotate-180');
        } else {
          filterContent?.classList.add('hidden');
          arrowIcon?.classList.remove('rotate-180');
        }
      });
    });

    // Vista grid/lista
    const gridViewBtn = document.getElementById('grid-view');
    const listViewBtn = document.getElementById('list-view');
    const productsGrid = document.getElementById('products-grid');

    gridViewBtn?.addEventListener('click', () => {
      productsGrid?.classList.remove('list-view');
      gridViewBtn.classList.add('active', 'bg-purple-50', 'text-[#5d3fbb]');
      gridViewBtn.classList.remove('text-gray-600');
      listViewBtn?.classList.remove('active', 'bg-purple-50', 'text-[#5d3fbb]');
      listViewBtn?.classList.add('text-gray-600');
    });

    listViewBtn?.addEventListener('click', () => {
      productsGrid?.classList.add('list-view');
      listViewBtn.classList.add('active', 'bg-purple-50', 'text-[#5d3fbb]');
      listViewBtn.classList.remove('text-gray-600');
      gridViewBtn?.classList.remove('active', 'bg-purple-50', 'text-[#5d3fbb]');
      gridViewBtn?.classList.add('text-gray-600');
    });

    // Ordenamiento
    const sortSelect = document.getElementById('sort-select');
    sortSelect?.addEventListener('change', (e) => {
      const value = (e.target as HTMLSelectElement).value;
      const cards = Array.from(document.querySelectorAll('.product-card'));
      
      cards.sort((a, b) => {
        const priceA = parseFloat(a.getAttribute('data-price') || '0');
        const priceB = parseFloat(b.getAttribute('data-price') || '0');
        
        switch(value) {
          case 'price-low':
            return priceA - priceB;
          case 'price-high':
            return priceB - priceA;
          case 'discount':
            const discountA = parseInt(a.getAttribute('data-discount') || '0');
            const discountB = parseInt(b.getAttribute('data-discount') || '0');
            return discountB - discountA;
          default:
            return 0;
        }
      });

      const grid = document.getElementById('products-grid');
      if (grid) {
        grid.innerHTML = '';
        cards.forEach(card => grid.appendChild(card));
        setupProductEventListeners();
      }
    });

    // Filtros
    const filterCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    filterCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        applyFilters();
      });
    });
    
    // Helper function to get cart item count (needed for add to cart)
    let getCartItemCount: any;
    (async () => {
      const cartModule = await import('../lib/db/cart');
      getCartItemCount = cartModule.getCartItemCount;
    })();
  </script>
</Layout>
