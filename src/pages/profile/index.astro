---
import UserLayout from '../../layouts/UserLayout.astro';
import InfoSection from '../../components/profile/sections/InfoSection.astro';
import OrdersSection from '../../components/profile/sections/OrdersSection.astro';
import AddressesSection from '../../components/profile/sections/AddressesSection.astro';
import PaymentSection from '../../components/profile/sections/PaymentSection.astro';
import FavoritesSection from '../../components/profile/sections/FavoritesSection.astro';
import HistorySection from '../../components/profile/sections/HistorySection.astro';
import ReturnsSection from '../../components/profile/sections/ReturnsSection.astro';
import SettingsSection from '../../components/profile/sections/SettingsSection.astro';
import SecuritySection from '../../components/profile/sections/SecuritySection.astro';

const sectionConfig = [
  { id: 'info', title: 'Mi Perfil', Component: InfoSection },
  { id: 'orders', title: 'Mis Pedidos', Component: OrdersSection },
  { id: 'addresses', title: 'Mis Direcciones', Component: AddressesSection },
  { id: 'payment', title: 'Métodos de Pago', Component: PaymentSection },
  { id: 'favorites', title: 'Favoritos', Component: FavoritesSection },
  { id: 'returns', title: 'Devoluciones', Component: ReturnsSection },
  { id: 'settings', title: 'Configuración', Component: SettingsSection },
  { id: 'security', title: 'Seguridad', Component: SecuritySection }
] as const;

const initialSection = 'info';
const sectionIds = sectionConfig.map((section) => section.id);
---

<UserLayout currentSection={initialSection} sectionConfig={sectionConfig}>
  <!-- Loading State -->
  <div id="profile-loading" class="flex items-center justify-center min-h-[400px]">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mb-4"></div>
      <p class="text-gray-600">Cargando tu perfil...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="profile-error" class="hidden flex items-center justify-center min-h-[400px]">
    <div class="text-center">
      <p class="text-red-500 mb-4">Error al cargar tu perfil</p>
      <a href="/login" class="text-purple-600 hover:underline">Volver al login</a>
    </div>
  </div>

  <!-- Content -->
  <section
    id="profile-content-panel"
    class="space-y-6 hidden"
    data-section-ids={JSON.stringify(sectionIds)}
    data-initial-section={initialSection}
  >
    {sectionConfig.map(({ id, Component }) => (
      <article
        id={`profile-section-${id}`}
        data-profile-section={id}
        class={`profile-section-panel ${id === initialSection ? '' : 'hidden'}`}
        aria-hidden={id === initialSection ? 'false' : 'true'}
      >
        <Component />
      </article>
    ))}
  </section>

  <script>
    (async function() {
      type ProfileWindow = Window &
        typeof globalThis & {
          currentProfileSection?: string;
          updateProfileSidebarSection?: (section: string) => void;
          onProfileSectionChange?: (section: string) => void;
        };

      const profileWindow = typeof window !== 'undefined' ? (window as ProfileWindow) : undefined;
      const loadingDiv = document.getElementById('profile-loading');
      const errorDiv = document.getElementById('profile-error');
      const contentPanel = document.getElementById('profile-content-panel');

      // Verificar autenticación y cargar datos del usuario
      async function checkAuthAndLoad() {
        try {
          const { getCurrentUser, getCurrentUserData, onAuthStateChange } = await import('../../lib/auth');
          
          // Esperar a que Firebase Auth esté listo
          return new Promise<void>((resolve) => {
            const unsubscribe = onAuthStateChange(async (firebaseUser) => {
              unsubscribe();
              
              if (!firebaseUser) {
                // No hay usuario autenticado, redirigir al login
                window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                resolve();
                return;
              }

              try {
                // Obtener datos completos del usuario
                const userDataResult = await getCurrentUserData();
                
                if (!userDataResult.success || !userDataResult.user) {
                  console.error('Error loading user data:', userDataResult.error);
                  // Mostrar error
                  if (loadingDiv) loadingDiv.classList.add('hidden');
                  if (errorDiv) errorDiv.classList.remove('hidden');
                  resolve();
                  return;
                }

                // Guardar datos del usuario en localStorage para uso en componentes
                localStorage.setItem('user', JSON.stringify(userDataResult.user));
                
                // Ocultar loading y mostrar contenido
                if (loadingDiv) loadingDiv.classList.add('hidden');
                if (errorDiv) errorDiv.classList.add('hidden');
                if (contentPanel) contentPanel.classList.remove('hidden');
                
                // Inicializar contenido del perfil
                initProfileContent();
                
                resolve();
              } catch (error) {
                console.error('Error loading user data:', error);
                if (loadingDiv) loadingDiv.classList.add('hidden');
                if (errorDiv) errorDiv.classList.remove('hidden');
                resolve();
              }
            });
          });
        } catch (error) {
          console.error('Error checking auth:', error);
          if (loadingDiv) loadingDiv.classList.add('hidden');
          if (errorDiv) errorDiv.classList.remove('hidden');
        }
      }

      function initProfileContent() {
        if (!contentPanel) return;

        const sectionIdsAttr = contentPanel.getAttribute('data-section-ids');
        const initialSectionAttr = contentPanel.getAttribute('data-initial-section');

        const sectionIds: string[] = sectionIdsAttr ? JSON.parse(sectionIdsAttr) : [];
        const defaultSection = initialSectionAttr || sectionIds[0] || 'info';

        const setActiveProfileSection = (sectionId: string) => {
          sectionIds.forEach((id) => {
            const el = document.querySelector<HTMLElement>(`[data-profile-section="${id}"]`);
            if (!el) return;
            const isActive = id === sectionId;
            el.classList.toggle('hidden', !isActive);
            el.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          });
          if (profileWindow?.updateProfileSidebarSection) {
            profileWindow.updateProfileSidebarSection(sectionId);
          }
        };

        const resolveInitialSection = () => {
          if (profileWindow?.currentProfileSection && sectionIds.includes(profileWindow.currentProfileSection)) {
            return profileWindow.currentProfileSection;
          }
          return defaultSection;
        };

        const applySection = (sectionId: string) => {
          if (!sectionIds.includes(sectionId)) return;
          profileWindow && (profileWindow.currentProfileSection = sectionId);
          setActiveProfileSection(sectionId);
        };

        const initialActiveSection = resolveInitialSection();
        applySection(initialActiveSection);

        if (profileWindow) {
          profileWindow.onProfileSectionChange = (sectionId: string) => {
            applySection(sectionId);
          };
        }
      }

      // Inicializar cuando el DOM esté listo
      if (typeof document !== 'undefined') {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', checkAuthAndLoad, { once: true });
        } else {
          await checkAuthAndLoad();
        }
      }
    })();
  </script>
</UserLayout>